enifed('@glimmer/test-helpers/lib/abstract-test-case', ['exports', '@glimmer/reference', '@glimmer/test-helpers/lib/environment', '@glimmer/test-helpers/lib/helpers'], function (exports, _glimmerReference, _glimmerTestHelpersLibEnvironment, _glimmerTestHelpersLibHelpers) {
    'use strict';

    exports.skip = skip;
    exports.testModule = testModule;
    exports.template = template;

    function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

    function skip(target, name, descriptor) {
        descriptor.value['skip'] = true;
    }

    var VersionedObject = (function () {
        function VersionedObject(value) {
            _classCallCheck(this, VersionedObject);

            this.tag = new _glimmerReference.DirtyableTag();
            _glimmerTestHelpersLibHelpers.assign(this, value);
        }

        VersionedObject.prototype.update = function update(value) {
            _glimmerTestHelpersLibHelpers.assign(this, value);
            this.dirty();
        };

        VersionedObject.prototype.set = function set(key, value) {
            this[key] = value;
            this.dirty();
        };

        VersionedObject.prototype.dirty = function dirty() {
            this.tag.dirty();
        };

        return VersionedObject;
    })();

    exports.VersionedObject = VersionedObject;

    var SimpleRootReference = (function () {
        function SimpleRootReference(object) {
            _classCallCheck(this, SimpleRootReference);

            this.object = object;
            this.tag = object.tag;
        }

        SimpleRootReference.prototype.get = function get(key) {
            return new SimplePathReference(this, key);
        };

        SimpleRootReference.prototype.value = function value() {
            return this.object;
        };

        return SimpleRootReference;
    })();

    exports.SimpleRootReference = SimpleRootReference;

    var SimplePathReference = (function () {
        function SimplePathReference(parent, key) {
            _classCallCheck(this, SimplePathReference);

            this.parent = parent;
            this.key = key;
            this.tag = parent.tag;
        }

        SimplePathReference.prototype.get = function get(key) {
            return new SimplePathReference(this, key);
        };

        SimplePathReference.prototype.value = function value() {
            return this.parent.value()[this.key];
        };

        return SimplePathReference;
    })();

    function isMarker(node) {
        if (node instanceof Comment && node.textContent === '') {
            return true;
        }
        if (node instanceof Text && node.textContent === '') {
            return true;
        }
        return false;
    }

    var RenderingTest = (function () {
        function RenderingTest(env, template, appendTo) {
            if (env === undefined) env = new _glimmerTestHelpersLibEnvironment.TestEnvironment();

            _classCallCheck(this, RenderingTest);

            this.env = env;
            this.appendTo = appendTo;
            this.context = null;
            this.result = null;
            this.template = this.env.compile(template);
            this.assert = QUnit.config.current.assert;
        }

        RenderingTest.prototype.teardown = function teardown() {};

        RenderingTest.prototype.render = function render(context) {
            this.env.begin();
            var dynamicScope = new _glimmerTestHelpersLibEnvironment.TestDynamicScope();
            var appendTo = this.appendTo;
            var rootObject = new VersionedObject(context);
            var root = new SimpleRootReference(rootObject);
            this.context = rootObject;
            this.result = this.template.render(root, appendTo, dynamicScope);
            this.env.commit();
            this.element = document.getElementById('qunit-fixture').firstChild;
        };

        RenderingTest.prototype.assertContent = function assertContent(expected, message) {
            var actual = document.getElementById('qunit-fixture').innerHTML;
            QUnit.equal(actual, expected);
        };

        RenderingTest.prototype.takeSnapshot = function takeSnapshot() {
            var snapshot = this.snapshot = [];
            var node = this.element.firstChild;
            while (node) {
                if (!isMarker(node)) {
                    snapshot.push(node);
                }
                node = node.nextSibling;
            }
            return snapshot;
        };

        RenderingTest.prototype.assertStableRerender = function assertStableRerender() {
            this.takeSnapshot();
            this.rerender();
            this.assertInvariants();
        };

        RenderingTest.prototype.rerender = function rerender() {
            this.result.rerender();
        };

        RenderingTest.prototype.assertInvariants = function assertInvariants(oldSnapshot, newSnapshot) {
            oldSnapshot = oldSnapshot || this.snapshot;
            newSnapshot = newSnapshot || this.takeSnapshot();
            this.assert.strictEqual(newSnapshot.length, oldSnapshot.length, 'Same number of nodes');
            for (var i = 0; i < oldSnapshot.length; i++) {
                this.assertSameNode(newSnapshot[i], oldSnapshot[i]);
            }
        };

        RenderingTest.prototype.assertSameNode = function assertSameNode(actual, expected) {
            this.assert.strictEqual(actual, expected, 'DOM node stability');
        };

        RenderingTest.prototype.runTask = function runTask(callback) {
            callback();
            this.env.begin();
            this.result.rerender();
            this.env.commit();
        };

        return RenderingTest;
    })();

    exports.RenderingTest = RenderingTest;

    function testModule(description) {
        return function (TestClass) {
            var context = undefined;
            QUnit.module('[Browser] ' + (description || TestClass.name), {
                afterEach: function () {
                    context.teardown();
                }
            });
            var keys = Object.getOwnPropertyNames(TestClass.prototype);
            keys.forEach(function (key) {
                if (key === 'constructor') return;
                var value = Object.getOwnPropertyDescriptor(TestClass.prototype, key).value;
                var isSkipped = value.skip;
                if (typeof value === 'function' && !isSkipped) {
                    QUnit.test(key, function (assert) {
                        var env = new _glimmerTestHelpersLibEnvironment.TestEnvironment();
                        context = new TestClass(env, value['template'], document.getElementById('qunit-fixture'));
                        value.call(context, assert);
                    });
                } else if (isSkipped) {
                    QUnit.skip(key, function () {});
                }
            });
        };
    }

    function template(t) {
        return function template(target, name, descriptor) {
            if (typeof descriptor.value !== 'function') {
                throw new Error("Can't decorator a non-function with the @template decorator");
            }
            descriptor.value['template'] = t;
        };
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkBnbGltbWVyL3Rlc3QtaGVscGVycy9saWIvYWJzdHJhY3QtdGVzdC1jYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQVNNLGFBQUEsSUFBQSxDQUFlLE1BQWMsRUFBRSxJQUFZLEVBQUUsVUFBOEIsRUFBQTtBQUMvRSxrQkFBVSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7S0FDakM7O1FBRUssZUFBQTtBQUlKLGlCQUpJLGVBQUEsQ0FJUSxLQUFhLEVBQUE7a0NBSnJCLGVBQUE7O0FBS0YsZ0JBQUksQ0FBQyxHQUFHLEdBQUcsc0JBbEJ3QyxZQUFZLEVBa0JsQyxDQUFDO0FBQzlCLDBDQVpLLE1BQU0sQ0FZSixJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDckI7O0FBUEcsdUJBQUEsV0FTSixNQUFNLEdBQUEsZ0JBQUMsS0FBYSxFQUFBO0FBQ2xCLDBDQWhCSyxNQUFNLENBZ0JKLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNwQixnQkFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ2Q7O0FBWkcsdUJBQUEsV0FjSixHQUFHLEdBQUEsYUFBQyxHQUFXLEVBQUUsS0FBYSxFQUFBO0FBQzVCLGdCQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0FBQ2xCLGdCQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDZDs7QUFqQkcsdUJBQUEsV0FtQkosS0FBSyxHQUFBLGlCQUFBO0FBQ0gsZ0JBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDbEI7O2VBckJHLGVBQUE7Ozs7O1FBd0JBLG1CQUFBO0FBR0osaUJBSEksbUJBQUEsQ0FHZ0IsTUFBdUIsRUFBQTtrQ0FIdkMsbUJBQUE7O0FBR2dCLGdCQUFBLENBQUEsTUFBTSxHQUFOLE1BQU0sQ0FBaUI7QUFDekMsZ0JBQUksQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztTQUN2Qjs7QUFMRywyQkFBQSxXQU9K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QUFDLENBQUM7U0FDbEMsQ0FBQztLQUNIIiwiZmlsZSI6ImFic3RyYWN0LXRlc3QtY2FzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhdGhSZWZlcmVuY2UsIFRhZ2dlZCwgUmV2aXNpb24sIFJldmlzaW9uVGFnLCBEaXJ0eWFibGVUYWcgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHsgVGVtcGxhdGUsIFJlbmRlclJlc3VsdCwgU2ltcGxlIH0gZnJvbSAnQGdsaW1tZXIvcnVudGltZSc7XG5pbXBvcnQge1xuICBUZXN0RW52aXJvbm1lbnQsXG4gIFRlc3REeW5hbWljU2NvcGVcbn0gZnJvbSAnLi9lbnZpcm9ubWVudCc7XG5pbXBvcnQgeyBPcGFxdWUgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IGFzc2lnbiB9IGZyb20gJy4vaGVscGVycyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBza2lwKHRhcmdldDogT2JqZWN0LCBuYW1lOiBzdHJpbmcsIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcikge1xuICBkZXNjcmlwdG9yLnZhbHVlWydza2lwJ10gPSB0cnVlO1xufVxuXG5leHBvcnQgY2xhc3MgVmVyc2lvbmVkT2JqZWN0IGltcGxlbWVudHMgVGFnZ2VkPFJldmlzaW9uPiB7XG4gIHB1YmxpYyB0YWc6IERpcnR5YWJsZVRhZztcbiAgcHVibGljIHZhbHVlOiBPYmplY3Q7XG5cbiAgY29uc3RydWN0b3IodmFsdWU6IE9iamVjdCkge1xuICAgIHRoaXMudGFnID0gbmV3IERpcnR5YWJsZVRhZygpO1xuICAgIGFzc2lnbih0aGlzLCB2YWx1ZSk7XG4gIH1cblxuICB1cGRhdGUodmFsdWU6IE9iamVjdCkge1xuICAgIGFzc2lnbih0aGlzLCB2YWx1ZSk7XG4gICAgdGhpcy5kaXJ0eSgpO1xuICB9XG5cbiAgc2V0KGtleTogc3RyaW5nLCB2YWx1ZTogT3BhcXVlKSB7XG4gICAgdGhpc1trZXldID0gdmFsdWU7XG4gICAgdGhpcy5kaXJ0eSgpO1xuICB9XG5cbiAgZGlydHkoKSB7XG4gICAgdGhpcy50YWcuZGlydHkoKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2ltcGxlUm9vdFJlZmVyZW5jZSBpbXBsZW1lbnRzIFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gIHB1YmxpYyB0YWc6IFJldmlzaW9uVGFnO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb2JqZWN0OiBWZXJzaW9uZWRPYmplY3QpIHtcbiAgICB0aGlzLnRhZyA9IG9iamVjdC50YWc7XG4gIH1cblxuICBnZXQoa2V5OiBzdHJpbmcpOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT4ge1xuICAgIHJldHVybiBuZXcgU2ltcGxlUGF0aFJlZmVyZW5jZSh0aGlzLCBrZXkpO1xuICB9XG5cbiAgdmFsdWUoKTogT2JqZWN0IHtcbiAgICByZXR1cm4gdGhpcy5vYmplY3Q7XG4gIH1cbn1cblxuY2xhc3MgU2ltcGxlUGF0aFJlZmVyZW5jZSBpbXBsZW1lbnRzIFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gIHB1YmxpYyB0YWc6IFJldmlzaW9uVGFnO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFyZW50OiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT4sIHByaXZhdGUga2V5OiBzdHJpbmcpIHtcbiAgICB0aGlzLnRhZyA9IHBhcmVudC50YWc7XG4gIH1cblxuICBnZXQoa2V5OiBzdHJpbmcpOiBTaW1wbGVQYXRoUmVmZXJlbmNlIHtcbiAgICByZXR1cm4gbmV3IFNpbXBsZVBhdGhSZWZlcmVuY2UodGhpcywga2V5KTtcbiAgfVxuXG4gIHZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLnBhcmVudC52YWx1ZSgpW3RoaXMua2V5XTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc01hcmtlcihub2RlKSB7XG4gIGlmIChub2RlIGluc3RhbmNlb2YgQ29tbWVudCAmJiBub2RlLnRleHRDb250ZW50ID09PSAnJykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaWYgKG5vZGUgaW5zdGFuY2VvZiBUZXh0ICYmIG5vZGUudGV4dENvbnRlbnQgPT09ICcnKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICByZXR1cm4gZmFsc2U7XG59XG5cbmV4cG9ydCBjbGFzcyBSZW5kZXJpbmdUZXN0IHtcbiAgcHVibGljIHRlbXBsYXRlOiBUZW1wbGF0ZTx7fT47XG4gIHByb3RlY3RlZCBjb250ZXh0OiBWZXJzaW9uZWRPYmplY3QgPSBudWxsO1xuICBwcml2YXRlIHJlc3VsdDogUmVuZGVyUmVzdWx0ID0gbnVsbDtcbiAgcHVibGljIHNuYXBzaG90OiBFbGVtZW50W107XG4gIHB1YmxpYyBlbGVtZW50OiBOb2RlO1xuICBwdWJsaWMgYXNzZXJ0OiBRVW5pdFsnYXNzZXJ0J107XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGVudjogVGVzdEVudmlyb25tZW50ID0gbmV3IFRlc3RFbnZpcm9ubWVudCgpLCB0ZW1wbGF0ZTogc3RyaW5nLCBwcml2YXRlIGFwcGVuZFRvOiBTaW1wbGUuRWxlbWVudCkge1xuICAgIHRoaXMudGVtcGxhdGUgPSB0aGlzLmVudi5jb21waWxlKHRlbXBsYXRlKTtcbiAgICB0aGlzLmFzc2VydCA9IFFVbml0LmNvbmZpZy5jdXJyZW50LmFzc2VydDtcbiAgfVxuXG4gIHRlYXJkb3duKCkge31cblxuICByZW5kZXIoY29udGV4dDogT2JqZWN0KSB7XG4gICAgdGhpcy5lbnYuYmVnaW4oKTtcbiAgICBsZXQgZHluYW1pY1Njb3BlID0gbmV3IFRlc3REeW5hbWljU2NvcGUoKTtcbiAgICBsZXQgYXBwZW5kVG8gPSB0aGlzLmFwcGVuZFRvO1xuICAgIGxldCByb290T2JqZWN0ID0gbmV3IFZlcnNpb25lZE9iamVjdChjb250ZXh0KTtcbiAgICBsZXQgcm9vdCA9IG5ldyBTaW1wbGVSb290UmVmZXJlbmNlKHJvb3RPYmplY3QpO1xuXG4gICAgdGhpcy5jb250ZXh0ID0gcm9vdE9iamVjdDtcbiAgICB0aGlzLnJlc3VsdCA9IHRoaXMudGVtcGxhdGUucmVuZGVyKHJvb3QsIGFwcGVuZFRvLCBkeW5hbWljU2NvcGUpO1xuICAgIHRoaXMuZW52LmNvbW1pdCgpO1xuICAgIHRoaXMuZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxdW5pdC1maXh0dXJlJykuZmlyc3RDaGlsZDtcbiAgfVxuICBhc3NlcnRDb250ZW50KGV4cGVjdGVkOiBzdHJpbmcsIG1lc3NhZ2U/OiBzdHJpbmcpIHtcbiAgICBsZXQgYWN0dWFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1bml0LWZpeHR1cmUnKS5pbm5lckhUTUw7XG4gICAgUVVuaXQuZXF1YWwoYWN0dWFsLCBleHBlY3RlZCk7XG4gIH1cblxuICB0YWtlU25hcHNob3QoKSB7XG4gICAgbGV0IHNuYXBzaG90ID0gdGhpcy5zbmFwc2hvdCA9IFtdO1xuICAgIGxldCBub2RlID0gdGhpcy5lbGVtZW50LmZpcnN0Q2hpbGQ7XG5cbiAgICB3aGlsZSAobm9kZSkge1xuICAgICAgaWYgKCFpc01hcmtlcihub2RlKSkge1xuICAgICAgICBzbmFwc2hvdC5wdXNoKG5vZGUpO1xuICAgICAgfVxuXG4gICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZztcbiAgICB9XG5cbiAgICByZXR1cm4gc25hcHNob3Q7XG4gIH1cblxuICBhc3NlcnRTdGFibGVSZXJlbmRlcigpIHtcbiAgICB0aGlzLnRha2VTbmFwc2hvdCgpO1xuICAgIHRoaXMucmVyZW5kZXIoKTtcbiAgICB0aGlzLmFzc2VydEludmFyaWFudHMoKTtcbiAgfVxuXG4gIHJlcmVuZGVyKCkge1xuICAgIHRoaXMucmVzdWx0LnJlcmVuZGVyKCk7XG4gIH1cblxuICBhc3NlcnRJbnZhcmlhbnRzKG9sZFNuYXBzaG90PzogQXJyYXk8Tm9kZT4sIG5ld1NuYXBzaG90PzogQXJyYXk8Tm9kZT4pIHtcbiAgICBvbGRTbmFwc2hvdCA9IG9sZFNuYXBzaG90IHx8IHRoaXMuc25hcHNob3Q7XG4gICAgbmV3U25hcHNob3QgPSBuZXdTbmFwc2hvdCB8fCB0aGlzLnRha2VTbmFwc2hvdCgpO1xuXG4gICAgdGhpcy5hc3NlcnQuc3RyaWN0RXF1YWwobmV3U25hcHNob3QubGVuZ3RoLCBvbGRTbmFwc2hvdC5sZW5ndGgsICdTYW1lIG51bWJlciBvZiBub2RlcycpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvbGRTbmFwc2hvdC5sZW5ndGg7IGkrKykge1xuICAgICAgdGhpcy5hc3NlcnRTYW1lTm9kZShuZXdTbmFwc2hvdFtpXSwgb2xkU25hcHNob3RbaV0pO1xuICAgIH1cbiAgfVxuXG4gIGFzc2VydFNhbWVOb2RlKGFjdHVhbDogTm9kZSwgZXhwZWN0ZWQ6IE5vZGUpIHtcbiAgICB0aGlzLmFzc2VydC5zdHJpY3RFcXVhbChhY3R1YWwsIGV4cGVjdGVkLCAnRE9NIG5vZGUgc3RhYmlsaXR5Jyk7XG4gIH1cblxuICBydW5UYXNrKGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XG4gICAgY2FsbGJhY2soKTtcbiAgICB0aGlzLmVudi5iZWdpbigpO1xuICAgIHRoaXMucmVzdWx0LnJlcmVuZGVyKCk7XG4gICAgdGhpcy5lbnYuY29tbWl0KCk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIENvbnN0cnVjdG9yPFQ+IHtcbiAgbmV3KC4uLmFyZ3MpOiBUO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdGVzdE1vZHVsZShkZXNjcmlwdGlvbj86IHN0cmluZykge1xuICByZXR1cm4gZnVuY3Rpb24oVGVzdENsYXNzOiB0eXBlb2YgUmVuZGVyaW5nVGVzdCkge1xuICAgIGxldCBjb250ZXh0OiBSZW5kZXJpbmdUZXN0O1xuXG4gICAgUVVuaXQubW9kdWxlKGBbQnJvd3Nlcl0gJHtkZXNjcmlwdGlvbiB8fCBUZXN0Q2xhc3MubmFtZX1gLCB7XG4gICAgICBhZnRlckVhY2goKSB7XG4gICAgICAgIGNvbnRleHQudGVhcmRvd24oKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGxldCBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoVGVzdENsYXNzLnByb3RvdHlwZSk7XG4gICAga2V5cy5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBpZiAoa2V5ID09PSAnY29uc3RydWN0b3InKSByZXR1cm47XG4gICAgICBsZXQgdmFsdWUgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKFRlc3RDbGFzcy5wcm90b3R5cGUsIGtleSkudmFsdWU7XG4gICAgICBsZXQgaXNTa2lwcGVkID0gdmFsdWUuc2tpcDtcbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgJiYgIWlzU2tpcHBlZCkge1xuICAgICAgICBRVW5pdC50ZXN0KGtleSwgKGFzc2VydCkgPT4ge1xuICAgICAgICAgIGxldCBlbnYgPSBuZXcgVGVzdEVudmlyb25tZW50KCk7XG4gICAgICAgICAgY29udGV4dCA9IG5ldyBUZXN0Q2xhc3MoZW52LCB2YWx1ZVsndGVtcGxhdGUnXSwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1bml0LWZpeHR1cmUnKSk7XG4gICAgICAgICAgdmFsdWUuY2FsbChjb250ZXh0LCBhc3NlcnQpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoaXNTa2lwcGVkKSB7XG4gICAgICAgIFFVbml0LnNraXAoa2V5LCAoKSA9PiB7fSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0ZW1wbGF0ZSh0OiBzdHJpbmcpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIHRlbXBsYXRlKHRhcmdldDogT2JqZWN0LCBuYW1lOiBzdHJpbmcsIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcikge1xuICAgIGlmICh0eXBlb2YgZGVzY3JpcHRvci52YWx1ZSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FuJ3QgZGVjb3JhdG9yIGEgbm9uLWZ1bmN0aW9uIHdpdGggdGhlIEB0ZW1wbGF0ZSBkZWNvcmF0b3JcIik7XG4gICAgfVxuXG4gICAgZGVzY3JpcHRvci52YWx1ZVsndGVtcGxhdGUnXSA9IHQ7XG4gIH07XG59XG4iXX0=