enifed('@glimmer/runtime/lib/environment', ['exports', '@glimmer/util', '@glimmer/runtime/lib/syntax/functions', '@glimmer/runtime/lib/opcodes', '@glimmer/runtime/lib/references', '@glimmer/runtime/lib/dom/attribute-managers'], function (exports, _glimmerUtil, _glimmerRuntimeLibSyntaxFunctions, _glimmerRuntimeLibOpcodes, _glimmerRuntimeLibReferences, _glimmerRuntimeLibDomAttributeManagers) {
    'use strict';

    var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

    function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

    var Scope = (function () {
        function Scope(references) {
            var callerScope = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];

            _classCallCheck(this, Scope);

            this.callerScope = null;
            this.slots = references;
            this.callerScope = callerScope;
        }

        Scope.root = function root(self) {
            var size = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];

            var refs = new Array(size + 1);
            for (var i = 0; i <= size; i++) {
                refs[i] = _glimmerRuntimeLibReferences.UNDEFINED_REFERENCE;
            }
            return new Scope(refs).init({ self: self });
        };

        Scope.prototype.init = function init(_ref) {
            var self = _ref.self;

            this.slots[0] = self;
            return this;
        };

        Scope.prototype.getSelf = function getSelf() {
            return this.slots[0];
        };

        Scope.prototype.getSymbol = function getSymbol(symbol) {
            return this.slots[symbol];
        };

        Scope.prototype.getBlock = function getBlock(symbol) {
            return this.slots[symbol];
        };

        Scope.prototype.getPartialArgs = function getPartialArgs(symbol) {
            return this.slots[symbol];
        };

        Scope.prototype.bindSymbol = function bindSymbol(symbol, value) {
            this.slots[symbol] = value;
        };

        Scope.prototype.bindBlock = function bindBlock(symbol, value) {
            this.slots[symbol] = value;
        };

        Scope.prototype.bindPartialArgs = function bindPartialArgs(symbol, value) {
            this.slots[symbol] = value;
        };

        Scope.prototype.bindCallerScope = function bindCallerScope(scope) {
            this.callerScope = scope;
        };

        Scope.prototype.getCallerScope = function getCallerScope() {
            return this.callerScope;
        };

        Scope.prototype.child = function child() {
            return new Scope(this.slots.slice(), this.callerScope);
        };

        return Scope;
    })();

    exports.Scope = Scope;

    var Transaction = (function () {
        function Transaction() {
            _classCallCheck(this, Transaction);

            this.scheduledInstallManagers = [];
            this.scheduledInstallModifiers = [];
            this.scheduledUpdateModifierManagers = [];
            this.scheduledUpdateModifiers = [];
            this.createdComponents = [];
            this.createdManagers = [];
            this.updatedComponents = [];
            this.updatedManagers = [];
            this.destructors = [];
        }

        Transaction.prototype.didCreate = function didCreate(component, manager) {
            this.createdComponents.push(component);
            this.createdManagers.push(manager);
        };

        Transaction.prototype.didUpdate = function didUpdate(component, manager) {
            this.updatedComponents.push(component);
            this.updatedManagers.push(manager);
        };

        Transaction.prototype.scheduleInstallModifier = function scheduleInstallModifier(modifier, manager) {
            this.scheduledInstallManagers.push(manager);
            this.scheduledInstallModifiers.push(modifier);
        };

        Transaction.prototype.scheduleUpdateModifier = function scheduleUpdateModifier(modifier, manager) {
            this.scheduledUpdateModifierManagers.push(manager);
            this.scheduledUpdateModifiers.push(modifier);
        };

        Transaction.prototype.didDestroy = function didDestroy(d) {
            this.destructors.push(d);
        };

        Transaction.prototype.commit = function commit() {
            var createdComponents = this.createdComponents;
            var createdManagers = this.createdManagers;

            for (var i = 0; i < createdComponents.length; i++) {
                var component = createdComponents[i];
                var manager = createdManagers[i];
                manager.didCreate(component);
            }
            var updatedComponents = this.updatedComponents;
            var updatedManagers = this.updatedManagers;

            for (var i = 0; i < updatedComponents.length; i++) {
                var component = updatedComponents[i];
                var manager = updatedManagers[i];
                manager.didUpdate(component);
            }
            var destructors = this.destructors;

            for (var i = 0; i < destructors.length; i++) {
                destructors[i].destroy();
            }
            var scheduledInstallManagers = this.scheduledInstallManagers;
            var scheduledInstallModifiers = this.scheduledInstallModifiers;

            for (var i = 0; i < scheduledInstallManagers.length; i++) {
                var manager = scheduledInstallManagers[i];
                var modifier = scheduledInstallModifiers[i];
                manager.install(modifier);
            }
            var scheduledUpdateModifierManagers = this.scheduledUpdateModifierManagers;
            var scheduledUpdateModifiers = this.scheduledUpdateModifiers;

            for (var i = 0; i < scheduledUpdateModifierManagers.length; i++) {
                var manager = scheduledUpdateModifierManagers[i];
                var modifier = scheduledUpdateModifiers[i];
                manager.update(modifier);
            }
        };

        return Transaction;
    })();

    var Opcode = (function () {
        function Opcode(array) {
            _classCallCheck(this, Opcode);

            this.array = array;
            this.offset = 0;
        }

        _createClass(Opcode, [{
            key: 'type',
            get: function () {
                return this.array[this.offset];
            }
        }, {
            key: 'op1',
            get: function () {
                return this.array[this.offset + 1];
            }
        }, {
            key: 'op2',
            get: function () {
                return this.array[this.offset + 2];
            }
        }, {
            key: 'op3',
            get: function () {
                return this.array[this.offset + 3];
            }
        }]);

        return Opcode;
    })();

    exports.Opcode = Opcode;

    var Program = (function () {
        function Program() {
            _classCallCheck(this, Program);

            this.opcodes = new _glimmerUtil.A(0x100000);
            this._offset = 0;
            this._opcode = new Opcode(this.opcodes);
        }

        Program.prototype.opcode = function opcode(offset) {
            this._opcode.offset = offset;
            return this._opcode;
        };

        Program.prototype.set = function set(pos, opcode) {
            var type = opcode[0];
            var op1 = opcode[1];
            var op2 = opcode[2];
            var op3 = opcode[3];

            this.opcodes[pos] = type;
            this.opcodes[pos + 1] = op1;
            this.opcodes[pos + 2] = op2;
            this.opcodes[pos + 3] = op3;
        };

        Program.prototype.push = function push(opcode) {
            var offset = this._offset;
            var type = opcode[0];
            var op1 = opcode[1];
            var op2 = opcode[2];
            var op3 = opcode[3];

            this.opcodes[this._offset++] = type;
            this.opcodes[this._offset++] = op1;
            this.opcodes[this._offset++] = op2;
            this.opcodes[this._offset++] = op3;
            return offset;
        };

        _createClass(Program, [{
            key: 'next',
            get: function () {
                return this._offset;
            }
        }, {
            key: 'current',
            get: function () {
                return this._offset - 4;
            }
        }]);

        return Program;
    })();

    exports.Program = Program;

    var Environment = (function () {
        function Environment(_ref2) {
            var appendOperations = _ref2.appendOperations;
            var updateOperations = _ref2.updateOperations;

            _classCallCheck(this, Environment);

            this._macros = null;
            this._transaction = null;
            this.constants = new _glimmerRuntimeLibOpcodes.Constants();
            this.program = new Program();
            this.appendOperations = appendOperations;
            this.updateOperations = updateOperations;
        }

        Environment.prototype.toConditionalReference = function toConditionalReference(reference) {
            return new _glimmerRuntimeLibReferences.ConditionalReference(reference);
        };

        Environment.prototype.getAppendOperations = function getAppendOperations() {
            return this.appendOperations;
        };

        Environment.prototype.getDOM = function getDOM() {
            return this.updateOperations;
        };

        Environment.prototype.getIdentity = function getIdentity(object) {
            return _glimmerUtil.ensureGuid(object) + '';
        };

        Environment.prototype.begin = function begin() {
            _glimmerUtil.assert(!this._transaction, 'Cannot start a nested transaction');
            this._transaction = new Transaction();
        };

        Environment.prototype.didCreate = function didCreate(component, manager) {
            this.transaction.didCreate(component, manager);
        };

        Environment.prototype.didUpdate = function didUpdate(component, manager) {
            this.transaction.didUpdate(component, manager);
        };

        Environment.prototype.scheduleInstallModifier = function scheduleInstallModifier(modifier, manager) {
            this.transaction.scheduleInstallModifier(modifier, manager);
        };

        Environment.prototype.scheduleUpdateModifier = function scheduleUpdateModifier(modifier, manager) {
            this.transaction.scheduleUpdateModifier(modifier, manager);
        };

        Environment.prototype.didDestroy = function didDestroy(d) {
            this.transaction.didDestroy(d);
        };

        Environment.prototype.commit = function commit() {
            this.transaction.commit();
            this._transaction = null;
        };

        Environment.prototype.attributeFor = function attributeFor(element, attr, isTrusting, namespace) {
            return _glimmerRuntimeLibDomAttributeManagers.defaultManagers(element, attr, isTrusting, namespace === undefined ? null : namespace);
        };

        Environment.prototype.macros = function macros() {
            var macros = this._macros;
            if (!macros) {
                this._macros = macros = _glimmerRuntimeLibSyntaxFunctions.populateBuiltins();
            }
            return macros;
        };

        _createClass(Environment, [{
            key: 'transaction',
            get: function () {
                return _glimmerUtil.expect(this._transaction, 'must be in a transaction');
            }
        }]);

        return Environment;
    })();

    exports.Environment = Environment;
    exports.default = Environment;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkBnbGltbWVyL3J1bnRpbWUvbGliL2Vudmlyb25tZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7UUEwRE0sS0FBQTtBQWVKLGlCQWZJLEtBQUEsQ0FlUSxVQUF1QixFQUFtQztnQkFBakMsV0FBQSx5REFBNkIsSUFBSTs7a0NBZmxFLEtBQUE7O0FBYUksZ0JBQUEsQ0FBQSxXQUFXLEdBQWtCLElBQUksQ0FBQztBQUd4QyxnQkFBSSxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUM7QUFDeEIsZ0JBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1NBQ2hDOztBQWxCRyxhQUFBLENBQ0csSUFBSSxHQUFBLGNBQUMsSUFBMkIsRUFBVTtnQkFBUixJQUFJLHlEQUFHLENBQUM7O0FBQy9DLGdCQUFJLElBQUksR0FBNEIsSUFBSSxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBRXhELGlCQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQzlCLG9CQUFJLENBQUMsQ0FBQyxDQUFDLGdDQXJESixtQkFBbUIsQUFxRE8sQ0FBQzthQUMvQjtBQUVELG1CQUFPLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBSixJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZDOztBQVRHLGFBQUEsV0FvQkosSUFBSSxHQUFBLGNBQUMsSUFBeUMsRUFBQTtnQkFBdkMsSUFBSSxHQUFOLElBQXlDLENBQXZDLElBQUk7O0FBQ1QsZ0JBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO0FBQ3JCLG1CQUFPLElBQUksQ0FBQztTQUNiOztBQXZCRyxhQUFBLFdBeUJKLE9BQU8sR0FBQSxtQkFBQTtBQUNMLG1CQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUEwQixDQUFDO1NBQy9DOztBQTNCRyxhQUFBLFdB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SixNQUFNLEdBQUEsa0JBQUE7QUFDSixnQkFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztBQUMxQixnQkFBSSxDQUFDLE1BQU0sRUFBRTtBQUNYLG9CQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sR0FBRyxrQ0F6VUosZ0JBQWdCLEVBeVVNLENBQUM7YUFDNUM7QUFFRCxtQkFBTyxNQUFNLENBQUM7U0FDZjs7cUJBeEVHLFdBQUE7O2lCQWdDbUIsWUFBQTtBQUNyQix1QkFBTyxhQXJRVCxNQUFNLENBcVFVLElBQUksQ0FBQyxZQUFZLEVBQUUsMEJBQTBCLENBQUMsQ0FBQzthQUM5RDs7O2VBbENHLFdBQUE7Ozs7c0JBdUZTLFdBQVciLCJmaWxlIjoiZW52aXJvbm1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTeW1ib2xUYWJsZSB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgQSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5pbXBvcnQgeyBCbG9ja3MsIElubGluZXMsIHBvcHVsYXRlQnVpbHRpbnMgfSBmcm9tICcuL3N5bnRheC9mdW5jdGlvbnMnO1xuXG5pbXBvcnQgeyBDb25zdGFudHMsIEFwcGVuZE9wY29kZSB9IGZyb20gJy4vb3Bjb2Rlcyc7XG5cbmltcG9ydCAqIGFzIFNpbXBsZSBmcm9tICcuL2RvbS9pbnRlcmZhY2VzJztcbmltcG9ydCB7IERPTUNoYW5nZXMsIERPTVRyZWVDb25zdHJ1Y3Rpb24gfSBmcm9tICcuL2RvbS9oZWxwZXInO1xuaW1wb3J0IHsgUmVmZXJlbmNlLCBQYXRoUmVmZXJlbmNlLCBPcGFxdWVJdGVyYWJsZSB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQgeyBVTkRFRklORURfUkVGRVJFTkNFLCBDb25kaXRpb25hbFJlZmVyZW5jZSB9IGZyb20gJy4vcmVmZXJlbmNlcyc7XG5pbXBvcnQge1xuICBkZWZhdWx0TWFuYWdlcnMsXG4gIEF0dHJpYnV0ZU1hbmFnZXJcbn0gZnJvbSAnLi9kb20vYXR0cmlidXRlLW1hbmFnZXJzJztcblxuaW1wb3J0IHtcbiAgUGFydGlhbERlZmluaXRpb25cbn0gZnJvbSAnLi9wYXJ0aWFsJztcblxuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBDb21wb25lbnRNYW5hZ2VyLFxuICBDb21wb25lbnREZWZpbml0aW9uXG59IGZyb20gJy4vY29tcG9uZW50L2ludGVyZmFjZXMnO1xuXG5pbXBvcnQge1xuICBNb2RpZmllck1hbmFnZXJcbn0gZnJvbSAnLi9tb2RpZmllci9pbnRlcmZhY2VzJztcblxuaW1wb3J0IHtcbiAgT3B0aW9uLFxuICBEZXN0cm95YWJsZSxcbiAgT3BhcXVlLFxuICBIYXNHdWlkLFxuICBlbnN1cmVHdWlkLFxuICBleHBlY3QsXG4gIGFzc2VydFxufSBmcm9tICdAZ2xpbW1lci91dGlsJztcblxuaW1wb3J0IHtcbiAgVGVtcGxhdGVNZXRhXG59IGZyb20gJ0BnbGltbWVyL3dpcmUtZm9ybWF0JztcblxuaW1wb3J0IHsgRXZhbHVhdGVkQXJncyB9IGZyb20gJy4vY29tcGlsZWQvZXhwcmVzc2lvbnMvYXJncyc7XG5cbmltcG9ydCB7IElubGluZUJsb2NrIH0gZnJvbSAnLi9zY2FubmVyJztcblxuaW1wb3J0IHsgUHVibGljVk0gfSBmcm9tICcuL3ZtL2FwcGVuZCc7XG5cbmV4cG9ydCB0eXBlIFNjb3BlU2xvdCA9IFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB8IElubGluZUJsb2NrIHwgRXZhbHVhdGVkQXJncztcblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbWljU2NvcGUge1xuICBnZXQoa2V5OiBzdHJpbmcpOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT47XG4gIHNldChrZXk6IHN0cmluZywgcmVmZXJlbmNlOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT4pOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT47XG4gIGNoaWxkKCk6IER5bmFtaWNTY29wZTtcbn1cblxuZXhwb3J0IGNsYXNzIFNjb3BlIHtcbiAgc3RhdGljIHJvb3Qoc2VsZjogUGF0aFJlZmVyZW5jZTxPcGFxdWU+LCBzaXplID0gMCkge1xuICAgIGxldCByZWZzOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT5bXSA9IG5ldyBBcnJheShzaXplICsgMSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBzaXplOyBpKyspIHtcbiAgICAgIHJlZnNbaV0gPSBVTkRFRklORURfUkVGRVJFTkNFO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgU2NvcGUocmVmcykuaW5pdCh7IHNlbGYgfSk7XG4gIH1cblxuICAvLyB0aGUgMHRoIHNsb3QgaXMgYHNlbGZgXG4gIHByaXZhdGUgc2xvdHM6IFNjb3BlU2xvdFtdO1xuICBwcml2YXRlIGNhbGxlclNjb3BlOiBPcHRpb248U2NvcGU+ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihyZWZlcmVuY2VzOiBTY29wZVNsb3RbXSwgY2FsbGVyU2NvcGU6IE9wdGlvbjxTY29wZT4gPSBudWxsKSB7XG4gICAgdGhpcy5zbG90cyA9IHJlZmVyZW5jZXM7XG4gICAgdGhpcy5jYWxsZXJTY29wZSA9IGNhbGxlclNjb3BlO1xuICB9XG5cbiAgaW5pdCh7IHNlbGYgfTogeyBzZWxmOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT4gfSk6IHRoaXMge1xuICAgIHRoaXMuc2xvdHNbMF0gPSBzZWxmO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZ2V0U2VsZigpOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT4ge1xuICAgIHJldHVybiB0aGlzLnNsb3RzWzBdIGFzIFBhdGhSZWZlcmVuY2U8T3BhcXVlPjtcbiAgfVxuXG4gIGdldFN5bWJvbChzeW1ib2w6IG51bWJlcik6IFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gICAgcmV0dXJuIHRoaXMuc2xvdHNbc3ltYm9sXSBhcyBQYXRoUmVmZXJlbmNlPE9wYXF1ZT47XG4gIH1cblxuICBnZXRCbG9jayhzeW1ib2w6IG51bWJlcik6IElubGluZUJsb2NrIHtcbiAgICByZXR1cm4gdGhpcy5zbG90c1tzeW1ib2xdIGFzIElubGluZUJsb2NrO1xuICB9XG5cbiAgZ2V0UGFydGlhbEFyZ3Moc3ltYm9sOiBudW1iZXIpOiBFdmFsdWF0ZWRBcmdzIHtcbiAgICByZXR1cm4gdGhpcy5zbG90c1tzeW1ib2xdIGFzIEV2YWx1YXRlZEFyZ3M7XG4gIH1cblxuICBiaW5kU3ltYm9sKHN5bWJvbDogbnVtYmVyLCB2YWx1ZTogUGF0aFJlZmVyZW5jZTxPcGFxdWU+KSB7XG4gICAgdGhpcy5zbG90c1tzeW1ib2xdID0gdmFsdWU7XG4gIH1cblxuICBiaW5kQmxvY2soc3ltYm9sOiBudW1iZXIsIHZhbHVlOiBJbmxpbmVCbG9jaykge1xuICAgIHRoaXMuc2xvdHNbc3ltYm9sXSA9IHZhbHVlO1xuICB9XG5cbiAgYmluZFBhcnRpYWxBcmdzKHN5bWJvbDogbnVtYmVyLCB2YWx1ZTogRXZhbHVhdGVkQXJncykge1xuICAgIHRoaXMuc2xvdHNbc3ltYm9sXSA9IHZhbHVlO1xuICB9XG5cbiAgYmluZENhbGxlclNjb3BlKHNjb3BlOiBTY29wZSkge1xuICAgIHRoaXMuY2FsbGVyU2NvcGUgPSBzY29wZTtcbiAgfVxuXG4gIGdldENhbGxlclNjb3BlKCk6IE9wdGlvbjxTY29wZT4ge1xuICAgIHJldHVybiB0aGlzLmNhbGxlclNjb3BlO1xuICB9XG5cbiAgY2hpbGQoKTogU2NvcGUge1xuICAgIHJldHVybiBuZXcgU2NvcGUodGhpcy5zbG90cy5zbGljZSgpLCB0aGlzLmNhbGxlclNjb3BlKTtcbiAgfVxufVxuXG5jbGFzcyBUcmFuc2FjdGlvbiB7XG4gIHB1YmxpYyBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnM6IE1vZGlmaWVyTWFuYWdlcjxPcGFxdWU+W10gPSBbXTtcbiAgcHVibGljIHNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnM6IE9iamVjdFtdID0gW107XG4gIHB1YmxpYyBzY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzOiBNb2RpZmllck1hbmFnZXI8T3BhcXVlPltdID0gW107XG4gIHB1YmxpYyBzY2hlZHVsZWRVcGRhdGVNb2RpZmllcnM6IE9iamVjdFtdID0gW107XG4gIHB1YmxpYyBjcmVhdGVkQ29tcG9uZW50czogQ29tcG9uZW50W10gPSBbXTtcbiAgcHVibGljIGNyZWF0ZWRNYW5hZ2VyczogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnQ+W10gPSBbXTtcbiAgcHVibGljIHVwZGF0ZWRDb21wb25lbnRzOiBDb21wb25lbnRbXSA9IFtdO1xuICBwdWJsaWMgdXBkYXRlZE1hbmFnZXJzOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudD5bXSA9IFtdO1xuICBwdWJsaWMgZGVzdHJ1Y3RvcnM6IERlc3Ryb3lhYmxlW10gPSBbXTtcblxuICBkaWRDcmVhdGU8VD4oY29tcG9uZW50OiBULCBtYW5hZ2VyOiBDb21wb25lbnRNYW5hZ2VyPFQ+KSB7XG4gICAgdGhpcy5jcmVhdGVkQ29tcG9uZW50cy5wdXNoKGNvbXBvbmVudCk7XG4gICAgdGhpcy5jcmVhdGVkTWFuYWdlcnMucHVzaChtYW5hZ2VyKTtcbiAgfVxuXG4gIGRpZFVwZGF0ZTxUPihjb21wb25lbnQ6IFQsIG1hbmFnZXI6IENvbXBvbmVudE1hbmFnZXI8VD4pIHtcbiAgICB0aGlzLnVwZGF0ZWRDb21wb25lbnRzLnB1c2goY29tcG9uZW50KTtcbiAgICB0aGlzLnVwZGF0ZWRNYW5hZ2Vycy5wdXNoKG1hbmFnZXIpO1xuICB9XG5cbiAgc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXI8VD4obW9kaWZpZXI6IFQsIG1hbmFnZXI6IE1vZGlmaWVyTWFuYWdlcjxUPikge1xuICAgIHRoaXMuc2NoZWR1bGVkSW5zdGFsbE1hbmFnZXJzLnB1c2gobWFuYWdlcik7XG4gICAgdGhpcy5zY2hlZHVsZWRJbnN0YWxsTW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpO1xuICB9XG5cbiAgc2NoZWR1bGVVcGRhdGVNb2RpZmllcjxUPihtb2RpZmllcjogVCwgbWFuYWdlcjogTW9kaWZpZXJNYW5hZ2VyPFQ+KSB7XG4gICAgdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzLnB1c2gobWFuYWdlcik7XG4gICAgdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllcnMucHVzaChtb2RpZmllcik7XG4gIH1cblxuICBkaWREZXN0cm95KGQ6IERlc3Ryb3lhYmxlKSB7XG4gICAgdGhpcy5kZXN0cnVjdG9ycy5wdXNoKGQpO1xuICB9XG5cbiAgY29tbWl0KCkge1xuICAgIGxldCB7IGNyZWF0ZWRDb21wb25lbnRzLCBjcmVhdGVkTWFuYWdlcnMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpPTA7IGk8Y3JlYXRlZENvbXBvbmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBjb21wb25lbnQgPSBjcmVhdGVkQ29tcG9uZW50c1tpXTtcbiAgICAgIGxldCBtYW5hZ2VyID0gY3JlYXRlZE1hbmFnZXJzW2ldO1xuICAgICAgbWFuYWdlci5kaWRDcmVhdGUoY29tcG9uZW50KTtcbiAgICB9XG5cbiAgICBsZXQgeyB1cGRhdGVkQ29tcG9uZW50cywgdXBkYXRlZE1hbmFnZXJzIH0gPSB0aGlzO1xuXG4gICAgZm9yIChsZXQgaT0wOyBpPHVwZGF0ZWRDb21wb25lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgY29tcG9uZW50ID0gdXBkYXRlZENvbXBvbmVudHNbaV07XG4gICAgICBsZXQgbWFuYWdlciA9IHVwZGF0ZWRNYW5hZ2Vyc1tpXTtcbiAgICAgIG1hbmFnZXIuZGlkVXBkYXRlKGNvbXBvbmVudCk7XG4gICAgfVxuXG4gICAgbGV0IHsgZGVzdHJ1Y3RvcnMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpPTA7IGk8ZGVzdHJ1Y3RvcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGRlc3RydWN0b3JzW2ldLmRlc3Ryb3koKTtcbiAgICB9XG5cbiAgICBsZXQgeyBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnMsIHNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVkdWxlZEluc3RhbGxNYW5hZ2Vycy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IG1hbmFnZXIgPSBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnNbaV07XG4gICAgICBsZXQgbW9kaWZpZXIgPSBzY2hlZHVsZWRJbnN0YWxsTW9kaWZpZXJzW2ldO1xuICAgICAgbWFuYWdlci5pbnN0YWxsKG1vZGlmaWVyKTtcbiAgICB9XG5cbiAgICBsZXQgeyBzY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzLCBzY2hlZHVsZWRVcGRhdGVNb2RpZmllcnMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVyTWFuYWdlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBtYW5hZ2VyID0gc2NoZWR1bGVkVXBkYXRlTW9kaWZpZXJNYW5hZ2Vyc1tpXTtcbiAgICAgIGxldCBtb2RpZmllciA9IHNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVyc1tpXTtcbiAgICAgIG1hbmFnZXIudXBkYXRlKG1vZGlmaWVyKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE9wY29kZSB7XG4gIHB1YmxpYyBvZmZzZXQgPSAwO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFycmF5OiBVaW50MzJBcnJheSB8IEFycmF5PG51bWJlcj4pIHt9XG5cbiAgZ2V0IHR5cGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXJyYXlbdGhpcy5vZmZzZXRdO1xuICB9XG5cbiAgZ2V0IG9wMSgpIHtcbiAgICByZXR1cm4gdGhpcy5hcnJheVt0aGlzLm9mZnNldCArIDFdO1xuICB9XG5cbiAgZ2V0IG9wMigpIHtcbiAgICByZXR1cm4gdGhpcy5hcnJheVt0aGlzLm9mZnNldCArIDJdO1xuICB9XG5cbiAgZ2V0IG9wMygpIHtcbiAgICByZXR1cm4gdGhpcy5hcnJheVt0aGlzLm9mZnNldCArIDNdO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQcm9ncmFtIHtcbiAgW2tleTogbnVtYmVyXTogbmV2ZXI7XG5cbiAgcHJpdmF0ZSBvcGNvZGVzID0gbmV3IEEoMHgxMDAwMDApO1xuICBwcml2YXRlIF9vZmZzZXQgPSAwO1xuICBwcml2YXRlIF9vcGNvZGU6IE9wY29kZTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9vcGNvZGUgPSBuZXcgT3Bjb2RlKHRoaXMub3Bjb2Rlcyk7XG4gIH1cblxuICBnZXQgbmV4dCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9vZmZzZXQ7XG4gIH1cblxuICBnZXQgY3VycmVudCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9vZmZzZXQgLSA0O1xuICB9XG5cbiAgb3Bjb2RlKG9mZnNldDogbnVtYmVyKTogT3Bjb2RlIHtcbiAgICB0aGlzLl9vcGNvZGUub2Zmc2V0ID0gb2Zmc2V0O1xuICAgIHJldHVybiB0aGlzLl9vcGNvZGU7XG4gIH1cblxuICBzZXQocG9zOiBudW1iZXIsIG9wY29kZTogQXBwZW5kT3Bjb2RlKSB7XG4gICAgbGV0IFt0eXBlLCBvcDEsIG9wMiwgb3AzXSA9IG9wY29kZTtcbiAgICB0aGlzLm9wY29kZXNbcG9zXSA9IHR5cGU7XG4gICAgdGhpcy5vcGNvZGVzW3BvcyArIDFdID0gb3AxO1xuICAgIHRoaXMub3Bjb2Rlc1twb3MgKyAyXSA9IG9wMjtcbiAgICB0aGlzLm9wY29kZXNbcG9zICsgM10gPSBvcDM7XG4gIH1cblxuICBwdXNoKG9wY29kZTogQXBwZW5kT3Bjb2RlKTogbnVtYmVyIHtcbiAgICBsZXQgb2Zmc2V0ID0gdGhpcy5fb2Zmc2V0O1xuICAgIGxldCBbdHlwZSwgb3AxLCBvcDIsIG9wM10gPSBvcGNvZGU7XG4gICAgdGhpcy5vcGNvZGVzW3RoaXMuX29mZnNldCsrXSA9IHR5cGU7XG4gICAgdGhpcy5vcGNvZGVzW3RoaXMuX29mZnNldCsrXSA9IG9wMTtcbiAgICB0aGlzLm9wY29kZXNbdGhpcy5fb2Zmc2V0KytdID0gb3AyO1xuICAgIHRoaXMub3Bjb2Rlc1t0aGlzLl9vZmZzZXQrK10gPSBvcDM7XG4gICAgcmV0dXJuIG9mZnNldDtcbiAgfVxufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRW52aXJvbm1lbnQge1xuICBwcm90ZWN0ZWQgdXBkYXRlT3BlcmF0aW9uczogRE9NQ2hhbmdlcztcbiAgcHJvdGVjdGVkIGFwcGVuZE9wZXJhdGlvbnM6IERPTVRyZWVDb25zdHJ1Y3Rpb247XG4gIHByaXZhdGUgX21hY3JvczogT3B0aW9uPHsgYmxvY2tzOiBCbG9ja3MsIGlubGluZXM6IElubGluZXMgfT4gPSBudWxsO1xuICBwcml2YXRlIF90cmFuc2FjdGlvbjogT3B0aW9uPFRyYW5zYWN0aW9uPiA9IG51bGw7XG4gIHB1YmxpYyBjb25zdGFudHM6IENvbnN0YW50cyA9IG5ldyBDb25zdGFudHMoKTtcbiAgcHVibGljIHByb2dyYW0gPSBuZXcgUHJvZ3JhbSgpO1xuXG4gIGNvbnN0cnVjdG9yKHsgYXBwZW5kT3BlcmF0aW9ucywgdXBkYXRlT3BlcmF0aW9ucyB9OiB7IGFwcGVuZE9wZXJhdGlvbnM6IERPTVRyZWVDb25zdHJ1Y3Rpb24sIHVwZGF0ZU9wZXJhdGlvbnM6IERPTUNoYW5nZXMgfSkge1xuICAgIHRoaXMuYXBwZW5kT3BlcmF0aW9ucyA9IGFwcGVuZE9wZXJhdGlvbnM7XG4gICAgdGhpcy51cGRhdGVPcGVyYXRpb25zID0gdXBkYXRlT3BlcmF0aW9ucztcbiAgfVxuXG4gIHRvQ29uZGl0aW9uYWxSZWZlcmVuY2UocmVmZXJlbmNlOiBSZWZlcmVuY2U8T3BhcXVlPik6IFJlZmVyZW5jZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG5ldyBDb25kaXRpb25hbFJlZmVyZW5jZShyZWZlcmVuY2UpO1xuICB9XG5cbiAgYWJzdHJhY3QgaXRlcmFibGVGb3IocmVmZXJlbmNlOiBSZWZlcmVuY2U8T3BhcXVlPiwgYXJnczogRXZhbHVhdGVkQXJncyk6IE9wYXF1ZUl0ZXJhYmxlO1xuICBhYnN0cmFjdCBwcm90b2NvbEZvclVSTChzOiBzdHJpbmcpOiBzdHJpbmc7XG5cbiAgZ2V0QXBwZW5kT3BlcmF0aW9ucygpOiBET01UcmVlQ29uc3RydWN0aW9uIHsgcmV0dXJuIHRoaXMuYXBwZW5kT3BlcmF0aW9uczsgfVxuICBnZXRET00oKTogRE9NQ2hhbmdlcyB7IHJldHVybiB0aGlzLnVwZGF0ZU9wZXJhdGlvbnM7IH1cblxuICBnZXRJZGVudGl0eShvYmplY3Q6IEhhc0d1aWQpOiBzdHJpbmcge1xuICAgIHJldHVybiBlbnN1cmVHdWlkKG9iamVjdCkgKyAnJztcbiAgfVxuXG4gIGJlZ2luKCkge1xuICAgIGFzc2VydCghdGhpcy5fdHJhbnNhY3Rpb24sICdDYW5ub3Qgc3RhcnQgYSBuZXN0ZWQgdHJhbnNhY3Rpb24nKTtcbiAgICB0aGlzLl90cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgdHJhbnNhY3Rpb24oKTogVHJhbnNhY3Rpb24ge1xuICAgIHJldHVybiBleHBlY3QodGhpcy5fdHJhbnNhY3Rpb24sICdtdXN0IGJlIGluIGEgdHJhbnNhY3Rpb24nKTtcbiAgfVxuXG4gIGRpZENyZWF0ZTxUPihjb21wb25lbnQ6IFQsIG1hbmFnZXI6IENvbXBvbmVudE1hbmFnZXI8VD4pIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uLmRpZENyZWF0ZShjb21wb25lbnQsIG1hbmFnZXIpO1xuICB9XG5cbiAgZGlkVXBkYXRlPFQ+KGNvbXBvbmVudDogVCwgbWFuYWdlcjogQ29tcG9uZW50TWFuYWdlcjxUPikge1xuICAgIHRoaXMudHJhbnNhY3Rpb24uZGlkVXBkYXRlKGNvbXBvbmVudCwgbWFuYWdlcik7XG4gIH1cblxuICBzY2hlZHVsZUluc3RhbGxNb2RpZmllcjxUPihtb2RpZmllcjogVCwgbWFuYWdlcjogTW9kaWZpZXJNYW5hZ2VyPFQ+KSB7XG4gICAgdGhpcy50cmFuc2FjdGlvbi5zY2hlZHVsZUluc3RhbGxNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7XG4gIH1cblxuICBzY2hlZHVsZVVwZGF0ZU1vZGlmaWVyPFQ+KG1vZGlmaWVyOiBULCBtYW5hZ2VyOiBNb2RpZmllck1hbmFnZXI8VD4pIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uLnNjaGVkdWxlVXBkYXRlTW9kaWZpZXIobW9kaWZpZXIsIG1hbmFnZXIpO1xuICB9XG5cbiAgZGlkRGVzdHJveShkOiBEZXN0cm95YWJsZSkge1xuICAgIHRoaXMudHJhbnNhY3Rpb24uZGlkRGVzdHJveShkKTtcbiAgfVxuXG4gIGNvbW1pdCgpIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uLmNvbW1pdCgpO1xuICAgIHRoaXMuX3RyYW5zYWN0aW9uID0gbnVsbDtcbiAgfVxuXG4gIGF0dHJpYnV0ZUZvcihlbGVtZW50OiBTaW1wbGUuRWxlbWVudCwgYXR0cjogc3RyaW5nLCBpc1RydXN0aW5nOiBib29sZWFuLCBuYW1lc3BhY2U/OiBzdHJpbmcpOiBBdHRyaWJ1dGVNYW5hZ2VyIHtcbiAgICByZXR1cm4gZGVmYXVsdE1hbmFnZXJzKGVsZW1lbnQsIGF0dHIsIGlzVHJ1c3RpbmcsIG5hbWVzcGFjZSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IG5hbWVzcGFjZSk7XG4gIH1cblxuICBtYWNyb3MoKTogeyBibG9ja3M6IEJsb2NrcywgaW5saW5lczogSW5saW5lcyB9IHtcbiAgICBsZXQgbWFjcm9zID0gdGhpcy5fbWFjcm9zO1xuICAgIGlmICghbWFjcm9zKSB7XG4gICAgICB0aGlzLl9tYWNyb3MgPSBtYWNyb3MgPSBwb3B1bGF0ZUJ1aWx0aW5zKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hY3JvcztcbiAgfVxuXG4gIGFic3RyYWN0IGhhc0hlbHBlcihoZWxwZXJOYW1lOiBPcHRpb248c3RyaW5nPltdLCBibG9ja01ldGE6IFRlbXBsYXRlTWV0YSk6IGJvb2xlYW47XG4gIGFic3RyYWN0IGxvb2t1cEhlbHBlcihoZWxwZXJOYW1lOiBPcHRpb248c3RyaW5nPltdLCBibG9ja01ldGE6IFRlbXBsYXRlTWV0YSk6IEhlbHBlcjtcblxuICBhYnN0cmFjdCBoYXNNb2RpZmllcihtb2RpZmllck5hbWU6IHN0cmluZ1tdLCBibG9ja01ldGE6IFRlbXBsYXRlTWV0YSk6IGJvb2xlYW47XG4gIGFic3RyYWN0IGxvb2t1cE1vZGlmaWVyKG1vZGlmaWVyTmFtZTogc3RyaW5nW10sIGJsb2NrTWV0YTogVGVtcGxhdGVNZXRhKTogTW9kaWZpZXJNYW5hZ2VyPE9wYXF1ZT47XG5cbiAgYWJzdHJhY3QgaGFzQ29tcG9uZW50RGVmaW5pdGlvbih0YWdOYW1lOiBzdHJpbmdbXSwgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKTogYm9vbGVhbjtcbiAgYWJzdHJhY3QgZ2V0Q29tcG9uZW50RGVmaW5pdGlvbih0YWdOYW1lOiBzdHJpbmdbXSwgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKTogQ29tcG9uZW50RGVmaW5pdGlvbjxPcGFxdWU+O1xuXG4gIGFic3RyYWN0IGhhc1BhcnRpYWwocGFydGlhbE5hbWU6IHN0cmluZywgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKTogYm9vbGVhbjtcbiAgYWJzdHJhY3QgbG9va3VwUGFydGlhbChQYXJ0aWFsTmFtZTogc3RyaW5nLCBzeW1ib2xUYWJsZTogU3ltYm9sVGFibGUpOiBQYXJ0aWFsRGVmaW5pdGlvbjxUZW1wbGF0ZU1ldGE+O1xufVxuXG5leHBvcnQgZGVmYXVsdCBFbnZpcm9ubWVudDtcblxuZXhwb3J0IGludGVyZmFjZSBIZWxwZXIge1xuICAodm06IFB1YmxpY1ZNLCBhcmdzOiBFdmFsdWF0ZWRBcmdzLCBzeW1ib2xUYWJsZTogU3ltYm9sVGFibGUpOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT47XG59XG4iXX0=