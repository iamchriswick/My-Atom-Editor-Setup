enifed('@glimmer/syntax/lib/traversal/traverse', ['exports', '@glimmer/syntax/lib/types/visitor-keys', '@glimmer/syntax/lib/traversal/errors'], function (exports, _glimmerSyntaxLibTypesVisitorKeys, _glimmerSyntaxLibTraversalErrors) {
    'use strict';

    exports.default = traverse;
    exports.normalizeVisitor = normalizeVisitor;

    function visitNode(visitor, node) {
        var handler = visitor[node.type] || visitor.All;
        var result = undefined;
        if (handler && handler.enter) {
            result = handler.enter.call(null, node);
        }
        if (result !== undefined && result !== null) {
            if (JSON.stringify(node) === JSON.stringify(result)) {
                result = undefined;
            } else if (Array.isArray(result)) {
                return visitArray(visitor, result) || result;
            } else {
                return visitNode(visitor, result) || result;
            }
        }
        if (result === undefined) {
            var keys = _glimmerSyntaxLibTypesVisitorKeys.default[node.type];
            for (var i = 0; i < keys.length; i++) {
                visitKey(visitor, handler, node, keys[i]);
            }
            if (handler && handler.exit) {
                result = handler.exit.call(null, node);
            }
        }
        return result;
    }
    function visitKey(visitor, handler, node, key) {
        var value = node[key];
        if (!value) {
            return;
        }
        var keyHandler = handler && (handler.keys[key] || handler.keys.All);
        var result = undefined;
        if (keyHandler && keyHandler.enter) {
            result = keyHandler.enter.call(null, node, key);
            if (result !== undefined) {
                throw _glimmerSyntaxLibTraversalErrors.cannotReplaceOrRemoveInKeyHandlerYet(node, key);
            }
        }
        if (Array.isArray(value)) {
            visitArray(visitor, value);
        } else {
            var _result = visitNode(visitor, value);
            if (_result !== undefined) {
                assignKey(node, key, _result);
            }
        }
        if (keyHandler && keyHandler.exit) {
            result = keyHandler.exit.call(null, node, key);
            if (result !== undefined) {
                throw _glimmerSyntaxLibTraversalErrors.cannotReplaceOrRemoveInKeyHandlerYet(node, key);
            }
        }
    }
    function visitArray(visitor, array) {
        for (var i = 0; i < array.length; i++) {
            var result = visitNode(visitor, array[i]);
            if (result !== undefined) {
                i += spliceArray(array, i, result) - 1;
            }
        }
    }
    function assignKey(node, key, result) {
        if (result === null) {
            throw _glimmerSyntaxLibTraversalErrors.cannotRemoveNode(node[key], node, key);
        } else if (Array.isArray(result)) {
            if (result.length === 1) {
                node[key] = result[0];
            } else {
                if (result.length === 0) {
                    throw _glimmerSyntaxLibTraversalErrors.cannotRemoveNode(node[key], node, key);
                } else {
                    throw _glimmerSyntaxLibTraversalErrors.cannotReplaceNode(node[key], node, key);
                }
            }
        } else {
            node[key] = result;
        }
    }
    function spliceArray(array, index, result) {
        if (result === null) {
            array.splice(index, 1);
            return 0;
        } else if (Array.isArray(result)) {
            array.splice.apply(array, [index, 1].concat(result));
            return result.length;
        } else {
            array.splice(index, 1, result);
            return 1;
        }
    }

    function traverse(node, visitor) {
        visitNode(normalizeVisitor(visitor), node);
    }

    function normalizeVisitor(visitor) {
        var normalizedVisitor = {};
        for (var type in visitor) {
            var handler = visitor[type] || visitor.All;
            var normalizedKeys = {};
            if (typeof handler === 'object') {
                var keys = handler.keys;
                if (keys) {
                    for (var key in keys) {
                        var keyHandler = keys[key];
                        if (typeof keyHandler === 'object') {
                            normalizedKeys[key] = {
                                enter: typeof keyHandler.enter === 'function' ? keyHandler.enter : null,
                                exit: typeof keyHandler.exit === 'function' ? keyHandler.exit : null
                            };
                        } else if (typeof keyHandler === 'function') {
                            normalizedKeys[key] = {
                                enter: keyHandler,
                                exit: null
                            };
                        }
                    }
                }
                normalizedVisitor[type] = {
                    enter: typeof handler.enter === 'function' ? handler.enter : null,
                    exit: typeof handler.exit === 'function' ? handler.exit : null,
                    keys: normalizedKeys
                };
            } else if (typeof handler === 'function') {
                normalizedVisitor[type] = {
                    enter: handler,
                    exit: null,
                    keys: normalizedKeys
                };
            }
        }
        return normalizedVisitor;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkBnbGltbWVyL3N5bnRheC9saWIvdHJhdmVyc2FsL3RyYXZlcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztzQkErR2MsUUFBQTs7O0FBeEdkLGFBQUEsU0FBQSxDQUFtQixPQUFPLEVBQUUsSUFBSSxFQUFBO0FBQzlCLFlBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQztBQUNoRCxZQUFJLE1BQU0sWUFBQSxDQUFDO0FBRVgsWUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtBQUM1QixrQkFBTSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN6QztBQUVELFlBQUksTUFBTSxLQUFLLFNBQVMsSUFBSSxNQUFNLEtBQUssSUFBSSxFQUFFO0FBQzNDLGdCQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtBQUNuRCxzQkFBTSxHQUFHLFNBQVMsQ0FBQzthQUNwQixNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtBQUNoQyx1QkFBTyxVQUFVLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQzthQUM5QyxNQUFNO0FBQ0wsdUJBQU8sU0FBUyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUM7YUFDN0M7U0FDRjtBQUVELFlBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtBQUN4QixnQkFBSSxJQUFJLEdBQUcsMENBQVksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRWxDLGlCQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUNwQyx3QkFBUSxDQUFDLE9B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QUFDLElBQUksR0FBRyxJQUFJO0FBQ2hFLHdCQUFJLEVBQUUsY0FBYztpQkFDckIsQ0FBQzthQUNILE1BQU0sSUFBSSxPQUFPLE9BQU8sS0FBSyxVQUFVLEVBQUU7QUFDeEMsaUNBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUc7QUFDeEIseUJBQUssRUFBRSxPQUFPO0FBQ2Qsd0JBQUksRUFBRSxJQUFJO0FBQ1Ysd0JBQUksRUFBRSxjQUFjO2lCQUNyQixDQUFDO2FBQ0g7U0FDRjtBQUVELGVBQU8saUJBQWlCLENBQUM7S0FDMUIiLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdmlzaXRvcktleXMgZnJvbSAnLi4vdHlwZXMvdmlzaXRvci1rZXlzJztcbmltcG9ydCB7XG4gIGNhbm5vdFJlbW92ZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VOb2RlLFxuICBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXRcbn0gZnJvbSAnLi9lcnJvcnMnO1xuXG5mdW5jdGlvbiB2aXNpdE5vZGUodmlzaXRvciwgbm9kZSkge1xuICBsZXQgaGFuZGxlciA9IHZpc2l0b3Jbbm9kZS50eXBlXSB8fCB2aXNpdG9yLkFsbDtcbiAgbGV0IHJlc3VsdDtcblxuICBpZiAoaGFuZGxlciAmJiBoYW5kbGVyLmVudGVyKSB7XG4gICAgcmVzdWx0ID0gaGFuZGxlci5lbnRlci5jYWxsKG51bGwsIG5vZGUpO1xuICB9XG5cbiAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdCAhPT0gbnVsbCkge1xuICAgIGlmIChKU09OLnN0cmluZ2lmeShub2RlKSA9PT0gSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkge1xuICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICByZXR1cm4gdmlzaXRBcnJheSh2aXNpdG9yLCByZXN1bHQpIHx8IHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHZpc2l0Tm9kZSh2aXNpdG9yLCByZXN1bHQpIHx8IHJlc3VsdDtcbiAgICB9XG4gIH1cblxuICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICBsZXQga2V5cyA9IHZpc2l0b3JLZXlzW25vZGUudHlwZV07XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIsIG5vZGUsIGtleXNbaV0pO1xuICAgIH1cblxuICAgIGlmIChoYW5kbGVyICYmIGhhbmRsZXIuZXhpdCkge1xuICAgICAgcmVzdWx0ID0gaGFuZGxlci5leGl0LmNhbGwobnVsbCwgbm9kZSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gdmlzaXRLZXkodmlzaXRvciwgaGFuZGxlciwgbm9kZSwga2V5KSB7XG4gIGxldCB2YWx1ZSA9IG5vZGVba2V5XTtcbiAgaWYgKCF2YWx1ZSkgeyByZXR1cm47IH1cblxuICBsZXQga2V5SGFuZGxlciA9IGhhbmRsZXIgJiYgKGhhbmRsZXIua2V5c1trZXldIHx8IGhhbmRsZXIua2V5cy5BbGwpO1xuICBsZXQgcmVzdWx0O1xuXG4gIGlmIChrZXlIYW5kbGVyICYmIGtleUhhbmRsZXIuZW50ZXIpIHtcbiAgICByZXN1bHQgPSBrZXlIYW5kbGVyLmVudGVyLmNhbGwobnVsbCwgbm9kZSwga2V5KTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIHZpc2l0QXJyYXkodmlzaXRvciwgdmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgdmFsdWUpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgYXNzaWduS2V5KG5vZGUsIGtleSwgcmVzdWx0KTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5SGFuZGxlciAmJiBrZXlIYW5kbGVyLmV4aXQpIHtcbiAgICByZXN1bHQgPSBrZXlIYW5kbGVyLmV4aXQuY2FsbChudWxsLCBub2RlLCBrZXkpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0KG5vZGUsIGtleSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHZpc2l0QXJyYXkodmlzaXRvciwgYXJyYXkpIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgYXJyYXlbaV0pO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaSArPSBzcGxpY2VBcnJheShhcnJheSwgaSwgcmVzdWx0KSAtIDE7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2lnbktleShub2RlLCBrZXksIHJlc3VsdCkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIG5vZGVba2V5XSA9IHJlc3VsdFswXTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIG5vZGVba2V5XSA9IHJlc3VsdDtcbiAgfVxufVxuXG5mdW5jdGlvbiBzcGxpY2VBcnJheShhcnJheSwgaW5kZXgsIHJlc3VsdCkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTtcbiAgICByZXR1cm4gMDtcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIC4uLnJlc3VsdCk7XG4gICAgcmV0dXJuIHJlc3VsdC5sZW5ndGg7XG4gIH0gZWxzZSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCByZXN1bHQpO1xuICAgIHJldHVybiAxO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRyYXZlcnNlKG5vZGUsIHZpc2l0b3IpIHtcbiAgdmlzaXROb2RlKG5vcm1hbGl6ZVZpc2l0b3IodmlzaXRvciksIG5vZGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplVmlzaXRvcih2aXNpdG9yKSB7XG4gIGxldCBub3JtYWxpemVkVmlzaXRvciA9IHt9O1xuXG4gIGZvciAobGV0IHR5cGUgaW4gdmlzaXRvcikge1xuICAgIGxldCBoYW5kbGVyID0gdmlzaXRvclt0eXBlXSB8fCB2aXNpdG9yLkFsbDtcbiAgICBsZXQgbm9ybWFsaXplZEtleXMgPSB7fTtcblxuICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGxldCBrZXlzID0gaGFuZGxlci5rZXlzO1xuICAgICAgaWYgKGtleXMpIHtcbiAgICAgICAgZm9yIChsZXQga2V5IGluIGtleXMpIHtcbiAgICAgICAgICBsZXQga2V5SGFuZGxlciA9IGtleXNba2V5XTtcbiAgICAgICAgICBpZiAodHlwZW9mIGtleUhhbmRsZXIgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICBub3JtYWxpemVkS2V5c1trZXldID0ge1xuICAgICAgICAgICAgICBlbnRlcjogKHR5cGVvZiBrZXlIYW5kbGVyLmVudGVyID09PSAnZnVuY3Rpb24nKSA/IGtleUhhbmRsZXIuZW50ZXIgOiBudWxsLFxuICAgICAgICAgICAgICBleGl0OiAodHlwZW9mIGtleUhhbmRsZXIuZXhpdCA9PT0gJ2Z1bmN0aW9uJykgPyBrZXlIYW5kbGVyLmV4aXQgOiBudWxsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGtleUhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXlzW2tleV0gPSB7XG4gICAgICAgICAgICAgIGVudGVyOiBrZXlIYW5kbGVyLFxuICAgICAgICAgICAgICBleGl0OiBudWxsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBub3JtYWxpemVkVmlzaXRvclt0eXBlXSA9IHtcbiAgICAgICAgZW50ZXI6ICh0eXBlb2YgaGFuZGxlci5lbnRlciA9PT0gJ2Z1bmN0aW9uJykgPyBoYW5kbGVyLmVudGVyIDogbnVsbCxcbiAgICAgICAgZXhpdDogKHR5cGVvZiBoYW5kbGVyLmV4aXQgPT09ICdmdW5jdGlvbicpID8gaGFuZGxlci5leGl0IDogbnVsbCxcbiAgICAgICAga2V5czogbm9ybWFsaXplZEtleXNcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgbm9ybWFsaXplZFZpc2l0b3JbdHlwZV0gPSB7XG4gICAgICAgIGVudGVyOiBoYW5kbGVyLFxuICAgICAgICBleGl0OiBudWxsLFxuICAgICAgICBrZXlzOiBub3JtYWxpemVkS2V5c1xuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbm9ybWFsaXplZFZpc2l0b3I7XG59XG4iXX0=