"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var object_reference_1 = require("@glimmer/object-reference");
var test_helpers_1 = require("@glimmer/test-helpers");
var ema_1 = require("./ema");
var Component = (function () {
    function Component(attrs) {
        this.element = null;
        this.attrs = attrs;
    }
    Component.create = function (_a) {
        var attrs = _a.attrs;
        return new this(attrs);
    };
    Component.prototype.set = function (key, value) {
        this[key] = value;
    };
    Component.prototype.didInitAttrs = function () { };
    Component.prototype.didUpdateAttrs = function () { };
    Component.prototype.didReceiveAttrs = function () { };
    Component.prototype.willInsertElement = function () { };
    Component.prototype.willUpdate = function () { };
    Component.prototype.willRender = function () { };
    Component.prototype.didInsertElement = function () { };
    Component.prototype.didUpdate = function () { };
    Component.prototype.didRender = function () { };
    return Component;
}());
var ServerUptime = (function (_super) {
    __extends(ServerUptime, _super);
    function ServerUptime() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ServerUptime.prototype, "upDays", {
        get: function () {
            return this.attrs.days.reduce(function (upDays, day) {
                return upDays += (day.up ? 1 : 0);
            }, 0);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ServerUptime.prototype, "streak", {
        get: function () {
            var max = this.attrs.days.reduce(function (_a, day) {
                var max = _a[0], streak = _a[1];
                if (day.up && streak + 1 > max) {
                    return [streak + 1, streak + 1];
                }
                else if (day.up) {
                    return [max, streak + 1];
                }
                else {
                    return [max, 0];
                }
            }, [0, 0])[0];
            return max;
        },
        enumerable: true,
        configurable: true
    });
    return ServerUptime;
}(Component));
var UptimeDay = (function (_super) {
    __extends(UptimeDay, _super);
    function UptimeDay() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(UptimeDay.prototype, "color", {
        get: function () {
            return this.attrs.day.up ? '#8cc665' : '#ccc';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(UptimeDay.prototype, "memo", {
        get: function () {
            return this.attrs.day.up ? 'Servers operational!' : 'Red alert!';
        },
        enumerable: true,
        configurable: true
    });
    return UptimeDay;
}(Component));
var env = new test_helpers_1.TestEnvironment();
env.registerEmberishGlimmerComponent('uptime-day', UptimeDay, "\n  <div class=\"uptime-day\">\n    <span class=\"uptime-day-status\" style=\"background-color: {{color}}\" />\n    <span class=\"hover\">{{@day.number}}: {{memo}}</span>\n  </div>\n");
env.registerEmberishGlimmerComponent('server-uptime', ServerUptime, "\n  <div class=\"server-uptime\">\n    <h1>{{@name}}</h1>\n    <h2>{{upDays}} Days Up</h2>\n    <h2>Biggest Streak: {{streak}}</h2>\n\n    <div class=\"days\">\n      {{#each @days key=\"number\" as |day|}}\n        <uptime-day @day={{day}} />\n      {{/each}}\n    </div>\n  </div>\n");
var app = env.compile("\n  {{#if fps}}<div id=\"fps\">{{fps}} FPS</div>{{/if}}\n\n  {{#each servers key=\"name\" as |server|}}\n    <server-uptime @name={{server.name}} @days={{server.days}} />\n  {{/each}}\n");
var serversRef;
var result;
var clear;
var fps;
var playing = false;
function init() {
    var output = document.getElementById('output');
    console.time('initial render');
    env.begin();
    serversRef = new object_reference_1.UpdatableReference({ servers: generateServers(), fps: null });
    result = app.render(serversRef, output, new test_helpers_1.TestDynamicScope());
    console.log(env['createdComponents'].length);
    env.commit();
    console.timeEnd('initial render');
}
exports.init = init;
function toggle() {
    if (playing) {
        window['playpause'].innerHTML = "Play";
        cancelAnimationFrame(clear);
        clear = null;
        fps = null;
        playing = false;
    }
    else {
        window['playpause'].innerHTML = "Pause";
        start();
        playing = true;
    }
}
exports.toggle = toggle;
function start() {
    playing = true;
    var lastFrame = null;
    var fpsMeter = new ema_1.default(2 / 121);
    var callback = function () {
        var thisFrame = window.performance.now();
        if (lastFrame) {
            fps = Math.round(fpsMeter.push(1000 / (thisFrame - lastFrame)));
        }
        onFrame();
        result.rerender();
        clear = requestAnimationFrame(callback);
        lastFrame = thisFrame;
    };
    callback();
    lastFrame = null;
}
function onFrame() {
    serversRef.update({ servers: generateServers(), fps: fps });
}
function generateServer(name) {
    var days = [];
    for (var i = 0; i <= 364; i++) {
        var up = Math.random() > 0.2;
        days.push({ number: i, up: up });
    }
    return { name: name, days: days };
}
function generateServers() {
    return [
        generateServer("Stefan's Server"),
        generateServer("Godfrey's Server"),
        generateServer("Yehuda's Server")
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXB0aW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2xpbW1lci1kZW1vcy9saWIvdXB0aW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDhEQUErRDtBQUMvRCxzREFBMEU7QUFDMUUsNkJBQTZDO0FBRTdDO0lBUUUsbUJBQVksS0FBVTtRQU5mLFlBQU8sR0FBWSxJQUFJLENBQUM7UUFPN0IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDckIsQ0FBQztJQU5NLGdCQUFNLEdBQWIsVUFBYyxFQUF5QjtZQUF2QixnQkFBSztRQUNuQixNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQU1ELHVCQUFHLEdBQUgsVUFBSSxHQUFXLEVBQUUsS0FBVTtRQUN6QixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ3BCLENBQUM7SUFFRCxnQ0FBWSxHQUFaLGNBQWdCLENBQUM7SUFDakIsa0NBQWMsR0FBZCxjQUFrQixDQUFDO0lBQ25CLG1DQUFlLEdBQWYsY0FBbUIsQ0FBQztJQUNwQixxQ0FBaUIsR0FBakIsY0FBcUIsQ0FBQztJQUN0Qiw4QkFBVSxHQUFWLGNBQWMsQ0FBQztJQUNmLDhCQUFVLEdBQVYsY0FBYyxDQUFDO0lBQ2Ysb0NBQWdCLEdBQWhCLGNBQW9CLENBQUM7SUFDckIsNkJBQVMsR0FBVCxjQUFhLENBQUM7SUFDZCw2QkFBUyxHQUFULGNBQWEsQ0FBQztJQUNoQixnQkFBQztBQUFELENBQUMsQUF6QkQsSUF5QkM7QUFFRDtJQUEyQixnQ0FBUztJQUFwQzs7SUFvQkEsQ0FBQztJQW5CQyxzQkFBSSxnQ0FBTTthQUFWO1lBQ0UsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFDLE1BQU0sRUFBRSxHQUFHO2dCQUN4QyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDcEMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ1IsQ0FBQzs7O09BQUE7SUFFRCxzQkFBSSxnQ0FBTTthQUFWO1lBQ08sSUFBQTs7Ozs7Ozs7Ozs7eUJBQUcsQ0FRRztZQUVYLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDYixDQUFDOzs7T0FBQTtJQUNILG1CQUFDO0FBQUQsQ0FBQyxBQXBCRCxDQUEyQixTQUFTLEdBb0JuQztBQUVEO0lBQXdCLDZCQUFTO0lBQWpDOztJQVFBLENBQUM7SUFQQyxzQkFBSSw0QkFBSzthQUFUO1lBQ0UsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxTQUFTLEdBQUcsTUFBTSxDQUFDO1FBQ2hELENBQUM7OztPQUFBO0lBRUQsc0JBQUksMkJBQUk7YUFBUjtZQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsc0JBQXNCLEdBQUcsWUFBWSxDQUFDO1FBQ25FLENBQUM7OztPQUFBO0lBQ0gsZ0JBQUM7QUFBRCxDQUFDLEFBUkQsQ0FBd0IsU0FBUyxHQVFoQztBQUVELElBQUksR0FBRyxHQUFHLElBQUksOEJBQWUsRUFBRSxDQUFDO0FBRWhDLEdBQUcsQ0FBQyxnQ0FBZ0MsQ0FBQyxZQUFZLEVBQUUsU0FBZ0IsRUFBRSx3TEFLcEUsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLGdDQUFnQyxDQUFDLGVBQWUsRUFBRSxZQUFtQixFQUFFLDhSQVkxRSxDQUFDLENBQUM7QUFFSCxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLDJMQU1yQixDQUFDLENBQUM7QUFFSCxJQUFJLFVBQVUsQ0FBQztBQUNmLElBQUksTUFBTSxDQUFDO0FBQ1gsSUFBSSxLQUFLLENBQUM7QUFDVixJQUFJLEdBQUcsQ0FBQztBQUNSLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztBQUVwQjtJQUNFLElBQUksTUFBTSxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFL0MsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQy9CLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUVaLFVBQVUsR0FBRyxJQUFJLHFDQUFrQixDQUFDLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQy9FLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSwrQkFBZ0IsRUFBRSxDQUFDLENBQUM7SUFFaEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM3QyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDYixPQUFPLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDcEMsQ0FBQztBQVpELG9CQVlDO0FBRUQ7SUFDRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ1osTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUM7UUFDdkMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDNUIsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNiLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFDWCxPQUFPLEdBQUcsS0FBSyxDQUFDO0lBQ2xCLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDO1FBQ3hDLEtBQUssRUFBRSxDQUFDO1FBQ1IsT0FBTyxHQUFHLElBQUksQ0FBQztJQUNqQixDQUFDO0FBQ0gsQ0FBQztBQVpELHdCQVlDO0FBRUQ7SUFDRSxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBRWYsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLElBQUksUUFBUSxHQUFHLElBQUksYUFBd0IsQ0FBQyxDQUFDLEdBQUMsR0FBRyxDQUFDLENBQUM7SUFFbkQsSUFBSSxRQUFRLEdBQUc7UUFDYixJQUFJLFNBQVMsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRXpDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDZCxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEUsQ0FBQztRQUVELE9BQU8sRUFBRSxDQUFDO1FBQ1YsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRWxCLEtBQUssR0FBRyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV4QyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQ3hCLENBQUMsQ0FBQztJQUVGLFFBQVEsRUFBRSxDQUFDO0lBRVgsU0FBUyxHQUFHLElBQUksQ0FBQztBQUNuQixDQUFDO0FBRUQ7SUFDRSxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxFQUFFLEdBQUcsS0FBQSxFQUFFLENBQUMsQ0FBQztBQUN6RCxDQUFDO0FBRUQsd0JBQXdCLElBQVk7SUFDbEMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRWQsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsSUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUMxQixJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBQSxFQUFFLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsTUFBTSxDQUFDLEVBQUUsSUFBSSxNQUFBLEVBQUUsSUFBSSxNQUFBLEVBQUUsQ0FBQztBQUN4QixDQUFDO0FBRUQ7SUFDRSxNQUFNLENBQUM7UUFDTCxjQUFjLENBQUMsaUJBQWlCLENBQUM7UUFDakMsY0FBYyxDQUFDLGtCQUFrQixDQUFDO1FBQ2xDLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQztLQUNsQyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVwZGF0YWJsZVJlZmVyZW5jZSB9IGZyb20gJ0BnbGltbWVyL29iamVjdC1yZWZlcmVuY2UnO1xuaW1wb3J0IHsgVGVzdEVudmlyb25tZW50LCBUZXN0RHluYW1pY1Njb3BlIH0gZnJvbSAnQGdsaW1tZXIvdGVzdC1oZWxwZXJzJztcbmltcG9ydCBFeHBvbmVudGlhbE1vdmluZ0F2ZXJhZ2UgZnJvbSAnLi9lbWEnO1xuXG5jbGFzcyBDb21wb25lbnQge1xuICBwdWJsaWMgYXR0cnM6IGFueTtcbiAgcHVibGljIGVsZW1lbnQ6IEVsZW1lbnQgPSBudWxsO1xuXG4gIHN0YXRpYyBjcmVhdGUoeyBhdHRycyB9OiB7IGF0dHJzOiBhbnkgfSk6IENvbXBvbmVudCB7XG4gICAgcmV0dXJuIG5ldyB0aGlzKGF0dHJzKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKGF0dHJzOiBhbnkpIHtcbiAgICB0aGlzLmF0dHJzID0gYXR0cnM7XG4gIH1cblxuICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICB0aGlzW2tleV0gPSB2YWx1ZTtcbiAgfVxuXG4gIGRpZEluaXRBdHRycygpIHt9XG4gIGRpZFVwZGF0ZUF0dHJzKCkge31cbiAgZGlkUmVjZWl2ZUF0dHJzKCkge31cbiAgd2lsbEluc2VydEVsZW1lbnQoKSB7fVxuICB3aWxsVXBkYXRlKCkge31cbiAgd2lsbFJlbmRlcigpIHt9XG4gIGRpZEluc2VydEVsZW1lbnQoKSB7fVxuICBkaWRVcGRhdGUoKSB7fVxuICBkaWRSZW5kZXIoKSB7fVxufVxuXG5jbGFzcyBTZXJ2ZXJVcHRpbWUgZXh0ZW5kcyBDb21wb25lbnQge1xuICBnZXQgdXBEYXlzKCkge1xuICAgIHJldHVybiB0aGlzLmF0dHJzLmRheXMucmVkdWNlKCh1cERheXMsIGRheSkgPT4ge1xuICAgICAgcmV0dXJuIHVwRGF5cyArPSAoZGF5LnVwID8gMSA6IDApO1xuICAgIH0sIDApO1xuICB9XG5cbiAgZ2V0IHN0cmVhaygpIHtcbiAgICBsZXQgW21heF0gPSB0aGlzLmF0dHJzLmRheXMucmVkdWNlKChbbWF4LCBzdHJlYWtdLCBkYXkpID0+IHtcbiAgICAgIGlmIChkYXkudXAgJiYgc3RyZWFrICsgMSA+IG1heCkge1xuICAgICAgICByZXR1cm4gW3N0cmVhayArIDEsIHN0cmVhayArIDFdO1xuICAgICAgfSBlbHNlIGlmIChkYXkudXApIHtcbiAgICAgICAgcmV0dXJuIFttYXgsIHN0cmVhayArIDFdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFttYXgsIDBdO1xuICAgICAgfVxuICAgIH0sIFswLCAwXSk7XG5cbiAgICByZXR1cm4gbWF4O1xuICB9XG59XG5cbmNsYXNzIFVwdGltZURheSBleHRlbmRzIENvbXBvbmVudCB7XG4gIGdldCBjb2xvcigpIHtcbiAgICByZXR1cm4gdGhpcy5hdHRycy5kYXkudXAgPyAnIzhjYzY2NScgOiAnI2NjYyc7XG4gIH1cblxuICBnZXQgbWVtbygpIHtcbiAgICByZXR1cm4gdGhpcy5hdHRycy5kYXkudXAgPyAnU2VydmVycyBvcGVyYXRpb25hbCEnIDogJ1JlZCBhbGVydCEnO1xuICB9XG59XG5cbmxldCBlbnYgPSBuZXcgVGVzdEVudmlyb25tZW50KCk7XG5cbmVudi5yZWdpc3RlckVtYmVyaXNoR2xpbW1lckNvbXBvbmVudCgndXB0aW1lLWRheScsIFVwdGltZURheSBhcyBhbnksIGBcbiAgPGRpdiBjbGFzcz1cInVwdGltZS1kYXlcIj5cbiAgICA8c3BhbiBjbGFzcz1cInVwdGltZS1kYXktc3RhdHVzXCIgc3R5bGU9XCJiYWNrZ3JvdW5kLWNvbG9yOiB7e2NvbG9yfX1cIiAvPlxuICAgIDxzcGFuIGNsYXNzPVwiaG92ZXJcIj57e0BkYXkubnVtYmVyfX06IHt7bWVtb319PC9zcGFuPlxuICA8L2Rpdj5cbmApO1xuXG5lbnYucmVnaXN0ZXJFbWJlcmlzaEdsaW1tZXJDb21wb25lbnQoJ3NlcnZlci11cHRpbWUnLCBTZXJ2ZXJVcHRpbWUgYXMgYW55LCBgXG4gIDxkaXYgY2xhc3M9XCJzZXJ2ZXItdXB0aW1lXCI+XG4gICAgPGgxPnt7QG5hbWV9fTwvaDE+XG4gICAgPGgyPnt7dXBEYXlzfX0gRGF5cyBVcDwvaDI+XG4gICAgPGgyPkJpZ2dlc3QgU3RyZWFrOiB7e3N0cmVha319PC9oMj5cblxuICAgIDxkaXYgY2xhc3M9XCJkYXlzXCI+XG4gICAgICB7eyNlYWNoIEBkYXlzIGtleT1cIm51bWJlclwiIGFzIHxkYXl8fX1cbiAgICAgICAgPHVwdGltZS1kYXkgQGRheT17e2RheX19IC8+XG4gICAgICB7ey9lYWNofX1cbiAgICA8L2Rpdj5cbiAgPC9kaXY+XG5gKTtcblxubGV0IGFwcCA9IGVudi5jb21waWxlKGBcbiAge3sjaWYgZnBzfX08ZGl2IGlkPVwiZnBzXCI+e3tmcHN9fSBGUFM8L2Rpdj57ey9pZn19XG5cbiAge3sjZWFjaCBzZXJ2ZXJzIGtleT1cIm5hbWVcIiBhcyB8c2VydmVyfH19XG4gICAgPHNlcnZlci11cHRpbWUgQG5hbWU9e3tzZXJ2ZXIubmFtZX19IEBkYXlzPXt7c2VydmVyLmRheXN9fSAvPlxuICB7ey9lYWNofX1cbmApO1xuXG5sZXQgc2VydmVyc1JlZjtcbmxldCByZXN1bHQ7XG5sZXQgY2xlYXI7XG5sZXQgZnBzO1xubGV0IHBsYXlpbmcgPSBmYWxzZTtcblxuZXhwb3J0IGZ1bmN0aW9uIGluaXQoKSB7XG4gIGxldCBvdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnb3V0cHV0Jyk7XG5cbiAgY29uc29sZS50aW1lKCdpbml0aWFsIHJlbmRlcicpO1xuICBlbnYuYmVnaW4oKTtcblxuICBzZXJ2ZXJzUmVmID0gbmV3IFVwZGF0YWJsZVJlZmVyZW5jZSh7IHNlcnZlcnM6IGdlbmVyYXRlU2VydmVycygpLCBmcHM6IG51bGwgfSk7XG4gIHJlc3VsdCA9IGFwcC5yZW5kZXIoc2VydmVyc1JlZiwgb3V0cHV0LCBuZXcgVGVzdER5bmFtaWNTY29wZSgpKTtcblxuICBjb25zb2xlLmxvZyhlbnZbJ2NyZWF0ZWRDb21wb25lbnRzJ10ubGVuZ3RoKTtcbiAgZW52LmNvbW1pdCgpO1xuICBjb25zb2xlLnRpbWVFbmQoJ2luaXRpYWwgcmVuZGVyJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b2dnbGUoKSB7XG4gIGlmIChwbGF5aW5nKSB7XG4gICAgd2luZG93WydwbGF5cGF1c2UnXS5pbm5lckhUTUwgPSBcIlBsYXlcIjtcbiAgICBjYW5jZWxBbmltYXRpb25GcmFtZShjbGVhcik7XG4gICAgY2xlYXIgPSBudWxsO1xuICAgIGZwcyA9IG51bGw7XG4gICAgcGxheWluZyA9IGZhbHNlO1xuICB9IGVsc2Uge1xuICAgIHdpbmRvd1sncGxheXBhdXNlJ10uaW5uZXJIVE1MID0gXCJQYXVzZVwiO1xuICAgIHN0YXJ0KCk7XG4gICAgcGxheWluZyA9IHRydWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gc3RhcnQoKSB7XG4gIHBsYXlpbmcgPSB0cnVlO1xuXG4gIGxldCBsYXN0RnJhbWUgPSBudWxsO1xuICBsZXQgZnBzTWV0ZXIgPSBuZXcgRXhwb25lbnRpYWxNb3ZpbmdBdmVyYWdlKDIvMTIxKTtcblxuICBsZXQgY2FsbGJhY2sgPSAoKSA9PiB7XG4gICAgbGV0IHRoaXNGcmFtZSA9IHdpbmRvdy5wZXJmb3JtYW5jZS5ub3coKTtcblxuICAgIGlmIChsYXN0RnJhbWUpIHtcbiAgICAgIGZwcyA9IE1hdGgucm91bmQoZnBzTWV0ZXIucHVzaCgxMDAwIC8gKHRoaXNGcmFtZSAtIGxhc3RGcmFtZSkpKTtcbiAgICB9XG5cbiAgICBvbkZyYW1lKCk7XG4gICAgcmVzdWx0LnJlcmVuZGVyKCk7XG5cbiAgICBjbGVhciA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShjYWxsYmFjayk7XG5cbiAgICBsYXN0RnJhbWUgPSB0aGlzRnJhbWU7XG4gIH07XG5cbiAgY2FsbGJhY2soKTtcblxuICBsYXN0RnJhbWUgPSBudWxsO1xufVxuXG5mdW5jdGlvbiBvbkZyYW1lKCkge1xuICBzZXJ2ZXJzUmVmLnVwZGF0ZSh7IHNlcnZlcnM6IGdlbmVyYXRlU2VydmVycygpLCBmcHMgfSk7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlU2VydmVyKG5hbWU6IHN0cmluZykge1xuICBsZXQgZGF5cyA9IFtdO1xuXG4gIGZvciAobGV0IGk9MDsgaTw9MzY0OyBpKyspIHtcbiAgICBsZXQgdXAgPSBNYXRoLnJhbmRvbSgpID4gMC4yO1xuICAgIGRheXMucHVzaCh7IG51bWJlcjogaSwgdXAgfSk7XG4gIH1cblxuICByZXR1cm4geyBuYW1lLCBkYXlzIH07XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlU2VydmVycygpIHtcbiAgcmV0dXJuIFtcbiAgICBnZW5lcmF0ZVNlcnZlcihcIlN0ZWZhbidzIFNlcnZlclwiKSxcbiAgICBnZW5lcmF0ZVNlcnZlcihcIkdvZGZyZXkncyBTZXJ2ZXJcIiksXG4gICAgZ2VuZXJhdGVTZXJ2ZXIoXCJZZWh1ZGEncyBTZXJ2ZXJcIilcbiAgXTtcbn1cbiJdfQ==