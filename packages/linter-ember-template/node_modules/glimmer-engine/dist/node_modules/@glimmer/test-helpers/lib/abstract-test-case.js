"use strict";
var reference_1 = require("@glimmer/reference");
var environment_1 = require("./environment");
var helpers_1 = require("./helpers");
function skip(target, name, descriptor) {
    descriptor.value['skip'] = true;
}
exports.skip = skip;
var VersionedObject = (function () {
    function VersionedObject(value) {
        this.tag = new reference_1.DirtyableTag();
        helpers_1.assign(this, value);
    }
    VersionedObject.prototype.update = function (value) {
        helpers_1.assign(this, value);
        this.dirty();
    };
    VersionedObject.prototype.set = function (key, value) {
        this[key] = value;
        this.dirty();
    };
    VersionedObject.prototype.dirty = function () {
        this.tag.dirty();
    };
    return VersionedObject;
}());
exports.VersionedObject = VersionedObject;
var SimpleRootReference = (function () {
    function SimpleRootReference(object) {
        this.object = object;
        this.tag = object.tag;
    }
    SimpleRootReference.prototype.get = function (key) {
        return new SimplePathReference(this, key);
    };
    SimpleRootReference.prototype.value = function () {
        return this.object;
    };
    return SimpleRootReference;
}());
exports.SimpleRootReference = SimpleRootReference;
var SimplePathReference = (function () {
    function SimplePathReference(parent, key) {
        this.parent = parent;
        this.key = key;
        this.tag = parent.tag;
    }
    SimplePathReference.prototype.get = function (key) {
        return new SimplePathReference(this, key);
    };
    SimplePathReference.prototype.value = function () {
        return this.parent.value()[this.key];
    };
    return SimplePathReference;
}());
function isMarker(node) {
    if (node instanceof Comment && node.textContent === '') {
        return true;
    }
    if (node instanceof Text && node.textContent === '') {
        return true;
    }
    return false;
}
var RenderingTest = (function () {
    function RenderingTest(env, template, appendTo) {
        if (env === void 0) { env = new environment_1.TestEnvironment(); }
        this.env = env;
        this.appendTo = appendTo;
        this.context = null;
        this.result = null;
        this.template = this.env.compile(template);
        this.assert = QUnit.config.current.assert;
    }
    RenderingTest.prototype.teardown = function () { };
    RenderingTest.prototype.render = function (context) {
        this.env.begin();
        var dynamicScope = new environment_1.TestDynamicScope();
        var appendTo = this.appendTo;
        var rootObject = new VersionedObject(context);
        var root = new SimpleRootReference(rootObject);
        this.context = rootObject;
        this.result = this.template.render(root, appendTo, dynamicScope);
        this.env.commit();
        this.element = document.getElementById('qunit-fixture').firstChild;
    };
    RenderingTest.prototype.assertContent = function (expected, message) {
        var actual = document.getElementById('qunit-fixture').innerHTML;
        QUnit.equal(actual, expected);
    };
    RenderingTest.prototype.takeSnapshot = function () {
        var snapshot = this.snapshot = [];
        var node = this.element.firstChild;
        while (node) {
            if (!isMarker(node)) {
                snapshot.push(node);
            }
            node = node.nextSibling;
        }
        return snapshot;
    };
    RenderingTest.prototype.assertStableRerender = function () {
        this.takeSnapshot();
        this.rerender();
        this.assertInvariants();
    };
    RenderingTest.prototype.rerender = function () {
        this.result.rerender();
    };
    RenderingTest.prototype.assertInvariants = function (oldSnapshot, newSnapshot) {
        oldSnapshot = oldSnapshot || this.snapshot;
        newSnapshot = newSnapshot || this.takeSnapshot();
        this.assert.strictEqual(newSnapshot.length, oldSnapshot.length, 'Same number of nodes');
        for (var i = 0; i < oldSnapshot.length; i++) {
            this.assertSameNode(newSnapshot[i], oldSnapshot[i]);
        }
    };
    RenderingTest.prototype.assertSameNode = function (actual, expected) {
        this.assert.strictEqual(actual, expected, 'DOM node stability');
    };
    RenderingTest.prototype.runTask = function (callback) {
        callback();
        this.env.begin();
        this.result.rerender();
        this.env.commit();
    };
    return RenderingTest;
}());
exports.RenderingTest = RenderingTest;
function testModule(description) {
    return function (TestClass) {
        var context;
        QUnit.module("[Browser] " + (description || TestClass.name), {
            afterEach: function () {
                context.teardown();
            }
        });
        var keys = Object.getOwnPropertyNames(TestClass.prototype);
        keys.forEach(function (key) {
            if (key === 'constructor')
                return;
            var value = Object.getOwnPropertyDescriptor(TestClass.prototype, key).value;
            var isSkipped = value.skip;
            if (typeof value === 'function' && !isSkipped) {
                QUnit.test(key, function (assert) {
                    var env = new environment_1.TestEnvironment();
                    context = new TestClass(env, value['template'], document.getElementById('qunit-fixture'));
                    value.call(context, assert);
                });
            }
            else if (isSkipped) {
                QUnit.skip(key, function () { });
            }
        });
    };
}
exports.testModule = testModule;
function template(t) {
    return function template(target, name, descriptor) {
        if (typeof descriptor.value !== 'function') {
            throw new Error("Can't decorator a non-function with the @template decorator");
        }
        descriptor.value['template'] = t;
    };
}
exports.template = template;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWJzdHJhY3QtdGVzdC1jYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQGdsaW1tZXIvdGVzdC1oZWxwZXJzL2xpYi9hYnN0cmFjdC10ZXN0LWNhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLGdEQUFnRztBQUVoRyw2Q0FHdUI7QUFFdkIscUNBQW1DO0FBRW5DLGNBQXFCLE1BQWMsRUFBRSxJQUFZLEVBQUUsVUFBOEI7SUFDL0UsVUFBVSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7QUFDbEMsQ0FBQztBQUZELG9CQUVDO0FBRUQ7SUFJRSx5QkFBWSxLQUFhO1FBQ3ZCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSx3QkFBWSxFQUFFLENBQUM7UUFDOUIsZ0JBQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVELGdDQUFNLEdBQU4sVUFBTyxLQUFhO1FBQ2xCLGdCQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNmLENBQUM7SUFFRCw2QkFBRyxHQUFILFVBQUksR0FBVyxFQUFFLEtBQWE7UUFDNUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUNsQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQsK0JBQUssR0FBTDtRQUNFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDbkIsQ0FBQztJQUNILHNCQUFDO0FBQUQsQ0FBQyxBQXRCRCxJQXNCQztBQXRCWSwwQ0FBZTtBQXdCNUI7SUFHRSw2QkFBb0IsTUFBdUI7UUFBdkIsV0FBTSxHQUFOLE1BQU0sQ0FBaUI7UUFDekMsSUFBSSxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxpQ0FBRyxHQUFILFVBQUksR0FBVztRQUNiLE1BQU0s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ZXZpc2lvbiwgUmV2aXNpb25UYWcsIERpcnR5YWJsZVRhZyB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQgeyBUZW1wbGF0ZSwgUmVuZGVyUmVzdWx0LCBTaW1wbGUgfSBmcm9tICdAZ2xpbW1lci9ydW50aW1lJztcbmltcG9ydCB7XG4gIFRlc3RFbnZpcm9ubWVudCxcbiAgVGVzdER5bmFtaWNTY29wZVxufSBmcm9tICcuL2Vudmlyb25tZW50JztcbmltcG9ydCB7IE9wYXF1ZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgYXNzaWduIH0gZnJvbSAnLi9oZWxwZXJzJztcblxuZXhwb3J0IGZ1bmN0aW9uIHNraXAodGFyZ2V0OiBPYmplY3QsIG5hbWU6IHN0cmluZywgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yKSB7XG4gIGRlc2NyaXB0b3IudmFsdWVbJ3NraXAnXSA9IHRydWU7XG59XG5cbmV4cG9ydCBjbGFzcyBWZXJzaW9uZWRPYmplY3QgaW1wbGVtZW50cyBUYWdnZWQ8UmV2aXNpb24+IHtcbiAgcHVibGljIHRhZzogRGlydHlhYmxlVGFnO1xuICBwdWJsaWMgdmFsdWU6IE9iamVjdDtcblxuICBjb25zdHJ1Y3Rvcih2YWx1ZTogT2JqZWN0KSB7XG4gICAgdGhpcy50YWcgPSBuZXcgRGlydHlhYmxlVGFnKCk7XG4gICAgYXNzaWduKHRoaXMsIHZhbHVlKTtcbiAgfVxuXG4gIHVwZGF0ZSh2YWx1ZTogT2JqZWN0KSB7XG4gICAgYXNzaWduKHRoaXMsIHZhbHVlKTtcbiAgICB0aGlzLmRpcnR5KCk7XG4gIH1cblxuICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBPcGFxdWUpIHtcbiAgICB0aGlzW2tleV0gPSB2YWx1ZTtcbiAgICB0aGlzLmRpcnR5KCk7XG4gIH1cblxuICBkaXJ0eSgpIHtcbiAgICB0aGlzLnRhZy5kaXJ0eSgpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTaW1wbGVSb290UmVmZXJlbmNlIGltcGxlbWVudHMgUGF0aFJlZmVyZW5jZTxPcGFxdWU+IHtcbiAgcHVibGljIHRhZzogUmV2aXNpb25UYWc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvYmplY3Q6IFZlcnNpb25lZE9iamVjdCkge1xuICAgIHRoaXMudGFnID0gb2JqZWN0LnRhZztcbiAgfVxuXG4gIGdldChrZXk6IHN0cmluZyk6IFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gICAgcmV0dXJuIG5ldyBTaW1wbGVQYXRoUmVmZXJlbmNlKHRoaXMsIGtleSk7XG4gIH1cblxuICB2YWx1ZSgpOiBPYmplY3Qge1xuICAgIHJldHVybiB0aGlzLm9iamVjdDtcbiAgfVxufVxuXG5jbGFzcyBTaW1wbGVQYXRoUmVmZXJlbmNlIGltcGxlbWVudHMgUGF0aFJlZmVyZW5jZTxPcGFxdWU+IHtcbiAgcHVibGljIHRhZzogUmV2aXNpb25UYWc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwYXJlbnQ6IFBhdGhSZWZlcmVuY2U8T3BhcXVlPiwgcHJpdmF0ZSBrZXk6IHN0cmluZykge1xuICAgIHRoaXMudGFnID0gcGFyZW50LnRhZztcbiAgfVxuXG4gIGdldChrZXk6IHN0cmluZyk6IFNpbXBsZVBhdGhSZWZlcmVuY2Uge1xuICAgIHJldHVybiBuZXcgU2ltcGxlUGF0aFJlZmVyZW5jZSh0aGlzLCBrZXkpO1xuICB9XG5cbiAgdmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50LnZhbHVlKClbdGhpcy5rZXldO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzTWFya2VyKG5vZGUpIHtcbiAgaWYgKG5vZGUgaW5zdGFuY2VvZiBDb21tZW50ICYmIG5vZGUudGV4dENvbnRlbnQgPT09ICcnKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpZiAobm9kZSBpbnN0YW5jZW9mIFRleHQgJiYgbm9kZS50ZXh0Q29udGVudCA9PT0gJycpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGNsYXNzIFJlbmRlcmluZ1Rlc3Qge1xuICBwdWJsaWMgdGVtcGxhdGU6IFRlbXBsYXRlPHt9PjtcbiAgcHJvdGVjdGVkIGNvbnRleHQ6IFZlcnNpb25lZE9iamVjdCA9IG51bGw7XG4gIHByaXZhdGUgcmVzdWx0OiBSZW5kZXJSZXN1bHQgPSBudWxsO1xuICBwdWJsaWMgc25hcHNob3Q6IEVsZW1lbnRbXTtcbiAgcHVibGljIGVsZW1lbnQ6IE5vZGU7XG4gIHB1YmxpYyBhc3NlcnQ6IFFVbml0Wydhc3NlcnQnXTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgZW52OiBUZXN0RW52aXJvbm1lbnQgPSBuZXcgVGVzdEVudmlyb25tZW50KCksIHRlbXBsYXRlOiBzdHJpbmcsIHByaXZhdGUgYXBwZW5kVG86IFNpbXBsZS5FbGVtZW50KSB7XG4gICAgdGhpcy50ZW1wbGF0ZSA9IHRoaXMuZW52LmNvbXBpbGUodGVtcGxhdGUpO1xuICAgIHRoaXMuYXNzZXJ0ID0gUVVuaXQuY29uZmlnLmN1cnJlbnQuYXNzZXJ0O1xuICB9XG5cbiAgdGVhcmRvd24oKSB7fVxuXG4gIHJlbmRlcihjb250ZXh0OiBPYmplY3QpIHtcbiAgICB0aGlzLmVudi5iZWdpbigpO1xuICAgIGxldCBkeW5hbWljU2NvcGUgPSBuZXcgVGVzdER5bmFtaWNTY29wZSgpO1xuICAgIGxldCBhcHBlbmRUbyA9IHRoaXMuYXBwZW5kVG87XG4gICAgbGV0IHJvb3RPYmplY3QgPSBuZXcgVmVyc2lvbmVkT2JqZWN0KGNvbnRleHQpO1xuICAgIGxldCByb290ID0gbmV3IFNpbXBsZVJvb3RSZWZlcmVuY2Uocm9vdE9iamVjdCk7XG5cbiAgICB0aGlzLmNvbnRleHQgPSByb290T2JqZWN0O1xuICAgIHRoaXMucmVzdWx0ID0gdGhpcy50ZW1wbGF0ZS5yZW5kZXIocm9vdCwgYXBwZW5kVG8sIGR5bmFtaWNTY29wZSk7XG4gICAgdGhpcy5lbnYuY29tbWl0KCk7XG4gICAgdGhpcy5lbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1bml0LWZpeHR1cmUnKS5maXJzdENoaWxkO1xuICB9XG4gIGFzc2VydENvbnRlbnQoZXhwZWN0ZWQ6IHN0cmluZywgbWVzc2FnZT86IHN0cmluZykge1xuICAgIGxldCBhY3R1YWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVuaXQtZml4dHVyZScpLmlubmVySFRNTDtcbiAgICBRVW5pdC5lcXVhbChhY3R1YWwsIGV4cGVjdGVkKTtcbiAgfVxuXG4gIHRha2VTbmFwc2hvdCgpIHtcbiAgICBsZXQgc25hcHNob3QgPSB0aGlzLnNuYXBzaG90ID0gW107XG4gICAgbGV0IG5vZGUgPSB0aGlzLmVsZW1lbnQuZmlyc3RDaGlsZDtcblxuICAgIHdoaWxlIChub2RlKSB7XG4gICAgICBpZiAoIWlzTWFya2VyKG5vZGUpKSB7XG4gICAgICAgIHNuYXBzaG90LnB1c2gobm9kZSk7XG4gICAgICB9XG5cbiAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nO1xuICAgIH1cblxuICAgIHJldHVybiBzbmFwc2hvdDtcbiAgfVxuXG4gIGFzc2VydFN0YWJsZVJlcmVuZGVyKCkge1xuICAgIHRoaXMudGFrZVNuYXBzaG90KCk7XG4gICAgdGhpcy5yZXJlbmRlcigpO1xuICAgIHRoaXMuYXNzZXJ0SW52YXJpYW50cygpO1xuICB9XG5cbiAgcmVyZW5kZXIoKSB7XG4gICAgdGhpcy5yZXN1bHQucmVyZW5kZXIoKTtcbiAgfVxuXG4gIGFzc2VydEludmFyaWFudHMob2xkU25hcHNob3Q/OiBBcnJheTxOb2RlPiwgbmV3U25hcHNob3Q/OiBBcnJheTxOb2RlPikge1xuICAgIG9sZFNuYXBzaG90ID0gb2xkU25hcHNob3QgfHwgdGhpcy5zbmFwc2hvdDtcbiAgICBuZXdTbmFwc2hvdCA9IG5ld1NuYXBzaG90IHx8IHRoaXMudGFrZVNuYXBzaG90KCk7XG5cbiAgICB0aGlzLmFzc2VydC5zdHJpY3RFcXVhbChuZXdTbmFwc2hvdC5sZW5ndGgsIG9sZFNuYXBzaG90Lmxlbmd0aCwgJ1NhbWUgbnVtYmVyIG9mIG5vZGVzJyk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9sZFNuYXBzaG90Lmxlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLmFzc2VydFNhbWVOb2RlKG5ld1NuYXBzaG90W2ldLCBvbGRTbmFwc2hvdFtpXSk7XG4gICAgfVxuICB9XG5cbiAgYXNzZXJ0U2FtZU5vZGUoYWN0dWFsOiBOb2RlLCBleHBlY3RlZDogTm9kZSkge1xuICAgIHRoaXMuYXNzZXJ0LnN0cmljdEVxdWFsKGFjdHVhbCwgZXhwZWN0ZWQsICdET00gbm9kZSBzdGFiaWxpdHknKTtcbiAgfVxuXG4gIHJ1blRhc2soY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICBjYWxsYmFjaygpO1xuICAgIHRoaXMuZW52LmJlZ2luKCk7XG4gICAgdGhpcy5yZXN1bHQucmVyZW5kZXIoKTtcbiAgICB0aGlzLmVudi5jb21taXQoKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgQ29uc3RydWN0b3I8VD4ge1xuICBuZXcoLi4uYXJncyk6IFQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0ZXN0TW9kdWxlKGRlc2NyaXB0aW9uPzogc3RyaW5nKSB7XG4gIHJldHVybiBmdW5jdGlvbihUZXN0Q2xhc3M6IHR5cGVvZiBSZW5kZXJpbmdUZXN0KSB7XG4gICAgbGV0IGNvbnRleHQ6IFJlbmRlcmluZ1Rlc3Q7XG5cbiAgICBRVW5pdC5tb2R1bGUoYFtCcm93c2VyXSAke2Rlc2NyaXB0aW9uIHx8IFRlc3RDbGFzcy5uYW1lfWAsIHtcbiAgICAgIGFmdGVyRWFjaCgpIHtcbiAgICAgICAgY29udGV4dC50ZWFyZG93bigpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbGV0IGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhUZXN0Q2xhc3MucHJvdG90eXBlKTtcbiAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGlmIChrZXkgPT09ICdjb25zdHJ1Y3RvcicpIHJldHVybjtcbiAgICAgIGxldCB2YWx1ZSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoVGVzdENsYXNzLnByb3RvdHlwZSwga2V5KS52YWx1ZTtcbiAgICAgIGxldCBpc1NraXBwZWQgPSB2YWx1ZS5za2lwO1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNTa2lwcGVkKSB7XG4gICAgICAgIFFVbml0LnRlc3Qoa2V5LCAoYXNzZXJ0KSA9PiB7XG4gICAgICAgICAgbGV0IGVudiA9IG5ldyBUZXN0RW52aXJvbm1lbnQoKTtcbiAgICAgICAgICBjb250ZXh0ID0gbmV3IFRlc3RDbGFzcyhlbnYsIHZhbHVlWyd0ZW1wbGF0ZSddLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVuaXQtZml4dHVyZScpKTtcbiAgICAgICAgICB2YWx1ZS5jYWxsKGNvbnRleHQsIGFzc2VydCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChpc1NraXBwZWQpIHtcbiAgICAgICAgUVVuaXQuc2tpcChrZXksICgpID0+IHt9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRlbXBsYXRlKHQ6IHN0cmluZykge1xuICByZXR1cm4gZnVuY3Rpb24gdGVtcGxhdGUodGFyZ2V0OiBPYmplY3QsIG5hbWU6IHN0cmluZywgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yKSB7XG4gICAgaWYgKHR5cGVvZiBkZXNjcmlwdG9yLnZhbHVlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW4ndCBkZWNvcmF0b3IgYSBub24tZnVuY3Rpb24gd2l0aCB0aGUgQHRlbXBsYXRlIGRlY29yYXRvclwiKTtcbiAgICB9XG5cbiAgICBkZXNjcmlwdG9yLnZhbHVlWyd0ZW1wbGF0ZSddID0gdDtcbiAgfTtcbn1cbiJdfQ==