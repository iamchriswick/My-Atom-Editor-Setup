"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var util_1 = require("@glimmer/util");
var util_2 = require("@glimmer/util");
var wire_format_1 = require("@glimmer/wire-format");
var Block = (function () {
    function Block() {
        this.type = "block";
        this.statements = [];
        this.positionals = [];
    }
    Block.prototype.toJSON = function () {
        return {
            statements: this.statements,
            locals: this.positionals
        };
    };
    Block.prototype.push = function (statement) {
        this.statements.push(statement);
    };
    return Block;
}());
exports.Block = Block;
var TemplateBlock = (function (_super) {
    __extends(TemplateBlock, _super);
    function TemplateBlock() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.type = "template";
        _this.yields = new util_2.DictSet();
        _this.named = new util_2.DictSet();
        _this.blocks = [];
        _this.hasPartials = false;
        return _this;
    }
    TemplateBlock.prototype.toJSON = function () {
        return {
            statements: this.statements,
            locals: this.positionals,
            named: this.named.toArray(),
            yields: this.yields.toArray(),
            hasPartials: this.hasPartials
        };
    };
    return TemplateBlock;
}(Block));
exports.TemplateBlock = TemplateBlock;
var ComponentBlock = (function (_super) {
    __extends(ComponentBlock, _super);
    function ComponentBlock() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.type = "component";
        _this.attributes = [];
        _this.arguments = [];
        _this.inParams = true;
        return _this;
    }
    ComponentBlock.prototype.push = function (statement) {
        if (this.inParams) {
            if (wire_format_1.Statements.isFlushElement(statement)) {
                this.inParams = false;
            }
            else if (wire_format_1.Statements.isArgument(statement)) {
                this.arguments.push(statement);
            }
            else if (wire_format_1.Statements.isAttribute(statement)) {
                this.attributes.push(statement);
            }
            else if (wire_format_1.Statements.isModifier(statement)) {
                throw new Error('Compile Error: Element modifiers are not allowed in components');
            }
            else {
                throw new Error('Compile Error: only parameters allowed before flush-element');
            }
        }
        else {
            this.statements.push(statement);
        }
    };
    ComponentBlock.prototype.toJSON = function () {
        var args = this.arguments;
        var keys = args.map(function (arg) { return arg[1]; });
        var values = args.map(function (arg) { return arg[2]; });
        return {
            attrs: this.attributes,
            args: [keys, values],
            locals: this.positionals,
            statements: this.statements
        };
    };
    return ComponentBlock;
}(Block));
exports.ComponentBlock = ComponentBlock;
var Template = (function () {
    function Template(meta) {
        this.meta = meta;
        this.block = new TemplateBlock();
    }
    Template.prototype.toJSON = function () {
        return {
            block: this.block.toJSON(),
            meta: this.meta
        };
    };
    return Template;
}());
exports.Template = Template;
var JavaScriptCompiler = (function () {
    function JavaScriptCompiler(opcodes, meta) {
        this.blocks = new util_2.Stack();
        this.values = [];
        this.opcodes = opcodes;
        this.template = new Template(meta);
    }
    JavaScriptCompiler.process = function (opcodes, meta) {
        var compiler = new JavaScriptCompiler(opcodes, meta);
        return compiler.process();
    };
    JavaScriptCompiler.prototype.process = function () {
        var _this = this;
        this.opcodes.forEach(function (_a) {
            var opcode = _a[0], args = _a.slice(1);
            if (!_this[opcode]) {
                throw new Error("unimplemented " + opcode + " on JavaScriptCompiler");
            }
            _this[opcode].apply(_this, args);
        });
        return this.template;
    };
    /// Nesting
    JavaScriptCompiler.prototype.startBlock = function (_a) {
        var program = _a[0];
        var block = new Block();
        block.positionals = program.blockParams;
        this.blocks.push(block);
    };
    JavaScriptCompiler.prototype.endBlock = function () {
        var _a = this, template = _a.template, blocks = _a.blocks;
        template.block.blocks.push(blocks.pop().toJSON());
    };
    JavaScriptCompiler.prototype.startProgram = function () {
        this.blocks.push(this.template.block);
    };
    JavaScriptCompiler.prototype.endProgram = function () {
    };
    /// Statements
    JavaScriptCompiler.prototype.text = function (content) {
        this.push(['text', content]);
    };
    JavaScriptCompiler.prototype.append = function (trusted) {
        this.push(['append', this.popValue(), trusted]);
    };
    JavaScriptCompiler.prototype.comment = function (value) {
        this.push(['comment', value]);
    };
    JavaScriptCompiler.prototype.modifier = function (path) {
        var params = this.popValue();
        var hash = this.popValue();
        this.push(['modifier', path, params, hash]);
    };
    JavaScriptCompiler.prototype.block = function (path, template, inverse) {
        var params = this.popValue();
        var hash = this.popValue();
        var blocks = this.template.block.blocks;
        util_1.assert(typeof template !== 'number' || blocks[template] !== null, 'missing block in the compiler');
        util_1.assert(typeof inverse !== 'number' || blocks[inverse] !== null, 'missing block in the compiler');
        this.push(['block', path, params, hash, blocks[template], blocks[inverse]]);
    };
    JavaScriptCompiler.prototype.openElement = function (tag, blockParams) {
        if (tag.indexOf('-') !== -1) {
            this.startComponent(blockParams);
        }
        else {
            this.push(['open-element', tag, blockParams]);
        }
    };
    JavaScriptCompiler.prototype.flushElement = function () {
        this.push(['flush-element']);
    };
    JavaScriptCompiler.prototype.closeElement = function (tag) {
        if (tag.indexOf('-') !== -1) {
            var component = this.endComponent();
            this.push(['component', tag, component]);
        }
        else {
            this.push(['close-element']);
        }
    };
    JavaScriptCompiler.prototype.staticAttr = function (name, namespace) {
        var value = this.popValue();
        this.push(['static-attr', name, value, namespace]);
    };
    JavaScriptCompiler.prototype.dynamicAttr = function (name, namespace) {
        var value = this.popValue();
        this.push(['dynamic-attr', name, value, namespace]);
    };
    JavaScriptCompiler.prototype.trustingAttr = function (name, namespace) {
        var value = this.popValue();
        this.push(['trusting-attr', name, value, namespace]);
    };
    JavaScriptCompiler.prototype.staticArg = function (name) {
        var value = this.popValue();
        this.push(['static-arg', name.slice(1), value]);
    };
    JavaScriptCompiler.prototype.dynamicArg = function (name) {
        var value = this.popValue();
        this.push(['dynamic-arg', name.slice(1), value]);
    };
    JavaScriptCompiler.prototype.yield = function (to) {
        var params = this.popValue();
        this.push(['yield', to, params]);
        this.template.block.yields.add(to);
    };
    JavaScriptCompiler.prototype.debugger = function () {
        this.push(['debugger', null, null]);
    };
    JavaScriptCompiler.prototype.hasBlock = function (name) {
        this.pushValue(['has-block', name]);
        this.template.block.yields.add(name);
    };
    JavaScriptCompiler.prototype.hasBlockParams = function (name) {
        this.pushValue(['has-block-params', name]);
        this.template.block.yields.add(name);
    };
    JavaScriptCompiler.prototype.partial = function () {
        var params = this.popValue();
        this.push(['partial', params[0]]);
        this.template.block.hasPartials = true;
    };
    /// Expressions
    JavaScriptCompiler.prototype.literal = function (value) {
        if (value === undefined) {
            this.pushValue(['undefined']);
        }
        else {
            this.pushValue(value);
        }
    };
    JavaScriptCompiler.prototype.unknown = function (path) {
        this.pushValue(['unknown', path]);
    };
    JavaScriptCompiler.prototype.arg = function (path) {
        this.template.block.named.add(path[0]);
        this.pushValue(['arg', path]);
    };
    JavaScriptCompiler.prototype.get = function (path) {
        this.pushValue(['get', path]);
    };
    JavaScriptCompiler.prototype.concat = function () {
        this.pushValue(['concat', this.popValue()]);
    };
    JavaScriptCompiler.prototype.helper = function (path) {
        var params = this.popValue();
        var hash = this.popValue();
        this.pushValue(['helper', path, params, hash]);
    };
    /// Stack Management Opcodes
    JavaScriptCompiler.prototype.startComponent = function (blockParams) {
        var component = new ComponentBlock();
        component.positionals = blockParams;
        this.blocks.push(component);
    };
    JavaScriptCompiler.prototype.endComponent = function () {
        var component = this.blocks.pop();
        util_1.assert(component.type === 'component', "Compiler bug: endComponent() should end a component");
        return component.toJSON();
    };
    JavaScriptCompiler.prototype.prepareArray = function (size) {
        var values = [];
        for (var i = 0; i < size; i++) {
            values.push(this.popValue());
        }
        this.pushValue(values);
    };
    JavaScriptCompiler.prototype.prepareObject = function (size) {
        util_1.assert(this.values.length >= size, "Expected " + size + " values on the stack, found " + this.values.length);
        var keys = new Array(size);
        var values = new Array(size);
        for (var i = 0; i < size; i++) {
            keys[i] = this.popValue();
            values[i] = this.popValue();
        }
        this.pushValue([keys, values]);
    };
    /// Utilities
    JavaScriptCompiler.prototype.push = function (args) {
        while (args[args.length - 1] === null) {
            args.pop();
        }
        this.blocks.current.push(args);
    };
    JavaScriptCompiler.prototype.pushValue = function (val) {
        this.values.push(val);
    };
    JavaScriptCompiler.prototype.popValue = function () {
        util_1.assert(this.values.length, "No expression found on stack");
        return this.values.pop();
    };
    return JavaScriptCompiler;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = JavaScriptCompiler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiamF2YXNjcmlwdC1jb21waWxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkBnbGltbWVyL2NvbXBpbGVyL2xpYi9qYXZhc2NyaXB0LWNvbXBpbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHNDQUF1QztBQUN2QyxzQ0FBK0M7QUFFL0Msb0RBVzhCO0FBUTlCO0lBQUE7UUFDUyxTQUFJLEdBQUcsT0FBTyxDQUFDO1FBQ3RCLGVBQVUsR0FBZ0IsRUFBRSxDQUFDO1FBQzdCLGdCQUFXLEdBQWEsRUFBRSxDQUFDO0lBWTdCLENBQUM7SUFWQyxzQkFBTSxHQUFOO1FBQ0UsTUFBTSxDQUFDO1lBQ0wsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQzNCLE1BQU0sRUFBRSxJQUFJLENBQUMsV0FBVztTQUN6QixDQUFDO0lBQ0osQ0FBQztJQUVELG9CQUFJLEdBQUosVUFBSyxTQUFvQjtRQUN2QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBQ0gsWUFBQztBQUFELENBQUMsQUFmRCxJQWVDO0FBZlksc0JBQUs7QUFpQmxCO0lBQW1DLGlDQUFLO0lBQXhDO1FBQUEscUVBZ0JDO1FBZlEsVUFBSSxHQUFHLFVBQVUsQ0FBQztRQUNsQixZQUFNLEdBQUcsSUFBSSxjQUFPLEVBQVUsQ0FBQztRQUMvQixXQUFLLEdBQUcsSUFBSSxjQUFPLEVBQVUsQ0FBQztRQUM5QixZQUFNLEdBQXNCLEVBQUUsQ0FBQztRQUMvQixpQkFBVyxHQUFHLEtBQUssQ0FBQzs7SUFXN0IsQ0FBQztJQVRDLDhCQUFNLEdBQU47UUFDRSxNQUFNLENBQUM7WUFDTCxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDM0IsTUFBTSxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQ3hCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUMzQixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0s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SUFDSCx5QkFBQztBQUFELENBQUMsQUFoUEQsSUFnUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NlcnQgfSBmcm9tIFwiQGdsaW1tZXIvdXRpbFwiO1xuaW1wb3J0IHsgU3RhY2ssIERpY3RTZXQgfSBmcm9tIFwiQGdsaW1tZXIvdXRpbFwiO1xuXG5pbXBvcnQge1xuICBUZW1wbGF0ZU1ldGEsXG4gIFNlcmlhbGl6ZWRCbG9jayxcbiAgU2VyaWFsaXplZFRlbXBsYXRlQmxvY2ssXG4gIFNlcmlhbGl6ZWRUZW1wbGF0ZSxcbiAgU2VyaWFsaXplZENvbXBvbmVudCxcbiAgQ29yZSxcbiAgU3RhdGVtZW50LFxuICBTdGF0ZW1lbnRzLFxuICBFeHByZXNzaW9uLFxuICBFeHByZXNzaW9uc1xufSBmcm9tICdAZ2xpbW1lci93aXJlLWZvcm1hdCc7XG5cbmV4cG9ydCB0eXBlIHN0ciA9IHN0cmluZztcbmV4cG9ydCB0eXBlIFBhcmFtcyA9IENvcmUuUGFyYW1zO1xuZXhwb3J0IHR5cGUgSGFzaCA9IENvcmUuSGFzaDtcbmV4cG9ydCB0eXBlIFBhdGggPSBDb3JlLlBhdGg7XG5leHBvcnQgdHlwZSBTdGFja1ZhbHVlID0gRXhwcmVzc2lvbiB8IFBhcmFtcyB8IEhhc2ggfCBzdHI7XG5cbmV4cG9ydCBjbGFzcyBCbG9jayB7XG4gIHB1YmxpYyB0eXBlID0gXCJibG9ja1wiO1xuICBzdGF0ZW1lbnRzOiBTdGF0ZW1lbnRbXSA9IFtdO1xuICBwb3NpdGlvbmFsczogc3RyaW5nW10gPSBbXTtcblxuICB0b0pTT04oKTogU2VyaWFsaXplZEJsb2NrIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdGVtZW50czogdGhpcy5zdGF0ZW1lbnRzLFxuICAgICAgbG9jYWxzOiB0aGlzLnBvc2l0aW9uYWxzXG4gICAgfTtcbiAgfVxuXG4gIHB1c2goc3RhdGVtZW50OiBTdGF0ZW1lbnQpIHtcbiAgICB0aGlzLnN0YXRlbWVudHMucHVzaChzdGF0ZW1lbnQpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZUJsb2NrIGV4dGVuZHMgQmxvY2sge1xuICBwdWJsaWMgdHlwZSA9IFwidGVtcGxhdGVcIjtcbiAgcHVibGljIHlpZWxkcyA9IG5ldyBEaWN0U2V0PHN0cmluZz4oKTtcbiAgcHVibGljIG5hbWVkID0gbmV3IERpY3RTZXQ8c3RyaW5nPigpO1xuICBwdWJsaWMgYmxvY2tzOiBTZXJpYWxpemVkQmxvY2tbXSA9IFtdO1xuICBwdWJsaWMgaGFzUGFydGlhbHMgPSBmYWxzZTtcblxuICB0b0pTT04oKTogU2VyaWFsaXplZFRlbXBsYXRlQmxvY2sge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0ZW1lbnRzOiB0aGlzLnN0YXRlbWVudHMsXG4gICAgICBsb2NhbHM6IHRoaXMucG9zaXRpb25hbHMsXG4gICAgICBuYW1lZDogdGhpcy5uYW1lZC50b0FycmF5KCksXG4gICAgICB5aWVsZHM6IHRoaXMueWllbGRzLnRvQXJyYXkoKSxcbiAgICAgIGhhc1BhcnRpYWxzOiB0aGlzLmhhc1BhcnRpYWxzXG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQ29tcG9uZW50QmxvY2sgZXh0ZW5kcyBCbG9jayB7XG4gIHB1YmxpYyB0eXBlID0gXCJjb21wb25lbnRcIjtcbiAgcHVibGljIGF0dHJpYnV0ZXM6IFN0YXRlbWVudHMuQXR0cmlidXRlW10gPSBbXTtcbiAgcHVibGljIGFyZ3VtZW50czogU3RhdGVtZW50cy5Bcmd1bWVudFtdID0gW107XG4gIHByaXZhdGUgaW5QYXJhbXMgPSB0cnVlO1xuXG4gIHB1c2goc3RhdGVtZW50OiBTdGF0ZW1lbnQpIHtcbiAgICBpZiAodGhpcy5pblBhcmFtcykge1xuICAgICAgaWYgKFN0YXRlbWVudHMuaXNGbHVzaEVsZW1lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmluUGFyYW1zID0gZmFsc2U7XG4gICAgICB9IGVsc2UgaWYgKFN0YXRlbWVudHMuaXNBcmd1bWVudChzdGF0ZW1lbnQpKSB7XG4gICAgICAgIHRoaXMuYXJndW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgICAgIH0gZWxzZSBpZiAoU3RhdGVtZW50cy5pc0F0dHJpYnV0ZShzdGF0ZW1lbnQpKSB7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlcy5wdXNoKHN0YXRlbWVudCk7XG4gICAgICB9IGVsc2UgaWYgKFN0YXRlbWVudHMuaXNNb2RpZmllcihzdGF0ZW1lbnQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsZSBFcnJvcjogRWxlbWVudCBtb2RpZmllcnMgYXJlIG5vdCBhbGxvd2VkIGluIGNvbXBvbmVudHMnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsZSBFcnJvcjogb25seSBwYXJhbWV0ZXJzIGFsbG93ZWQgYmVmb3JlIGZsdXNoLWVsZW1lbnQnKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgICB9XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZENvbXBvbmVudCB7XG4gICAgbGV0IGFyZ3MgPSB0aGlzLmFyZ3VtZW50cztcbiAgICBsZXQga2V5cyA9IGFyZ3MubWFwKGFyZyA9PiBhcmdbMV0pO1xuICAgIGxldCB2YWx1ZXMgPSBhcmdzLm1hcChhcmcgPT4gYXJnWzJdKTtcblxuICAgIHJldHVybiB7XG4gICAgICBhdHRyczogdGhpcy5hdHRyaWJ1dGVzLFxuICAgICAgYXJnczogW2tleXMsIHZhbHVlc10sXG4gICAgICBsb2NhbHM6IHRoaXMucG9zaXRpb25hbHMsXG4gICAgICBzdGF0ZW1lbnRzOiB0aGlzLnN0YXRlbWVudHNcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZTxUIGV4dGVuZHMgVGVtcGxhdGVNZXRhPiB7XG4gIHB1YmxpYyBibG9jayA9IG5ldyBUZW1wbGF0ZUJsb2NrKCk7XG5cbiAgY29uc3RydWN0b3IocHVibGljIG1ldGE6IFQpIHt9XG5cbiAgdG9KU09OKCk6IFNlcmlhbGl6ZWRUZW1wbGF0ZTxUPiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGJsb2NrOiB0aGlzLmJsb2NrLnRvSlNPTigpLFxuICAgICAgbWV0YTogdGhpcy5tZXRhXG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBKYXZhU2NyaXB0Q29tcGlsZXI8VCBleHRlbmRzIFRlbXBsYXRlTWV0YT4ge1xuICBzdGF0aWMgcHJvY2VzczxUIGV4dGVuZHMgVGVtcGxhdGVNZXRhPihvcGNvZGVzLCBtZXRhKTogVGVtcGxhdGU8VD4ge1xuICAgIGxldCBjb21waWxlciA9IG5ldyBKYXZhU2NyaXB0Q29tcGlsZXI8VD4ob3Bjb2RlcywgbWV0YSk7XG4gICAgcmV0dXJuIGNvbXBpbGVyLnByb2Nlc3MoKTtcbiAgfVxuXG4gIHByaXZhdGUgdGVtcGxhdGU6IFRlbXBsYXRlPFQ+O1xuICBwcml2YXRlIGJsb2NrcyA9IG5ldyBTdGFjazxCbG9jaz4oKTtcbiAgcHJpdmF0ZSBvcGNvZGVzOiBhbnlbXTtcbiAgcHJpdmF0ZSB2YWx1ZXM6IFN0YWNrVmFsdWVbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKG9wY29kZXMsIG1ldGE6IFQpIHtcbiAgICB0aGlzLm9wY29kZXMgPSBvcGNvZGVzO1xuICAgIHRoaXMudGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUobWV0YSk7XG4gIH1cblxuICBwcm9jZXNzKCk6IFRlbXBsYXRlPFQ+IHtcbiAgICB0aGlzLm9wY29kZXMuZm9yRWFjaCgoW29wY29kZSwgLi4uYXJnc10pID0+IHtcbiAgICAgIGlmICghdGhpc1tvcGNvZGVdKSB7IHRocm93IG5ldyBFcnJvcihgdW5pbXBsZW1lbnRlZCAke29wY29kZX0gb24gSmF2YVNjcmlwdENvbXBpbGVyYCk7IH1cbiAgICAgIHRoaXNbb3Bjb2RlXSguLi5hcmdzKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLnRlbXBsYXRlO1xuICB9XG5cbiAgLy8vIE5lc3RpbmdcblxuICBzdGFydEJsb2NrKFtwcm9ncmFtXSkge1xuICAgIGxldCBibG9jazogQmxvY2sgPSBuZXcgQmxvY2soKTtcbiAgICBibG9jay5wb3NpdGlvbmFscyA9IHByb2dyYW0uYmxvY2tQYXJhbXM7XG4gICAgdGhpcy5ibG9ja3MucHVzaChibG9jayk7XG4gIH1cblxuICBlbmRCbG9jaygpIHtcbiAgICBsZXQgeyB0ZW1wbGF0ZSwgYmxvY2tzIH0gPSB0aGlzO1xuICAgIHRlbXBsYXRlLmJsb2NrLmJsb2Nrcy5wdXNoKGJsb2Nrcy5wb3AoKS50b0pTT04oKSk7XG4gIH1cblxuICBzdGFydFByb2dyYW0oKSB7XG4gICAgdGhpcy5ibG9ja3MucHVzaCh0aGlzLnRlbXBsYXRlLmJsb2NrKTtcbiAgfVxuXG4gIGVuZFByb2dyYW0oKSB7XG5cbiAgfVxuXG4gIC8vLyBTdGF0ZW1lbnRzXG5cbiAgdGV4dChjb250ZW50OiBzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2goWyd0ZXh0JywgY29udGVudF0pO1xuICB9XG5cbiAgYXBwZW5kKHRydXN0ZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLnB1c2goWydhcHBlbmQnLCB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCksIHRydXN0ZWRdKTtcbiAgfVxuXG4gIGNvbW1lbnQodmFsdWU6IHN0cmluZykge1xuICAgIHRoaXMucHVzaChbJ2NvbW1lbnQnLCB2YWx1ZV0pO1xuICB9XG5cbiAgbW9kaWZpZXIocGF0aDogUGF0aCkge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKTtcbiAgICBsZXQgaGFzaCA9IHRoaXMucG9wVmFsdWU8SGFzaD4oKTtcblxuICAgIHRoaXMucHVzaChbJ21vZGlmaWVyJywgcGF0aCwgcGFyYW1zLCBoYXNoXSk7XG4gIH1cblxuICBibG9jayhwYXRoOiBQYXRoLCB0ZW1wbGF0ZTogbnVtYmVyLCBpbnZlcnNlOiBudW1iZXIpIHtcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCk7XG4gICAgbGV0IGhhc2ggPSB0aGlzLnBvcFZhbHVlPEhhc2g+KCk7XG5cbiAgICBsZXQgYmxvY2tzID0gdGhpcy50ZW1wbGF0ZS5ibG9jay5ibG9ja3M7XG4gICAgYXNzZXJ0KHR5cGVvZiB0ZW1wbGF0ZSAhPT0gJ251bWJlcicgfHwgYmxvY2tzW3RlbXBsYXRlXSAhPT0gbnVsbCwgJ21pc3NpbmcgYmxvY2sgaW4gdGhlIGNvbXBpbGVyJyk7XG4gICAgYXNzZXJ0KHR5cGVvZiBpbnZlcnNlICE9PSAnbnVtYmVyJyB8fCBibG9ja3NbaW52ZXJzZV0gIT09IG51bGwsICdtaXNzaW5nIGJsb2NrIGluIHRoZSBjb21waWxlcicpO1xuXG4gICAgdGhpcy5wdXNoKFsnYmxvY2snLCBwYXRoLCBwYXJhbXMsIGhhc2gsIGJsb2Nrc1t0ZW1wbGF0ZV0sIGJsb2Nrc1tpbnZlcnNlXV0pO1xuICB9XG5cbiAgb3BlbkVsZW1lbnQodGFnOiBzdHIsIGJsb2NrUGFyYW1zOiBzdHJpbmdbXSkge1xuICAgIGlmICh0YWcuaW5kZXhPZignLScpICE9PSAtMSkge1xuICAgICAgdGhpcy5zdGFydENvbXBvbmVudChibG9ja1BhcmFtcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHVzaChbJ29wZW4tZWxlbWVudCcsIHRhZywgYmxvY2tQYXJhbXNdKTtcbiAgICB9XG4gIH1cblxuICBmbHVzaEVsZW1lbnQoKSB7XG4gICAgdGhpcy5wdXNoKFsnZmx1c2gtZWxlbWVudCddKTtcbiAgfVxuXG4gIGNsb3NlRWxlbWVudCh0YWc6IHN0cikge1xuICAgIGlmICh0YWcuaW5kZXhPZignLScpICE9PSAtMSkge1xuICAgICAgbGV0IGNvbXBvbmVudCA9IHRoaXMuZW5kQ29tcG9uZW50KCk7XG4gICAgICB0aGlzLnB1c2goWydjb21wb25lbnQnLCB0YWcsIGNvbXBvbmVudF0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1c2goWydjbG9zZS1lbGVtZW50J10pO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpY0F0dHIobmFtZTogc3RyLCBuYW1lc3BhY2U6IHN0cikge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goWydzdGF0aWMtYXR0cicsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2VdKTtcbiAgfVxuXG4gIGR5bmFtaWNBdHRyKG5hbWU6IHN0ciwgbmFtZXNwYWNlOiBzdHIpIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFsnZHluYW1pYy1hdHRyJywgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZV0pO1xuICB9XG5cbiAgdHJ1c3RpbmdBdHRyKG5hbWU6IHN0ciwgbmFtZXNwYWNlOiBzdHIpIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFsndHJ1c3RpbmctYXR0cicsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2VdKTtcbiAgfVxuXG4gIHN0YXRpY0FyZyhuYW1lOiBzdHIpIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFsnc3RhdGljLWFyZycsIG5hbWUuc2xpY2UoMSksIHZhbHVlXSk7XG4gIH1cblxuICBkeW5hbWljQXJnKG5hbWU6IHN0cikge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goWydkeW5hbWljLWFyZycsIG5hbWUuc2xpY2UoMSksIHZhbHVlXSk7XG4gIH1cblxuICB5aWVsZCh0bzogc3RyaW5nKSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIHRoaXMucHVzaChbJ3lpZWxkJywgdG8sIHBhcmFtc10pO1xuICAgIHRoaXMudGVtcGxhdGUuYmxvY2sueWllbGRzLmFkZCh0byk7XG4gIH1cblxuICBkZWJ1Z2dlcigpIHtcbiAgICB0aGlzLnB1c2goWydkZWJ1Z2dlcicsIG51bGwsIG51bGxdKTtcbiAgfVxuXG4gIGhhc0Jsb2NrKG5hbWU6IHN0cmluZykge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkhhc0Jsb2NrPihbJ2hhcy1ibG9jaycsIG5hbWVdKTtcbiAgICB0aGlzLnRlbXBsYXRlLmJsb2NrLnlpZWxkcy5hZGQobmFtZSk7XG4gIH1cblxuICBoYXNCbG9ja1BhcmFtcyhuYW1lOiBzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5IYXNCbG9ja1BhcmFtcz4oWydoYXMtYmxvY2stcGFyYW1zJywgbmFtZV0pO1xuICAgIHRoaXMudGVtcGxhdGUuYmxvY2sueWllbGRzLmFkZChuYW1lKTtcbiAgfVxuXG4gIHBhcnRpYWwoKSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIHRoaXMucHVzaChbJ3BhcnRpYWwnLCBwYXJhbXNbMF1dKTtcbiAgICB0aGlzLnRlbXBsYXRlLmJsb2NrLmhhc1BhcnRpYWxzID0gdHJ1ZTtcbiAgfVxuXG4gIC8vLyBFeHByZXNzaW9uc1xuXG4gIGxpdGVyYWwodmFsdWU6IEV4cHJlc3Npb25zLlZhbHVlIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLlVuZGVmaW5lZD4oWyd1bmRlZmluZWQnXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLlZhbHVlPih2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgdW5rbm93bihwYXRoOiBzdHJpbmdbXSkge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLlVua25vd24+KFsndW5rbm93bicsIHBhdGhdKTtcbiAgfVxuXG4gIGFyZyhwYXRoOiBzdHJpbmdbXSkge1xuICAgIHRoaXMudGVtcGxhdGUuYmxvY2submFtZWQuYWRkKHBhdGhbMF0pO1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkFyZz4oWydhcmcnLCBwYXRoXSk7XG4gIH1cblxuICBnZXQocGF0aDogc3RyaW5nW10pIHtcbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5HZXQ+KFsnZ2V0JywgcGF0aF0pO1xuICB9XG5cbiAgY29uY2F0KCkge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkNvbmNhdD4oWydjb25jYXQnLCB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKV0pO1xuICB9XG5cbiAgaGVscGVyKHBhdGg6IHN0cmluZ1tdKSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIGxldCBoYXNoID0gdGhpcy5wb3BWYWx1ZTxIYXNoPigpO1xuXG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuSGVscGVyPihbJ2hlbHBlcicsIHBhdGgsIHBhcmFtcywgaGFzaF0pO1xuICB9XG5cbiAgLy8vIFN0YWNrIE1hbmFnZW1lbnQgT3Bjb2Rlc1xuXG4gIHN0YXJ0Q29tcG9uZW50KGJsb2NrUGFyYW1zOiBzdHJpbmdbXSkge1xuICAgIGxldCBjb21wb25lbnQgPSBuZXcgQ29tcG9uZW50QmxvY2soKTtcbiAgICBjb21wb25lbnQucG9zaXRpb25hbHMgPSBibG9ja1BhcmFtcztcbiAgICB0aGlzLmJsb2Nrcy5wdXNoKGNvbXBvbmVudCk7XG4gIH1cblxuICBlbmRDb21wb25lbnQoKTogU2VyaWFsaXplZENvbXBvbmVudCB7XG4gICAgbGV0IGNvbXBvbmVudCA9IHRoaXMuYmxvY2tzLnBvcCgpO1xuICAgIGFzc2VydChjb21wb25lbnQudHlwZSA9PT0gJ2NvbXBvbmVudCcsIFwiQ29tcGlsZXIgYnVnOiBlbmRDb21wb25lbnQoKSBzaG91bGQgZW5kIGEgY29tcG9uZW50XCIpO1xuICAgIHJldHVybiAoY29tcG9uZW50IGFzIENvbXBvbmVudEJsb2NrKS50b0pTT04oKTtcbiAgfVxuXG4gIHByZXBhcmVBcnJheShzaXplOiBudW1iZXIpIHtcbiAgICBsZXQgdmFsdWVzID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykge1xuICAgICAgdmFsdWVzLnB1c2godGhpcy5wb3BWYWx1ZSgpKTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2hWYWx1ZTxQYXJhbXM+KHZhbHVlcyk7XG4gIH1cblxuICBwcmVwYXJlT2JqZWN0KHNpemU6IG51bWJlcikge1xuICAgIGFzc2VydCh0aGlzLnZhbHVlcy5sZW5ndGggPj0gc2l6ZSwgYEV4cGVjdGVkICR7c2l6ZX0gdmFsdWVzIG9uIHRoZSBzdGFjaywgZm91bmQgJHt0aGlzLnZhbHVlcy5sZW5ndGh9YCk7XG5cbiAgICBsZXQga2V5czogc3RyaW5nW10gPSBuZXcgQXJyYXkoc2l6ZSk7XG4gICAgbGV0IHZhbHVlczogRXhwcmVzc2lvbltdID0gbmV3IEFycmF5KHNpemUpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHtcbiAgICAgIGtleXNbaV0gPSB0aGlzLnBvcFZhbHVlPHN0cj4oKTtcbiAgICAgIHZhbHVlc1tpXSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2hWYWx1ZTxIYXNoPihba2V5cywgdmFsdWVzXSk7XG4gIH1cblxuICAvLy8gVXRpbGl0aWVzXG5cbiAgcHVzaChhcmdzOiBTdGF0ZW1lbnQpIHtcbiAgICB3aGlsZSAoYXJnc1thcmdzLmxlbmd0aCAtIDFdID09PSBudWxsKSB7XG4gICAgICBhcmdzLnBvcCgpO1xuICAgIH1cblxuICAgIHRoaXMuYmxvY2tzLmN1cnJlbnQucHVzaChhcmdzKTtcbiAgfVxuXG4gIHB1c2hWYWx1ZTxTIGV4dGVuZHMgRXhwcmVzc2lvbiB8IFBhcmFtcyB8IEhhc2g+KHZhbDogUykge1xuICAgIHRoaXMudmFsdWVzLnB1c2godmFsKTtcbiAgfVxuXG4gIHBvcFZhbHVlPFQgZXh0ZW5kcyBTdGFja1ZhbHVlPigpOiBUIHtcbiAgICBhc3NlcnQodGhpcy52YWx1ZXMubGVuZ3RoLCBcIk5vIGV4cHJlc3Npb24gZm91bmQgb24gc3RhY2tcIik7XG4gICAgcmV0dXJuIHRoaXMudmFsdWVzLnBvcCgpIGFzIFQ7XG4gIH1cbn1cbiJdfQ==