"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var sanitized_values_1 = require("./sanitized-values");
var props_1 = require("./props");
var helper_1 = require("./helper");
var content_1 = require("../compiled/opcodes/content");
function defaultManagers(element, attr, _isTrusting, _namespace) {
    var tagName = element.tagName;
    var isSVG = element.namespaceURI === helper_1.SVG_NAMESPACE;
    if (isSVG) {
        return defaultAttributeManagers(tagName, attr);
    }
    var _a = props_1.normalizeProperty(element, attr), type = _a.type, normalized = _a.normalized;
    if (type === 'attr') {
        return defaultAttributeManagers(tagName, normalized);
    }
    else {
        return defaultPropertyManagers(tagName, normalized);
    }
}
exports.defaultManagers = defaultManagers;
function defaultPropertyManagers(tagName, attr) {
    if (sanitized_values_1.requiresSanitization(tagName, attr)) {
        return new SafePropertyManager(attr);
    }
    if (isUserInputValue(tagName, attr)) {
        return exports.INPUT_VALUE_PROPERTY_MANAGER;
    }
    if (isOptionSelected(tagName, attr)) {
        return exports.OPTION_SELECTED_MANAGER;
    }
    return new PropertyManager(attr);
}
exports.defaultPropertyManagers = defaultPropertyManagers;
function defaultAttributeManagers(tagName, attr) {
    if (sanitized_values_1.requiresSanitization(tagName, attr)) {
        return new SafeAttributeManager(attr);
    }
    return new AttributeManager(attr);
}
exports.defaultAttributeManagers = defaultAttributeManagers;
function readDOMAttr(element, attr) {
    var isSVG = element.namespaceURI === helper_1.SVG_NAMESPACE;
    var _a = props_1.normalizeProperty(element, attr), type = _a.type, normalized = _a.normalized;
    if (isSVG) {
        return element.getAttribute(normalized);
    }
    if (type === 'attr') {
        return element.getAttribute(normalized);
    }
    {
        return element[normalized];
    }
}
exports.readDOMAttr = readDOMAttr;
;
var AttributeManager = (function () {
    function AttributeManager(attr) {
        this.attr = attr;
    }
    AttributeManager.prototype.setAttribute = function (env, element, value, namespace) {
        var dom = env.getAppendOperations();
        var normalizedValue = normalizeAttributeValue(value);
        if (!isAttrRemovalValue(normalizedValue)) {
            dom.setAttribute(element, this.attr, normalizedValue, namespace);
        }
    };
    AttributeManager.prototype.updateAttribute = function (env, element, value, namespace) {
        if (value === null || value === undefined || value === false) {
            if (namespace) {
                env.getDOM().removeAttributeNS(element, namespace, this.attr);
            }
            else {
                env.getDOM().removeAttribute(element, this.attr);
            }
        }
        else {
            this.setAttribute(env, element, value);
        }
    };
    return AttributeManager;
}());
exports.AttributeManager = AttributeManager;
;
var PropertyManager = (function (_super) {
    __extends(PropertyManager, _super);
    function PropertyManager() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyManager.prototype.setAttribute = function (_env, element, value, _namespace) {
        if (!isAttrRemovalValue(value)) {
            element[this.attr] = value;
        }
    };
    PropertyManager.prototype.removeAttribute = function (env, element, namespace) {
        // TODO this sucks but to preserve properties first and to meet current
        // semantics we must do this.
        var attr = this.attr;
        if (namespace) {
            env.getDOM().removeAttributeNS(element, namespace, attr);
        }
        else {
            env.getDOM().removeAttribute(element, attr);
        }
    };
    PropertyManager.prototype.updateAttribute = function (env, element, value, namespace) {
        // ensure the property is always updated
        element[this.attr] = value;
        if (isAttrRemovalValue(value)) {
            this.removeAttribute(env, element, namespace);
        }
    };
    return PropertyManager;
}(AttributeManager));
exports.PropertyManager = PropertyManager;
;
function normalizeAttributeValue(value) {
    if (value === false || value === undefined || value === null) {
        return null;
    }
    if (value === true) {
        return '';
    }
    // onclick function etc in SSR
    if (typeof value === 'function') {
        return null;
    }
    return String(value);
}
function isAttrRemovalValue(value) {
    return value === null || value === undefined;
}
var SafePropertyManager = (function (_super) {
    __extends(SafePropertyManager, _super);
    function SafePropertyManager() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    SafePropertyManager.prototype.setAttribute = function (env, element, value) {
        _super.prototype.setAttribute.call(this, env, element, sanitized_values_1.sanitizeAttributeValue(env, element, this.attr, value));
    };
    SafePropertyManager.prototype.updateAttribute = function (env, element, value) {
        _super.prototype.updateAttribute.call(this, env, element, sanitized_values_1.sanitizeAttributeValue(env, element, this.attr, value));
    };
    return SafePropertyManager;
}(PropertyManager));
function isUserInputValue(tagName, attribute) {
    return (tagName === 'INPUT' || tagName === 'TEXTAREA') && attribute === 'value';
}
var InputValuePropertyManager = (function (_super) {
    __extends(InputValuePropertyManager, _super);
    function InputValuePropertyManager() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    InputValuePropertyManager.prototype.setAttribute = function (_env, element, value) {
        var input = element;
        input.value = content_1.normalizeTextValue(value);
    };
    InputValuePropertyManager.prototype.updateAttribute = function (_env, element, value) {
        var input = element;
        var currentValue = input.value;
        var normalizedValue = content_1.normalizeTextValue(value);
        if (currentValue !== normalizedValue) {
            input.value = normalizedValue;
        }
    };
    return InputValuePropertyManager;
}(AttributeManager));
exports.INPUT_VALUE_PROPERTY_MANAGER = new InputValuePropertyManager('value');
function isOptionSelected(tagName, attribute) {
    return tagName === 'OPTION' && attribute === 'selected';
}
var OptionSelectedManager = (function (_super) {
    __extends(OptionSelectedManager, _super);
    function OptionSelectedManager() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    OptionSelectedManager.prototype.setAttribute = function (_env, element, value) {
        if (value !== null && value !== undefined && value !== false) {
            var option = element;
            option.selected = true;
        }
    };
    OptionSelectedManager.prototype.updateAttribute = function (_env, element, value) {
        var option = element;
        if (value) {
            option.selected = true;
        }
        else {
            option.selected = false;
        }
    };
    return OptionSelectedManager;
}(PropertyManager));
exports.OPTION_SELECTED_MANAGER = new OptionSelectedManager('selected');
var SafeAttributeManager = (function (_super) {
    __extends(SafeAttributeManager, _super);
    function SafeAttributeManager() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    SafeAttributeManager.prototype.setAttribute = function (env, element, value) {
        _super.prototype.setAttribute.call(this, env, element, sanitized_values_1.sanitizeAttributeValue(env, element, this.attr, value));
    };
    SafeAttributeManager.prototype.updateAttribute = function (env, element, value, _namespace) {
        _super.prototype.updateAttribute.call(this, env, element, sanitized_values_1.sanitizeAttributeValue(env, element, this.attr, value));
    };
    return SafeAttributeManager;
}(AttributeManager));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0cmlidXRlLW1hbmFnZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQGdsaW1tZXIvcnVudGltZS9saWIvZG9tL2F0dHJpYnV0ZS1tYW5hZ2Vycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFHQSx1REFHNEI7QUFDNUIsaUNBQTRDO0FBQzVDLG1DQUF5QztBQUN6Qyx1REFBaUU7QUFHakUseUJBQWdDLE9BQXVCLEVBQUUsSUFBWSxFQUFFLFdBQW9CLEVBQUUsVUFBMEI7SUFDckgsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztJQUM5QixJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsWUFBWSxLQUFLLHNCQUFhLENBQUM7SUFFbkQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNWLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVHLElBQUEsNkNBQXVELEVBQXJELGNBQUksRUFBRSwwQkFBVSxDQUFzQztJQUU1RCxFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNwQixNQUFNLENBQUMsd0JBQXdCLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDdEQsQ0FBQztBQUNILENBQUM7QUFmRCwwQ0FlQztBQUVELGlDQUF3QyxPQUFlLEVBQUUsSUFBWTtJQUNuRSxFQUFFLENBQUMsQ0FBQyx1Q0FBb0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sQ0FBQyxJQUFJLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxP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QUMsQ0FBQztJQUM5RixDQUFDO0lBQ0gsMkJBQUM7QUFBRCxDQUFDLEFBUkQsQ0FBbUMsZ0JBQWdCLEdBUWxEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRklYTUUsIE9wYXF1ZSwgT3B0aW9uLCBNYXliZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgRE9NTmFtZXNwYWNlIH0gZnJvbSAnLi9oZWxwZXInO1xuaW1wb3J0ICogYXMgU2ltcGxlIGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge1xuICBzYW5pdGl6ZUF0dHJpYnV0ZVZhbHVlLFxuICByZXF1aXJlc1Nhbml0aXphdGlvblxufSBmcm9tICcuL3Nhbml0aXplZC12YWx1ZXMnO1xuaW1wb3J0IHsgbm9ybWFsaXplUHJvcGVydHkgfSBmcm9tICcuL3Byb3BzJztcbmltcG9ydCB7IFNWR19OQU1FU1BBQ0UgfSBmcm9tICcuL2hlbHBlcic7XG5pbXBvcnQgeyBub3JtYWxpemVUZXh0VmFsdWUgfSBmcm9tICcuLi9jb21waWxlZC9vcGNvZGVzL2NvbnRlbnQnO1xuaW1wb3J0IHsgRW52aXJvbm1lbnQgfSBmcm9tICcuLi9lbnZpcm9ubWVudCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWZhdWx0TWFuYWdlcnMoZWxlbWVudDogU2ltcGxlLkVsZW1lbnQsIGF0dHI6IHN0cmluZywgX2lzVHJ1c3Rpbmc6IGJvb2xlYW4sIF9uYW1lc3BhY2U6IE9wdGlvbjxzdHJpbmc+KTogQXR0cmlidXRlTWFuYWdlciB7XG4gIGxldCB0YWdOYW1lID0gZWxlbWVudC50YWdOYW1lO1xuICBsZXQgaXNTVkcgPSBlbGVtZW50Lm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRTtcblxuICBpZiAoaXNTVkcpIHtcbiAgICByZXR1cm4gZGVmYXVsdEF0dHJpYnV0ZU1hbmFnZXJzKHRhZ05hbWUsIGF0dHIpO1xuICB9XG5cbiAgbGV0IHsgdHlwZSwgbm9ybWFsaXplZCB9ID0gbm9ybWFsaXplUHJvcGVydHkoZWxlbWVudCwgYXR0cik7XG5cbiAgaWYgKHR5cGUgPT09ICdhdHRyJykge1xuICAgIHJldHVybiBkZWZhdWx0QXR0cmlidXRlTWFuYWdlcnModGFnTmFtZSwgbm9ybWFsaXplZCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGRlZmF1bHRQcm9wZXJ0eU1hbmFnZXJzKHRhZ05hbWUsIG5vcm1hbGl6ZWQpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWZhdWx0UHJvcGVydHlNYW5hZ2Vycyh0YWdOYW1lOiBzdHJpbmcsIGF0dHI6IHN0cmluZyk6IEF0dHJpYnV0ZU1hbmFnZXIge1xuICBpZiAocmVxdWlyZXNTYW5pdGl6YXRpb24odGFnTmFtZSwgYXR0cikpIHtcbiAgICByZXR1cm4gbmV3IFNhZmVQcm9wZXJ0eU1hbmFnZXIoYXR0cik7XG4gIH1cblxuICBpZiAoaXNVc2VySW5wdXRWYWx1ZSh0YWdOYW1lLCBhdHRyKSkge1xuICAgIHJldHVybiBJTlBVVF9WQUxVRV9QUk9QRVJUWV9NQU5BR0VSO1xuICB9XG5cbiAgaWYgKGlzT3B0aW9uU2VsZWN0ZWQodGFnTmFtZSwgYXR0cikpIHtcbiAgICByZXR1cm4gT1BUSU9OX1NFTEVDVEVEX01BTkFHRVI7XG4gIH1cblxuICByZXR1cm4gbmV3IFByb3BlcnR5TWFuYWdlcihhdHRyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRBdHRyaWJ1dGVNYW5hZ2Vycyh0YWdOYW1lOiBzdHJpbmcsIGF0dHI6IHN0cmluZyk6IEF0dHJpYnV0ZU1hbmFnZXIge1xuICBpZiAocmVxdWlyZXNTYW5pdGl6YXRpb24odGFnTmFtZSwgYXR0cikpIHtcbiAgICByZXR1cm4gbmV3IFNhZmVBdHRyaWJ1dGVNYW5hZ2VyKGF0dHIpO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBBdHRyaWJ1dGVNYW5hZ2VyKGF0dHIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVhZERPTUF0dHIoZWxlbWVudDogRWxlbWVudCwgYXR0cjogc3RyaW5nKSB7XG4gIGxldCBpc1NWRyA9IGVsZW1lbnQubmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFO1xuICBsZXQgeyB0eXBlLCBub3JtYWxpemVkIH0gPSBub3JtYWxpemVQcm9wZXJ0eShlbGVtZW50LCBhdHRyKTtcblxuICBpZiAoaXNTVkcpIHtcbiAgICByZXR1cm4gZWxlbWVudC5nZXRBdHRyaWJ1dGUobm9ybWFsaXplZCk7XG4gIH1cblxuICBpZiAodHlwZSA9PT0gJ2F0dHInKSB7XG4gICAgcmV0dXJuIGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5vcm1hbGl6ZWQpO1xuICB9IHtcbiAgICByZXR1cm4gZWxlbWVudFtub3JtYWxpemVkXTtcbiAgfVxufTtcblxuZXhwb3J0IGNsYXNzIEF0dHJpYnV0ZU1hbmFnZXIge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgYXR0cjogc3RyaW5nKSB7fVxuXG4gIHNldEF0dHJpYnV0ZShlbnY6IEVudmlyb25tZW50LCBlbGVtZW50OiBTaW1wbGUuRWxlbWVudCwgdmFsdWU6IE9wYXF1ZSwgbmFtZXNwYWNlPzogRE9NTmFtZXNwYWNlKSB7XG4gICAgbGV0IGRvbSA9IGVudi5nZXRBcHBlbmRPcGVyYXRpb25zKCk7XG4gICAgbGV0IG5vcm1hbGl6ZWRWYWx1ZSA9IG5vcm1hbGl6ZUF0dHJpYnV0ZVZhbHVlKHZhbHVlKTtcblxuICAgIGlmICghaXNBdHRyUmVtb3ZhbFZhbHVlKG5vcm1hbGl6ZWRWYWx1ZSkpIHtcbiAgICAgIGRvbS5zZXRBdHRyaWJ1dGUoZWxlbWVudCwgdGhpcy5hdHRyLCBub3JtYWxpemVkVmFsdWUsIG5hbWVzcGFjZSk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlQXR0cmlidXRlKGVudjogRW52aXJvbm1lbnQsIGVsZW1lbnQ6IEVsZW1lbnQsIHZhbHVlOiBPcGFxdWUsIG5hbWVzcGFjZT86IERPTU5hbWVzcGFjZSkge1xuICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBmYWxzZSkge1xuICAgICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgICBlbnYuZ2V0RE9NKCkucmVtb3ZlQXR0cmlidXRlTlMoZWxlbWVudCwgbmFtZXNwYWNlLCB0aGlzLmF0dHIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZW52LmdldERPTSgpLnJlbW92ZUF0dHJpYnV0ZShlbGVtZW50LCB0aGlzLmF0dHIpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldEF0dHJpYnV0ZShlbnYsIGVsZW1lbnQsIHZhbHVlKTtcbiAgICB9XG4gIH1cbn07XG5cbmV4cG9ydCBjbGFzcyBQcm9wZXJ0eU1hbmFnZXIgZXh0ZW5kcyBBdHRyaWJ1dGVNYW5hZ2VyIHtcbiAgc2V0QXR0cmlidXRlKF9lbnY6IEVudmlyb25tZW50LCBlbGVtZW50OiBTaW1wbGUuRWxlbWVudCwgdmFsdWU6IE9wYXF1ZSwgX25hbWVzcGFjZT86IERPTU5hbWVzcGFjZSkge1xuICAgIGlmICghaXNBdHRyUmVtb3ZhbFZhbHVlKHZhbHVlKSkge1xuICAgICAgZWxlbWVudFt0aGlzLmF0dHJdID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHJlbW92ZUF0dHJpYnV0ZShlbnY6IEVudmlyb25tZW50LCBlbGVtZW50OiBFbGVtZW50LCBuYW1lc3BhY2U/OiBET01OYW1lc3BhY2UpIHtcbiAgICAvLyBUT0RPIHRoaXMgc3Vja3MgYnV0IHRvIHByZXNlcnZlIHByb3BlcnRpZXMgZmlyc3QgYW5kIHRvIG1lZXQgY3VycmVudFxuICAgIC8vIHNlbWFudGljcyB3ZSBtdXN0IGRvIHRoaXMuXG4gICAgbGV0IHsgYXR0ciB9ID0gdGhpcztcbiAgICBpZiAobmFtZXNwYWNlKSB7XG4gICAgICBlbnYuZ2V0RE9NKCkucmVtb3ZlQXR0cmlidXRlTlMoZWxlbWVudCwgbmFtZXNwYWNlLCBhdHRyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZW52LmdldERPTSgpLnJlbW92ZUF0dHJpYnV0ZShlbGVtZW50LCBhdHRyKTtcbiAgICB9XG4gIH1cblxuICB1cGRhdGVBdHRyaWJ1dGUoZW52OiBFbnZpcm9ubWVudCwgZWxlbWVudDogRWxlbWVudCwgdmFsdWU6IE9wYXF1ZSwgbmFtZXNwYWNlPzogRE9NTmFtZXNwYWNlKSB7XG4gICAgLy8gZW5zdXJlIHRoZSBwcm9wZXJ0eSBpcyBhbHdheXMgdXBkYXRlZFxuICAgIGVsZW1lbnRbdGhpcy5hdHRyXSA9IHZhbHVlO1xuXG4gICAgaWYgKGlzQXR0clJlbW92YWxWYWx1ZSh2YWx1ZSkpIHtcbiAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlKGVudiwgZWxlbWVudCwgbmFtZXNwYWNlKTtcbiAgICB9XG4gIH1cbn07XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZUF0dHJpYnV0ZVZhbHVlKHZhbHVlOiBPcGFxdWUpOiBPcHRpb248c3RyaW5nPiB7XG4gIGlmICh2YWx1ZSA9PT0gZmFsc2UgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGlmICh2YWx1ZSA9PT0gdHJ1ZSkge1xuICAgIHJldHVybiAnJztcbiAgfVxuICAvLyBvbmNsaWNrIGZ1bmN0aW9uIGV0YyBpbiBTU1JcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7XG59XG5cbmZ1bmN0aW9uIGlzQXR0clJlbW92YWxWYWx1ZTxUPih2YWx1ZTogTWF5YmU8VD4pOiB2YWx1ZSBpcyAobnVsbCB8IHVuZGVmaW5lZCkge1xuICByZXR1cm4gdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZDtcbn1cblxuY2xhc3MgU2FmZVByb3BlcnR5TWFuYWdlciBleHRlbmRzIFByb3BlcnR5TWFuYWdlciB7XG4gIHNldEF0dHJpYnV0ZShlbnY6IEVudmlyb25tZW50LCBlbGVtZW50OiBTaW1wbGUuRWxlbWVudCwgdmFsdWU6IE9wYXF1ZSkge1xuICAgIHN1cGVyLnNldEF0dHJpYnV0ZShlbnYsIGVsZW1lbnQsIHNhbml0aXplQXR0cmlidXRlVmFsdWUoZW52LCBlbGVtZW50LCB0aGlzLmF0dHIsIHZhbHVlKSk7XG4gIH1cblxuICB1cGRhdGVBdHRyaWJ1dGUoZW52OiBFbnZpcm9ubWVudCwgZWxlbWVudDogRWxlbWVudCwgdmFsdWU6IE9wYXF1ZSkge1xuICAgIHN1cGVyLnVwZGF0ZUF0dHJpYnV0ZShlbnYsIGVsZW1lbnQsIHNhbml0aXplQXR0cmlidXRlVmFsdWUoZW52LCBlbGVtZW50LCB0aGlzLmF0dHIsIHZhbHVlKSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNVc2VySW5wdXRWYWx1ZSh0YWdOYW1lOiBzdHJpbmcsIGF0dHJpYnV0ZTogc3RyaW5nKSB7XG4gIHJldHVybiAodGFnTmFtZSA9PT0gJ0lOUFVUJyB8fCB0YWdOYW1lID09PSAnVEVYVEFSRUEnKSAmJiBhdHRyaWJ1dGUgPT09ICd2YWx1ZSc7XG59XG5cbmNsYXNzIElucHV0VmFsdWVQcm9wZXJ0eU1hbmFnZXIgZXh0ZW5kcyBBdHRyaWJ1dGVNYW5hZ2VyIHtcbiAgc2V0QXR0cmlidXRlKF9lbnY6IEVudmlyb25tZW50LCBlbGVtZW50OiBTaW1wbGUuRWxlbWVudCwgdmFsdWU6IE9wYXF1ZSkge1xuICAgIGxldCBpbnB1dCA9IGVsZW1lbnQgYXMgRklYTUU8SFRNTElucHV0RWxlbWVudCwgXCJUaGlzIGJyZWFrcyBTU1JcIj47XG4gICAgaW5wdXQudmFsdWUgPSBub3JtYWxpemVUZXh0VmFsdWUodmFsdWUpO1xuICB9XG5cbiAgdXBkYXRlQXR0cmlidXRlKF9lbnY6IEVudmlyb25tZW50LCBlbGVtZW50OiBFbGVtZW50LCB2YWx1ZTogT3BhcXVlKSB7XG4gICAgbGV0IGlucHV0ID0gPEhUTUxJbnB1dEVsZW1lbnQ+ZWxlbWVudDtcbiAgICBsZXQgY3VycmVudFZhbHVlID0gaW5wdXQudmFsdWU7XG4gICAgbGV0IG5vcm1hbGl6ZWRWYWx1ZSA9IG5vcm1hbGl6ZVRleHRWYWx1ZSh2YWx1ZSk7XG4gICAgaWYgKGN1cnJlbnRWYWx1ZSAhPT0gbm9ybWFsaXplZFZhbHVlKSB7XG4gICAgICBpbnB1dC52YWx1ZSA9IG5vcm1hbGl6ZWRWYWx1ZTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IElOUFVUX1ZBTFVFX1BST1BFUlRZX01BTkFHRVI6IEF0dHJpYnV0ZU1hbmFnZXIgPSBuZXcgSW5wdXRWYWx1ZVByb3BlcnR5TWFuYWdlcigndmFsdWUnKTtcblxuZnVuY3Rpb24gaXNPcHRpb25TZWxlY3RlZCh0YWdOYW1lOiBzdHJpbmcsIGF0dHJpYnV0ZTogc3RyaW5nKSB7XG4gIHJldHVybiB0YWdOYW1lID09PSAnT1BUSU9OJyAmJiBhdHRyaWJ1dGUgPT09ICdzZWxlY3RlZCc7XG59XG5cbmNsYXNzIE9wdGlvblNlbGVjdGVkTWFuYWdlciBleHRlbmRzIFByb3BlcnR5TWFuYWdlciB7XG4gIHNldEF0dHJpYnV0ZShfZW52OiBFbnZpcm9ubWVudCwgZWxlbWVudDogU2ltcGxlLkVsZW1lbnQsIHZhbHVlOiBPcGFxdWUpIHtcbiAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gZmFsc2UpIHtcbiAgICAgIGxldCBvcHRpb24gPSA8SFRNTE9wdGlvbkVsZW1lbnQ+ZWxlbWVudDtcbiAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlQXR0cmlidXRlKF9lbnY6IEVudmlyb25tZW50LCBlbGVtZW50OiBFbGVtZW50LCB2YWx1ZTogT3BhcXVlKSB7XG4gICAgbGV0IG9wdGlvbiA9IDxIVE1MT3B0aW9uRWxlbWVudD5lbGVtZW50O1xuXG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICBvcHRpb24uc2VsZWN0ZWQgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBvcHRpb24uc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IE9QVElPTl9TRUxFQ1RFRF9NQU5BR0VSOiBBdHRyaWJ1dGVNYW5hZ2VyID0gbmV3IE9wdGlvblNlbGVjdGVkTWFuYWdlcignc2VsZWN0ZWQnKTtcblxuY2xhc3MgU2FmZUF0dHJpYnV0ZU1hbmFnZXIgZXh0ZW5kcyBBdHRyaWJ1dGVNYW5hZ2VyIHtcbiAgc2V0QXR0cmlidXRlKGVudjogRW52aXJvbm1lbnQsIGVsZW1lbnQ6IEVsZW1lbnQsIHZhbHVlOiBPcGFxdWUpIHtcbiAgICBzdXBlci5zZXRBdHRyaWJ1dGUoZW52LCBlbGVtZW50LCBzYW5pdGl6ZUF0dHJpYnV0ZVZhbHVlKGVudiwgZWxlbWVudCwgdGhpcy5hdHRyLCB2YWx1ZSkpO1xuICB9XG5cbiAgdXBkYXRlQXR0cmlidXRlKGVudjogRW52aXJvbm1lbnQsIGVsZW1lbnQ6IEVsZW1lbnQsIHZhbHVlOiBPcGFxdWUsIF9uYW1lc3BhY2U/OiBET01OYW1lc3BhY2UpIHtcbiAgICBzdXBlci51cGRhdGVBdHRyaWJ1dGUoZW52LCBlbGVtZW50LCBzYW5pdGl6ZUF0dHJpYnV0ZVZhbHVlKGVudiwgZWxlbWVudCwgdGhpcy5hdHRyLCB2YWx1ZSkpO1xuICB9XG59XG4iXX0=