"use strict";
var util_1 = require("@glimmer/util");
var CapturedFrame = (function () {
    function CapturedFrame(operand, args, condition) {
        this.operand = operand;
        this.args = args;
        this.condition = condition;
    }
    return CapturedFrame;
}());
exports.CapturedFrame = CapturedFrame;
var Frame = (function () {
    function Frame(ops, component, manager, shadow) {
        if (component === void 0) { component = null; }
        if (manager === void 0) { manager = null; }
        if (shadow === void 0) { shadow = null; }
        this.ops = ops;
        this.component = component;
        this.manager = manager;
        this.shadow = shadow;
        this.operand = null;
        this.immediate = null;
        this.args = null;
        this.callerScope = null;
        this.blocks = null;
        this.condition = null;
        this.iterator = null;
        this.key = null;
        this.ip = ops[0];
    }
    Frame.prototype.capture = function () {
        return new CapturedFrame(this.operand, this.args, this.condition);
    };
    Frame.prototype.restore = function (frame) {
        this.operand = frame['operand'];
        this.args = frame['args'];
        this.condition = frame['condition'];
    };
    return Frame;
}());
var FrameStack = (function () {
    function FrameStack() {
        this.frames = [];
        this.frame = null;
    }
    Object.defineProperty(FrameStack.prototype, "currentFrame", {
        get: function () {
            return this.frames[util_1.unwrap(this.frame)];
        },
        enumerable: true,
        configurable: true
    });
    FrameStack.prototype.push = function (ops, component, manager, shadow) {
        if (component === void 0) { component = null; }
        if (manager === void 0) { manager = null; }
        if (shadow === void 0) { shadow = null; }
        var frame = (this.frame === null) ? (this.frame = 0) : ++this.frame;
        if (this.frames.length <= frame) {
            this.frames.push(null);
        }
        this.frames[frame] = new Frame(ops, component, manager, shadow);
    };
    FrameStack.prototype.pop = function () {
        var _a = this, frames = _a.frames, frame = _a.frame;
        frames[util_1.expect(frame, 'only pop after pushing')] = null;
        this.frame = frame === 0 ? null : frame - 1;
    };
    FrameStack.prototype.capture = function () {
        return this.currentFrame.capture();
    };
    FrameStack.prototype.restore = function (frame) {
        this.currentFrame.restore(frame);
    };
    FrameStack.prototype.getOps = function () {
        return this.currentFrame.ops;
    };
    FrameStack.prototype.getCurrent = function () {
        return this.currentFrame.ip;
    };
    FrameStack.prototype.setCurrent = function (ip) {
        return this.currentFrame.ip = ip;
    };
    FrameStack.prototype.getOperand = function () {
        return util_1.unwrap(this.currentFrame.operand);
    };
    FrameStack.prototype.setOperand = function (operand) {
        return this.currentFrame.operand = operand;
    };
    FrameStack.prototype.getImmediate = function () {
        return this.currentFrame.immediate;
    };
    FrameStack.prototype.setImmediate = function (value) {
        return this.currentFrame.immediate = value;
    };
    // FIXME: These options are required in practice by the existing code, but
    // figure out why.
    FrameStack.prototype.getArgs = function () {
        return this.currentFrame.args;
    };
    FrameStack.prototype.setArgs = function (args) {
        return this.currentFrame.args = args;
    };
    FrameStack.prototype.getCondition = function () {
        return util_1.unwrap(this.currentFrame.condition);
    };
    FrameStack.prototype.setCondition = function (condition) {
        return this.currentFrame.condition = condition;
    };
    FrameStack.prototype.getIterator = function () {
        return util_1.unwrap(this.currentFrame.iterator);
    };
    FrameStack.prototype.setIterator = function (iterator) {
        return this.currentFrame.iterator = iterator;
    };
    FrameStack.prototype.getKey = function () {
        return this.currentFrame.key;
    };
    FrameStack.prototype.setKey = function (key) {
        return this.currentFrame.key = key;
    };
    FrameStack.prototype.getBlocks = function () {
        return util_1.unwrap(this.currentFrame.blocks);
    };
    FrameStack.prototype.setBlocks = function (blocks) {
        return this.currentFrame.blocks = blocks;
    };
    FrameStack.prototype.getCallerScope = function () {
        return util_1.unwrap(this.currentFrame.callerScope);
    };
    FrameStack.prototype.setCallerScope = function (callerScope) {
        return this.currentFrame.callerScope = callerScope;
    };
    FrameStack.prototype.getComponent = function () {
        return util_1.unwrap(this.currentFrame.component);
    };
    FrameStack.prototype.getManager = function () {
        return util_1.unwrap(this.currentFrame.manager);
    };
    FrameStack.prototype.getShadow = function () {
        return this.currentFrame.shadow;
    };
    FrameStack.prototype.goto = function (ip) {
        this.setCurrent(ip);
    };
    FrameStack.prototype.hasOpcodes = function () {
        return this.frame !== null;
    };
    FrameStack.prototype.nextStatement = function (env) {
        var ip = this.frames[util_1.unwrap(this.frame)].ip;
        var ops = this.getOps();
        if (ip <= ops[1]) {
            var program = env.program;
            this.setCurrent(ip + 4);
            return program.opcode(ip);
        }
        else {
            this.pop();
            return null;
        }
    };
    return FrameStack;
}());
exports.FrameStack = FrameStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJAZ2xpbW1lci9ydW50aW1lL2xpYi92bS9mcmFtZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsc0NBQThEO0FBTTlEO0lBQ0UsdUJBQ1MsT0FBbUMsRUFDbkMsSUFBMkIsRUFDM0IsU0FBcUM7UUFGckMsWUFBTyxHQUFQLE9BQU8sQ0FBNEI7UUFDbkMsU0FBSSxHQUFKLElBQUksQ0FBdUI7UUFDM0IsY0FBUyxHQUFULFNBQVMsQ0FBNEI7SUFDM0MsQ0FBQztJQUNOLG9CQUFDO0FBQUQsQ0FBQyxBQU5ELElBTUM7QUFOWSxzQ0FBYTtBQVExQjtJQVdFLGVBQ1MsR0FBVSxFQUNWLFNBQTJCLEVBQzNCLE9BQW1ELEVBQ25ELE1BQWtDO1FBRmxDLDBCQUFBLEVBQUEsZ0JBQTJCO1FBQzNCLHdCQUFBLEVBQUEsY0FBbUQ7UUFDbkQsdUJBQUEsRUFBQSxhQUFrQztRQUhsQyxRQUFHLEdBQUgsR0FBRyxDQUFPO1FBQ1YsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IsWUFBTyxHQUFQLE9BQU8sQ0FBNEM7UUFDbkQsV0FBTSxHQUFOLE1BQU0sQ0FBNEI7UUFiM0MsWUFBTyxHQUErQixJQUFJLENBQUM7UUFDM0MsY0FBUyxHQUFRLElBQUksQ0FBQztRQUN0QixTQUFJLEdBQTBCLElBQUksQ0FBQztRQUNuQyxnQkFBVyxHQUFrQixJQUFJLENBQUM7UUFDbEMsV0FBTSxHQUFtQixJQUFJLENBQUM7UUFDOUIsY0FBUyxHQUErQixJQUFJLENBQUM7UUFDN0MsYUFBUSxHQUE4QixJQUFJLENBQUM7UUFDM0MsUUFBRyxHQUFtQixJQUFJLENBQUM7UUFRekIsSUFBSSxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVELHVCQUFPLEdBQVA7UUFDRSxNQUFNLENBQUMsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsSUFB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LENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQixJQUFJLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDO1lBQzFCLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzVCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUNILGlCQUFDO0FBQUQsQ0FBQyxBQWhKRCxJQWdKQztBQWhKWSxnQ0FBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNjb3BlLCBFbnZpcm9ubWVudCwgT3Bjb2RlIH0gZnJvbSAnLi4vZW52aXJvbm1lbnQnO1xuaW1wb3J0IHsgUmVmZXJlbmNlLCBQYXRoUmVmZXJlbmNlLCBSZWZlcmVuY2VJdGVyYXRvciB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQgeyBUUlVTVCwgT3B0aW9uLCB1bndyYXAsIGV4cGVjdCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgSW5saW5lQmxvY2sgfSBmcm9tICcuLi9zY2FubmVyJztcbmltcG9ydCB7IEV2YWx1YXRlZEFyZ3MgfSBmcm9tICcuLi9jb21waWxlZC9leHByZXNzaW9ucy9hcmdzJztcbmltcG9ydCB7IFNsaWNlIH0gZnJvbSAnLi4vb3Bjb2Rlcyc7XG5pbXBvcnQgeyBDb21wb25lbnQsIENvbXBvbmVudE1hbmFnZXIgfSBmcm9tICcuLi9jb21wb25lbnQvaW50ZXJmYWNlcyc7XG5cbmV4cG9ydCBjbGFzcyBDYXB0dXJlZEZyYW1lIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIG9wZXJhbmQ6IE9wdGlvbjxQYXRoUmVmZXJlbmNlPGFueT4+LFxuICAgIHB1YmxpYyBhcmdzOiBPcHRpb248RXZhbHVhdGVkQXJncz4sXG4gICAgcHVibGljIGNvbmRpdGlvbjogT3B0aW9uPFJlZmVyZW5jZTxib29sZWFuPj5cbiAgKSB7fVxufVxuXG5jbGFzcyBGcmFtZSB7XG4gIGlwOiBudW1iZXI7XG4gIG9wZXJhbmQ6IE9wdGlvbjxQYXRoUmVmZXJlbmNlPGFueT4+ID0gbnVsbDtcbiAgaW1tZWRpYXRlOiBhbnkgPSBudWxsO1xuICBhcmdzOiBPcHRpb248RXZhbHVhdGVkQXJncz4gPSBudWxsO1xuICBjYWxsZXJTY29wZTogT3B0aW9uPFNjb3BlPiA9IG51bGw7XG4gIGJsb2NrczogT3B0aW9uPEJsb2Nrcz4gPSBudWxsO1xuICBjb25kaXRpb246IE9wdGlvbjxSZWZlcmVuY2U8Ym9vbGVhbj4+ID0gbnVsbDtcbiAgaXRlcmF0b3I6IE9wdGlvbjxSZWZlcmVuY2VJdGVyYXRvcj4gPSBudWxsO1xuICBrZXk6IE9wdGlvbjxzdHJpbmc+ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgb3BzOiBTbGljZSxcbiAgICBwdWJsaWMgY29tcG9uZW50OiBDb21wb25lbnQgPSBudWxsLFxuICAgIHB1YmxpYyBtYW5hZ2VyOiBPcHRpb248Q29tcG9uZW50TWFuYWdlcjxDb21wb25lbnQ+PiA9IG51bGwsXG4gICAgcHVibGljIHNoYWRvdzogT3B0aW9uPElubGluZUJsb2NrPiA9IG51bGxcbiAgKSB7XG4gICAgdGhpcy5pcCA9IG9wc1swXTtcbiAgfVxuXG4gIGNhcHR1cmUoKTogQ2FwdHVyZWRGcmFtZSB7XG4gICAgcmV0dXJuIG5ldyBDYXB0dXJlZEZyYW1lKHRoaXMub3BlcmFuZCwgdGhpcy5hcmdzLCB0aGlzLmNvbmRpdGlvbik7XG4gIH1cblxuICByZXN0b3JlKGZyYW1lOiBDYXB0dXJlZEZyYW1lKSB7XG4gICAgdGhpcy5vcGVyYW5kID0gZnJhbWVbJ29wZXJhbmQnXTtcbiAgICB0aGlzLmFyZ3MgPSBmcmFtZVsnYXJncyddO1xuICAgIHRoaXMuY29uZGl0aW9uID0gZnJhbWVbJ2NvbmRpdGlvbiddO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmxvY2tzIHtcbiAgZGVmYXVsdDogT3B0aW9uPElubGluZUJsb2NrPjtcbiAgaW52ZXJzZTogT3B0aW9uPElubGluZUJsb2NrPjtcbn1cblxuZXhwb3J0IGNsYXNzIEZyYW1lU3RhY2sge1xuICBwcml2YXRlIGZyYW1lczogRnJhbWVbXSA9IFtdO1xuICBwcml2YXRlIGZyYW1lOiBPcHRpb248bnVtYmVyPiA9IG51bGw7XG5cbiAgcHJpdmF0ZSBnZXQgY3VycmVudEZyYW1lKCk6IEZyYW1lIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZXNbdW53cmFwKHRoaXMuZnJhbWUpXTtcbiAgfVxuXG4gIHB1c2gob3BzOiBTbGljZSwgY29tcG9uZW50OiBDb21wb25lbnQgPSBudWxsLCBtYW5hZ2VyOiBPcHRpb248Q29tcG9uZW50TWFuYWdlcjxDb21wb25lbnQ+PiA9IG51bGwsIHNoYWRvdzogT3B0aW9uPElubGluZUJsb2NrPiA9IG51bGwpIHtcbiAgICBsZXQgZnJhbWUgPSAodGhpcy5mcmFtZSA9PT0gbnVsbCkgPyAodGhpcy5mcmFtZSA9IDApIDogKyt0aGlzLmZyYW1lO1xuXG4gICAgaWYgKHRoaXMuZnJhbWVzLmxlbmd0aCA8PSBmcmFtZSkge1xuICAgICAgdGhpcy5mcmFtZXMucHVzaChudWxsIGFzIFRSVVNUPEZyYW1lLCAndGhlIG51bGwgaXMgcmVwbGFjZWQgb24gdGhlIG5leHQgbGluZSc+KTtcbiAgICB9XG5cbiAgICB0aGlzLmZyYW1lc1tmcmFtZV0gPSBuZXcgRnJhbWUob3BzLCBjb21wb25lbnQsIG1hbmFnZXIsIHNoYWRvdyk7XG4gIH1cblxuICBwb3AoKSB7XG4gICAgbGV0IHsgZnJhbWVzLCBmcmFtZSB9ID0gdGhpcztcbiAgICBmcmFtZXNbZXhwZWN0KGZyYW1lLCAnb25seSBwb3AgYWZ0ZXIgcHVzaGluZycpXSA9IG51bGwgYXMgVFJVU1Q8RnJhbWUsIFwidGhpcyBmcmFtZSB3b24ndCBiZSBhY2Nlc3NlZCBhbnltb3JlXCI+O1xuICAgIHRoaXMuZnJhbWUgPSBmcmFtZSA9PT0gMCA/IG51bGwgOiBmcmFtZSAtIDE7XG4gIH1cblxuICBjYXB0dXJlKCk6IENhcHR1cmVkRnJhbWUge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5jYXB0dXJlKCk7XG4gIH1cblxuICByZXN0b3JlKGZyYW1lOiBDYXB0dXJlZEZyYW1lKSB7XG4gICAgdGhpcy5jdXJyZW50RnJhbWUucmVzdG9yZShmcmFtZSk7XG4gIH1cblxuICBnZXRPcHMoKTogU2xpY2Uge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5vcHM7XG4gIH1cblxuICBnZXRDdXJyZW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudEZyYW1lLmlwO1xuICB9XG5cbiAgc2V0Q3VycmVudChpcDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50RnJhbWUuaXAgPSBpcDtcbiAgfVxuXG4gIGdldE9wZXJhbmQ8VD4oKTogUGF0aFJlZmVyZW5jZTxUPiB7XG4gICAgcmV0dXJuIHVud3JhcCh0aGlzLmN1cnJlbnRGcmFtZS5vcGVyYW5kKTtcbiAgfVxuXG4gIHNldE9wZXJhbmQ8VD4ob3BlcmFuZDogUGF0aFJlZmVyZW5jZTxUPik6IFBhdGhSZWZlcmVuY2U8VD4ge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5vcGVyYW5kID0gb3BlcmFuZDtcbiAgfVxuXG4gIGdldEltbWVkaWF0ZTxUPigpOiBUIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50RnJhbWUuaW1tZWRpYXRlO1xuICB9XG5cbiAgc2V0SW1tZWRpYXRlPFQ+KHZhbHVlOiBUKTogVCB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudEZyYW1lLmltbWVkaWF0ZSA9IHZhbHVlO1xuICB9XG5cbiAgLy8gRklYTUU6IFRoZXNlIG9wdGlvbnMgYXJlIHJlcXVpcmVkIGluIHByYWN0aWNlIGJ5IHRoZSBleGlzdGluZyBjb2RlLCBidXRcbiAgLy8gZmlndXJlIG91dCB3aHkuXG5cbiAgZ2V0QXJncygpOiBPcHRpb248RXZhbHVhdGVkQXJncz4ge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5hcmdzO1xuICB9XG5cbiAgc2V0QXJncyhhcmdzOiBFdmFsdWF0ZWRBcmdzKTogRXZhbHVhdGVkQXJncyB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudEZyYW1lLmFyZ3MgPSBhcmdzO1xuICB9XG5cbiAgZ2V0Q29uZGl0aW9uKCk6IFJlZmVyZW5jZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHVud3JhcCh0aGlzLmN1cnJlbnRGcmFtZS5jb25kaXRpb24pO1xuICB9XG5cbiAgc2V0Q29uZGl0aW9uKGNvbmRpdGlvbjogUmVmZXJlbmNlPGJvb2xlYW4+KTogUmVmZXJlbmNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50RnJhbWUuY29uZGl0aW9uID0gY29uZGl0aW9uO1xuICB9XG5cbiAgZ2V0SXRlcmF0b3IoKTogUmVmZXJlbmNlSXRlcmF0b3Ige1xuICAgIHJldHVybiB1bndyYXAodGhpcy5jdXJyZW50RnJhbWUuaXRlcmF0b3IpO1xuICB9XG5cbiAgc2V0SXRlcmF0b3IoaXRlcmF0b3I6IFJlZmVyZW5jZUl0ZXJhdG9yKTogUmVmZXJlbmNlSXRlcmF0b3Ige1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5pdGVyYXRvciA9IGl0ZXJhdG9yO1xuICB9XG5cbiAgZ2V0S2V5KCk6IE9wdGlvbjxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50RnJhbWUua2V5O1xuICB9XG5cbiAgc2V0S2V5KGtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50RnJhbWUua2V5ID0ga2V5O1xuICB9XG5cbiAgZ2V0QmxvY2tzKCk6IEJsb2NrcyB7XG4gICAgcmV0dXJuIHVud3JhcCh0aGlzLmN1cnJlbnRGcmFtZS5ibG9ja3MpO1xuICB9XG5cbiAgc2V0QmxvY2tzKGJsb2NrczogQmxvY2tzKTogQmxvY2tzIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50RnJhbWUuYmxvY2tzID0gYmxvY2tzO1xuICB9XG5cbiAgZ2V0Q2FsbGVyU2NvcGUoKTogU2NvcGUge1xuICAgIHJldHVybiB1bndyYXAodGhpcy5jdXJyZW50RnJhbWUuY2FsbGVyU2NvcGUpO1xuICB9XG5cbiAgc2V0Q2FsbGVyU2NvcGUoY2FsbGVyU2NvcGU6IFNjb3BlKTogU2NvcGUge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5jYWxsZXJTY29wZSA9IGNhbGxlclNjb3BlO1xuICB9XG5cbiAgZ2V0Q29tcG9uZW50KCk6IENvbXBvbmVudCB7XG4gICAgcmV0dXJuIHVud3JhcCh0aGlzLmN1cnJlbnRGcmFtZS5jb21wb25lbnQpO1xuICB9XG5cbiAgZ2V0TWFuYWdlcigpOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudD4ge1xuICAgIHJldHVybiB1bndyYXAodGhpcy5jdXJyZW50RnJhbWUubWFuYWdlcik7XG4gIH1cblxuICBnZXRTaGFkb3coKTogT3B0aW9uPElubGluZUJsb2NrPiB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudEZyYW1lLnNoYWRvdztcbiAgfVxuXG4gIGdvdG8oaXA6IG51bWJlcikge1xuICAgIHRoaXMuc2V0Q3VycmVudChpcCk7XG4gIH1cblxuICBoYXNPcGNvZGVzKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmZyYW1lICE9PSBudWxsO1xuICB9XG5cbiAgbmV4dFN0YXRlbWVudChlbnY6IEVudmlyb25tZW50KTogT3B0aW9uPE9wY29kZT4ge1xuICAgIGxldCBpcCA9IHRoaXMuZnJhbWVzW3Vud3JhcCh0aGlzLmZyYW1lKV0uaXA7XG4gICAgbGV0IG9wcyA9IHRoaXMuZ2V0T3BzKCk7XG5cbiAgICBpZiAoaXAgPD0gb3BzWzFdKSB7XG4gICAgICBsZXQgcHJvZ3JhbSA9IGVudi5wcm9ncmFtO1xuICAgICAgdGhpcy5zZXRDdXJyZW50KGlwICsgNCk7XG4gICAgICByZXR1cm4gcHJvZ3JhbS5vcGNvZGUoaXApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBvcCgpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG59XG4iXX0=