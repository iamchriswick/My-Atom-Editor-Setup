"use strict";
var blocks_1 = require("./compiled/blocks");
var scanner_1 = require("./scanner");
var functions_1 = require("./syntax/functions");
var builder_1 = require("./compiled/opcodes/builder");
function compileLayout(compilable, env) {
    var builder = new ComponentLayoutBuilder(env);
    compilable.compile(builder);
    return builder.compile();
}
exports.compileLayout = compileLayout;
var ComponentLayoutBuilder = (function () {
    function ComponentLayoutBuilder(env) {
        this.env = env;
    }
    ComponentLayoutBuilder.prototype.wrapLayout = function (layout) {
        this.inner = new WrappedBuilder(this.env, layout);
    };
    ComponentLayoutBuilder.prototype.fromLayout = function (layout) {
        this.inner = new UnwrappedBuilder(this.env, layout);
    };
    ComponentLayoutBuilder.prototype.compile = function () {
        return this.inner.compile();
    };
    Object.defineProperty(ComponentLayoutBuilder.prototype, "tag", {
        get: function () {
            return this.inner.tag;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ComponentLayoutBuilder.prototype, "attrs", {
        get: function () {
            return this.inner.attrs;
        },
        enumerable: true,
        configurable: true
    });
    return ComponentLayoutBuilder;
}());
var WrappedBuilder = (function () {
    function WrappedBuilder(env, layout) {
        this.env = env;
        this.layout = layout;
        this.tag = new ComponentTagBuilder();
        this.attrs = new ComponentAttrsBuilder();
    }
    WrappedBuilder.prototype.compile = function () {
        //========DYNAMIC
        //        PutValue(TagExpr)
        //        Test
        //        JumpUnless(BODY)
        //        OpenDynamicPrimitiveElement
        //        DidCreateElement
        //        ...attr statements...
        //        FlushElement
        // BODY:  Noop
        //        ...body statements...
        //        PutValue(TagExpr)
        //        Test
        //        JumpUnless(END)
        //        CloseElement
        // END:   Noop
        //        DidRenderLayout
        //        Exit
        //
        //========STATIC
        //        OpenPrimitiveElementOpcode
        //        DidCreateElement
        //        ...attr statements...
        //        FlushElement
        //        ...body statements...
        //        CloseElement
        //        DidRenderLayout
        //        Exit
        var _a = this, env = _a.env, layout = _a.layout;
        var symbolTable = layout.symbolTable;
        var b = builder(env, layout.symbolTable);
        b.startLabels();
        var dynamicTag = this.tag.getDynamic();
        var staticTag;
        if (dynamicTag) {
            b.putValue(dynamicTag);
            b.test('simple');
            b.jumpUnless('BODY');
            b.openDynamicPrimitiveElement();
            b.didCreateElement();
            this.attrs['buffer'].forEach(function (statement) { return scanner_1.compileStatement(statement, b); });
            b.flushElement();
            b.label('BODY');
        }
        else if (staticTag = this.tag.getStatic()) {
            b.openPrimitiveElement(staticTag);
            b.didCreateElement();
            this.attrs['buffer'].forEach(function (statement) { return scanner_1.compileStatement(statement, b); });
            b.flushElement();
        }
        b.preludeForLayout(layout);
        layout.statements.forEach(function (statement) { return scanner_1.compileStatement(statement, b); });
        if (dynamicTag) {
            b.putValue(dynamicTag);
            b.test('simple');
            b.jumpUnless('END');
            b.closeElement();
            b.label('END');
        }
        else if (staticTag) {
            b.closeElement();
        }
        b.didRenderLayout();
        b.stopLabels();
        return new blocks_1.CompiledProgram(b.toSlice(), symbolTable.size);
    };
    return WrappedBuilder;
}());
function isOpenElement(value) {
    var type = value[0];
    return type === 'open-element' || type === 'open-primitive-element';
}
var UnwrappedBuilder = (function () {
    function UnwrappedBuilder(env, layout) {
        this.env = env;
        this.layout = layout;
        this.attrs = new ComponentAttrsBuilder();
    }
    Object.defineProperty(UnwrappedBuilder.prototype, "tag", {
        get: function () {
            throw new Error('BUG: Cannot call `tag` on an UnwrappedBuilder');
        },
        enumerable: true,
        configurable: true
    });
    UnwrappedBuilder.prototype.compile = function () {
        var _a = this, env = _a.env, layout = _a.layout;
        var b = builder(env, layout.symbolTable);
        b.startLabels();
        b.preludeForLayout(layout);
        var attrs = this.attrs['buffer'];
        var attrsInserted = false;
        for (var i = 0; i < layout.statements.length; i++) {
            var statement = layout.statements[i];
            if (!attrsInserted && isOpenElement(statement)) {
                b.openComponentElement(statement[1]);
                b.didCreateElement();
                b.shadowAttributes();
                attrs.forEach(function (statement) { return scanner_1.compileStatement(statement, b); });
                attrsInserted = true;
            }
            else {
                scanner_1.compileStatement(statement, b);
            }
        }
        b.didRenderLayout();
        b.stopLabels();
        return new blocks_1.CompiledProgram(b.toSlice(), layout.symbolTable.size);
    };
    return UnwrappedBuilder;
}());
var ComponentTagBuilder = (function () {
    function ComponentTagBuilder() {
        this.isDynamic = null;
        this.isStatic = null;
        this.staticTagName = null;
        this.dynamicTagName = null;
    }
    ComponentTagBuilder.prototype.getDynamic = function () {
        if (this.isDynamic) {
            return this.dynamicTagName;
        }
    };
    ComponentTagBuilder.prototype.getStatic = function () {
        if (this.isStatic) {
            return this.staticTagName;
        }
    };
    ComponentTagBuilder.prototype.static = function (tagName) {
        this.isStatic = true;
        this.staticTagName = tagName;
    };
    ComponentTagBuilder.prototype.dynamic = function (tagName) {
        this.isDynamic = true;
        this.dynamicTagName = ['function', tagName];
    };
    return ComponentTagBuilder;
}());
var ComponentAttrsBuilder = (function () {
    function ComponentAttrsBuilder() {
        this.buffer = [];
    }
    ComponentAttrsBuilder.prototype.static = function (name, value) {
        this.buffer.push(['static-attr', name, value, null]);
    };
    ComponentAttrsBuilder.prototype.dynamic = function (name, value) {
        this.buffer.push(['dynamic-attr', name, ['function', value], null]);
    };
    return ComponentAttrsBuilder;
}());
var ComponentBuilder = (function () {
    function ComponentBuilder(builder) {
        this.builder = builder;
        this.env = builder.env;
    }
    ComponentBuilder.prototype.static = function (definition, args, _symbolTable, shadow) {
        this.builder.unit(function (b) {
            b.putComponentDefinition(definition);
            b.openComponent(functions_1.compileBaselineArgs(args, b), shadow);
            b.closeComponent();
        });
    };
    ComponentBuilder.prototype.dynamic = function (definitionArgs, definition, args, _symbolTable, shadow) {
        this.builder.unit(function (b) {
            b.putArgs(functions_1.compileArgs(definitionArgs[0], definitionArgs[1], b));
            b.putValue(['function', definition]);
            b.test('simple');
            b.enter('BEGIN', 'END');
            b.label('BEGIN');
            b.jumpUnless('END');
            b.putDynamicComponentDefinition();
            b.openComponent(functions_1.compileBaselineArgs(args, b), shadow);
            b.closeComponent();
            b.label('END');
            b.exit();
        });
    };
    return ComponentBuilder;
}());
exports.ComponentBuilder = ComponentBuilder;
function builder(env, symbolTable) {
    return new builder_1.default(symbolTable, env);
}
exports.builder = builder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJAZ2xpbW1lci9ydW50aW1lL2xpYi9jb21waWxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsNENBQW9EO0FBR3BELHFDQUttQjtBQVFuQixnREFHNEI7QUFNNUIsc0RBQTBEO0FBVTFELHVCQUE4QixVQUE0QixFQUFFLEdBQWdCO0lBQzFFLElBQUksT0FBTyxHQUFHLElBQUksc0JBQXNCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFOUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUU1QixNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzNCLENBQUM7QUFORCxzQ0FNQztBQUVEO0lBR0UsZ0NBQW1CLEdBQWdCO1FBQWhCLFFBQUcsR0FBSCxHQUFHLENBQWE7SUFBRyxDQUFDO0lBRXZDLDJDQUFVLEdBQVYsVUFBVyxNQUFjO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsMkNBQVUsR0FBVixVQUFXLE1BQWM7UUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELHdDQUFPLEdBQVA7UUFDRSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQsc0JBQUksdUNBQUc7YUFBUDtZQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUN4QixDQUFDOzs7T0FBQTtJQUVELHNCQUFJLHlDQUFLO2FBQVQ7WUFDRSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFDMUIsQ0FBQzs7O09BQUE7SUFDSCw2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LENBQUM7WUFDakIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNqQixDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BCLENBQUMsQ0FBQyw2QkFBNkIsRUFBRSxDQUFDO1lBQ2xDLENBQUMsQ0FBQyxhQUFhLENBQUMsK0JBQW1CLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3RELENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNuQixDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2YsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0gsdUJBQUM7QUFBRCxDQUFDLEFBOUJELElBOEJDO0FBOUJZLDRDQUFnQjtBQWdDN0IsaUJBQStDLEdBQWdCLEVBQUUsV0FBYztJQUM3RSxNQUFNLENBQUMsSUFBSSxpQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDaEQsQ0FBQztBQUZELDBCQUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW52aXJvbm1lbnQgfSBmcm9tICcuL2Vudmlyb25tZW50JztcbmltcG9ydCB7IFN5bWJvbFRhYmxlIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBDb21waWxlZFByb2dyYW0gfSBmcm9tICcuL2NvbXBpbGVkL2Jsb2Nrcyc7XG5pbXBvcnQgeyBNYXliZSwgT3B0aW9uIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5cbmltcG9ydCB7XG4gIEJhc2VsaW5lU3ludGF4LFxuICBMYXlvdXQsXG4gIElubGluZUJsb2NrLFxuICBjb21waWxlU3RhdGVtZW50XG59IGZyb20gJy4vc2Nhbm5lcic7XG5cbmltcG9ydCB7XG4gIENvbXBvbmVudEJ1aWxkZXIgYXMgSUNvbXBvbmVudEJ1aWxkZXIsXG4gIER5bmFtaWNEZWZpbml0aW9uLFxuICBTdGF0aWNEZWZpbml0aW9uXG59IGZyb20gJy4vb3Bjb2RlLWJ1aWxkZXInO1xuXG5pbXBvcnQge1xuICBjb21waWxlQXJncyxcbiAgY29tcGlsZUJhc2VsaW5lQXJnc1xufSBmcm9tICcuL3N5bnRheC9mdW5jdGlvbnMnO1xuXG5pbXBvcnQge1xuICBGdW5jdGlvbkV4cHJlc3Npb25cbn0gZnJvbSAnLi9jb21waWxlZC9leHByZXNzaW9ucy9mdW5jdGlvbic7XG5cbmltcG9ydCBPcGNvZGVCdWlsZGVyRFNMIGZyb20gJy4vY29tcGlsZWQvb3Bjb2Rlcy9idWlsZGVyJztcblxuaW1wb3J0ICogYXMgQ29tcG9uZW50IGZyb20gJy4vY29tcG9uZW50L2ludGVyZmFjZXMnO1xuXG5pbXBvcnQgKiBhcyBXaXJlRm9ybWF0IGZyb20gJ0BnbGltbWVyL3dpcmUtZm9ybWF0JztcblxuZXhwb3J0IGludGVyZmFjZSBDb21waWxhYmxlTGF5b3V0IHtcbiAgY29tcGlsZShidWlsZGVyOiBDb21wb25lbnQuQ29tcG9uZW50TGF5b3V0QnVpbGRlcik6IHZvaWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21waWxlTGF5b3V0KGNvbXBpbGFibGU6IENvbXBpbGFibGVMYXlvdXQsIGVudjogRW52aXJvbm1lbnQpOiBDb21waWxlZFByb2dyYW0ge1xuICBsZXQgYnVpbGRlciA9IG5ldyBDb21wb25lbnRMYXlvdXRCdWlsZGVyKGVudik7XG5cbiAgY29tcGlsYWJsZS5jb21waWxlKGJ1aWxkZXIpO1xuXG4gIHJldHVybiBidWlsZGVyLmNvbXBpbGUoKTtcbn1cblxuY2xhc3MgQ29tcG9uZW50TGF5b3V0QnVpbGRlciBpbXBsZW1lbnRzIENvbXBvbmVudC5Db21wb25lbnRMYXlvdXRCdWlsZGVyIHtcbiAgcHJpdmF0ZSBpbm5lcjogV3JhcHBlZEJ1aWxkZXIgfCBVbndyYXBwZWRCdWlsZGVyO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlbnY6IEVudmlyb25tZW50KSB7fVxuXG4gIHdyYXBMYXlvdXQobGF5b3V0OiBMYXlvdXQpIHtcbiAgICB0aGlzLmlubmVyID0gbmV3IFdyYXBwZWRCdWlsZGVyKHRoaXMuZW52LCBsYXlvdXQpO1xuICB9XG5cbiAgZnJvbUxheW91dChsYXlvdXQ6IExheW91dCkge1xuICAgIHRoaXMuaW5uZXIgPSBuZXcgVW53cmFwcGVkQnVpbGRlcih0aGlzLmVudiwgbGF5b3V0KTtcbiAgfVxuXG4gIGNvbXBpbGUoKTogQ29tcGlsZWRQcm9ncmFtIHtcbiAgICByZXR1cm4gdGhpcy5pbm5lci5jb21waWxlKCk7XG4gIH1cblxuICBnZXQgdGFnKCk6IENvbXBvbmVudC5Db21wb25lbnRUYWdCdWlsZGVyIHtcbiAgICByZXR1cm4gdGhpcy5pbm5lci50YWc7XG4gIH1cblxuICBnZXQgYXR0cnMoKTogQ29tcG9uZW50LkNvbXBvbmVudEF0dHJzQnVpbGRlciB7XG4gICAgcmV0dXJuIHRoaXMuaW5uZXIuYXR0cnM7XG4gIH1cbn1cblxuY2xhc3MgV3JhcHBlZEJ1aWxkZXIge1xuICBwdWJsaWMgdGFnID0gbmV3IENvbXBvbmVudFRhZ0J1aWxkZXIoKTtcbiAgcHVibGljIGF0dHJzID0gbmV3IENvbXBvbmVudEF0dHJzQnVpbGRlcigpO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlbnY6IEVudmlyb25tZW50LCBwcml2YXRlIGxheW91dDogTGF5b3V0KSB7fVxuXG4gIGNvbXBpbGUoKTogQ29tcGlsZWRQcm9ncmFtIHtcbiAgICAvLz09PT09PT09RFlOQU1JQ1xuICAgIC8vICAgICAgICBQdXRWYWx1ZShUYWdFeHByKVxuICAgIC8vICAgICAgICBUZXN0XG4gICAgLy8gICAgICAgIEp1bXBVbmxlc3MoQk9EWSlcbiAgICAvLyAgICAgICAgT3BlbkR5bmFtaWNQcmltaXRpdmVFbGVtZW50XG4gICAgLy8gICAgICAgIERpZENyZWF0ZUVsZW1lbnRcbiAgICAvLyAgICAgICAgLi4uYXR0ciBzdGF0ZW1lbnRzLi4uXG4gICAgLy8gICAgICAgIEZsdXNoRWxlbWVudFxuICAgIC8vIEJPRFk6ICBOb29wXG4gICAgLy8gICAgICAgIC4uLmJvZHkgc3RhdGVtZW50cy4uLlxuICAgIC8vICAgICAgICBQdXRWYWx1ZShUYWdFeHByKVxuICAgIC8vICAgICAgICBUZXN0XG4gICAgLy8gICAgICAgIEp1bXBVbmxlc3MoRU5EKVxuICAgIC8vICAgICAgICBDbG9zZUVsZW1lbnRcbiAgICAvLyBFTkQ6ICAgTm9vcFxuICAgIC8vICAgICAgICBEaWRSZW5kZXJMYXlvdXRcbiAgICAvLyAgICAgICAgRXhpdFxuICAgIC8vXG4gICAgLy89PT09PT09PVNUQVRJQ1xuICAgIC8vICAgICAgICBPcGVuUHJpbWl0aXZlRWxlbWVudE9wY29kZVxuICAgIC8vICAgICAgICBEaWRDcmVhdGVFbGVtZW50XG4gICAgLy8gICAgICAgIC4uLmF0dHIgc3RhdGVtZW50cy4uLlxuICAgIC8vICAgICAgICBGbHVzaEVsZW1lbnRcbiAgICAvLyAgICAgICAgLi4uYm9keSBzdGF0ZW1lbnRzLi4uXG4gICAgLy8gICAgICAgIENsb3NlRWxlbWVudFxuICAgIC8vICAgICAgICBEaWRSZW5kZXJMYXlvdXRcbiAgICAvLyAgICAgICAgRXhpdFxuXG4gICAgbGV0IHsgZW52LCBsYXlvdXQgfSA9IHRoaXM7XG5cbiAgICBsZXQgc3ltYm9sVGFibGUgPSBsYXlvdXQuc3ltYm9sVGFibGU7XG4gICAgbGV0IGIgPSBidWlsZGVyKGVudiwgbGF5b3V0LnN5bWJvbFRhYmxlKTtcblxuICAgIGIuc3RhcnRMYWJlbHMoKTtcblxuICAgIGxldCBkeW5hbWljVGFnID0gdGhpcy50YWcuZ2V0RHluYW1pYygpO1xuICAgIGxldCBzdGF0aWNUYWc6IE1heWJlPHN0cmluZz47XG5cbiAgICBpZiAoZHluYW1pY1RhZykge1xuICAgICAgYi5wdXRWYWx1ZShkeW5hbWljVGFnKTtcbiAgICAgIGIudGVzdCgnc2ltcGxlJyk7XG4gICAgICBiLmp1bXBVbmxlc3MoJ0JPRFknKTtcbiAgICAgIGIub3BlbkR5bmFtaWNQcmltaXRpdmVFbGVtZW50KCk7XG4gICAgICBiLmRpZENyZWF0ZUVsZW1lbnQoKTtcbiAgICAgIHRoaXMuYXR0cnNbJ2J1ZmZlciddLmZvckVhY2goc3RhdGVtZW50ID0+IGNvbXBpbGVTdGF0ZW1lbnQoc3RhdGVtZW50LCBiKSk7XG4gICAgICBiLmZsdXNoRWxlbWVudCgpO1xuICAgICAgYi5sYWJlbCgnQk9EWScpO1xuICAgIH0gZWxzZSBpZiAoc3RhdGljVGFnID0gdGhpcy50YWcuZ2V0U3RhdGljKCkpIHtcbiAgICAgIGIub3BlblByaW1pdGl2ZUVsZW1lbnQoc3RhdGljVGFnKTtcbiAgICAgIGIuZGlkQ3JlYXRlRWxlbWVudCgpO1xuICAgICAgdGhpcy5hdHRyc1snYnVmZmVyJ10uZm9yRWFjaChzdGF0ZW1lbnQgPT4gY29tcGlsZVN0YXRlbWVudChzdGF0ZW1lbnQsIGIpKTtcbiAgICAgIGIuZmx1c2hFbGVtZW50KCk7XG4gICAgfVxuXG4gICAgYi5wcmVsdWRlRm9yTGF5b3V0KGxheW91dCk7XG5cbiAgICBsYXlvdXQuc3RhdGVtZW50cy5mb3JFYWNoKHN0YXRlbWVudCA9PiBjb21waWxlU3RhdGVtZW50KHN0YXRlbWVudCwgYikpO1xuXG4gICAgaWYgKGR5bmFtaWNUYWcpIHtcbiAgICAgIGIucHV0VmFsdWUoZHluYW1pY1RhZyk7XG4gICAgICBiLnRlc3QoJ3NpbXBsZScpO1xuICAgICAgYi5qdW1wVW5sZXNzKCdFTkQnKTtcbiAgICAgIGIuY2xvc2VFbGVtZW50KCk7XG4gICAgICBiLmxhYmVsKCdFTkQnKTtcbiAgICB9IGVsc2UgaWYgKHN0YXRpY1RhZykge1xuICAgICAgYi5jbG9zZUVsZW1lbnQoKTtcbiAgICB9XG5cbiAgICBiLmRpZFJlbmRlckxheW91dCgpO1xuICAgIGIuc3RvcExhYmVscygpO1xuXG4gICAgcmV0dXJuIG5ldyBDb21waWxlZFByb2dyYW0oYi50b1NsaWNlKCksIHN5bWJvbFRhYmxlLnNpemUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzT3BlbkVsZW1lbnQodmFsdWU6IEJhc2VsaW5lU3ludGF4LkFueVN0YXRlbWVudCk6IHZhbHVlIGlzIChCYXNlbGluZVN5bnRheC5PcGVuUHJpbWl0aXZlRWxlbWVudCB8IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5PcGVuRWxlbWVudCkge1xuICBsZXQgdHlwZSA9IHZhbHVlWzBdO1xuICByZXR1cm4gdHlwZSA9PT0gJ29wZW4tZWxlbWVudCcgfHwgdHlwZSA9PT0gJ29wZW4tcHJpbWl0aXZlLWVsZW1lbnQnO1xufVxuXG5jbGFzcyBVbndyYXBwZWRCdWlsZGVyIHtcbiAgcHVibGljIGF0dHJzID0gbmV3IENvbXBvbmVudEF0dHJzQnVpbGRlcigpO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlbnY6IEVudmlyb25tZW50LCBwcml2YXRlIGxheW91dDogTGF5b3V0KSB7fVxuXG4gIGdldCB0YWcoKTogQ29tcG9uZW50LkNvbXBvbmVudFRhZ0J1aWxkZXIge1xuICAgIHRocm93IG5ldyBFcnJvcignQlVHOiBDYW5ub3QgY2FsbCBgdGFnYCBvbiBhbiBVbndyYXBwZWRCdWlsZGVyJyk7XG4gIH1cblxuICBjb21waWxlKCk6IENvbXBpbGVkUHJvZ3JhbSB7XG4gICAgbGV0IHsgZW52LCBsYXlvdXQgfSA9IHRoaXM7XG5cbiAgICBsZXQgYiA9IGJ1aWxkZXIoZW52LCBsYXlvdXQuc3ltYm9sVGFibGUpO1xuXG4gICAgYi5zdGFydExhYmVscygpO1xuXG4gICAgYi5wcmVsdWRlRm9yTGF5b3V0KGxheW91dCk7XG5cbiAgICBsZXQgYXR0cnMgPSB0aGlzLmF0dHJzWydidWZmZXInXTtcbiAgICBsZXQgYXR0cnNJbnNlcnRlZCA9IGZhbHNlO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXlvdXQuc3RhdGVtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHN0YXRlbWVudCA9IGxheW91dC5zdGF0ZW1lbnRzW2ldO1xuICAgICAgaWYgKCFhdHRyc0luc2VydGVkICYmIGlzT3BlbkVsZW1lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICBiLm9wZW5Db21wb25lbnRFbGVtZW50KHN0YXRlbWVudFsxXSk7XG4gICAgICAgIGIuZGlkQ3JlYXRlRWxlbWVudCgpO1xuICAgICAgICBiLnNoYWRvd0F0dHJpYnV0ZXMoKTtcbiAgICAgICAgYXR0cnMuZm9yRWFjaChzdGF0ZW1lbnQgPT4gY29tcGlsZVN0YXRlbWVudChzdGF0ZW1lbnQsIGIpKTtcbiAgICAgICAgYXR0cnNJbnNlcnRlZCA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb21waWxlU3RhdGVtZW50KHN0YXRlbWVudCwgYik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYi5kaWRSZW5kZXJMYXlvdXQoKTtcbiAgICBiLnN0b3BMYWJlbHMoKTtcblxuICAgIHJldHVybiBuZXcgQ29tcGlsZWRQcm9ncmFtKGIudG9TbGljZSgpLCBsYXlvdXQuc3ltYm9sVGFibGUuc2l6ZSk7XG4gIH1cbn1cblxuY2xhc3MgQ29tcG9uZW50VGFnQnVpbGRlciBpbXBsZW1lbnRzIENvbXBvbmVudC5Db21wb25lbnRUYWdCdWlsZGVyIHtcbiAgcHVibGljIGlzRHluYW1pYzogT3B0aW9uPGJvb2xlYW4+ID0gbnVsbDtcbiAgcHVibGljIGlzU3RhdGljOiBPcHRpb248Ym9vbGVhbj4gPSBudWxsO1xuICBwdWJsaWMgc3RhdGljVGFnTmFtZTogT3B0aW9uPHN0cmluZz4gPSBudWxsO1xuICBwdWJsaWMgZHluYW1pY1RhZ05hbWU6IE9wdGlvbjxCYXNlbGluZVN5bnRheC5BbnlFeHByZXNzaW9uPiA9IG51bGw7XG5cbiAgZ2V0RHluYW1pYygpOiBNYXliZTxCYXNlbGluZVN5bnRheC5BbnlFeHByZXNzaW9uPiB7XG4gICAgaWYgKHRoaXMuaXNEeW5hbWljKSB7XG4gICAgICByZXR1cm4gdGhpcy5keW5hbWljVGFnTmFtZTtcbiAgICB9XG4gIH1cblxuICBnZXRTdGF0aWMoKTogTWF5YmU8c3RyaW5nPiB7XG4gICAgaWYgKHRoaXMuaXNTdGF0aWMpIHtcbiAgICAgIHJldHVybiB0aGlzLnN0YXRpY1RhZ05hbWU7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljKHRhZ05hbWU6IHN0cmluZykge1xuICAgIHRoaXMuaXNTdGF0aWMgPSB0cnVlO1xuICAgIHRoaXMuc3RhdGljVGFnTmFtZSA9IHRhZ05hbWU7XG4gIH1cblxuICBkeW5hbWljKHRhZ05hbWU6IEZ1bmN0aW9uRXhwcmVzc2lvbjxzdHJpbmc+KSB7XG4gICAgdGhpcy5pc0R5bmFtaWMgPSB0cnVlO1xuICAgIHRoaXMuZHluYW1pY1RhZ05hbWUgPSBbJ2Z1bmN0aW9uJywgdGFnTmFtZV07XG4gIH1cbn1cblxuY2xhc3MgQ29tcG9uZW50QXR0cnNCdWlsZGVyIGltcGxlbWVudHMgQ29tcG9uZW50LkNvbXBvbmVudEF0dHJzQnVpbGRlciB7XG4gIHByaXZhdGUgYnVmZmVyOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuQXR0cmlidXRlW10gPSBbXTtcblxuICBzdGF0aWMobmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5idWZmZXIucHVzaChbJ3N0YXRpYy1hdHRyJywgbmFtZSwgdmFsdWUsIG51bGxdKTtcbiAgfVxuXG4gIGR5bmFtaWMobmFtZTogc3RyaW5nLCB2YWx1ZTogRnVuY3Rpb25FeHByZXNzaW9uPHN0cmluZz4pIHtcbiAgICB0aGlzLmJ1ZmZlci5wdXNoKFsnZHluYW1pYy1hdHRyJywgbmFtZSwgWydmdW5jdGlvbicsIHZhbHVlXSwgbnVsbF0pO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDb21wb25lbnRCdWlsZGVyIGltcGxlbWVudHMgSUNvbXBvbmVudEJ1aWxkZXIge1xuICBwcml2YXRlIGVudjogRW52aXJvbm1lbnQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBidWlsZGVyOiBPcGNvZGVCdWlsZGVyRFNMKSB7XG4gICAgdGhpcy5lbnYgPSBidWlsZGVyLmVudjtcbiAgfVxuXG4gIHN0YXRpYyhkZWZpbml0aW9uOiBTdGF0aWNEZWZpbml0aW9uLCBhcmdzOiBCYXNlbGluZVN5bnRheC5BcmdzLCBfc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlLCBzaGFkb3c6IElubGluZUJsb2NrKSB7XG4gICAgdGhpcy5idWlsZGVyLnVuaXQoYiA9PiB7XG4gICAgICBiLnB1dENvbXBvbmVudERlZmluaXRpb24oZGVmaW5pdGlvbik7XG4gICAgICBiLm9wZW5Db21wb25lbnQoY29tcGlsZUJhc2VsaW5lQXJncyhhcmdzLCBiKSwgc2hhZG93KTtcbiAgICAgIGIuY2xvc2VDb21wb25lbnQoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGR5bmFtaWMoZGVmaW5pdGlvbkFyZ3M6IEJhc2VsaW5lU3ludGF4LkFyZ3MsIGRlZmluaXRpb246IER5bmFtaWNEZWZpbml0aW9uLCBhcmdzOiBCYXNlbGluZVN5bnRheC5BcmdzLCBfc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlLCBzaGFkb3c6IElubGluZUJsb2NrKSB7XG4gICAgdGhpcy5idWlsZGVyLnVuaXQoYiA9PiB7XG4gICAgICBiLnB1dEFyZ3MoY29tcGlsZUFyZ3MoZGVmaW5pdGlvbkFyZ3NbMF0sIGRlZmluaXRpb25BcmdzWzFdLCBiKSk7XG4gICAgICBiLnB1dFZhbHVlKFsnZnVuY3Rpb24nLCBkZWZpbml0aW9uXSk7XG4gICAgICBiLnRlc3QoJ3NpbXBsZScpO1xuICAgICAgYi5lbnRlcignQkVHSU4nLCAnRU5EJyk7XG4gICAgICBiLmxhYmVsKCdCRUdJTicpO1xuICAgICAgYi5qdW1wVW5sZXNzKCdFTkQnKTtcbiAgICAgIGIucHV0RHluYW1pY0NvbXBvbmVudERlZmluaXRpb24oKTtcbiAgICAgIGIub3BlbkNvbXBvbmVudChjb21waWxlQmFzZWxpbmVBcmdzKGFyZ3MsIGIpLCBzaGFkb3cpO1xuICAgICAgYi5jbG9zZUNvbXBvbmVudCgpO1xuICAgICAgYi5sYWJlbCgnRU5EJyk7XG4gICAgICBiLmV4aXQoKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRlcjxTIGV4dGVuZHMgU3ltYm9sVGFibGU+KGVudjogRW52aXJvbm1lbnQsIHN5bWJvbFRhYmxlOiBTKSB7XG4gIHJldHVybiBuZXcgT3Bjb2RlQnVpbGRlckRTTChzeW1ib2xUYWJsZSwgZW52KTtcbn1cbiJdfQ==