"use strict";
var util_1 = require("@glimmer/util");
var functions_1 = require("./syntax/functions");
var opcodes_1 = require("./opcodes");
var references_1 = require("./references");
var attribute_managers_1 = require("./dom/attribute-managers");
var util_2 = require("@glimmer/util");
var Scope = (function () {
    function Scope(references, callerScope) {
        if (callerScope === void 0) { callerScope = null; }
        this.callerScope = null;
        this.slots = references;
        this.callerScope = callerScope;
    }
    Scope.root = function (self, size) {
        if (size === void 0) { size = 0; }
        var refs = new Array(size + 1);
        for (var i = 0; i <= size; i++) {
            refs[i] = references_1.UNDEFINED_REFERENCE;
        }
        return new Scope(refs).init({ self: self });
    };
    Scope.prototype.init = function (_a) {
        var self = _a.self;
        this.slots[0] = self;
        return this;
    };
    Scope.prototype.getSelf = function () {
        return this.slots[0];
    };
    Scope.prototype.getSymbol = function (symbol) {
        return this.slots[symbol];
    };
    Scope.prototype.getBlock = function (symbol) {
        return this.slots[symbol];
    };
    Scope.prototype.getPartialArgs = function (symbol) {
        return this.slots[symbol];
    };
    Scope.prototype.bindSymbol = function (symbol, value) {
        this.slots[symbol] = value;
    };
    Scope.prototype.bindBlock = function (symbol, value) {
        this.slots[symbol] = value;
    };
    Scope.prototype.bindPartialArgs = function (symbol, value) {
        this.slots[symbol] = value;
    };
    Scope.prototype.bindCallerScope = function (scope) {
        this.callerScope = scope;
    };
    Scope.prototype.getCallerScope = function () {
        return this.callerScope;
    };
    Scope.prototype.child = function () {
        return new Scope(this.slots.slice(), this.callerScope);
    };
    return Scope;
}());
exports.Scope = Scope;
var Transaction = (function () {
    function Transaction() {
        this.scheduledInstallManagers = [];
        this.scheduledInstallModifiers = [];
        this.scheduledUpdateModifierManagers = [];
        this.scheduledUpdateModifiers = [];
        this.createdComponents = [];
        this.createdManagers = [];
        this.updatedComponents = [];
        this.updatedManagers = [];
        this.destructors = [];
    }
    Transaction.prototype.didCreate = function (component, manager) {
        this.createdComponents.push(component);
        this.createdManagers.push(manager);
    };
    Transaction.prototype.didUpdate = function (component, manager) {
        this.updatedComponents.push(component);
        this.updatedManagers.push(manager);
    };
    Transaction.prototype.scheduleInstallModifier = function (modifier, manager) {
        this.scheduledInstallManagers.push(manager);
        this.scheduledInstallModifiers.push(modifier);
    };
    Transaction.prototype.scheduleUpdateModifier = function (modifier, manager) {
        this.scheduledUpdateModifierManagers.push(manager);
        this.scheduledUpdateModifiers.push(modifier);
    };
    Transaction.prototype.didDestroy = function (d) {
        this.destructors.push(d);
    };
    Transaction.prototype.commit = function () {
        var _a = this, createdComponents = _a.createdComponents, createdManagers = _a.createdManagers;
        for (var i = 0; i < createdComponents.length; i++) {
            var component = createdComponents[i];
            var manager = createdManagers[i];
            manager.didCreate(component);
        }
        var _b = this, updatedComponents = _b.updatedComponents, updatedManagers = _b.updatedManagers;
        for (var i = 0; i < updatedComponents.length; i++) {
            var component = updatedComponents[i];
            var manager = updatedManagers[i];
            manager.didUpdate(component);
        }
        var destructors = this.destructors;
        for (var i = 0; i < destructors.length; i++) {
            destructors[i].destroy();
        }
        var _c = this, scheduledInstallManagers = _c.scheduledInstallManagers, scheduledInstallModifiers = _c.scheduledInstallModifiers;
        for (var i = 0; i < scheduledInstallManagers.length; i++) {
            var manager = scheduledInstallManagers[i];
            var modifier = scheduledInstallModifiers[i];
            manager.install(modifier);
        }
        var _d = this, scheduledUpdateModifierManagers = _d.scheduledUpdateModifierManagers, scheduledUpdateModifiers = _d.scheduledUpdateModifiers;
        for (var i = 0; i < scheduledUpdateModifierManagers.length; i++) {
            var manager = scheduledUpdateModifierManagers[i];
            var modifier = scheduledUpdateModifiers[i];
            manager.update(modifier);
        }
    };
    return Transaction;
}());
var Opcode = (function () {
    function Opcode(array) {
        this.array = array;
        this.offset = 0;
    }
    Object.defineProperty(Opcode.prototype, "type", {
        get: function () {
            return this.array[this.offset];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Opcode.prototype, "op1", {
        get: function () {
            return this.array[this.offset + 1];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Opcode.prototype, "op2", {
        get: function () {
            return this.array[this.offset + 2];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Opcode.prototype, "op3", {
        get: function () {
            return this.array[this.offset + 3];
        },
        enumerable: true,
        configurable: true
    });
    return Opcode;
}());
exports.Opcode = Opcode;
var Program = (function () {
    function Program() {
        this.opcodes = new util_1.A(0x100000);
        this._offset = 0;
        this._opcode = new Opcode(this.opcodes);
    }
    Object.defineProperty(Program.prototype, "next", {
        get: function () {
            return this._offset;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Program.prototype, "current", {
        get: function () {
            return this._offset - 4;
        },
        enumerable: true,
        configurable: true
    });
    Program.prototype.opcode = function (offset) {
        this._opcode.offset = offset;
        return this._opcode;
    };
    Program.prototype.set = function (pos, opcode) {
        var type = opcode[0], op1 = opcode[1], op2 = opcode[2], op3 = opcode[3];
        this.opcodes[pos] = type;
        this.opcodes[pos + 1] = op1;
        this.opcodes[pos + 2] = op2;
        this.opcodes[pos + 3] = op3;
    };
    Program.prototype.push = function (opcode) {
        var offset = this._offset;
        var type = opcode[0], op1 = opcode[1], op2 = opcode[2], op3 = opcode[3];
        this.opcodes[this._offset++] = type;
        this.opcodes[this._offset++] = op1;
        this.opcodes[this._offset++] = op2;
        this.opcodes[this._offset++] = op3;
        return offset;
    };
    return Program;
}());
exports.Program = Program;
var Environment = (function () {
    function Environment(_a) {
        var appendOperations = _a.appendOperations, updateOperations = _a.updateOperations;
        this._macros = null;
        this._transaction = null;
        this.constants = new opcodes_1.Constants();
        this.program = new Program();
        this.appendOperations = appendOperations;
        this.updateOperations = updateOperations;
    }
    Environment.prototype.toConditionalReference = function (reference) {
        return new references_1.ConditionalReference(reference);
    };
    Environment.prototype.getAppendOperations = function () { return this.appendOperations; };
    Environment.prototype.getDOM = function () { return this.updateOperations; };
    Environment.prototype.getIdentity = function (object) {
        return util_2.ensureGuid(object) + '';
    };
    Environment.prototype.begin = function () {
        util_2.assert(!this._transaction, 'Cannot start a nested transaction');
        this._transaction = new Transaction();
    };
    Object.defineProperty(Environment.prototype, "transaction", {
        get: function () {
            return util_2.expect(this._transaction, 'must be in a transaction');
        },
        enumerable: true,
        configurable: true
    });
    Environment.prototype.didCreate = function (component, manager) {
        this.transaction.didCreate(component, manager);
    };
    Environment.prototype.didUpdate = function (component, manager) {
        this.transaction.didUpdate(component, manager);
    };
    Environment.prototype.scheduleInstallModifier = function (modifier, manager) {
        this.transaction.scheduleInstallModifier(modifier, manager);
    };
    Environment.prototype.scheduleUpdateModifier = function (modifier, manager) {
        this.transaction.scheduleUpdateModifier(modifier, manager);
    };
    Environment.prototype.didDestroy = function (d) {
        this.transaction.didDestroy(d);
    };
    Environment.prototype.commit = function () {
        this.transaction.commit();
        this._transaction = null;
    };
    Environment.prototype.attributeFor = function (element, attr, isTrusting, namespace) {
        return attribute_managers_1.defaultManagers(element, attr, isTrusting, namespace === undefined ? null : namespace);
    };
    Environment.prototype.macros = function () {
        var macros = this._macros;
        if (!macros) {
            this._macros = macros = functions_1.populateBuiltins();
        }
        return macros;
    };
    return Environment;
}());
exports.Environment = Environment;
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Environment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW52aXJvbm1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJAZ2xpbW1lci9ydW50aW1lL2xpYi9lbnZpcm9ubWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0Esc0NBQWtDO0FBRWxDLGdEQUF1RTtBQUV2RSxxQ0FBb0Q7QUFLcEQsMkNBQXlFO0FBQ3pFLCtEQUdrQztBQWdCbEMsc0NBUXVCO0FBb0J2QjtJQWVFLGVBQVksVUFBdUIsRUFBRSxXQUFpQztRQUFqQyw0QkFBQSxFQUFBLGtCQUFpQztRQUY5RCxnQkFBVyxHQUFrQixJQUFJLENBQUM7UUFHeEMsSUFBSSxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUM7UUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7SUFDakMsQ0FBQztJQWpCTSxVQUFJLEdBQVgsVUFBWSxJQUEyQixFQUFFLElBQVE7UUFBUixxQkFBQSxFQUFBLFFBQVE7UUFDL0MsSUFBSSxJQUFJLEdBQTRCLElBQUksS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQztRQUV4RCxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQy9CLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxnQ0FBbUIsQ0FBQztRQUNoQyxDQUFDO1FBRUQsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksTUFBQSxFQUFFLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBV0Qsb0JBQUksR0FBSixVQUFLLEVBQXlDO1lBQXZDLGNBQUk7UUFDVCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELHVCQUFPLEdBQVA7UUFDRSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUss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LEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVELGdDQUFVLEdBQVYsVUFBVyxDQUFjO1FBQ3ZCLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCw0QkFBTSxHQUFOO1FBQ0UsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztJQUMzQixDQUFDO0lBRUQsa0NBQVksR0FBWixVQUFhLE9BQXVCLEVBQUUsSUFBWSxFQUFFLFVBQW1CLEVBQUUsU0FBa0I7UUFDekYsTUFBTSxDQUFDLG9DQUFlLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsU0FBUyxLQUFLLFNBQVMsR0FBRyxJQUFJLEdBQUcsU0FBUyxDQUFDLENBQUM7SUFDaEcsQ0FBQztJQUVELDRCQUFNLEdBQU47UUFDRSxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQzFCLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNaLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxHQUFHLDRCQUFnQixFQUFFLENBQUM7UUFDN0MsQ0FBQztRQUVELE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQWFILGtCQUFDO0FBQUQsQ0FBQyxBQXJGRCxJQXFGQztBQXJGcUIsa0NBQVc7O0FBdUZqQyxrQkFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTeW1ib2xUYWJsZSB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgQSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5pbXBvcnQgeyBCbG9ja3MsIElubGluZXMsIHBvcHVsYXRlQnVpbHRpbnMgfSBmcm9tICcuL3N5bnRheC9mdW5jdGlvbnMnO1xuXG5pbXBvcnQgeyBDb25zdGFudHMsIEFwcGVuZE9wY29kZSB9IGZyb20gJy4vb3Bjb2Rlcyc7XG5cbmltcG9ydCAqIGFzIFNpbXBsZSBmcm9tICcuL2RvbS9pbnRlcmZhY2VzJztcbmltcG9ydCB7IERPTUNoYW5nZXMsIERPTVRyZWVDb25zdHJ1Y3Rpb24gfSBmcm9tICcuL2RvbS9oZWxwZXInO1xuaW1wb3J0IHsgUmVmZXJlbmNlLCBQYXRoUmVmZXJlbmNlLCBPcGFxdWVJdGVyYWJsZSB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQgeyBVTkRFRklORURfUkVGRVJFTkNFLCBDb25kaXRpb25hbFJlZmVyZW5jZSB9IGZyb20gJy4vcmVmZXJlbmNlcyc7XG5pbXBvcnQge1xuICBkZWZhdWx0TWFuYWdlcnMsXG4gIEF0dHJpYnV0ZU1hbmFnZXJcbn0gZnJvbSAnLi9kb20vYXR0cmlidXRlLW1hbmFnZXJzJztcblxuaW1wb3J0IHtcbiAgUGFydGlhbERlZmluaXRpb25cbn0gZnJvbSAnLi9wYXJ0aWFsJztcblxuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBDb21wb25lbnRNYW5hZ2VyLFxuICBDb21wb25lbnREZWZpbml0aW9uXG59IGZyb20gJy4vY29tcG9uZW50L2ludGVyZmFjZXMnO1xuXG5pbXBvcnQge1xuICBNb2RpZmllck1hbmFnZXJcbn0gZnJvbSAnLi9tb2RpZmllci9pbnRlcmZhY2VzJztcblxuaW1wb3J0IHtcbiAgT3B0aW9uLFxuICBEZXN0cm95YWJsZSxcbiAgT3BhcXVlLFxuICBIYXNHdWlkLFxuICBlbnN1cmVHdWlkLFxuICBleHBlY3QsXG4gIGFzc2VydFxufSBmcm9tICdAZ2xpbW1lci91dGlsJztcblxuaW1wb3J0IHtcbiAgVGVtcGxhdGVNZXRhXG59IGZyb20gJ0BnbGltbWVyL3dpcmUtZm9ybWF0JztcblxuaW1wb3J0IHsgRXZhbHVhdGVkQXJncyB9IGZyb20gJy4vY29tcGlsZWQvZXhwcmVzc2lvbnMvYXJncyc7XG5cbmltcG9ydCB7IElubGluZUJsb2NrIH0gZnJvbSAnLi9zY2FubmVyJztcblxuaW1wb3J0IHsgUHVibGljVk0gfSBmcm9tICcuL3ZtL2FwcGVuZCc7XG5cbmV4cG9ydCB0eXBlIFNjb3BlU2xvdCA9IFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB8IElubGluZUJsb2NrIHwgRXZhbHVhdGVkQXJncztcblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbWljU2NvcGUge1xuICBnZXQoa2V5OiBzdHJpbmcpOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT47XG4gIHNldChrZXk6IHN0cmluZywgcmVmZXJlbmNlOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT4pOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT47XG4gIGNoaWxkKCk6IER5bmFtaWNTY29wZTtcbn1cblxuZXhwb3J0IGNsYXNzIFNjb3BlIHtcbiAgc3RhdGljIHJvb3Qoc2VsZjogUGF0aFJlZmVyZW5jZTxPcGFxdWU+LCBzaXplID0gMCkge1xuICAgIGxldCByZWZzOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT5bXSA9IG5ldyBBcnJheShzaXplICsgMSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBzaXplOyBpKyspIHtcbiAgICAgIHJlZnNbaV0gPSBVTkRFRklORURfUkVGRVJFTkNFO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgU2NvcGUocmVmcykuaW5pdCh7IHNlbGYgfSk7XG4gIH1cblxuICAvLyB0aGUgMHRoIHNsb3QgaXMgYHNlbGZgXG4gIHByaXZhdGUgc2xvdHM6IFNjb3BlU2xvdFtdO1xuICBwcml2YXRlIGNhbGxlclNjb3BlOiBPcHRpb248U2NvcGU+ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihyZWZlcmVuY2VzOiBTY29wZVNsb3RbXSwgY2FsbGVyU2NvcGU6IE9wdGlvbjxTY29wZT4gPSBudWxsKSB7XG4gICAgdGhpcy5zbG90cyA9IHJlZmVyZW5jZXM7XG4gICAgdGhpcy5jYWxsZXJTY29wZSA9IGNhbGxlclNjb3BlO1xuICB9XG5cbiAgaW5pdCh7IHNlbGYgfTogeyBzZWxmOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT4gfSk6IHRoaXMge1xuICAgIHRoaXMuc2xvdHNbMF0gPSBzZWxmO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZ2V0U2VsZigpOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT4ge1xuICAgIHJldHVybiB0aGlzLnNsb3RzWzBdIGFzIFBhdGhSZWZlcmVuY2U8T3BhcXVlPjtcbiAgfVxuXG4gIGdldFN5bWJvbChzeW1ib2w6IG51bWJlcik6IFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gICAgcmV0dXJuIHRoaXMuc2xvdHNbc3ltYm9sXSBhcyBQYXRoUmVmZXJlbmNlPE9wYXF1ZT47XG4gIH1cblxuICBnZXRCbG9jayhzeW1ib2w6IG51bWJlcik6IElubGluZUJsb2NrIHtcbiAgICByZXR1cm4gdGhpcy5zbG90c1tzeW1ib2xdIGFzIElubGluZUJsb2NrO1xuICB9XG5cbiAgZ2V0UGFydGlhbEFyZ3Moc3ltYm9sOiBudW1iZXIpOiBFdmFsdWF0ZWRBcmdzIHtcbiAgICByZXR1cm4gdGhpcy5zbG90c1tzeW1ib2xdIGFzIEV2YWx1YXRlZEFyZ3M7XG4gIH1cblxuICBiaW5kU3ltYm9sKHN5bWJvbDogbnVtYmVyLCB2YWx1ZTogUGF0aFJlZmVyZW5jZTxPcGFxdWU+KSB7XG4gICAgdGhpcy5zbG90c1tzeW1ib2xdID0gdmFsdWU7XG4gIH1cblxuICBiaW5kQmxvY2soc3ltYm9sOiBudW1iZXIsIHZhbHVlOiBJbmxpbmVCbG9jaykge1xuICAgIHRoaXMuc2xvdHNbc3ltYm9sXSA9IHZhbHVlO1xuICB9XG5cbiAgYmluZFBhcnRpYWxBcmdzKHN5bWJvbDogbnVtYmVyLCB2YWx1ZTogRXZhbHVhdGVkQXJncykge1xuICAgIHRoaXMuc2xvdHNbc3ltYm9sXSA9IHZhbHVlO1xuICB9XG5cbiAgYmluZENhbGxlclNjb3BlKHNjb3BlOiBTY29wZSkge1xuICAgIHRoaXMuY2FsbGVyU2NvcGUgPSBzY29wZTtcbiAgfVxuXG4gIGdldENhbGxlclNjb3BlKCk6IE9wdGlvbjxTY29wZT4ge1xuICAgIHJldHVybiB0aGlzLmNhbGxlclNjb3BlO1xuICB9XG5cbiAgY2hpbGQoKTogU2NvcGUge1xuICAgIHJldHVybiBuZXcgU2NvcGUodGhpcy5zbG90cy5zbGljZSgpLCB0aGlzLmNhbGxlclNjb3BlKTtcbiAgfVxufVxuXG5jbGFzcyBUcmFuc2FjdGlvbiB7XG4gIHB1YmxpYyBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnM6IE1vZGlmaWVyTWFuYWdlcjxPcGFxdWU+W10gPSBbXTtcbiAgcHVibGljIHNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnM6IE9iamVjdFtdID0gW107XG4gIHB1YmxpYyBzY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzOiBNb2RpZmllck1hbmFnZXI8T3BhcXVlPltdID0gW107XG4gIHB1YmxpYyBzY2hlZHVsZWRVcGRhdGVNb2RpZmllcnM6IE9iamVjdFtdID0gW107XG4gIHB1YmxpYyBjcmVhdGVkQ29tcG9uZW50czogQ29tcG9uZW50W10gPSBbXTtcbiAgcHVibGljIGNyZWF0ZWRNYW5hZ2VyczogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnQ+W10gPSBbXTtcbiAgcHVibGljIHVwZGF0ZWRDb21wb25lbnRzOiBDb21wb25lbnRbXSA9IFtdO1xuICBwdWJsaWMgdXBkYXRlZE1hbmFnZXJzOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudD5bXSA9IFtdO1xuICBwdWJsaWMgZGVzdHJ1Y3RvcnM6IERlc3Ryb3lhYmxlW10gPSBbXTtcblxuICBkaWRDcmVhdGU8VD4oY29tcG9uZW50OiBULCBtYW5hZ2VyOiBDb21wb25lbnRNYW5hZ2VyPFQ+KSB7XG4gICAgdGhpcy5jcmVhdGVkQ29tcG9uZW50cy5wdXNoKGNvbXBvbmVudCk7XG4gICAgdGhpcy5jcmVhdGVkTWFuYWdlcnMucHVzaChtYW5hZ2VyKTtcbiAgfVxuXG4gIGRpZFVwZGF0ZTxUPihjb21wb25lbnQ6IFQsIG1hbmFnZXI6IENvbXBvbmVudE1hbmFnZXI8VD4pIHtcbiAgICB0aGlzLnVwZGF0ZWRDb21wb25lbnRzLnB1c2goY29tcG9uZW50KTtcbiAgICB0aGlzLnVwZGF0ZWRNYW5hZ2Vycy5wdXNoKG1hbmFnZXIpO1xuICB9XG5cbiAgc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXI8VD4obW9kaWZpZXI6IFQsIG1hbmFnZXI6IE1vZGlmaWVyTWFuYWdlcjxUPikge1xuICAgIHRoaXMuc2NoZWR1bGVkSW5zdGFsbE1hbmFnZXJzLnB1c2gobWFuYWdlcik7XG4gICAgdGhpcy5zY2hlZHVsZWRJbnN0YWxsTW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpO1xuICB9XG5cbiAgc2NoZWR1bGVVcGRhdGVNb2RpZmllcjxUPihtb2RpZmllcjogVCwgbWFuYWdlcjogTW9kaWZpZXJNYW5hZ2VyPFQ+KSB7XG4gICAgdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzLnB1c2gobWFuYWdlcik7XG4gICAgdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllcnMucHVzaChtb2RpZmllcik7XG4gIH1cblxuICBkaWREZXN0cm95KGQ6IERlc3Ryb3lhYmxlKSB7XG4gICAgdGhpcy5kZXN0cnVjdG9ycy5wdXNoKGQpO1xuICB9XG5cbiAgY29tbWl0KCkge1xuICAgIGxldCB7IGNyZWF0ZWRDb21wb25lbnRzLCBjcmVhdGVkTWFuYWdlcnMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpPTA7IGk8Y3JlYXRlZENvbXBvbmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBjb21wb25lbnQgPSBjcmVhdGVkQ29tcG9uZW50c1tpXTtcbiAgICAgIGxldCBtYW5hZ2VyID0gY3JlYXRlZE1hbmFnZXJzW2ldO1xuICAgICAgbWFuYWdlci5kaWRDcmVhdGUoY29tcG9uZW50KTtcbiAgICB9XG5cbiAgICBsZXQgeyB1cGRhdGVkQ29tcG9uZW50cywgdXBkYXRlZE1hbmFnZXJzIH0gPSB0aGlzO1xuXG4gICAgZm9yIChsZXQgaT0wOyBpPHVwZGF0ZWRDb21wb25lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgY29tcG9uZW50ID0gdXBkYXRlZENvbXBvbmVudHNbaV07XG4gICAgICBsZXQgbWFuYWdlciA9IHVwZGF0ZWRNYW5hZ2Vyc1tpXTtcbiAgICAgIG1hbmFnZXIuZGlkVXBkYXRlKGNvbXBvbmVudCk7XG4gICAgfVxuXG4gICAgbGV0IHsgZGVzdHJ1Y3RvcnMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpPTA7IGk8ZGVzdHJ1Y3RvcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGRlc3RydWN0b3JzW2ldLmRlc3Ryb3koKTtcbiAgICB9XG5cbiAgICBsZXQgeyBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnMsIHNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVkdWxlZEluc3RhbGxNYW5hZ2Vycy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IG1hbmFnZXIgPSBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnNbaV07XG4gICAgICBsZXQgbW9kaWZpZXIgPSBzY2hlZHVsZWRJbnN0YWxsTW9kaWZpZXJzW2ldO1xuICAgICAgbWFuYWdlci5pbnN0YWxsKG1vZGlmaWVyKTtcbiAgICB9XG5cbiAgICBsZXQgeyBzY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzLCBzY2hlZHVsZWRVcGRhdGVNb2RpZmllcnMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVyTWFuYWdlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBtYW5hZ2VyID0gc2NoZWR1bGVkVXBkYXRlTW9kaWZpZXJNYW5hZ2Vyc1tpXTtcbiAgICAgIGxldCBtb2RpZmllciA9IHNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVyc1tpXTtcbiAgICAgIG1hbmFnZXIudXBkYXRlKG1vZGlmaWVyKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE9wY29kZSB7XG4gIHB1YmxpYyBvZmZzZXQgPSAwO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFycmF5OiBVaW50MzJBcnJheSB8IEFycmF5PG51bWJlcj4pIHt9XG5cbiAgZ2V0IHR5cGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXJyYXlbdGhpcy5vZmZzZXRdO1xuICB9XG5cbiAgZ2V0IG9wMSgpIHtcbiAgICByZXR1cm4gdGhpcy5hcnJheVt0aGlzLm9mZnNldCArIDFdO1xuICB9XG5cbiAgZ2V0IG9wMigpIHtcbiAgICByZXR1cm4gdGhpcy5hcnJheVt0aGlzLm9mZnNldCArIDJdO1xuICB9XG5cbiAgZ2V0IG9wMygpIHtcbiAgICByZXR1cm4gdGhpcy5hcnJheVt0aGlzLm9mZnNldCArIDNdO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQcm9ncmFtIHtcbiAgW2tleTogbnVtYmVyXTogbmV2ZXI7XG5cbiAgcHJpdmF0ZSBvcGNvZGVzID0gbmV3IEEoMHgxMDAwMDApO1xuICBwcml2YXRlIF9vZmZzZXQgPSAwO1xuICBwcml2YXRlIF9vcGNvZGU6IE9wY29kZTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9vcGNvZGUgPSBuZXcgT3Bjb2RlKHRoaXMub3Bjb2Rlcyk7XG4gIH1cblxuICBnZXQgbmV4dCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9vZmZzZXQ7XG4gIH1cblxuICBnZXQgY3VycmVudCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9vZmZzZXQgLSA0O1xuICB9XG5cbiAgb3Bjb2RlKG9mZnNldDogbnVtYmVyKTogT3Bjb2RlIHtcbiAgICB0aGlzLl9vcGNvZGUub2Zmc2V0ID0gb2Zmc2V0O1xuICAgIHJldHVybiB0aGlzLl9vcGNvZGU7XG4gIH1cblxuICBzZXQocG9zOiBudW1iZXIsIG9wY29kZTogQXBwZW5kT3Bjb2RlKSB7XG4gICAgbGV0IFt0eXBlLCBvcDEsIG9wMiwgb3AzXSA9IG9wY29kZTtcbiAgICB0aGlzLm9wY29kZXNbcG9zXSA9IHR5cGU7XG4gICAgdGhpcy5vcGNvZGVzW3BvcyArIDFdID0gb3AxO1xuICAgIHRoaXMub3Bjb2Rlc1twb3MgKyAyXSA9IG9wMjtcbiAgICB0aGlzLm9wY29kZXNbcG9zICsgM10gPSBvcDM7XG4gIH1cblxuICBwdXNoKG9wY29kZTogQXBwZW5kT3Bjb2RlKTogbnVtYmVyIHtcbiAgICBsZXQgb2Zmc2V0ID0gdGhpcy5fb2Zmc2V0O1xuICAgIGxldCBbdHlwZSwgb3AxLCBvcDIsIG9wM10gPSBvcGNvZGU7XG4gICAgdGhpcy5vcGNvZGVzW3RoaXMuX29mZnNldCsrXSA9IHR5cGU7XG4gICAgdGhpcy5vcGNvZGVzW3RoaXMuX29mZnNldCsrXSA9IG9wMTtcbiAgICB0aGlzLm9wY29kZXNbdGhpcy5fb2Zmc2V0KytdID0gb3AyO1xuICAgIHRoaXMub3Bjb2Rlc1t0aGlzLl9vZmZzZXQrK10gPSBvcDM7XG4gICAgcmV0dXJuIG9mZnNldDtcbiAgfVxufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRW52aXJvbm1lbnQge1xuICBwcm90ZWN0ZWQgdXBkYXRlT3BlcmF0aW9uczogRE9NQ2hhbmdlcztcbiAgcHJvdGVjdGVkIGFwcGVuZE9wZXJhdGlvbnM6IERPTVRyZWVDb25zdHJ1Y3Rpb247XG4gIHByaXZhdGUgX21hY3JvczogT3B0aW9uPHsgYmxvY2tzOiBCbG9ja3MsIGlubGluZXM6IElubGluZXMgfT4gPSBudWxsO1xuICBwcml2YXRlIF90cmFuc2FjdGlvbjogT3B0aW9uPFRyYW5zYWN0aW9uPiA9IG51bGw7XG4gIHB1YmxpYyBjb25zdGFudHM6IENvbnN0YW50cyA9IG5ldyBDb25zdGFudHMoKTtcbiAgcHVibGljIHByb2dyYW0gPSBuZXcgUHJvZ3JhbSgpO1xuXG4gIGNvbnN0cnVjdG9yKHsgYXBwZW5kT3BlcmF0aW9ucywgdXBkYXRlT3BlcmF0aW9ucyB9OiB7IGFwcGVuZE9wZXJhdGlvbnM6IERPTVRyZWVDb25zdHJ1Y3Rpb24sIHVwZGF0ZU9wZXJhdGlvbnM6IERPTUNoYW5nZXMgfSkge1xuICAgIHRoaXMuYXBwZW5kT3BlcmF0aW9ucyA9IGFwcGVuZE9wZXJhdGlvbnM7XG4gICAgdGhpcy51cGRhdGVPcGVyYXRpb25zID0gdXBkYXRlT3BlcmF0aW9ucztcbiAgfVxuXG4gIHRvQ29uZGl0aW9uYWxSZWZlcmVuY2UocmVmZXJlbmNlOiBSZWZlcmVuY2U8T3BhcXVlPik6IFJlZmVyZW5jZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG5ldyBDb25kaXRpb25hbFJlZmVyZW5jZShyZWZlcmVuY2UpO1xuICB9XG5cbiAgYWJzdHJhY3QgaXRlcmFibGVGb3IocmVmZXJlbmNlOiBSZWZlcmVuY2U8T3BhcXVlPiwgYXJnczogRXZhbHVhdGVkQXJncyk6IE9wYXF1ZUl0ZXJhYmxlO1xuICBhYnN0cmFjdCBwcm90b2NvbEZvclVSTChzOiBzdHJpbmcpOiBzdHJpbmc7XG5cbiAgZ2V0QXBwZW5kT3BlcmF0aW9ucygpOiBET01UcmVlQ29uc3RydWN0aW9uIHsgcmV0dXJuIHRoaXMuYXBwZW5kT3BlcmF0aW9uczsgfVxuICBnZXRET00oKTogRE9NQ2hhbmdlcyB7IHJldHVybiB0aGlzLnVwZGF0ZU9wZXJhdGlvbnM7IH1cblxuICBnZXRJZGVudGl0eShvYmplY3Q6IEhhc0d1aWQpOiBzdHJpbmcge1xuICAgIHJldHVybiBlbnN1cmVHdWlkKG9iamVjdCkgKyAnJztcbiAgfVxuXG4gIGJlZ2luKCkge1xuICAgIGFzc2VydCghdGhpcy5fdHJhbnNhY3Rpb24sICdDYW5ub3Qgc3RhcnQgYSBuZXN0ZWQgdHJhbnNhY3Rpb24nKTtcbiAgICB0aGlzLl90cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbigpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgdHJhbnNhY3Rpb24oKTogVHJhbnNhY3Rpb24ge1xuICAgIHJldHVybiBleHBlY3QodGhpcy5fdHJhbnNhY3Rpb24sICdtdXN0IGJlIGluIGEgdHJhbnNhY3Rpb24nKTtcbiAgfVxuXG4gIGRpZENyZWF0ZTxUPihjb21wb25lbnQ6IFQsIG1hbmFnZXI6IENvbXBvbmVudE1hbmFnZXI8VD4pIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uLmRpZENyZWF0ZShjb21wb25lbnQsIG1hbmFnZXIpO1xuICB9XG5cbiAgZGlkVXBkYXRlPFQ+KGNvbXBvbmVudDogVCwgbWFuYWdlcjogQ29tcG9uZW50TWFuYWdlcjxUPikge1xuICAgIHRoaXMudHJhbnNhY3Rpb24uZGlkVXBkYXRlKGNvbXBvbmVudCwgbWFuYWdlcik7XG4gIH1cblxuICBzY2hlZHVsZUluc3RhbGxNb2RpZmllcjxUPihtb2RpZmllcjogVCwgbWFuYWdlcjogTW9kaWZpZXJNYW5hZ2VyPFQ+KSB7XG4gICAgdGhpcy50cmFuc2FjdGlvbi5zY2hlZHVsZUluc3RhbGxNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7XG4gIH1cblxuICBzY2hlZHVsZVVwZGF0ZU1vZGlmaWVyPFQ+KG1vZGlmaWVyOiBULCBtYW5hZ2VyOiBNb2RpZmllck1hbmFnZXI8VD4pIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uLnNjaGVkdWxlVXBkYXRlTW9kaWZpZXIobW9kaWZpZXIsIG1hbmFnZXIpO1xuICB9XG5cbiAgZGlkRGVzdHJveShkOiBEZXN0cm95YWJsZSkge1xuICAgIHRoaXMudHJhbnNhY3Rpb24uZGlkRGVzdHJveShkKTtcbiAgfVxuXG4gIGNvbW1pdCgpIHtcbiAgICB0aGlzLnRyYW5zYWN0aW9uLmNvbW1pdCgpO1xuICAgIHRoaXMuX3RyYW5zYWN0aW9uID0gbnVsbDtcbiAgfVxuXG4gIGF0dHJpYnV0ZUZvcihlbGVtZW50OiBTaW1wbGUuRWxlbWVudCwgYXR0cjogc3RyaW5nLCBpc1RydXN0aW5nOiBib29sZWFuLCBuYW1lc3BhY2U/OiBzdHJpbmcpOiBBdHRyaWJ1dGVNYW5hZ2VyIHtcbiAgICByZXR1cm4gZGVmYXVsdE1hbmFnZXJzKGVsZW1lbnQsIGF0dHIsIGlzVHJ1c3RpbmcsIG5hbWVzcGFjZSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IG5hbWVzcGFjZSk7XG4gIH1cblxuICBtYWNyb3MoKTogeyBibG9ja3M6IEJsb2NrcywgaW5saW5lczogSW5saW5lcyB9IHtcbiAgICBsZXQgbWFjcm9zID0gdGhpcy5fbWFjcm9zO1xuICAgIGlmICghbWFjcm9zKSB7XG4gICAgICB0aGlzLl9tYWNyb3MgPSBtYWNyb3MgPSBwb3B1bGF0ZUJ1aWx0aW5zKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hY3JvcztcbiAgfVxuXG4gIGFic3RyYWN0IGhhc0hlbHBlcihoZWxwZXJOYW1lOiBPcHRpb248c3RyaW5nPltdLCBibG9ja01ldGE6IFRlbXBsYXRlTWV0YSk6IGJvb2xlYW47XG4gIGFic3RyYWN0IGxvb2t1cEhlbHBlcihoZWxwZXJOYW1lOiBPcHRpb248c3RyaW5nPltdLCBibG9ja01ldGE6IFRlbXBsYXRlTWV0YSk6IEhlbHBlcjtcblxuICBhYnN0cmFjdCBoYXNNb2RpZmllcihtb2RpZmllck5hbWU6IHN0cmluZ1tdLCBibG9ja01ldGE6IFRlbXBsYXRlTWV0YSk6IGJvb2xlYW47XG4gIGFic3RyYWN0IGxvb2t1cE1vZGlmaWVyKG1vZGlmaWVyTmFtZTogc3RyaW5nW10sIGJsb2NrTWV0YTogVGVtcGxhdGVNZXRhKTogTW9kaWZpZXJNYW5hZ2VyPE9wYXF1ZT47XG5cbiAgYWJzdHJhY3QgaGFzQ29tcG9uZW50RGVmaW5pdGlvbih0YWdOYW1lOiBzdHJpbmdbXSwgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKTogYm9vbGVhbjtcbiAgYWJzdHJhY3QgZ2V0Q29tcG9uZW50RGVmaW5pdGlvbih0YWdOYW1lOiBzdHJpbmdbXSwgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKTogQ29tcG9uZW50RGVmaW5pdGlvbjxPcGFxdWU+O1xuXG4gIGFic3RyYWN0IGhhc1BhcnRpYWwocGFydGlhbE5hbWU6IHN0cmluZywgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKTogYm9vbGVhbjtcbiAgYWJzdHJhY3QgbG9va3VwUGFydGlhbChQYXJ0aWFsTmFtZTogc3RyaW5nLCBzeW1ib2xUYWJsZTogU3ltYm9sVGFibGUpOiBQYXJ0aWFsRGVmaW5pdGlvbjxUZW1wbGF0ZU1ldGE+O1xufVxuXG5leHBvcnQgZGVmYXVsdCBFbnZpcm9ubWVudDtcblxuZXhwb3J0IGludGVyZmFjZSBIZWxwZXIge1xuICAodm06IFB1YmxpY1ZNLCBhcmdzOiBFdmFsdWF0ZWRBcmdzLCBzeW1ib2xUYWJsZTogU3ltYm9sVGFibGUpOiBQYXRoUmVmZXJlbmNlPE9wYXF1ZT47XG59XG4iXX0=