"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var blocks_1 = require("./compiled/blocks");
var compiler_1 = require("./compiler");
var WireFormat = require("@glimmer/wire-format");
var symbol_table_1 = require("./symbol-table");
var functions_1 = require("./syntax/functions");
var specialize_1 = require("./syntax/specialize");
function compileStatement(statement, builder) {
    var refined = specialize_1.SPECIALIZE.specialize(statement, builder.symbolTable);
    functions_1.STATEMENTS.compile(refined, builder);
}
exports.compileStatement = compileStatement;
var Template = (function () {
    function Template(statements, symbolTable) {
        this.statements = statements;
        this.symbolTable = symbolTable;
    }
    return Template;
}());
exports.Template = Template;
var Layout = (function (_super) {
    __extends(Layout, _super);
    function Layout() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    return Layout;
}(Template));
exports.Layout = Layout;
var EntryPoint = (function (_super) {
    __extends(EntryPoint, _super);
    function EntryPoint() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    EntryPoint.prototype.compile = function (env) {
        var table = this.symbolTable;
        var b = compiler_1.builder(env, table);
        for (var i = 0; i < this.statements.length; i++) {
            var statement = this.statements[i];
            var refined = specialize_1.SPECIALIZE.specialize(statement, table);
            functions_1.STATEMENTS.compile(refined, b);
        }
        return new blocks_1.CompiledProgram(b.toSlice(), this.symbolTable.size);
    };
    return EntryPoint;
}(Template));
exports.EntryPoint = EntryPoint;
var InlineBlock = (function (_super) {
    __extends(InlineBlock, _super);
    function InlineBlock() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    InlineBlock.prototype.splat = function (builder) {
        var table = builder.symbolTable;
        var locals = table.getSymbols().locals;
        if (locals) {
            builder.pushChildScope();
            builder.bindPositionalArgsForLocals(locals);
        }
        for (var i = 0; i < this.statements.length; i++) {
            var statement = this.statements[i];
            var refined = specialize_1.SPECIALIZE.specialize(statement, table);
            functions_1.STATEMENTS.compile(refined, builder);
        }
        if (locals) {
            builder.popScope();
        }
    };
    InlineBlock.prototype.compile = function (env) {
        var table = this.symbolTable;
        var b = compiler_1.builder(env, table);
        this.splat(b);
        return new blocks_1.CompiledBlock(b.toSlice());
    };
    return InlineBlock;
}(Template));
exports.InlineBlock = InlineBlock;
var PartialBlock = (function (_super) {
    __extends(PartialBlock, _super);
    function PartialBlock() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    PartialBlock.prototype.compile = function (env) {
        var table = this.symbolTable;
        var b = compiler_1.builder(env, table);
        for (var i = 0; i < this.statements.length; i++) {
            var statement = this.statements[i];
            var refined = specialize_1.SPECIALIZE.specialize(statement, table);
            functions_1.STATEMENTS.compile(refined, b);
        }
        return new blocks_1.CompiledProgram(b.toSlice(), table.size);
    };
    return PartialBlock;
}(Template));
exports.PartialBlock = PartialBlock;
var Scanner = (function () {
    function Scanner(block, meta, env) {
        this.block = block;
        this.meta = meta;
        this.env = env;
    }
    Scanner.prototype.scanEntryPoint = function () {
        var _a = this, block = _a.block, meta = _a.meta;
        var symbolTable = symbol_table_1.entryPoint(meta);
        var child = scanBlock(block, symbolTable, this.env);
        return new EntryPoint(child.statements, symbolTable);
    };
    Scanner.prototype.scanLayout = function () {
        var _a = this, block = _a.block, meta = _a.meta;
        var named = block.named, yields = block.yields, hasPartials = block.hasPartials;
        var symbolTable = symbol_table_1.layout(meta, named, yields, hasPartials);
        var child = scanBlock(block, symbolTable, this.env);
        return new Layout(child.statements, symbolTable);
    };
    Scanner.prototype.scanPartial = function (symbolTable) {
        var block = this.block;
        var child = scanBlock(block, symbolTable, this.env);
        return new PartialBlock(child.statements, symbolTable);
    };
    return Scanner;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Scanner;
function scanBlock(_a, symbolTable, env) {
    var statements = _a.statements;
    return new RawInlineBlock(env, symbolTable, statements).scan();
}
exports.scanBlock = scanBlock;
var BaselineSyntax;
(function (BaselineSyntax) {
    BaselineSyntax.isScannedComponent = WireFormat.is('scanned-component');
    BaselineSyntax.isPrimitiveElement = WireFormat.is('open-primitive-element');
    BaselineSyntax.isOptimizedAppend = WireFormat.is('optimized-append');
    BaselineSyntax.isUnoptimizedAppend = WireFormat.is('unoptimized-append');
    BaselineSyntax.isAnyAttr = WireFormat.is('any-dynamic-attr');
    BaselineSyntax.isStaticPartial = WireFormat.is('static-partial');
    BaselineSyntax.isDynamicPartial = WireFormat.is('dynamic-partial');
    BaselineSyntax.isFunctionExpression = WireFormat.is('function');
    BaselineSyntax.isNestedBlock = WireFormat.is('nested-block');
    BaselineSyntax.isScannedBlock = WireFormat.is('scanned-block');
    BaselineSyntax.isDebugger = WireFormat.is('debugger');
    var NestedBlock;
    (function (NestedBlock) {
        function defaultBlock(sexp) {
            return sexp[4];
        }
        NestedBlock.defaultBlock = defaultBlock;
        function inverseBlock(sexp) {
            return sexp[5];
        }
        NestedBlock.inverseBlock = inverseBlock;
        function params(sexp) {
            return sexp[2];
        }
        NestedBlock.params = params;
        function hash(sexp) {
            return sexp[3];
        }
        NestedBlock.hash = hash;
    })(NestedBlock = BaselineSyntax.NestedBlock || (BaselineSyntax.NestedBlock = {}));
})(BaselineSyntax = exports.BaselineSyntax || (exports.BaselineSyntax = {}));
var RawInlineBlock = (function () {
    function RawInlineBlock(env, table, statements) {
        this.env = env;
        this.table = table;
        this.statements = statements;
    }
    RawInlineBlock.prototype.scan = function () {
        var buffer = [];
        for (var i = 0; i < this.statements.length; i++) {
            var statement = this.statements[i];
            if (WireFormat.Statements.isBlock(statement)) {
                buffer.push(this.specializeBlock(statement));
            }
            else if (WireFormat.Statements.isComponent(statement)) {
                buffer.push.apply(buffer, this.specializeComponent(statement));
            }
            else {
                buffer.push(statement);
            }
        }
        return new InlineBlock(buffer, this.table);
    };
    RawInlineBlock.prototype.specializeBlock = function (block) {
        var path = block[1], params = block[2], hash = block[3], template = block[4], inverse = block[5];
        return ['scanned-block', path, params, hash, this.child(template), this.child(inverse)];
    };
    RawInlineBlock.prototype.specializeComponent = function (sexp) {
        var tag = sexp[1], component = sexp[2];
        if (this.env.hasComponentDefinition([tag], this.table)) {
            var child = this.child(component);
            var attrs = new RawInlineBlock(this.env, this.table, component.attrs);
            return [['scanned-component', tag, attrs, component.args, child]];
        }
        else {
            var buf = [];
            buf.push(['open-element', tag, []]);
            buf.push.apply(buf, component.attrs);
            buf.push(['flush-element']);
            buf.push.apply(buf, component.statements);
            buf.push(['close-element']);
            return buf;
        }
    };
    RawInlineBlock.prototype.child = function (block) {
        if (!block)
            return null;
        var table = symbol_table_1.block(this.table, block.locals);
        return new RawInlineBlock(this.env, table, block.statements);
    };
    return RawInlineBlock;
}());
exports.RawInlineBlock = RawInlineBlock;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nhbm5lci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkBnbGltbWVyL3J1bnRpbWUvbGliL3NjYW5uZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNENBQW1FO0FBQ25FLHVDQUFxQztBQUtyQyxpREFBbUQ7QUFDbkQsK0NBQTJHO0FBRzNHLGdEQUU0QjtBQUU1QixrREFFNkI7QUFJN0IsMEJBQWlDLFNBQXNDLEVBQUUsT0FBc0I7SUFDN0YsSUFBSSxPQUFPLEdBQUcsdUJBQVUsQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRSxzQkFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUhELDRDQUdDO0FBRUQ7SUFDRSxrQkFBbUIsVUFBeUMsRUFBUyxXQUF3QjtRQUExRSxlQUFVLEdBQVYsVUFBVSxDQUErQjtRQUFTLGdCQUFXLEdBQVgsV0FBVyxDQUFhO0lBQUcsQ0FBQztJQUNuRyxlQUFDO0FBQUQsQ0FBQyxBQUZELElBRUM7QUFGWSw0QkFBUTtBQUlyQjtJQUE0QiwwQkFBUTtJQUFwQzs7SUFFQSxDQUFDO0lBQUQsYUFBQztBQUFELENBQUMsQUFGRCxDQUE0QixRQUFRLEdBRW5DO0FBRlksd0JBQU07QUFJbkI7SUFBZ0MsOEJBQVE7SUFBeEM7O0lBZ0JBLENBQUM7SUFiQyw0QkFBTyxHQUFQLFVBQVEsR0FBZ0I7UUFDdEIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUU3QixJQUFJLENBQUMsR0FBRyxrQkFBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU1QixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDaEQsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxJQUFJLE9BQU8sR0FBRyx1QkFBVSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEQsc0JBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2pDLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSx3QkFBZSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFDSCxpQkFBQztBQUFELENBQUMsQUFoQkQsQ0FBZ0MsUUFBUSxHQWdCdkM7QUFoQlksZ0NBQVU7QUFrQnZCO0lBQWlDLCtCQUFRO0lBQXpDOztJQThCQSxDQUFDO0lBN0JDLDJCQUFLLEdBQUwsVUFBTSxPQUFzQjtRQUMxQixJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO1FBRWhDLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQyxNQUFNLENBQUM7UUFFdkMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUN6QixPQUFPLENBQUMsMkJBQTJCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNoRCxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25DLElBQUksT0FBTyxHQUFHLHVCQUFVLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN0RCxzQkFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDdkMsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWCxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDckIsQ0FBQztJQUNILENBQUM7SUFFRCw2QkFBTyxHQUFQLFVBQVEsR0FBZ0I7UUFDdEIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUM3QixJQUFJLENBQUMsR0FBRyxrQkFBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUU1QixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWQsTUFBTSxDQUFDLElBQUksc0JBQWEsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBQ0gsa0JBQUM7QUFBRCxDQUFDLEFBOUJELENBQWlDLFFBQVEsR0E4QnhDO0FBOUJZLGtDQUFXO0FBZ0N4QjtJQUFrQyxnQ0FBUTtJQUExQzs7SUFlQSxDQUFDO0lBWkMsOEJBQU8sR0FBUCxVQUFRLEdBQWdCO1FBQ3RCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDN0IsSUFBSSxDQUFDLEdBQUcsa0JBQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFNUIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2hELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsSUFBSSxPQUFPLEdBQUcsdUJBQVUsQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3RELHNCQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNqQyxDQUFDO1FBRUQsTUFBTSxDQUFDLElBQUksd0JBQWUsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFDSCxtQkFBQztBQUFELENBQUMsQUFmRCxDQUFrQyxRQUFRLEdBZXpDO0FBZlksb0NBQVk7QUFpQnpCO0lBQ0UsaUJBQW9CLEtBQThCLEVBQVUsSUFBa0IsRUFBVSxHQUFnQjtRQUFwRixVQUFLLEdBQUwsS0FBSyxDQUF5QjtRQUFVLFNBQUksR0FBSixJQUFJLENBQWM7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFhO0lBQ3hHLENBQUM7SUFFRCxnQ0FBYyxHQUFkO1FBQ00sSUFBQSxTQUFzQixFQUFwQixnQkFBSyxFQUFFLGNBQUksQ0FBVTtRQUUzQixJQUFJLFdBQVcsR0FBRyx5QkFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hDLElBQUksS0FBSyxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsSUFBSSxVQUFVLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQsNEJBQVUsR0FBVjtRQUNNLElBQUEsU0FBc0IsRUFBcEIsZ0JBQUssRUFBRSxjQUFJLENBQVU7UUFDckIsSUFBQSxtQkFBSyxFQUFFLHFCQUFNLEVBQUUsK0JBQVcsQ0FBVztRQUUzQyxJQUFJLFdBQVcsR0FBRyxxQkFBVyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2hFLElBQUksS0FBSyxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVwRCxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQsNkJBQVcsR0FBWCxVQUFZLFdBQXdCO1FBQzVCLElBQUEsa0JBQUssQ0FBVTtRQUVyQixJQUFJLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFcEQsTUFBTSxDQUFDLElBQUksWUFBWSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUNILGNBQUM7QUFBRCxDQUFDLEFBN0JELElBNkJDOzs7QUFFRCxtQkFBMEIsRUFBK0IsRUFBRSxXQUF3QixFQUFFLEdBQWdCO1FBQXpFLDBCQUFVO0lBQ3BDLE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxHQUFHLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2pFLENBQUM7QUFGRCw4QkFFQztBQUtELElBQWlCLGNBQWMsQ0E4RTlCO0FBOUVELFdBQWlCLGNBQWM7SUFLaEIsaUNBQWtCLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBbUIsbUJBQW1CLENBQUMsQ0FBQztJQU8xRSxpQ0FBa0IsR0FBRyxVQUFVLENBQUMsRUFBRSxDQUF1Qix3QkFBd0IsQ0FBQyxDQUFDO0lBR25GLGdDQUFpQixHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQWtCLGtCQUFrQixDQUFDLENBQUM7SUFHdkUsa0NBQW1CLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBb0Isb0JBQW9CLENBQUMsQ0FBQztJQUc3RSx3QkFBUyxHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQWlCLGtCQUFrQixDQUFDLENBQUM7SUFHOUQsOEJBQWUsR0FBRyxVQUFVLENBQUMsRUFBRSxDQUFnQixnQkFBZ0IsQ0FBQyxDQUFDO0lBRWpFLCtCQUFnQixHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQWlCLGlCQUFpQixDQUFDLENBQUM7SUFJcEUsbUNBQW9CLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBcUIsVUFBVSxDQUFDLENBQUM7SUFHckUsNEJBQWEsR0FBRyxVQUFVLENBQUMsRUFBRSxDQUFjLGNBQWMsQ0FBQyxDQUFDO0lBRzNELDZCQUFjLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBZSxlQUFlLENBQUMsQ0FBQztJQUc5RCx5QkFBVSxHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQVcsVUFBVSxDQUFDLENBQUM7SUFJOUQsSUFBaUIsV0FBVyxDQWdCM0I7SUFoQkQsV0FBaUIsV0FBVztRQUMxQixzQkFBNkIsSUFBaUI7WUFDNUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQixDQUFDO1FBRmUsd0JBQVksZUFFM0IsQ0FBQTtRQUVELHNCQUE2QixJQUFpQjtZQUM1QyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLENBQUM7UUFGZSx3QkFBWSxlQUUzQixDQUFBO1FBRUQsZ0JBQXVCLElBQWlCO1lBQ3RDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakIsQ0FBQztRQUZlLGtCQUFNLFNBRXJCLENBQUE7UUFFRCxjQUFxQixJQUFpQjtZQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLENBQUM7UUFGZSxnQkFBSSxPQUVuQixDQUFBO0lBQ0gsQ0FBQyxFQWhCZ0IsV0FBVyxHQUFYLDBCQUFXLEtBQVgsMEJBQVcsUUFnQjNCO0FBbUJILENBQUMsRUE5RWdCLGNBQWMsR0FBZCxzQkFBYyxLQUFkLHNCQUFjLFFBOEU5QjtBQUVEO0lBQ0Usd0JBQW9CLEdBQWdCLEVBQVUsS0FBa0IsRUFBVSxVQUFpQztRQUF2RixRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBYTtRQUFVLGVBQVUsR0FBVixVQUFVLENBQXVCO0lBQUcsQ0FBQztJQUUvRyw2QkFBSSxHQUFKO1FBQ0UsSUFBSSxNQUFNLEdBQWtDLEVBQUUsQ0FBQztRQUUvQyxHQUFHLENBQUEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDL0MsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQy9DLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4RCxNQUFNLENBQUMsSUFBSSxPQUFYLE1BQU0sRUFBUyxJQUFJLENBQUMsbUJBQW1CLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDdEQsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDekIsQ0FBQztRQUNILENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRU8sd0NBQWUsR0FBdkIsVUFBd0IsS0FBa0M7UUFDakQsSUFBQSxlQUFJLEVBQUUsaUJBQU0sRUFBRSxlQUFJLEVBQUUsbUJBQVEsRUFBRSxrQkFBTyxDQUFVO1FBQ3RELE1BQU0sQ0FBQyxDQUFDLGVBQWUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUMxRixDQUFDO0lBRU8sNENBQW1CLEdBQTNCLFVBQTRCLElBQXFDO1FBQ3hELElBQUEsYUFBRyxFQUFFLG1CQUFTLENBQVM7UUFFOUIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNsQyxJQUFJLEtBQUssR0FBRyxJQUFJLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3RFLE1BQU0sQ0FBQyxDQUFDLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDcEUsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxHQUFHLEdBQWtDLEVBQUUsQ0FBQztZQUM1QyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLEdBQUcsQ0FBQyxJQUFJLE9BQVIsR0FBRyxFQUFTLFNBQVMsQ0FBQyxLQUFLLEVBQUU7WUFDN0IsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFDNUIsR0FBRyxDQUFDLElBQUksT0FBUixHQUFHLEVBQVMsU0FBUyxDQUFDLFVBQVUsRUFBRTtZQUNsQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUM1QixNQUFNLENBQUMsR0FBRyxDQUFDO1FBQ2IsQ0FBQztJQUNILENBQUM7SUFFRCw4QkFBSyxHQUFMLFVBQU0sS0FBOEI7UUFDbEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ3hCLElBQUksS0FBSyxHQUFHLG9CQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakQsTUFBTSxDQUFDLElBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBQ0gscUJBQUM7QUFBRCxDQUFDLEFBaERELElBZ0RDO0FBaERZLHdDQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcGlsZWRQcm9ncmFtLCBDb21waWxlZEJsb2NrIH0gZnJvbSAnLi9jb21waWxlZC9ibG9ja3MnO1xuaW1wb3J0IHsgYnVpbGRlciB9IGZyb20gJy4vY29tcGlsZXInO1xuaW1wb3J0IE9wY29kZUJ1aWxkZXIgZnJvbSAnLi9jb21waWxlZC9vcGNvZGVzL2J1aWxkZXInO1xuaW1wb3J0IEVudmlyb25tZW50IGZyb20gJy4vZW52aXJvbm1lbnQnO1xuaW1wb3J0IHsgT3B0aW9uIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBTZXJpYWxpemVkVGVtcGxhdGVCbG9jaywgVGVtcGxhdGVNZXRhLCBTZXJpYWxpemVkQmxvY2ssIFN0YXRlbWVudCBhcyBTZXJpYWxpemVkU3RhdGVtZW50IH0gZnJvbSAnQGdsaW1tZXIvd2lyZS1mb3JtYXQnO1xuaW1wb3J0ICogYXMgV2lyZUZvcm1hdCBmcm9tICdAZ2xpbW1lci93aXJlLWZvcm1hdCc7XG5pbXBvcnQgeyBlbnRyeVBvaW50IGFzIGVudHJ5UG9pbnRUYWJsZSwgbGF5b3V0IGFzIGxheW91dFRhYmxlLCBibG9jayBhcyBibG9ja1RhYmxlIH0gZnJvbSAnLi9zeW1ib2wtdGFibGUnO1xuaW1wb3J0IHsgT3BhcXVlLCBTeW1ib2xUYWJsZSwgUHJvZ3JhbVN5bWJvbFRhYmxlIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5cbmltcG9ydCB7XG4gIFNUQVRFTUVOVFNcbn0gZnJvbSAnLi9zeW50YXgvZnVuY3Rpb25zJztcblxuaW1wb3J0IHtcbiAgU1BFQ0lBTElaRVxufSBmcm9tICcuL3N5bnRheC9zcGVjaWFsaXplJztcblxuZXhwb3J0IHR5cGUgRGVzZXJpYWxpemVkU3RhdGVtZW50ID0gV2lyZUZvcm1hdC5TdGF0ZW1lbnQgfCBXaXJlRm9ybWF0LlN0YXRlbWVudHMuQXR0cmlidXRlIHwgV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkFyZ3VtZW50O1xuXG5leHBvcnQgZnVuY3Rpb24gY29tcGlsZVN0YXRlbWVudChzdGF0ZW1lbnQ6IEJhc2VsaW5lU3ludGF4LkFueVN0YXRlbWVudCwgYnVpbGRlcjogT3Bjb2RlQnVpbGRlcikge1xuICBsZXQgcmVmaW5lZCA9IFNQRUNJQUxJWkUuc3BlY2lhbGl6ZShzdGF0ZW1lbnQsIGJ1aWxkZXIuc3ltYm9sVGFibGUpO1xuICBTVEFURU1FTlRTLmNvbXBpbGUocmVmaW5lZCwgYnVpbGRlcik7XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZSB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBzdGF0ZW1lbnRzOiBCYXNlbGluZVN5bnRheC5BbnlTdGF0ZW1lbnRbXSwgcHVibGljIHN5bWJvbFRhYmxlOiBTeW1ib2xUYWJsZSkge31cbn1cblxuZXhwb3J0IGNsYXNzIExheW91dCBleHRlbmRzIFRlbXBsYXRlIHtcbiAgcHVibGljIHN5bWJvbFRhYmxlOiBQcm9ncmFtU3ltYm9sVGFibGU7XG59XG5cbmV4cG9ydCBjbGFzcyBFbnRyeVBvaW50IGV4dGVuZHMgVGVtcGxhdGUge1xuICBwdWJsaWMgc3ltYm9sVGFibGU6IFByb2dyYW1TeW1ib2xUYWJsZTtcblxuICBjb21waWxlKGVudjogRW52aXJvbm1lbnQpOiBDb21waWxlZFByb2dyYW0ge1xuICAgIGxldCB0YWJsZSA9IHRoaXMuc3ltYm9sVGFibGU7XG5cbiAgICBsZXQgYiA9IGJ1aWxkZXIoZW52LCB0YWJsZSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3RhdGVtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHN0YXRlbWVudCA9IHRoaXMuc3RhdGVtZW50c1tpXTtcbiAgICAgIGxldCByZWZpbmVkID0gU1BFQ0lBTElaRS5zcGVjaWFsaXplKHN0YXRlbWVudCwgdGFibGUpO1xuICAgICAgU1RBVEVNRU5UUy5jb21waWxlKHJlZmluZWQsIGIpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgQ29tcGlsZWRQcm9ncmFtKGIudG9TbGljZSgpLCB0aGlzLnN5bWJvbFRhYmxlLnNpemUpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBJbmxpbmVCbG9jayBleHRlbmRzIFRlbXBsYXRlIHtcbiAgc3BsYXQoYnVpbGRlcjogT3Bjb2RlQnVpbGRlcikge1xuICAgIGxldCB0YWJsZSA9IGJ1aWxkZXIuc3ltYm9sVGFibGU7XG5cbiAgICBsZXQgbG9jYWxzID0gdGFibGUuZ2V0U3ltYm9scygpLmxvY2FscztcblxuICAgIGlmIChsb2NhbHMpIHtcbiAgICAgIGJ1aWxkZXIucHVzaENoaWxkU2NvcGUoKTtcbiAgICAgIGJ1aWxkZXIuYmluZFBvc2l0aW9uYWxBcmdzRm9yTG9jYWxzKGxvY2Fscyk7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBzdGF0ZW1lbnQgPSB0aGlzLnN0YXRlbWVudHNbaV07XG4gICAgICBsZXQgcmVmaW5lZCA9IFNQRUNJQUxJWkUuc3BlY2lhbGl6ZShzdGF0ZW1lbnQsIHRhYmxlKTtcbiAgICAgIFNUQVRFTUVOVFMuY29tcGlsZShyZWZpbmVkLCBidWlsZGVyKTtcbiAgICB9XG5cbiAgICBpZiAobG9jYWxzKSB7XG4gICAgICBidWlsZGVyLnBvcFNjb3BlKCk7XG4gICAgfVxuICB9XG5cbiAgY29tcGlsZShlbnY6IEVudmlyb25tZW50KTogQ29tcGlsZWRCbG9jayB7XG4gICAgbGV0IHRhYmxlID0gdGhpcy5zeW1ib2xUYWJsZTtcbiAgICBsZXQgYiA9IGJ1aWxkZXIoZW52LCB0YWJsZSk7XG5cbiAgICB0aGlzLnNwbGF0KGIpO1xuXG4gICAgcmV0dXJuIG5ldyBDb21waWxlZEJsb2NrKGIudG9TbGljZSgpKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUGFydGlhbEJsb2NrIGV4dGVuZHMgVGVtcGxhdGUge1xuICBwdWJsaWMgc3ltYm9sVGFibGU6IFByb2dyYW1TeW1ib2xUYWJsZTtcblxuICBjb21waWxlKGVudjogRW52aXJvbm1lbnQpOiBDb21waWxlZFByb2dyYW0ge1xuICAgIGxldCB0YWJsZSA9IHRoaXMuc3ltYm9sVGFibGU7XG4gICAgbGV0IGIgPSBidWlsZGVyKGVudiwgdGFibGUpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBzdGF0ZW1lbnQgPSB0aGlzLnN0YXRlbWVudHNbaV07XG4gICAgICBsZXQgcmVmaW5lZCA9IFNQRUNJQUxJWkUuc3BlY2lhbGl6ZShzdGF0ZW1lbnQsIHRhYmxlKTtcbiAgICAgIFNUQVRFTUVOVFMuY29tcGlsZShyZWZpbmVkLCBiKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IENvbXBpbGVkUHJvZ3JhbShiLnRvU2xpY2UoKSwgdGFibGUuc2l6ZSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2Nhbm5lciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYmxvY2s6IFNlcmlhbGl6ZWRUZW1wbGF0ZUJsb2NrLCBwcml2YXRlIG1ldGE6IFRlbXBsYXRlTWV0YSwgcHJpdmF0ZSBlbnY6IEVudmlyb25tZW50KSB7XG4gIH1cblxuICBzY2FuRW50cnlQb2ludCgpOiBFbnRyeVBvaW50IHtcbiAgICBsZXQgeyBibG9jaywgbWV0YSB9ID0gdGhpcztcblxuICAgIGxldCBzeW1ib2xUYWJsZSA9IGVudHJ5UG9pbnRUYWJsZShtZXRhKTtcbiAgICBsZXQgY2hpbGQgPSBzY2FuQmxvY2soYmxvY2ssIHN5bWJvbFRhYmxlLCB0aGlzLmVudik7XG4gICAgcmV0dXJuIG5ldyBFbnRyeVBvaW50KGNoaWxkLnN0YXRlbWVudHMsIHN5bWJvbFRhYmxlKTtcbiAgfVxuXG4gIHNjYW5MYXlvdXQoKTogTGF5b3V0IHtcbiAgICBsZXQgeyBibG9jaywgbWV0YSB9ID0gdGhpcztcbiAgICBsZXQgeyBuYW1lZCwgeWllbGRzLCBoYXNQYXJ0aWFscyB9ID0gYmxvY2s7XG5cbiAgICBsZXQgc3ltYm9sVGFibGUgPSBsYXlvdXRUYWJsZShtZXRhLCBuYW1lZCwgeWllbGRzLCBoYXNQYXJ0aWFscyk7XG4gICAgbGV0IGNoaWxkID0gc2NhbkJsb2NrKGJsb2NrLCBzeW1ib2xUYWJsZSwgdGhpcy5lbnYpO1xuXG4gICAgcmV0dXJuIG5ldyBMYXlvdXQoY2hpbGQuc3RhdGVtZW50cywgc3ltYm9sVGFibGUpO1xuICB9XG5cbiAgc2NhblBhcnRpYWwoc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKTogUGFydGlhbEJsb2NrIHtcbiAgICBsZXQgeyBibG9jayB9ID0gdGhpcztcblxuICAgIGxldCBjaGlsZCA9IHNjYW5CbG9jayhibG9jaywgc3ltYm9sVGFibGUsIHRoaXMuZW52KTtcblxuICAgIHJldHVybiBuZXcgUGFydGlhbEJsb2NrKGNoaWxkLnN0YXRlbWVudHMsIHN5bWJvbFRhYmxlKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2NhbkJsb2NrKHsgc3RhdGVtZW50cyB9OiBTZXJpYWxpemVkQmxvY2ssIHN5bWJvbFRhYmxlOiBTeW1ib2xUYWJsZSwgZW52OiBFbnZpcm9ubWVudCk6IElubGluZUJsb2NrIHtcbiAgcmV0dXJuIG5ldyBSYXdJbmxpbmVCbG9jayhlbnYsIHN5bWJvbFRhYmxlLCBzdGF0ZW1lbnRzKS5zY2FuKCk7XG59XG5cbmltcG9ydCB7IFB1YmxpY1ZNIH0gZnJvbSAnLi92bSc7XG5pbXBvcnQgeyBQYXRoUmVmZXJlbmNlIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcblxuZXhwb3J0IG5hbWVzcGFjZSBCYXNlbGluZVN5bnRheCB7XG4gIGltcG9ydCBDb3JlID0gV2lyZUZvcm1hdC5Db3JlO1xuXG4gIC8vIFRPRE86IHVzZSBzeW1ib2xzIGZvciBzZXhwWzBdP1xuICBleHBvcnQgdHlwZSBTY2FubmVkQ29tcG9uZW50ID0gWydzY2FubmVkLWNvbXBvbmVudCcsIHN0cmluZywgUmF3SW5saW5lQmxvY2ssIFdpcmVGb3JtYXQuQ29yZS5IYXNoLCBPcHRpb248UmF3SW5saW5lQmxvY2s+XTtcbiAgZXhwb3J0IGNvbnN0IGlzU2Nhbm5lZENvbXBvbmVudCA9IFdpcmVGb3JtYXQuaXM8U2Nhbm5lZENvbXBvbmVudD4oJ3NjYW5uZWQtY29tcG9uZW50Jyk7XG5cbiAgaW1wb3J0IFBhcmFtcyA9IFdpcmVGb3JtYXQuQ29yZS5QYXJhbXM7XG4gIGltcG9ydCBIYXNoID0gV2lyZUZvcm1hdC5Db3JlLkhhc2g7XG4gIGV4cG9ydCB0eXBlIEJsb2NrID0gSW5saW5lQmxvY2s7XG5cbiAgZXhwb3J0IHR5cGUgT3BlblByaW1pdGl2ZUVsZW1lbnQgPSBbJ29wZW4tcHJpbWl0aXZlLWVsZW1lbnQnLCBzdHJpbmcsIHN0cmluZ1tdXTtcbiAgZXhwb3J0IGNvbnN0IGlzUHJpbWl0aXZlRWxlbWVudCA9IFdpcmVGb3JtYXQuaXM8T3BlblByaW1pdGl2ZUVsZW1lbnQ+KCdvcGVuLXByaW1pdGl2ZS1lbGVtZW50Jyk7XG5cbiAgZXhwb3J0IHR5cGUgT3B0aW1pemVkQXBwZW5kID0gWydvcHRpbWl6ZWQtYXBwZW5kJywgV2lyZUZvcm1hdC5FeHByZXNzaW9uLCBib29sZWFuXTtcbiAgZXhwb3J0IGNvbnN0IGlzT3B0aW1pemVkQXBwZW5kID0gV2lyZUZvcm1hdC5pczxPcHRpbWl6ZWRBcHBlbmQ+KCdvcHRpbWl6ZWQtYXBwZW5kJyk7XG5cbiAgZXhwb3J0IHR5cGUgVW5vcHRpbWl6ZWRBcHBlbmQgPSBbJ3Vub3B0aW1pemVkLWFwcGVuZCcsIFdpcmVGb3JtYXQuRXhwcmVzc2lvbiwgYm9vbGVhbl07XG4gIGV4cG9ydCBjb25zdCBpc1Vub3B0aW1pemVkQXBwZW5kID0gV2lyZUZvcm1hdC5pczxVbm9wdGltaXplZEFwcGVuZD4oJ3Vub3B0aW1pemVkLWFwcGVuZCcpO1xuXG4gIGV4cG9ydCB0eXBlIEFueUR5bmFtaWNBdHRyID0gWydhbnktZHluYW1pYy1hdHRyJywgc3RyaW5nLCBXaXJlRm9ybWF0LkV4cHJlc3Npb24sIE9wdGlvbjxzdHJpbmc+LCBib29sZWFuXTtcbiAgZXhwb3J0IGNvbnN0IGlzQW55QXR0ciA9IFdpcmVGb3JtYXQuaXM8QW55RHluYW1pY0F0dHI+KCdhbnktZHluYW1pYy1hdHRyJyk7XG5cbiAgZXhwb3J0IHR5cGUgU3RhdGljUGFydGlhbCA9IFsnc3RhdGljLXBhcnRpYWwnLCBzdHJpbmddO1xuICBleHBvcnQgY29uc3QgaXNTdGF0aWNQYXJ0aWFsID0gV2lyZUZvcm1hdC5pczxTdGF0aWNQYXJ0aWFsPignc3RhdGljLXBhcnRpYWwnKTtcbiAgZXhwb3J0IHR5cGUgRHluYW1pY1BhcnRpYWwgPSBbJ2R5bmFtaWMtcGFydGlhbCcsIFdpcmVGb3JtYXQuRXhwcmVzc2lvbl07XG4gIGV4cG9ydCBjb25zdCBpc0R5bmFtaWNQYXJ0aWFsID0gV2lyZUZvcm1hdC5pczxEeW5hbWljUGFydGlhbD4oJ2R5bmFtaWMtcGFydGlhbCcpO1xuXG4gIGV4cG9ydCB0eXBlIEZ1bmN0aW9uRXhwcmVzc2lvbkNhbGxiYWNrPFQ+ID0gKFZNOiBQdWJsaWNWTSwgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKSA9PiBQYXRoUmVmZXJlbmNlPFQ+O1xuICBleHBvcnQgdHlwZSBGdW5jdGlvbkV4cHJlc3Npb24gPSBbJ2Z1bmN0aW9uJywgRnVuY3Rpb25FeHByZXNzaW9uQ2FsbGJhY2s8T3BhcXVlPl07XG4gIGV4cG9ydCBjb25zdCBpc0Z1bmN0aW9uRXhwcmVzc2lvbiA9IFdpcmVGb3JtYXQuaXM8RnVuY3Rpb25FeHByZXNzaW9uPignZnVuY3Rpb24nKTtcblxuICBleHBvcnQgdHlwZSBOZXN0ZWRCbG9jayA9IFsnbmVzdGVkLWJsb2NrJywgV2lyZUZvcm1hdC5Db3JlLlBhdGgsIFdpcmVGb3JtYXQuQ29yZS5QYXJhbXMsIFdpcmVGb3JtYXQuQ29yZS5IYXNoLCBPcHRpb248QmxvY2s+LCBPcHRpb248QmxvY2s+XTtcbiAgZXhwb3J0IGNvbnN0IGlzTmVzdGVkQmxvY2sgPSBXaXJlRm9ybWF0LmlzPE5lc3RlZEJsb2NrPignbmVzdGVkLWJsb2NrJyk7XG5cbiAgZXhwb3J0IHR5cGUgU2Nhbm5lZEJsb2NrID0gWydzY2FubmVkLWJsb2NrJywgQ29yZS5QYXRoLCBDb3JlLlBhcmFtcywgQ29yZS5IYXNoLCBPcHRpb248UmF3SW5saW5lQmxvY2s+LCBPcHRpb248UmF3SW5saW5lQmxvY2s+XTtcbiAgZXhwb3J0IGNvbnN0IGlzU2Nhbm5lZEJsb2NrID0gV2lyZUZvcm1hdC5pczxTY2FubmVkQmxvY2s+KCdzY2FubmVkLWJsb2NrJyk7XG5cbiAgZXhwb3J0IHR5cGUgRGVidWdnZXIgPSBbJ2RlYnVnZ2VyJ107XG4gIGV4cG9ydCBjb25zdCBpc0RlYnVnZ2VyID0gV2lyZUZvcm1hdC5pczxEZWJ1Z2dlcj4oJ2RlYnVnZ2VyJyk7XG5cbiAgZXhwb3J0IHR5cGUgQXJncyA9IFtQYXJhbXMsIEhhc2gsIE9wdGlvbjxCbG9jaz4sIE9wdGlvbjxCbG9jaz5dO1xuXG4gIGV4cG9ydCBuYW1lc3BhY2UgTmVzdGVkQmxvY2sge1xuICAgIGV4cG9ydCBmdW5jdGlvbiBkZWZhdWx0QmxvY2soc2V4cDogTmVzdGVkQmxvY2spOiBPcHRpb248SW5saW5lQmxvY2s+IHtcbiAgICAgIHJldHVybiBzZXhwWzRdO1xuICAgIH1cblxuICAgIGV4cG9ydCBmdW5jdGlvbiBpbnZlcnNlQmxvY2soc2V4cDogTmVzdGVkQmxvY2spOiBPcHRpb248SW5saW5lQmxvY2s+IHtcbiAgICAgIHJldHVybiBzZXhwWzVdO1xuICAgIH1cblxuICAgIGV4cG9ydCBmdW5jdGlvbiBwYXJhbXMoc2V4cDogTmVzdGVkQmxvY2spOiBXaXJlRm9ybWF0LkNvcmUuUGFyYW1zIHtcbiAgICAgIHJldHVybiBzZXhwWzJdO1xuICAgIH1cblxuICAgIGV4cG9ydCBmdW5jdGlvbiBoYXNoKHNleHA6IE5lc3RlZEJsb2NrKTogV2lyZUZvcm1hdC5Db3JlLkhhc2gge1xuICAgICAgcmV0dXJuIHNleHBbM107XG4gICAgfVxuICB9XG5cbiAgZXhwb3J0IHR5cGUgU3RhdGVtZW50ID1cbiAgICAgIFNjYW5uZWRDb21wb25lbnRcbiAgICB8IE9wZW5QcmltaXRpdmVFbGVtZW50XG4gICAgfCBPcHRpbWl6ZWRBcHBlbmRcbiAgICB8IFVub3B0aW1pemVkQXBwZW5kXG4gICAgfCBTdGF0aWNQYXJ0aWFsXG4gICAgfCBEeW5hbWljUGFydGlhbFxuICAgIHwgQW55RHluYW1pY0F0dHJcbiAgICB8IE5lc3RlZEJsb2NrXG4gICAgfCBTY2FubmVkQmxvY2tcbiAgICB8IERlYnVnZ2VyXG4gICAgO1xuXG4gIGV4cG9ydCB0eXBlIEFueVN0YXRlbWVudCA9IFN0YXRlbWVudCB8IFdpcmVGb3JtYXQuU3RhdGVtZW50O1xuICBleHBvcnQgdHlwZSBBbnlFeHByZXNzaW9uID0gRnVuY3Rpb25FeHByZXNzaW9uIHwgV2lyZUZvcm1hdC5FeHByZXNzaW9uO1xuXG4gIGV4cG9ydCB0eXBlIFByb2dyYW0gPSBBbnlTdGF0ZW1lbnRbXTtcbn1cblxuZXhwb3J0IGNsYXNzIFJhd0lubGluZUJsb2NrIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbnY6IEVudmlyb25tZW50LCBwcml2YXRlIHRhYmxlOiBTeW1ib2xUYWJsZSwgcHJpdmF0ZSBzdGF0ZW1lbnRzOiBTZXJpYWxpemVkU3RhdGVtZW50W10pIHt9XG5cbiAgc2NhbigpOiBJbmxpbmVCbG9jayB7XG4gICAgbGV0IGJ1ZmZlcjogQmFzZWxpbmVTeW50YXguQW55U3RhdGVtZW50W10gPSBbXTtcblxuICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLnN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBzdGF0ZW1lbnQgPSB0aGlzLnN0YXRlbWVudHNbaV07XG4gICAgICBpZiAoV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLmlzQmxvY2soc3RhdGVtZW50KSkge1xuICAgICAgICBidWZmZXIucHVzaCh0aGlzLnNwZWNpYWxpemVCbG9jayhzdGF0ZW1lbnQpKTtcbiAgICAgIH0gZWxzZSBpZiAoV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLmlzQ29tcG9uZW50KHN0YXRlbWVudCkpIHtcbiAgICAgICAgYnVmZmVyLnB1c2goLi4udGhpcy5zcGVjaWFsaXplQ29tcG9uZW50KHN0YXRlbWVudCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnVmZmVyLnB1c2goc3RhdGVtZW50KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IElubGluZUJsb2NrKGJ1ZmZlciwgdGhpcy50YWJsZSk7XG4gIH1cblxuICBwcml2YXRlIHNwZWNpYWxpemVCbG9jayhibG9jazogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkJsb2NrKTogQmFzZWxpbmVTeW50YXguU2Nhbm5lZEJsb2NrIHtcbiAgICBsZXQgWywgcGF0aCwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZV0gPSBibG9jaztcbiAgICByZXR1cm4gWydzY2FubmVkLWJsb2NrJywgcGF0aCwgcGFyYW1zLCBoYXNoLCB0aGlzLmNoaWxkKHRlbXBsYXRlKSwgdGhpcy5jaGlsZChpbnZlcnNlKV07XG4gIH1cblxuICBwcml2YXRlIHNwZWNpYWxpemVDb21wb25lbnQoc2V4cDogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkNvbXBvbmVudCk6IEJhc2VsaW5lU3ludGF4LkFueVN0YXRlbWVudFtdIHtcbiAgICBsZXQgWywgdGFnLCBjb21wb25lbnRdID0gc2V4cDtcblxuICAgIGlmICh0aGlzLmVudi5oYXNDb21wb25lbnREZWZpbml0aW9uKFt0YWddLCB0aGlzLnRhYmxlKSkge1xuICAgICAgbGV0IGNoaWxkID0gdGhpcy5jaGlsZChjb21wb25lbnQpO1xuICAgICAgbGV0IGF0dHJzID0gbmV3IFJhd0lubGluZUJsb2NrKHRoaXMuZW52LCB0aGlzLnRhYmxlLCBjb21wb25lbnQuYXR0cnMpO1xuICAgICAgcmV0dXJuIFtbJ3NjYW5uZWQtY29tcG9uZW50JywgdGFnLCBhdHRycywgY29tcG9uZW50LmFyZ3MsIGNoaWxkXV07XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBidWY6IEJhc2VsaW5lU3ludGF4LkFueVN0YXRlbWVudFtdID0gW107XG4gICAgICBidWYucHVzaChbJ29wZW4tZWxlbWVudCcsIHRhZywgW11dKTtcbiAgICAgIGJ1Zi5wdXNoKC4uLmNvbXBvbmVudC5hdHRycyk7XG4gICAgICBidWYucHVzaChbJ2ZsdXNoLWVsZW1lbnQnXSk7XG4gICAgICBidWYucHVzaCguLi5jb21wb25lbnQuc3RhdGVtZW50cyk7XG4gICAgICBidWYucHVzaChbJ2Nsb3NlLWVsZW1lbnQnXSk7XG4gICAgICByZXR1cm4gYnVmO1xuICAgIH1cbiAgfVxuXG4gIGNoaWxkKGJsb2NrOiBPcHRpb248U2VyaWFsaXplZEJsb2NrPik6IE9wdGlvbjxSYXdJbmxpbmVCbG9jaz4ge1xuICAgIGlmICghYmxvY2spIHJldHVybiBudWxsO1xuICAgIGxldCB0YWJsZSA9IGJsb2NrVGFibGUodGhpcy50YWJsZSwgYmxvY2subG9jYWxzKTtcbiAgICByZXR1cm4gbmV3IFJhd0lubGluZUJsb2NrKHRoaXMuZW52LCB0YWJsZSwgYmxvY2suc3RhdGVtZW50cyk7XG4gIH1cbn1cbiJdfQ==