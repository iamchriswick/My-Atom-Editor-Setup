"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var opcodes_1 = require("../../opcodes");
var vm_1 = require("./vm");
var args_1 = require("../../compiled/expressions/args");
var reference_1 = require("@glimmer/reference");
var opcodes_2 = require("../../opcodes");
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.PutDynamicComponent, function (vm) {
    var reference = vm.frame.getOperand();
    var cache = reference_1.isConst(reference) ? undefined : new reference_1.ReferenceCache(reference);
    var definition = cache ? cache.peek() : reference.value();
    vm.frame.setImmediate(definition);
    if (cache) {
        vm.updateWith(new vm_1.Assert(cache));
    }
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.PutComponent, function (vm, _a) {
    var _component = _a.op1;
    var definition = vm.constants.getOther(_component);
    vm.frame.setImmediate(definition);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.OpenComponent, function (vm, _a) {
    var _args = _a.op1, _shadow = _a.op2;
    var rawArgs = vm.constants.getExpression(_args);
    var shadow = vm.constants.getBlock(_shadow);
    var definition = vm.frame.getImmediate();
    var dynamicScope = vm.pushDynamicScope();
    var callerScope = vm.scope();
    var manager = definition.manager;
    var args = manager.prepareArgs(definition, rawArgs.evaluate(vm), dynamicScope);
    var hasDefaultBlock = !!args.blocks.default; // TODO Cleanup?
    var component = manager.create(vm.env, definition, args, dynamicScope, vm.getSelf(), hasDefaultBlock);
    var destructor = manager.getDestructor(component);
    if (destructor)
        vm.newDestroyable(destructor);
    var layout = manager.layoutFor(definition, component, vm.env);
    var selfRef = manager.getSelf(component);
    vm.beginCacheGroup();
    vm.stack().pushSimpleBlock();
    vm.pushRootScope(selfRef, layout.symbols);
    vm.invokeLayout(args, layout, callerScope, component, manager, shadow);
    vm.updateWith(new UpdateComponentOpcode(definition.name, component, manager, args, dynamicScope));
});
// export class DidCreateElementOpcode extends Opcode {
//   public type = "did-create-element";
//   evaluate(vm: VM) {
//     let manager = vm.frame.getManager();
//     let component = vm.frame.getComponent();
//     let action = 'DidCreateElementOpcode#evaluate';
//     manager.didCreateElement(component, vm.stack().expectConstructing(action), vm.stack().expectOperations(action));
//   }
//   toJSON(): OpcodeJSON {
//     return {
//       guid: this._guid,
//       type: this.type,
//       args: ["$ARGS"]
//     };
//   }
// }
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.DidCreateElement, function (vm) {
    var manager = vm.frame.getManager();
    var component = vm.frame.getComponent();
    var action = 'DidCreateElementOpcode#evaluate';
    manager.didCreateElement(component, vm.stack().expectConstructing(action), vm.stack().expectOperations(action));
});
// export class ShadowAttributesOpcode extends Opcode {
//   public type = "shadow-attributes";
//   evaluate(vm: VM) {
//     let shadow = vm.frame.getShadow();
//     vm.pushCallerScope();
//     if (!shadow) return;
//     vm.invokeBlock(shadow, EvaluatedArgs.empty());
//   }
//   toJSON(): OpcodeJSON {
//     return {
//       guid: this._guid,
//       type: this.type,
//       args: ["$ARGS"]
//     };
//   }
// }
// Slow path for non-specialized component invocations. Uses an internal
// named lookup on the args.
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.ShadowAttributes, function (vm) {
    var shadow = vm.frame.getShadow();
    vm.pushCallerScope();
    if (!shadow)
        return;
    vm.invokeBlock(shadow, args_1.EvaluatedArgs.empty());
});
// export class DidRenderLayoutOpcode extends Opcode {
//   public type = "did-render-layout";
//   evaluate(vm: VM) {
//     let manager = vm.frame.getManager();
//     let component = vm.frame.getComponent();
//     let bounds = vm.stack().popBlock();
//     manager.didRenderLayout(component, bounds);
//     vm.env.didCreate(component, manager);
//     vm.updateWith(new DidUpdateLayoutOpcode(manager, component, bounds));
//   }
// }
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.DidRenderLayout, function (vm) {
    var manager = vm.frame.getManager();
    var component = vm.frame.getComponent();
    var bounds = vm.stack().popBlock();
    manager.didRenderLayout(component, bounds);
    vm.env.didCreate(component, manager);
    vm.updateWith(new DidUpdateLayoutOpcode(manager, component, bounds));
});
// export class CloseComponentOpcode extends Opcode {
//   public type = "close-component";
//   evaluate(vm: VM) {
//     vm.popScope();
//     vm.popDynamicScope();
//     vm.commitCacheGroup();
//   }
// }
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.CloseComponent, function (vm) {
    vm.popScope();
    vm.popDynamicScope();
    vm.commitCacheGroup();
});
var UpdateComponentOpcode = (function (_super) {
    __extends(UpdateComponentOpcode, _super);
    function UpdateComponentOpcode(name, component, manager, args, dynamicScope) {
        var _this = _super.call(this) || this;
        _this.name = name;
        _this.component = component;
        _this.manager = manager;
        _this.args = args;
        _this.dynamicScope = dynamicScope;
        _this.type = "update-component";
        var componentTag = manager.getTag(component);
        if (componentTag) {
            _this.tag = reference_1.combine([args.tag, componentTag]);
        }
        else {
            _this.tag = args.tag;
        }
        return _this;
    }
    UpdateComponentOpcode.prototype.evaluate = function (_vm) {
        var _a = this, component = _a.component, manager = _a.manager, args = _a.args, dynamicScope = _a.dynamicScope;
        manager.update(component, args, dynamicScope);
    };
    UpdateComponentOpcode.prototype.toJSON = function () {
        return {
            guid: this._guid,
            type: this.type,
            args: [JSON.stringify(this.name)]
        };
    };
    return UpdateComponentOpcode;
}(opcodes_1.UpdatingOpcode));
exports.UpdateComponentOpcode = UpdateComponentOpcode;
var DidUpdateLayoutOpcode = (function (_super) {
    __extends(DidUpdateLayoutOpcode, _super);
    function DidUpdateLayoutOpcode(manager, component, bounds) {
        var _this = _super.call(this) || this;
        _this.manager = manager;
        _this.component = component;
        _this.bounds = bounds;
        _this.type = "did-update-layout";
        _this.tag = reference_1.CONSTANT_TAG;
        return _this;
    }
    DidUpdateLayoutOpcode.prototype.evaluate = function (vm) {
        var _a = this, manager = _a.manager, component = _a.component, bounds = _a.bounds;
        manager.didUpdateLayout(component, bounds);
        vm.env.didUpdate(component, manager);
    };
    return DidUpdateLayoutOpcode;
}(opcodes_1.UpdatingOpcode));
exports.DidUpdateLayoutOpcode = DidUpdateLayoutOpcode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQGdsaW1tZXIvcnVudGltZS9saWIvY29tcGlsZWQvb3Bjb2Rlcy9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEseUNBQTJEO0FBQzNELDJCQUE4QjtBQUc5Qix3REFBOEU7QUFHOUUsZ0RBQWlHO0FBQ2pHLHlDQUFpRTtBQUVqRSx3QkFBYyxDQUFDLEdBQUcsQ0FBQyxvQkFBRSxDQUFDLG1CQUFtQixFQUFFLFVBQUEsRUFBRTtJQUMzQyxJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBa0MsQ0FBQztJQUN0RSxJQUFJLEtBQUssR0FBRyxtQkFBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLFNBQVMsR0FBRyxJQUFJLDBCQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDM0UsSUFBSSxVQUFVLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7SUFFMUQsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7SUFFbEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNWLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxXQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNuQyxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCx3QkFBYyxDQUFDLEdBQUcsQ0FBQyxvQkFBRSxDQUFDLFlBQVksRUFBRSxVQUFDLEVBQUUsRUFBRSxFQUFtQjtRQUFqQixtQkFBZTtJQUN4RCxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBaUMsVUFBVSxDQUFDLENBQUM7SUFDbkYsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDcEMsQ0FBQyxDQUFDLENBQUM7QUFF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QVMsRUFBRSxrQkFBTSxDQUFVO1FBRTFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRTNDLEVBQUUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBQ0gsNEJBQUM7QUFBRCxDQUFDLEFBbkJELENBQTJDLHdCQUFjLEdBbUJ4RDtBQW5CWSxzREFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPcGNvZGVKU09OLCBVcGRhdGluZ09wY29kZSB9IGZyb20gJy4uLy4uL29wY29kZXMnO1xuaW1wb3J0IHsgQXNzZXJ0IH0gZnJvbSAnLi92bSc7XG5pbXBvcnQgeyBDb21wb25lbnQsIENvbXBvbmVudE1hbmFnZXIsIENvbXBvbmVudERlZmluaXRpb24gfSBmcm9tICcuLi8uLi9jb21wb25lbnQvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBVcGRhdGluZ1ZNIH0gZnJvbSAnLi4vLi4vdm0nO1xuaW1wb3J0IHsgQ29tcGlsZWRBcmdzLCBFdmFsdWF0ZWRBcmdzIH0gZnJvbSAnLi4vLi4vY29tcGlsZWQvZXhwcmVzc2lvbnMvYXJncyc7XG5pbXBvcnQgeyBEeW5hbWljU2NvcGUgfSBmcm9tICcuLi8uLi9lbnZpcm9ubWVudCc7XG5pbXBvcnQgQm91bmRzIGZyb20gJy4uLy4uL2JvdW5kcyc7XG5pbXBvcnQgeyBDT05TVEFOVF9UQUcsIFJlZmVyZW5jZUNhY2hlLCBjb21iaW5lLCBpc0NvbnN0LCBSZXZpc2lvblRhZyB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQgeyBBUFBFTkRfT1BDT0RFUywgT3Bjb2RlTmFtZSBhcyBPcCB9IGZyb20gJy4uLy4uL29wY29kZXMnO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUHV0RHluYW1pY0NvbXBvbmVudCwgdm0gPT4ge1xuICBsZXQgcmVmZXJlbmNlID0gdm0uZnJhbWUuZ2V0T3BlcmFuZDxDb21wb25lbnREZWZpbml0aW9uPENvbXBvbmVudD4+KCk7XG4gIGxldCBjYWNoZSA9IGlzQ29uc3QocmVmZXJlbmNlKSA/IHVuZGVmaW5lZCA6IG5ldyBSZWZlcmVuY2VDYWNoZShyZWZlcmVuY2UpO1xuICBsZXQgZGVmaW5pdGlvbiA9IGNhY2hlID8gY2FjaGUucGVlaygpIDogcmVmZXJlbmNlLnZhbHVlKCk7XG5cbiAgdm0uZnJhbWUuc2V0SW1tZWRpYXRlKGRlZmluaXRpb24pO1xuXG4gIGlmIChjYWNoZSkge1xuICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChjYWNoZSkpO1xuICB9XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlB1dENvbXBvbmVudCwgKHZtLCB7IG9wMTogX2NvbXBvbmVudCB9KSA9PiB7XG4gIGxldCBkZWZpbml0aW9uID0gdm0uY29uc3RhbnRzLmdldE90aGVyPENvbXBvbmVudERlZmluaXRpb248Q29tcG9uZW50Pj4oX2NvbXBvbmVudCk7XG4gIHZtLmZyYW1lLnNldEltbWVkaWF0ZShkZWZpbml0aW9uKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuT3BlbkNvbXBvbmVudCwgKHZtLCB7IG9wMTogX2FyZ3MsIG9wMjogX3NoYWRvdyB9KSA9PiB7XG4gIGxldCByYXdBcmdzID0gdm0uY29uc3RhbnRzLmdldEV4cHJlc3Npb248Q29tcGlsZWRBcmdzPihfYXJncyk7XG4gIGxldCBzaGFkb3cgPSB2bS5jb25zdGFudHMuZ2V0QmxvY2soX3NoYWRvdyk7XG5cbiAgbGV0IGRlZmluaXRpb24gPSB2bS5mcmFtZS5nZXRJbW1lZGlhdGU8Q29tcG9uZW50RGVmaW5pdGlvbjxDb21wb25lbnQ+PigpO1xuICBsZXQgZHluYW1pY1Njb3BlID0gdm0ucHVzaER5bmFtaWNTY29wZSgpO1xuICBsZXQgY2FsbGVyU2NvcGUgPSB2bS5zY29wZSgpO1xuXG4gIGxldCBtYW5hZ2VyID0gZGVmaW5pdGlvbi5tYW5hZ2VyO1xuICBsZXQgYXJncyA9IG1hbmFnZXIucHJlcGFyZUFyZ3MoZGVmaW5pdGlvbiwgcmF3QXJncy5ldmFsdWF0ZSh2bSksIGR5bmFtaWNTY29wZSk7XG4gIGxldCBoYXNEZWZhdWx0QmxvY2sgPSAhIWFyZ3MuYmxvY2tzLmRlZmF1bHQ7IC8vIFRPRE8gQ2xlYW51cD9cbiAgbGV0IGNvbXBvbmVudCA9IG1hbmFnZXIuY3JlYXRlKHZtLmVudiwgZGVmaW5pdGlvbiwgYXJncywgZHluYW1pY1Njb3BlLCB2bS5nZXRTZWxmKCksIGhhc0RlZmF1bHRCbG9jayk7XG4gIGxldCBkZXN0cnVjdG9yID0gbWFuYWdlci5nZXREZXN0cnVjdG9yKGNvbXBvbmVudCk7XG4gIGlmIChkZXN0cnVjdG9yKSB2bS5uZXdEZXN0cm95YWJsZShkZXN0cnVjdG9yKTtcblxuICBsZXQgbGF5b3V0ID0gbWFuYWdlci5sYXlvdXRGb3IoZGVmaW5pdGlvbiwgY29tcG9uZW50LCB2bS5lbnYpO1xuICBsZXQgc2VsZlJlZiA9IG1hbmFnZXIuZ2V0U2VsZihjb21wb25lbnQpO1xuXG4gIHZtLmJlZ2luQ2FjaGVHcm91cCgpO1xuICB2bS5zdGFjaygpLnB1c2hTaW1wbGVCbG9jaygpO1xuICB2bS5wdXNoUm9vdFNjb3BlKHNlbGZSZWYsIGxheW91dC5zeW1ib2xzKTtcbiAgdm0uaW52b2tlTGF5b3V0KGFyZ3MsIGxheW91dCwgY2FsbGVyU2NvcGUsIGNvbXBvbmVudCwgbWFuYWdlciwgc2hhZG93KTtcblxuICB2bS51cGRhdGVXaXRoKG5ldyBVcGRhdGVDb21wb25lbnRPcGNvZGUoZGVmaW5pdGlvbi5uYW1lLCBjb21wb25lbnQsIG1hbmFnZXIsIGFyZ3MsIGR5bmFtaWNTY29wZSkpO1xufSk7XG5cbi8vIGV4cG9ydCBjbGFzcyBEaWRDcmVhdGVFbGVtZW50T3Bjb2RlIGV4dGVuZHMgT3Bjb2RlIHtcbi8vICAgcHVibGljIHR5cGUgPSBcImRpZC1jcmVhdGUtZWxlbWVudFwiO1xuXG4vLyAgIGV2YWx1YXRlKHZtOiBWTSkge1xuLy8gICAgIGxldCBtYW5hZ2VyID0gdm0uZnJhbWUuZ2V0TWFuYWdlcigpO1xuLy8gICAgIGxldCBjb21wb25lbnQgPSB2bS5mcmFtZS5nZXRDb21wb25lbnQoKTtcblxuLy8gICAgIGxldCBhY3Rpb24gPSAnRGlkQ3JlYXRlRWxlbWVudE9wY29kZSNldmFsdWF0ZSc7XG4vLyAgICAgbWFuYWdlci5kaWRDcmVhdGVFbGVtZW50KGNvbXBvbmVudCwgdm0uc3RhY2soKS5leHBlY3RDb25zdHJ1Y3RpbmcoYWN0aW9uKSwgdm0uc3RhY2soKS5leHBlY3RPcGVyYXRpb25zKGFjdGlvbikpO1xuLy8gICB9XG5cbi8vICAgdG9KU09OKCk6IE9wY29kZUpTT04ge1xuLy8gICAgIHJldHVybiB7XG4vLyAgICAgICBndWlkOiB0aGlzLl9ndWlkLFxuLy8gICAgICAgdHlwZTogdGhpcy50eXBlLFxuLy8gICAgICAgYXJnczogW1wiJEFSR1NcIl1cbi8vICAgICB9O1xuLy8gICB9XG4vLyB9XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5EaWRDcmVhdGVFbGVtZW50LCB2bSA9PiB7XG4gIGxldCBtYW5hZ2VyID0gdm0uZnJhbWUuZ2V0TWFuYWdlcigpO1xuICBsZXQgY29tcG9uZW50ID0gdm0uZnJhbWUuZ2V0Q29tcG9uZW50KCk7XG5cbiAgbGV0IGFjdGlvbiA9ICdEaWRDcmVhdGVFbGVtZW50T3Bjb2RlI2V2YWx1YXRlJztcbiAgbWFuYWdlci5kaWRDcmVhdGVFbGVtZW50KGNvbXBvbmVudCwgdm0uc3RhY2soKS5leHBlY3RDb25zdHJ1Y3RpbmcoYWN0aW9uKSwgdm0uc3RhY2soKS5leHBlY3RPcGVyYXRpb25zKGFjdGlvbikpO1xufSk7XG5cbi8vIGV4cG9ydCBjbGFzcyBTaGFkb3dBdHRyaWJ1dGVzT3Bjb2RlIGV4dGVuZHMgT3Bjb2RlIHtcbi8vICAgcHVibGljIHR5cGUgPSBcInNoYWRvdy1hdHRyaWJ1dGVzXCI7XG5cbi8vICAgZXZhbHVhdGUodm06IFZNKSB7XG4vLyAgICAgbGV0IHNoYWRvdyA9IHZtLmZyYW1lLmdldFNoYWRvdygpO1xuXG4vLyAgICAgdm0ucHVzaENhbGxlclNjb3BlKCk7XG4vLyAgICAgaWYgKCFzaGFkb3cpIHJldHVybjtcblxuLy8gICAgIHZtLmludm9rZUJsb2NrKHNoYWRvdywgRXZhbHVhdGVkQXJncy5lbXB0eSgpKTtcbi8vICAgfVxuXG4vLyAgIHRvSlNPTigpOiBPcGNvZGVKU09OIHtcbi8vICAgICByZXR1cm4ge1xuLy8gICAgICAgZ3VpZDogdGhpcy5fZ3VpZCxcbi8vICAgICAgIHR5cGU6IHRoaXMudHlwZSxcbi8vICAgICAgIGFyZ3M6IFtcIiRBUkdTXCJdXG4vLyAgICAgfTtcbi8vICAgfVxuLy8gfVxuXG4vLyBTbG93IHBhdGggZm9yIG5vbi1zcGVjaWFsaXplZCBjb21wb25lbnQgaW52b2NhdGlvbnMuIFVzZXMgYW4gaW50ZXJuYWxcbi8vIG5hbWVkIGxvb2t1cCBvbiB0aGUgYXJncy5cbkFQUEVORF9PUENPREVTLmFkZChPcC5TaGFkb3dBdHRyaWJ1dGVzLCB2bSA9PiB7XG4gIGxldCBzaGFkb3cgPSB2bS5mcmFtZS5nZXRTaGFkb3coKTtcblxuICB2bS5wdXNoQ2FsbGVyU2NvcGUoKTtcbiAgaWYgKCFzaGFkb3cpIHJldHVybjtcblxuICB2bS5pbnZva2VCbG9jayhzaGFkb3csIEV2YWx1YXRlZEFyZ3MuZW1wdHkoKSk7XG59KTtcblxuLy8gZXhwb3J0IGNsYXNzIERpZFJlbmRlckxheW91dE9wY29kZSBleHRlbmRzIE9wY29kZSB7XG4vLyAgIHB1YmxpYyB0eXBlID0gXCJkaWQtcmVuZGVyLWxheW91dFwiO1xuXG4vLyAgIGV2YWx1YXRlKHZtOiBWTSkge1xuLy8gICAgIGxldCBtYW5hZ2VyID0gdm0uZnJhbWUuZ2V0TWFuYWdlcigpO1xuLy8gICAgIGxldCBjb21wb25lbnQgPSB2bS5mcmFtZS5nZXRDb21wb25lbnQoKTtcbi8vICAgICBsZXQgYm91bmRzID0gdm0uc3RhY2soKS5wb3BCbG9jaygpO1xuXG4vLyAgICAgbWFuYWdlci5kaWRSZW5kZXJMYXlvdXQoY29tcG9uZW50LCBib3VuZHMpO1xuXG4vLyAgICAgdm0uZW52LmRpZENyZWF0ZShjb21wb25lbnQsIG1hbmFnZXIpO1xuXG4vLyAgICAgdm0udXBkYXRlV2l0aChuZXcgRGlkVXBkYXRlTGF5b3V0T3Bjb2RlKG1hbmFnZXIsIGNvbXBvbmVudCwgYm91bmRzKSk7XG4vLyAgIH1cbi8vIH1cblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkRpZFJlbmRlckxheW91dCwgdm0gPT4ge1xuICBsZXQgbWFuYWdlciA9IHZtLmZyYW1lLmdldE1hbmFnZXIoKTtcbiAgbGV0IGNvbXBvbmVudCA9IHZtLmZyYW1lLmdldENvbXBvbmVudCgpO1xuICBsZXQgYm91bmRzID0gdm0uc3RhY2soKS5wb3BCbG9jaygpO1xuXG4gIG1hbmFnZXIuZGlkUmVuZGVyTGF5b3V0KGNvbXBvbmVudCwgYm91bmRzKTtcblxuICB2bS5lbnYuZGlkQ3JlYXRlKGNvbXBvbmVudCwgbWFuYWdlcik7XG5cbiAgdm0udXBkYXRlV2l0aChuZXcgRGlkVXBkYXRlTGF5b3V0T3Bjb2RlKG1hbmFnZXIsIGNvbXBvbmVudCwgYm91bmRzKSk7XG59KTtcblxuLy8gZXhwb3J0IGNsYXNzIENsb3NlQ29tcG9uZW50T3Bjb2RlIGV4dGVuZHMgT3Bjb2RlIHtcbi8vICAgcHVibGljIHR5cGUgPSBcImNsb3NlLWNvbXBvbmVudFwiO1xuXG4vLyAgIGV2YWx1YXRlKHZtOiBWTSkge1xuLy8gICAgIHZtLnBvcFNjb3BlKCk7XG4vLyAgICAgdm0ucG9wRHluYW1pY1Njb3BlKCk7XG4vLyAgICAgdm0uY29tbWl0Q2FjaGVHcm91cCgpO1xuLy8gICB9XG4vLyB9XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5DbG9zZUNvbXBvbmVudCwgdm0gPT4ge1xuICB2bS5wb3BTY29wZSgpO1xuICB2bS5wb3BEeW5hbWljU2NvcGUoKTtcbiAgdm0uY29tbWl0Q2FjaGVHcm91cCgpO1xufSk7XG5cbmV4cG9ydCBjbGFzcyBVcGRhdGVDb21wb25lbnRPcGNvZGUgZXh0ZW5kcyBVcGRhdGluZ09wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJ1cGRhdGUtY29tcG9uZW50XCI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBuYW1lOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBjb21wb25lbnQ6IENvbXBvbmVudCxcbiAgICBwcml2YXRlIG1hbmFnZXI6IENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50PixcbiAgICBwcml2YXRlIGFyZ3M6IEV2YWx1YXRlZEFyZ3MsXG4gICAgcHJpdmF0ZSBkeW5hbWljU2NvcGU6IER5bmFtaWNTY29wZSxcbiAgKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIGxldCBjb21wb25lbnRUYWcgPSBtYW5hZ2VyLmdldFRhZyhjb21wb25lbnQpO1xuXG4gICAgaWYgKGNvbXBvbmVudFRhZykge1xuICAgICAgdGhpcy50YWcgPSBjb21iaW5lKFthcmdzLnRhZywgY29tcG9uZW50VGFnXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGFnID0gYXJncy50YWc7XG4gICAgfVxuICB9XG5cbiAgZXZhbHVhdGUoX3ZtOiBVcGRhdGluZ1ZNKSB7XG4gICAgbGV0IHsgY29tcG9uZW50LCBtYW5hZ2VyLCBhcmdzLCBkeW5hbWljU2NvcGUgfSA9IHRoaXM7XG5cbiAgICBtYW5hZ2VyLnVwZGF0ZShjb21wb25lbnQsIGFyZ3MsIGR5bmFtaWNTY29wZSk7XG4gIH1cblxuICB0b0pTT04oKTogT3Bjb2RlSlNPTiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGd1aWQ6IHRoaXMuX2d1aWQsXG4gICAgICB0eXBlOiB0aGlzLnR5cGUsXG4gICAgICBhcmdzOiBbSlNPTi5zdHJpbmdpZnkodGhpcy5uYW1lKV1cbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBEaWRVcGRhdGVMYXlvdXRPcGNvZGUgZXh0ZW5kcyBVcGRhdGluZ09wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJkaWQtdXBkYXRlLWxheW91dFwiO1xuICBwdWJsaWMgdGFnOiBSZXZpc2lvblRhZyA9IENPTlNUQU5UX1RBRztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG1hbmFnZXI6IENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50PixcbiAgICBwcml2YXRlIGNvbXBvbmVudDogQ29tcG9uZW50LFxuICAgIHByaXZhdGUgYm91bmRzOiBCb3VuZHNcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIGV2YWx1YXRlKHZtOiBVcGRhdGluZ1ZNKSB7XG4gICAgbGV0IHsgbWFuYWdlciwgY29tcG9uZW50LCBib3VuZHMgfSA9IHRoaXM7XG5cbiAgICBtYW5hZ2VyLmRpZFVwZGF0ZUxheW91dChjb21wb25lbnQsIGJvdW5kcyk7XG5cbiAgICB2bS5lbnYuZGlkVXBkYXRlKGNvbXBvbmVudCwgbWFuYWdlcik7XG4gIH1cbn1cbiJdfQ==