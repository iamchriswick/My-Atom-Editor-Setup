"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var opcodes_1 = require("../../opcodes");
var reference_1 = require("@glimmer/reference");
var util_1 = require("@glimmer/util");
var reference_2 = require("@glimmer/reference");
var opcodes_2 = require("../../opcodes");
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.PushChildScope, function (vm) { return vm.pushChildScope(); });
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.PopScope, function (vm) { return vm.popScope(); });
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.PushDynamicScope, function (vm) { return vm.pushDynamicScope(); });
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.PopDynamicScope, function (vm) { return vm.popDynamicScope(); });
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.Put, function (vm, _a) {
    var reference = _a.op1;
    vm.frame.setOperand(vm.constants.getReference(reference));
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.EvaluatePut, function (vm, _a) {
    var expression = _a.op1;
    var expr = vm.constants.getExpression(expression);
    vm.evaluateOperand(expr);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.PutArgs, function (vm, _a) {
    var args = _a.op1;
    vm.evaluateArgs(vm.constants.getExpression(args));
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.BindPositionalArgs, function (vm, _a) {
    var _symbols = _a.op1;
    var symbols = vm.constants.getArray(_symbols);
    vm.bindPositionalArgs(symbols);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.BindNamedArgs, function (vm, _a) {
    var _names = _a.op1, _symbols = _a.op2;
    var names = vm.constants.getArray(_names);
    var symbols = vm.constants.getArray(_symbols);
    vm.bindNamedArgs(names, symbols);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.BindBlocks, function (vm, _a) {
    var _names = _a.op1, _symbols = _a.op2;
    var names = vm.constants.getArray(_names);
    var symbols = vm.constants.getArray(_symbols);
    vm.bindBlocks(names, symbols);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.BindPartialArgs, function (vm, _a) {
    var symbol = _a.op1;
    vm.bindPartialArgs(symbol);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.BindCallerScope, function (vm) { return vm.bindCallerScope(); });
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.BindDynamicScope, function (vm, _a) {
    var _names = _a.op1;
    var names = vm.constants.getArray(_names);
    vm.bindDynamicScope(names);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.Enter, function (vm, _a) {
    var slice = _a.op1;
    return vm.enter(slice);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.Exit, function (vm) { return vm.exit(); });
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.Evaluate, function (vm, _a) {
    var _block = _a.op1;
    var block = vm.constants.getBlock(_block);
    var args = vm.frame.getArgs();
    vm.invokeBlock(block, args);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.Jump, function (vm, _a) {
    var target = _a.op1;
    return vm.goto(target);
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.JumpIf, function (vm, _a) {
    var target = _a.op1;
    var reference = vm.frame.getCondition();
    if (reference_2.isConst(reference)) {
        if (reference.value()) {
            vm.goto(target);
        }
    }
    else {
        var cache = new reference_2.ReferenceCache(reference);
        if (cache.peek()) {
            vm.goto(target);
        }
        vm.updateWith(new Assert(cache));
    }
});
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.JumpUnless, function (vm, _a) {
    var target = _a.op1;
    var reference = vm.frame.getCondition();
    if (reference_2.isConst(reference)) {
        if (!reference.value()) {
            vm.goto(target);
        }
    }
    else {
        var cache = new reference_2.ReferenceCache(reference);
        if (!cache.peek()) {
            vm.goto(target);
        }
        vm.updateWith(new Assert(cache));
    }
});
exports.ConstTest = function (ref, _env) {
    return new reference_1.ConstReference(!!ref.value());
};
exports.SimpleTest = function (ref, _env) {
    return ref;
};
exports.EnvironmentTest = function (ref, env) {
    return env.toConditionalReference(ref);
};
opcodes_2.APPEND_OPCODES.add(opcodes_2.OpcodeName.Test, function (vm, _a) {
    var _func = _a.op1;
    var operand = vm.frame.getOperand();
    var func = vm.constants.getFunction(_func);
    vm.frame.setCondition(func(operand, vm.env));
});
var Assert = (function (_super) {
    __extends(Assert, _super);
    function Assert(cache) {
        var _this = _super.call(this) || this;
        _this.type = "assert";
        _this.tag = cache.tag;
        _this.cache = cache;
        return _this;
    }
    Assert.prototype.evaluate = function (vm) {
        var cache = this.cache;
        if (reference_2.isModified(cache.revalidate())) {
            vm.throw();
        }
    };
    Assert.prototype.toJSON = function () {
        var _a = this, type = _a.type, _guid = _a._guid, cache = _a.cache;
        var expected;
        try {
            expected = JSON.stringify(cache.peek());
        }
        catch (e) {
            expected = String(cache.peek());
        }
        return {
            guid: _guid,
            type: type,
            args: [],
            details: { expected: expected }
        };
    };
    return Assert;
}(opcodes_1.UpdatingOpcode));
exports.Assert = Assert;
var JumpIfNotModifiedOpcode = (function (_super) {
    __extends(JumpIfNotModifiedOpcode, _super);
    function JumpIfNotModifiedOpcode(tag, target) {
        var _this = _super.call(this) || this;
        _this.target = target;
        _this.type = "jump-if-not-modified";
        _this.tag = tag;
        _this.lastRevision = tag.value();
        return _this;
    }
    JumpIfNotModifiedOpcode.prototype.evaluate = function (vm) {
        var _a = this, tag = _a.tag, target = _a.target, lastRevision = _a.lastRevision;
        if (!vm.alwaysRevalidate && tag.validate(lastRevision)) {
            vm.goto(target);
        }
    };
    JumpIfNotModifiedOpcode.prototype.didModify = function () {
        this.lastRevision = this.tag.value();
    };
    JumpIfNotModifiedOpcode.prototype.toJSON = function () {
        return {
            guid: this._guid,
            type: this.type,
            args: [JSON.stringify(this.target.inspect())]
        };
    };
    return JumpIfNotModifiedOpcode;
}(opcodes_1.UpdatingOpcode));
exports.JumpIfNotModifiedOpcode = JumpIfNotModifiedOpcode;
var DidModifyOpcode = (function (_super) {
    __extends(DidModifyOpcode, _super);
    function DidModifyOpcode(target) {
        var _this = _super.call(this) || this;
        _this.target = target;
        _this.type = "did-modify";
        _this.tag = reference_2.CONSTANT_TAG;
        return _this;
    }
    DidModifyOpcode.prototype.evaluate = function () {
        this.target.didModify();
    };
    return DidModifyOpcode;
}(opcodes_1.UpdatingOpcode));
exports.DidModifyOpcode = DidModifyOpcode;
var LabelOpcode = (function () {
    function LabelOpcode(label) {
        this.tag = reference_2.CONSTANT_TAG;
        this.type = "label";
        this.label = null;
        this.prev = null;
        this.next = null;
        util_1.initializeGuid(this);
        if (label)
            this.label = label;
    }
    LabelOpcode.prototype.evaluate = function () { };
    LabelOpcode.prototype.inspect = function () {
        return this.label + " [" + this._guid + "]";
    };
    LabelOpcode.prototype.toJSON = function () {
        return {
            guid: this._guid,
            type: this.type,
            args: [JSON.stringify(this.inspect())]
        };
    };
    return LabelOpcode;
}());
exports.LabelOpcode = LabelOpcode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJAZ2xpbW1lci9ydW50aW1lL2xpYi9jb21waWxlZC9vcGNvZGVzL3ZtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHlDQUEyRDtBQUkzRCxnREFBK0Q7QUFDL0Qsc0NBQStEO0FBQy9ELGdEQUE4RztBQUU5Ryx5Q0FBaUU7QUFFakUsd0JBQWMsQ0FBQyxHQUFHLENBQUMsb0JBQUUsQ0FBQyxjQUFjLEVBQUUsVUFBQSxFQUFFLElBQUksT0FBQSxFQUFFLENBQUMsY0FBYyxFQUFFLEVBQW5CLENBQW1CLENBQUMsQ0FBQztBQUVqRSx3QkFBYyxDQUFDLEdBQUcsQ0FBQyxvQkFBRSxDQUFDLFFBQVEsRUFBRSxVQUFBLEVBQUUsSUFBSSxPQUFBLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBYixDQUFhLENBQUMsQ0FBQztBQUVyRCx3QkFBYyxDQUFDLEdBQUcsQ0FBQyxvQkFBRSxDQUFDLGdCQUFnQixFQUFFLFVBQUEsRUFBRSxJQUFJLE9BQUEsRUFBRSxDQUFDLGdCQUFnQixFQUFFLEVBQXJCLENBQXFCLENBQUMsQ0FBQztBQUVyRSx3QkFBYyxDQUFDLEdBQUcsQ0FBQyxvQkFBRSxDQUFDLGVBQWUsRUFBRSxVQUFBLEVBQUUsSUFBSSxPQUFBLEVBQUUsQ0FBQyxlQUFlLEVBQUUsRUFBcEIsQ0FBb0IsQ0FBQyxDQUFDO0FBRW5FLHdCQUFjLENBQUMsR0FBRyxDQUFDLG9CQUFFLENBQUMsR0FBRyxFQUFFLFVBQUMsRUFBRSxFQUFFLEVBQWtCO1FBQWhCLGtCQUFjO0lBQzlDLEVBQUUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7QUFDNUQsQ0FBQyxDQUFDLENBQUM7QUFFSCx3QkFBYyxDQUFDLEdBQUcsQ0FBQyxvQkFBRSxDQUFDLFdBQVcsRUFBRSxVQUFDLEVBQUUsRUFBRSxFQUFtQjtRQUFqQixt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QUFNLEdBQU47UUFDRSxNQUFNLENBQUM7WUFDTCxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2YsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztTQUN2QyxDQUFDO0lBQ0osQ0FBQztJQUNILGtCQUFDO0FBQUQsQ0FBQyxBQTNCRCxJQTJCQztBQTNCWSxrQ0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9wY29kZUpTT04sIFVwZGF0aW5nT3Bjb2RlIH0gZnJvbSAnLi4vLi4vb3Bjb2Rlcyc7XG5pbXBvcnQgeyBDb21waWxlZEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9ucyc7XG5pbXBvcnQgeyBDb21waWxlZEFyZ3MgfSBmcm9tICcuLi9leHByZXNzaW9ucy9hcmdzJztcbmltcG9ydCB7IFVwZGF0aW5nVk0gfSBmcm9tICcuLi8uLi92bSc7XG5pbXBvcnQgeyBSZWZlcmVuY2UsIENvbnN0UmVmZXJlbmNlIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCB7IE9wdGlvbiwgT3BhcXVlLCBpbml0aWFsaXplR3VpZCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgQ09OU1RBTlRfVEFHLCBSZWZlcmVuY2VDYWNoZSwgUmV2aXNpb24sIFJldmlzaW9uVGFnLCBpc0NvbnN0LCBpc01vZGlmaWVkIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCBFbnZpcm9ubWVudCBmcm9tICcuLi8uLi9lbnZpcm9ubWVudCc7XG5pbXBvcnQgeyBBUFBFTkRfT1BDT0RFUywgT3Bjb2RlTmFtZSBhcyBPcCB9IGZyb20gJy4uLy4uL29wY29kZXMnO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUHVzaENoaWxkU2NvcGUsIHZtID0+IHZtLnB1c2hDaGlsZFNjb3BlKCkpO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUG9wU2NvcGUsIHZtID0+IHZtLnBvcFNjb3BlKCkpO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUHVzaER5bmFtaWNTY29wZSwgdm0gPT4gdm0ucHVzaER5bmFtaWNTY29wZSgpKTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlBvcER5bmFtaWNTY29wZSwgdm0gPT4gdm0ucG9wRHluYW1pY1Njb3BlKCkpO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUHV0LCAodm0sIHsgb3AxOiByZWZlcmVuY2UgfSkgPT4ge1xuICB2bS5mcmFtZS5zZXRPcGVyYW5kKHZtLmNvbnN0YW50cy5nZXRSZWZlcmVuY2UocmVmZXJlbmNlKSk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkV2YWx1YXRlUHV0LCAodm0sIHsgb3AxOiBleHByZXNzaW9uIH0pID0+IHtcbiAgbGV0IGV4cHIgPSB2bS5jb25zdGFudHMuZ2V0RXhwcmVzc2lvbjxDb21waWxlZEV4cHJlc3Npb248T3BhcXVlPj4oZXhwcmVzc2lvbik7XG4gIHZtLmV2YWx1YXRlT3BlcmFuZChleHByKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUHV0QXJncywgKHZtLCB7IG9wMTogYXJncyB9KSA9PiB7XG4gIHZtLmV2YWx1YXRlQXJncyh2bS5jb25zdGFudHMuZ2V0RXhwcmVzc2lvbjxDb21waWxlZEFyZ3M+KGFyZ3MpKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQmluZFBvc2l0aW9uYWxBcmdzLCAodm0sIHsgb3AxOiBfc3ltYm9scyB9KSA9PiB7XG4gIGxldCBzeW1ib2xzID0gdm0uY29uc3RhbnRzLmdldEFycmF5KF9zeW1ib2xzKTtcbiAgdm0uYmluZFBvc2l0aW9uYWxBcmdzKHN5bWJvbHMpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5CaW5kTmFtZWRBcmdzLCAodm0sIHsgb3AxOiBfbmFtZXMsIG9wMjogX3N5bWJvbHMgfSkgPT4ge1xuICBsZXQgbmFtZXMgPSB2bS5jb25zdGFudHMuZ2V0QXJyYXkoX25hbWVzKTtcbiAgbGV0IHN5bWJvbHMgPSB2bS5jb25zdGFudHMuZ2V0QXJyYXkoX3N5bWJvbHMpO1xuICB2bS5iaW5kTmFtZWRBcmdzKG5hbWVzLCBzeW1ib2xzKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQmluZEJsb2NrcywgKHZtLCB7IG9wMTogX25hbWVzLCBvcDI6IF9zeW1ib2xzIH0pID0+IHtcbiAgbGV0IG5hbWVzID0gdm0uY29uc3RhbnRzLmdldEFycmF5KF9uYW1lcyk7XG4gIGxldCBzeW1ib2xzID0gdm0uY29uc3RhbnRzLmdldEFycmF5KF9zeW1ib2xzKTtcbiAgdm0uYmluZEJsb2NrcyhuYW1lcywgc3ltYm9scyk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkJpbmRQYXJ0aWFsQXJncywgKHZtLCB7IG9wMTogc3ltYm9sIH0pID0+IHtcbiAgdm0uYmluZFBhcnRpYWxBcmdzKHN5bWJvbCk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkJpbmRDYWxsZXJTY29wZSwgdm0gPT4gdm0uYmluZENhbGxlclNjb3BlKCkpO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQmluZER5bmFtaWNTY29wZSwgKHZtLCB7IG9wMTogX25hbWVzIH0pID0+IHtcbiAgbGV0IG5hbWVzID0gdm0uY29uc3RhbnRzLmdldEFycmF5KF9uYW1lcyk7XG4gIHZtLmJpbmREeW5hbWljU2NvcGUobmFtZXMpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5FbnRlciwgKHZtLCB7IG9wMTogc2xpY2UgfSkgPT4gdm0uZW50ZXIoc2xpY2UpKTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkV4aXQsICh2bSkgPT4gdm0uZXhpdCgpKTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkV2YWx1YXRlLCAodm0sIHsgb3AxOiBfYmxvY2sgfSkgPT4ge1xuICBsZXQgYmxvY2sgPSB2bS5jb25zdGFudHMuZ2V0QmxvY2soX2Jsb2NrKTtcbiAgbGV0IGFyZ3MgPSB2bS5mcmFtZS5nZXRBcmdzKCk7XG4gIHZtLmludm9rZUJsb2NrKGJsb2NrLCBhcmdzKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuSnVtcCwgKHZtLCB7IG9wMTogdGFyZ2V0IH0pID0+IHZtLmdvdG8odGFyZ2V0KSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5KdW1wSWYsICh2bSwgeyBvcDE6IHRhcmdldCB9KSA9PiB7XG4gIGxldCByZWZlcmVuY2UgPSB2bS5mcmFtZS5nZXRDb25kaXRpb24oKTtcblxuICBpZiAoaXNDb25zdChyZWZlcmVuY2UpKSB7XG4gICAgaWYgKHJlZmVyZW5jZS52YWx1ZSgpKSB7XG4gICAgICB2bS5nb3RvKHRhcmdldCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxldCBjYWNoZSA9IG5ldyBSZWZlcmVuY2VDYWNoZShyZWZlcmVuY2UpO1xuXG4gICAgaWYgKGNhY2hlLnBlZWsoKSkge1xuICAgICAgdm0uZ290byh0YXJnZXQpO1xuICAgIH1cblxuICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChjYWNoZSkpO1xuICB9XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkp1bXBVbmxlc3MsICh2bSwgeyBvcDE6IHRhcmdldCB9KSA9PiB7XG4gIGxldCByZWZlcmVuY2UgPSB2bS5mcmFtZS5nZXRDb25kaXRpb24oKTtcblxuICBpZiAoaXNDb25zdChyZWZlcmVuY2UpKSB7XG4gICAgaWYgKCFyZWZlcmVuY2UudmFsdWUoKSkge1xuICAgICAgdm0uZ290byh0YXJnZXQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsZXQgY2FjaGUgPSBuZXcgUmVmZXJlbmNlQ2FjaGUocmVmZXJlbmNlKTtcblxuICAgIGlmICghY2FjaGUucGVlaygpKSB7XG4gICAgICB2bS5nb3RvKHRhcmdldCk7XG4gICAgfVxuXG4gICAgdm0udXBkYXRlV2l0aChuZXcgQXNzZXJ0KGNhY2hlKSk7XG4gIH1cbn0pO1xuXG5leHBvcnQgdHlwZSBUZXN0RnVuY3Rpb24gPSAocmVmOiBSZWZlcmVuY2U8T3BhcXVlPiwgZW52OiBFbnZpcm9ubWVudCkgPT4gUmVmZXJlbmNlPGJvb2xlYW4+O1xuXG5leHBvcnQgY29uc3QgQ29uc3RUZXN0OiBUZXN0RnVuY3Rpb24gPSBmdW5jdGlvbihyZWY6IFJlZmVyZW5jZTxPcGFxdWU+LCBfZW52OiBFbnZpcm9ubWVudCk6IFJlZmVyZW5jZTxib29sZWFuPiB7XG4gIHJldHVybiBuZXcgQ29uc3RSZWZlcmVuY2UoISFyZWYudmFsdWUoKSk7XG59O1xuXG5leHBvcnQgY29uc3QgU2ltcGxlVGVzdDogVGVzdEZ1bmN0aW9uID0gZnVuY3Rpb24ocmVmOiBSZWZlcmVuY2U8T3BhcXVlPiwgX2VudjogRW52aXJvbm1lbnQpOiBSZWZlcmVuY2U8Ym9vbGVhbj4ge1xuICByZXR1cm4gcmVmIGFzIFJlZmVyZW5jZTxib29sZWFuPjtcbn07XG5cbmV4cG9ydCBjb25zdCBFbnZpcm9ubWVudFRlc3Q6IFRlc3RGdW5jdGlvbiA9IGZ1bmN0aW9uKHJlZjogUmVmZXJlbmNlPE9wYXF1ZT4sIGVudjogRW52aXJvbm1lbnQpOiBSZWZlcmVuY2U8Ym9vbGVhbj4ge1xuICByZXR1cm4gZW52LnRvQ29uZGl0aW9uYWxSZWZlcmVuY2UocmVmKTtcbn07XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5UZXN0LCAodm0sIHsgb3AxOiBfZnVuYyB9KSA9PiB7XG4gIGxldCBvcGVyYW5kID0gdm0uZnJhbWUuZ2V0T3BlcmFuZCgpO1xuICBsZXQgZnVuYyA9IHZtLmNvbnN0YW50cy5nZXRGdW5jdGlvbihfZnVuYyk7XG4gIHZtLmZyYW1lLnNldENvbmRpdGlvbihmdW5jKG9wZXJhbmQsIHZtLmVudikpO1xufSk7XG5cbmV4cG9ydCBjbGFzcyBBc3NlcnQgZXh0ZW5kcyBVcGRhdGluZ09wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJhc3NlcnRcIjtcblxuICBwcml2YXRlIGNhY2hlOiBSZWZlcmVuY2VDYWNoZTxPcGFxdWU+O1xuXG4gIGNvbnN0cnVjdG9yKGNhY2hlOiBSZWZlcmVuY2VDYWNoZTxPcGFxdWU+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnRhZyA9IGNhY2hlLnRhZztcbiAgICB0aGlzLmNhY2hlID0gY2FjaGU7XG4gIH1cblxuICBldmFsdWF0ZSh2bTogVXBkYXRpbmdWTSkge1xuICAgIGxldCB7IGNhY2hlIH0gPSB0aGlzO1xuXG4gICAgaWYgKGlzTW9kaWZpZWQoY2FjaGUucmV2YWxpZGF0ZSgpKSkge1xuICAgICAgdm0udGhyb3coKTtcbiAgICB9XG4gIH1cblxuICB0b0pTT04oKTogT3Bjb2RlSlNPTiB7XG4gICAgbGV0IHsgdHlwZSwgX2d1aWQsIGNhY2hlIH0gPSB0aGlzO1xuXG4gICAgbGV0IGV4cGVjdGVkO1xuXG4gICAgdHJ5IHtcbiAgICAgIGV4cGVjdGVkID0gSlNPTi5zdHJpbmdpZnkoY2FjaGUucGVlaygpKTtcbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgIGV4cGVjdGVkID0gU3RyaW5nKGNhY2hlLnBlZWsoKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGd1aWQ6IF9ndWlkLFxuICAgICAgdHlwZSxcbiAgICAgIGFyZ3M6IFtdLFxuICAgICAgZGV0YWlsczogeyBleHBlY3RlZCB9XG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSnVtcElmTm90TW9kaWZpZWRPcGNvZGUgZXh0ZW5kcyBVcGRhdGluZ09wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gXCJqdW1wLWlmLW5vdC1tb2RpZmllZFwiO1xuXG4gIHByaXZhdGUgbGFzdFJldmlzaW9uOiBSZXZpc2lvbjtcblxuICBjb25zdHJ1Y3Rvcih0YWc6IFJldmlzaW9uVGFnLCBwcml2YXRlIHRhcmdldDogTGFiZWxPcGNvZGUpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudGFnID0gdGFnO1xuICAgIHRoaXMubGFzdFJldmlzaW9uID0gdGFnLnZhbHVlKCk7XG4gIH1cblxuICBldmFsdWF0ZSh2bTogVXBkYXRpbmdWTSkge1xuICAgIGxldCB7IHRhZywgdGFyZ2V0LCBsYXN0UmV2aXNpb24gfSA9IHRoaXM7XG5cbiAgICBpZiAoIXZtLmFsd2F5c1JldmFsaWRhdGUgJiYgdGFnLnZhbGlkYXRlKGxhc3RSZXZpc2lvbikpIHtcbiAgICAgIHZtLmdvdG8odGFyZ2V0KTtcbiAgICB9XG4gIH1cblxuICBkaWRNb2RpZnkoKSB7XG4gICAgdGhpcy5sYXN0UmV2aXNpb24gPSB0aGlzLnRhZy52YWx1ZSgpO1xuICB9XG5cbiAgdG9KU09OKCk6IE9wY29kZUpTT04ge1xuICAgIHJldHVybiB7XG4gICAgICBndWlkOiB0aGlzLl9ndWlkLFxuICAgICAgdHlwZTogdGhpcy50eXBlLFxuICAgICAgYXJnczogW0pTT04uc3RyaW5naWZ5KHRoaXMudGFyZ2V0Lmluc3BlY3QoKSldXG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGlkTW9kaWZ5T3Bjb2RlIGV4dGVuZHMgVXBkYXRpbmdPcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9IFwiZGlkLW1vZGlmeVwiO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdGFyZ2V0OiBKdW1wSWZOb3RNb2RpZmllZE9wY29kZSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy50YWcgPSBDT05TVEFOVF9UQUc7XG4gIH1cblxuICBldmFsdWF0ZSgpIHtcbiAgICB0aGlzLnRhcmdldC5kaWRNb2RpZnkoKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTGFiZWxPcGNvZGUgaW1wbGVtZW50cyBVcGRhdGluZ09wY29kZSB7XG4gIHB1YmxpYyB0YWcgPSBDT05TVEFOVF9UQUc7XG4gIHB1YmxpYyB0eXBlID0gXCJsYWJlbFwiO1xuICBwdWJsaWMgbGFiZWw6IE9wdGlvbjxzdHJpbmc+ID0gbnVsbDtcbiAgcHVibGljIF9ndWlkOiBudW1iZXI7XG5cbiAgcHJldjogYW55ID0gbnVsbDtcbiAgbmV4dDogYW55ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihsYWJlbDogc3RyaW5nKSB7XG4gICAgaW5pdGlhbGl6ZUd1aWQodGhpcyk7XG4gICAgaWYgKGxhYmVsKSB0aGlzLmxhYmVsID0gbGFiZWw7XG4gIH1cblxuICBldmFsdWF0ZSgpIHt9XG5cbiAgaW5zcGVjdCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHt0aGlzLmxhYmVsfSBbJHt0aGlzLl9ndWlkfV1gO1xuICB9XG5cbiAgdG9KU09OKCk6IE9wY29kZUpTT04ge1xuICAgIHJldHVybiB7XG4gICAgICBndWlkOiB0aGlzLl9ndWlkLFxuICAgICAgdHlwZTogdGhpcy50eXBlLFxuICAgICAgYXJnczogW0pTT04uc3RyaW5naWZ5KHRoaXMuaW5zcGVjdCgpKV1cbiAgICB9O1xuICB9XG59XG4iXX0=