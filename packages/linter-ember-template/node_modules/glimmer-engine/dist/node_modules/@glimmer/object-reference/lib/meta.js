"use strict";
var descriptors_1 = require("./references/descriptors");
var root_1 = require("./references/root");
var util_1 = require("@glimmer/util");
var reference_1 = require("@glimmer/reference");
var NOOP_DESTROY = { destroy: function () { } };
var ConstPath = (function () {
    function ConstPath(parent, property) {
        this.tag = reference_1.VOLATILE_TAG;
        this.parent = parent;
    }
    ConstPath.prototype.chain = function () { return NOOP_DESTROY; };
    ConstPath.prototype.notify = function () { };
    ConstPath.prototype.value = function () {
        return this.parent[this.property];
    };
    ConstPath.prototype.get = function (prop) {
        return new ConstPath(this.parent[this.property], prop);
    };
    return ConstPath;
}());
var ConstRoot = (function () {
    function ConstRoot(value) {
        this.tag = reference_1.VOLATILE_TAG;
        this.inner = value;
    }
    ConstRoot.prototype.update = function (inner) {
        this.inner = inner;
    };
    ConstRoot.prototype.chain = function () { return NOOP_DESTROY; };
    ConstRoot.prototype.notify = function () { };
    ConstRoot.prototype.value = function () {
        return this.inner;
    };
    ConstRoot.prototype.referenceFromParts = function (parts) {
        throw new Error("Not implemented");
    };
    ConstRoot.prototype.chainFor = function (prop) {
        throw new Error("Not implemented");
    };
    ConstRoot.prototype.get = function (prop) {
        return new ConstPath(this.inner, prop);
    };
    return ConstRoot;
}());
var ConstMeta /*implements IMeta*/ = (function () {
    function ConstMeta(object) {
        this.object = object;
    }
    ConstMeta.prototype.root = function () {
        return new ConstRoot(this.object);
    };
    return ConstMeta;
}());
exports.CLASS_META = "df8be4c8-4e89-44e2-a8f9-550c8dacdca7";
var hasOwnProperty = Object.hasOwnProperty;
var Meta = (function () {
    function Meta(object, _a) {
        var RootReferenceFactory = _a.RootReferenceFactory, DefaultPathReferenceFactory = _a.DefaultPathReferenceFactory;
        this.references = null;
        this.slots = null;
        this.referenceTypes = null;
        this.propertyMetadata = null;
        this.object = object;
        this.RootReferenceFactory = RootReferenceFactory || root_1.default;
        this.DefaultPathReferenceFactory = DefaultPathReferenceFactory || descriptors_1.PropertyReference;
    }
    Meta.for = function (obj) {
        if (obj === null || obj === undefined)
            return new Meta(obj, {});
        if (hasOwnProperty.call(obj, '_meta') && obj._meta)
            return obj._meta;
        if (!Object.isExtensible(obj))
            return new ConstMeta(obj);
        var MetaToUse = Meta;
        if (obj.constructor && obj.constructor[exports.CLASS_META]) {
            var classMeta = obj.constructor[exports.CLASS_META];
            MetaToUse = classMeta.InstanceMetaConstructor;
        }
        else if (obj[exports.CLASS_META]) {
            MetaToUse = obj[exports.CLASS_META].InstanceMetaConstructor;
        }
        return (obj._meta = new MetaToUse(obj, {}));
    };
    Meta.exists = function (obj) {
        return typeof obj === 'object' && obj._meta;
    };
    Meta.metadataForProperty = function (key) {
        return null;
    };
    Meta.prototype.addReference = function (property, reference) {
        var refs = this.references = this.references || util_1.dict();
        var set = refs[property] = refs[property] || new util_1.DictSet();
        set.add(reference);
    };
    Meta.prototype.addReferenceTypeFor = function (property, type) {
        this.referenceTypes = this.referenceTypes || util_1.dict();
        this.referenceTypes[property] = type;
    };
    Meta.prototype.referenceTypeFor = function (property) {
        if (!this.referenceTypes)
            return descriptors_1.PropertyReference;
        return this.referenceTypes[property] || descriptors_1.PropertyReference;
    };
    Meta.prototype.removeReference = function (property, reference) {
        if (!this.references)
            return;
        var set = this.references[property];
        set.delete(reference);
    };
    Meta.prototype.getReferenceTypes = function () {
        this.referenceTypes = this.referenceTypes || util_1.dict();
        return this.referenceTypes;
    };
    Meta.prototype.referencesFor = function (property) {
        if (!this.references)
            return;
        return this.references[property];
    };
    Meta.prototype.getSlots = function () {
        return (this.slots = this.slots || util_1.dict());
    };
    Meta.prototype.root = function () {
        return (this.rootCache = this.rootCache || new this.RootReferenceFactory(this.object));
    };
    return Meta;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Meta;
function metaFor(obj) {
    return Meta.for(obj);
}
exports.metaFor = metaFor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkBnbGltbWVyL29iamVjdC1yZWZlcmVuY2UvbGliL21ldGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHdEQUE2RDtBQUM3RCwwQ0FBOEM7QUFHOUMsc0NBQWtFO0FBU2xFLGdEQUFtRjtBQUluRixJQUFNLFlBQVksR0FBRyxFQUFFLE9BQU8sZ0JBQUksQ0FBQyxFQUFFLENBQUM7QUFFdEM7SUFLRSxtQkFBWSxNQUFXLEVBQUUsUUFBZ0I7UUFGbEMsUUFBRyxHQUFHLHdCQUFZLENBQUM7UUFHeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDdkIsQ0FBQztJQUVELHlCQUFLLEdBQUwsY0FBVSxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztJQUNoQywwQkFBTSxHQUFOLGNBQVUsQ0FBQztJQUVYLHlCQUFLLEdBQUw7UUFDRSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELHVCQUFHLEdBQUgsVUFBSSxJQUFZO1FBQ2QsTUFBTSxDQUFDLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFDSCxnQkFBQztBQUFELENBQUMsQUFuQkQsSUFtQkM7QUFFRDtJQUlFLG1CQUFZLEtBQUs7UUFGVixRQUFHLEdBQUcsd0JBQVksQ0FBQztRQUd4QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBRUQsMEJBQU0sR0FBTixVQUFPLEtBQVU7UUFDZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBRUQseUJBQUssR0FBTCxjQUFVLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBQ2hDLDBCQUFNLEdBQU4sY0FBVSxDQUFD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QyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVELGdDQUFpQixHQUFqQjtRQUNFLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsSUFBSSxXQUFJLEVBQTZCLENBQUM7UUFDL0UsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUM7SUFDN0IsQ0FBQztJQUVELDRCQUFhLEdBQWIsVUFBYyxRQUFnQjtRQUM1QixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7WUFBQyxNQUFNLENBQUM7UUFDN0IsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELHVCQUFRLEdBQVI7UUFDRSxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksV0FBSSxFQUFFLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsbUJBQUksR0FBSjtRQUNFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUN6RixDQUFDO0lBQ0gsV0FBQztBQUFELENBQUMsQUFqRkQsSUFpRkM7O0FBRUQsa0JBQWUsSUFBSSxDQUFDO0FBTXBCLGlCQUF3QixHQUFRO0lBQzlCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLENBQUM7QUFGRCwwQkFFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3BlcnR5UmVmZXJlbmNlIH0gZnJvbSAnLi9yZWZlcmVuY2VzL2Rlc2NyaXB0b3JzJztcbmltcG9ydCBSb290UmVmZXJlbmNlIGZyb20gJy4vcmVmZXJlbmNlcy9yb290JztcbmltcG9ydCB7IE1ldGFPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XG5cbmltcG9ydCB7IERpY3QsIERpY3RTZXQsIEhhc0d1aWQsIFNldCwgZGljdCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5pbXBvcnQge1xuICBSb290UmVmZXJlbmNlRmFjdG9yeSxcbiAgUGF0aFJlZmVyZW5jZUZhY3RvcnksXG4gIE1ldGEgYXMgSU1ldGEsXG4gIFJvb3RSZWZlcmVuY2UgYXMgSVJvb3RSZWZlcmVuY2Vcbn0gZnJvbSAnLi90eXBlcyc7XG5cbmltcG9ydCB7IFBhdGhSZWZlcmVuY2UgYXMgSVBhdGhSZWZlcmVuY2UsIFZPTEFUSUxFX1RBRyB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5cbmltcG9ydCB7IElubmVyUmVmZXJlbmNlRmFjdG9yeSB9IGZyb20gJy4vcmVmZXJlbmNlcy9kZXNjcmlwdG9ycyc7XG5cbmNvbnN0IE5PT1BfREVTVFJPWSA9IHsgZGVzdHJveSgpIHt9IH07XG5cbmNsYXNzIENvbnN0UGF0aCBpbXBsZW1lbnRzIElQYXRoUmVmZXJlbmNlPGFueT4ge1xuICBwcml2YXRlIHBhcmVudDogYW55O1xuICBwcml2YXRlIHByb3BlcnR5OiBzdHJpbmc7XG4gIHB1YmxpYyB0YWcgPSBWT0xBVElMRV9UQUc7XG5cbiAgY29uc3RydWN0b3IocGFyZW50OiBhbnksIHByb3BlcnR5OiBzdHJpbmcpIHtcbiAgICB0aGlzLnBhcmVudCA9IHBhcmVudDtcbiAgfVxuXG4gIGNoYWluKCkgeyByZXR1cm4gTk9PUF9ERVNUUk9ZOyB9XG4gIG5vdGlmeSgpIHt9XG5cbiAgdmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50W3RoaXMucHJvcGVydHldO1xuICB9XG5cbiAgZ2V0KHByb3A6IHN0cmluZyk6IElQYXRoUmVmZXJlbmNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgQ29uc3RQYXRoKHRoaXMucGFyZW50W3RoaXMucHJvcGVydHldLCBwcm9wKTtcbiAgfVxufVxuXG5jbGFzcyBDb25zdFJvb3QgaW1wbGVtZW50cyBJUm9vdFJlZmVyZW5jZTxhbnk+IHtcbiAgcHJpdmF0ZSBpbm5lcjogYW55O1xuICBwdWJsaWMgdGFnID0gVk9MQVRJTEVfVEFHO1xuXG4gIGNvbnN0cnVjdG9yKHZhbHVlKSB7XG4gICAgdGhpcy5pbm5lciA9IHZhbHVlO1xuICB9XG5cbiAgdXBkYXRlKGlubmVyOiBhbnkpIHtcbiAgICB0aGlzLmlubmVyID0gaW5uZXI7XG4gIH1cblxuICBjaGFpbigpIHsgcmV0dXJuIE5PT1BfREVTVFJPWTsgfVxuICBub3RpZnkoKSB7fVxuXG4gIHZhbHVlKCk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuaW5uZXI7XG4gIH1cblxuICByZWZlcmVuY2VGcm9tUGFydHMocGFydHM6IHN0cmluZ1tdKTogSVBhdGhSZWZlcmVuY2U8YW55PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IGltcGxlbWVudGVkXCIpO1xuICB9XG5cbiAgY2hhaW5Gb3IocHJvcDogc3RyaW5nKTogSVBhdGhSZWZlcmVuY2U8YW55PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IGltcGxlbWVudGVkXCIpO1xuICB9XG5cbiAgZ2V0KHByb3A6IHN0cmluZyk6IElQYXRoUmVmZXJlbmNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgQ29uc3RQYXRoKHRoaXMuaW5uZXIsIHByb3ApO1xuICB9XG59XG5cbmNsYXNzIENvbnN0TWV0YSAvKmltcGxlbWVudHMgSU1ldGEqLyB7XG4gIHByaXZhdGUgb2JqZWN0OiBhbnk7XG5cbiAgY29uc3RydWN0b3Iob2JqZWN0OiBhbnkpIHtcbiAgICB0aGlzLm9iamVjdCA9IG9iamVjdDtcbiAgfVxuXG4gIHJvb3QoKTogQ29uc3RSb290IHtcbiAgICByZXR1cm4gbmV3IENvbnN0Um9vdCh0aGlzLm9iamVjdCk7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IENMQVNTX01FVEEgPSBcImRmOGJlNGM4LTRlODktNDRlMi1hOGY5LTU1MGM4ZGFjZGNhN1wiO1xuXG5jb25zdCBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eTtcblxuY2xhc3MgTWV0YSBpbXBsZW1lbnRzIElNZXRhLCBIYXNHdWlkIHtcbiAgc3RhdGljIGZvcihvYmo6IGFueSk6IElNZXRhIHtcbiAgICBpZiAob2JqID09PSBudWxsIHx8IG9iaiA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbmV3IE1ldGEob2JqLCB7fSk7XG4gICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqLCAnX21ldGEnKSAmJiBvYmouX21ldGEpIHJldHVybiBvYmouX21ldGE7XG4gICAgaWYgKCFPYmplY3QuaXNFeHRlbnNpYmxlKG9iaikpIHJldHVybiA8YW55Pm5ldyBDb25zdE1ldGEob2JqKTtcblxuICAgIGxldCBNZXRhVG9Vc2U6IHR5cGVvZiBNZXRhID0gTWV0YTtcblxuICAgIGlmIChvYmouY29uc3RydWN0b3IgJiYgb2JqLmNvbnN0cnVjdG9yW0NMQVNTX01FVEFdKSB7XG4gICAgICBsZXQgY2xhc3NNZXRhOiBDbGFzc01ldGEgPSBvYmouY29uc3RydWN0b3JbQ0xBU1NfTUVUQV07XG4gICAgICBNZXRhVG9Vc2UgPSBjbGFzc01ldGEuSW5zdGFuY2VNZXRhQ29uc3RydWN0b3I7XG4gICAgfSBlbHNlIGlmIChvYmpbQ0xBU1NfTUVUQV0pIHtcbiAgICAgIE1ldGFUb1VzZSA9IG9ialtDTEFTU19NRVRBXS5JbnN0YW5jZU1ldGFDb25zdHJ1Y3RvcjtcbiAgICB9XG5cbiAgICByZXR1cm4gKG9iai5fbWV0YSA9IG5ldyBNZXRhVG9Vc2Uob2JqLCB7fSkpO1xuICB9XG5cbiAgc3RhdGljIGV4aXN0cyhvYmo6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmouX21ldGE7XG4gIH1cblxuICBzdGF0aWMgbWV0YWRhdGFGb3JQcm9wZXJ0eShrZXk6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcml2YXRlIG9iamVjdDogYW55O1xuICBwcml2YXRlIFJvb3RSZWZlcmVuY2VGYWN0b3J5OiBSb290UmVmZXJlbmNlRmFjdG9yeTxhbnk+O1xuICBwcml2YXRlIERlZmF1bHRQYXRoUmVmZXJlbmNlRmFjdG9yeTogSW5uZXJSZWZlcmVuY2VGYWN0b3J5PGFueT47XG4gIHByaXZhdGUgcm9vdENhY2hlOiBJUm9vdFJlZmVyZW5jZTxhbnk+O1xuICBwcml2YXRlIHJlZmVyZW5jZXM6IERpY3Q8RGljdFNldDxJUGF0aFJlZmVyZW5jZTxhbnk+ICYgSGFzR3VpZD4+ID0gbnVsbDtcbiAgcHVibGljIF9ndWlkO1xuICBwcm90ZWN0ZWQgc2xvdHM6IERpY3Q8YW55PiA9IG51bGw7XG4gIHByb3RlY3RlZCByZWZlcmVuY2VUeXBlczogRGljdDxJbm5lclJlZmVyZW5jZUZhY3Rvcnk8YW55Pj4gPSBudWxsO1xuICBwcm90ZWN0ZWQgcHJvcGVydHlNZXRhZGF0YTogRGljdDxhbnk+ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihvYmplY3Q6IGFueSwgeyBSb290UmVmZXJlbmNlRmFjdG9yeSwgRGVmYXVsdFBhdGhSZWZlcmVuY2VGYWN0b3J5IH06IE1ldGFPcHRpb25zKSB7XG4gICAgdGhpcy5vYmplY3QgPSBvYmplY3Q7XG4gICAgdGhpcy5Sb290UmVmZXJlbmNlRmFjdG9yeSA9IFJvb3RSZWZlcmVuY2VGYWN0b3J5IHx8IFJvb3RSZWZlcmVuY2U7XG4gICAgdGhpcy5EZWZhdWx0UGF0aFJlZmVyZW5jZUZhY3RvcnkgPSBEZWZhdWx0UGF0aFJlZmVyZW5jZUZhY3RvcnkgfHwgUHJvcGVydHlSZWZlcmVuY2U7XG4gIH1cblxuICBhZGRSZWZlcmVuY2UocHJvcGVydHk6IHN0cmluZywgcmVmZXJlbmNlOiBJUGF0aFJlZmVyZW5jZTxhbnk+ICYgSGFzR3VpZCkge1xuICAgIGxldCByZWZzID0gdGhpcy5yZWZlcmVuY2VzID0gdGhpcy5yZWZlcmVuY2VzIHx8IGRpY3Q8RGljdFNldDxJUGF0aFJlZmVyZW5jZTxhbnk+ICYgSGFzR3VpZD4+KCk7XG4gICAgbGV0IHNldCA9IHJlZnNbcHJvcGVydHldID0gcmVmc1twcm9wZXJ0eV0gfHwgbmV3IERpY3RTZXQ8SVBhdGhSZWZlcmVuY2U8YW55PiAmIEhhc0d1aWQ+KCk7XG4gICAgc2V0LmFkZChyZWZlcmVuY2UpO1xuICB9XG5cbiAgYWRkUmVmZXJlbmNlVHlwZUZvcihwcm9wZXJ0eTogc3RyaW5nLCB0eXBlOiBQYXRoUmVmZXJlbmNlRmFjdG9yeTxhbnk+KSB7XG4gICAgdGhpcy5yZWZlcmVuY2VUeXBlcyA9IHRoaXMucmVmZXJlbmNlVHlwZXMgfHwgZGljdDxQYXRoUmVmZXJlbmNlRmFjdG9yeTxhbnk+PigpO1xuICAgIHRoaXMucmVmZXJlbmNlVHlwZXNbcHJvcGVydHldID0gdHlwZTtcbiAgfVxuXG4gIHJlZmVyZW5jZVR5cGVGb3IocHJvcGVydHk6IHN0cmluZyk6IElubmVyUmVmZXJlbmNlRmFjdG9yeTxhbnk+IHtcbiAgICBpZiAoIXRoaXMucmVmZXJlbmNlVHlwZXMpIHJldHVybiBQcm9wZXJ0eVJlZmVyZW5jZTtcbiAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VUeXBlc1twcm9wZXJ0eV0gfHwgUHJvcGVydHlSZWZlcmVuY2U7XG4gIH1cblxuICByZW1vdmVSZWZlcmVuY2UocHJvcGVydHk6IHN0cmluZywgcmVmZXJlbmNlOiBJUGF0aFJlZmVyZW5jZTxhbnk+ICYgSGFzR3VpZCkge1xuICAgIGlmICghdGhpcy5yZWZlcmVuY2VzKSByZXR1cm47XG4gICAgbGV0IHNldCA9IHRoaXMucmVmZXJlbmNlc1twcm9wZXJ0eV07XG4gICAgc2V0LmRlbGV0ZShyZWZlcmVuY2UpO1xuICB9XG5cbiAgZ2V0UmVmZXJlbmNlVHlwZXMoKTogRGljdDxJbm5lclJlZmVyZW5jZUZhY3Rvcnk8YW55Pj4ge1xuICAgIHRoaXMucmVmZXJlbmNlVHlwZXMgPSB0aGlzLnJlZmVyZW5jZVR5cGVzIHx8IGRpY3Q8UGF0aFJlZmVyZW5jZUZhY3Rvcnk8YW55Pj4oKTtcbiAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VUeXBlcztcbiAgfVxuXG4gIHJlZmVyZW5jZXNGb3IocHJvcGVydHk6IHN0cmluZyk6IFNldDxJUGF0aFJlZmVyZW5jZTxhbnk+PiB7XG4gICAgaWYgKCF0aGlzLnJlZmVyZW5jZXMpIHJldHVybjtcbiAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VzW3Byb3BlcnR5XTtcbiAgfVxuXG4gIGdldFNsb3RzKCkge1xuICAgIHJldHVybiAodGhpcy5zbG90cyA9IHRoaXMuc2xvdHMgfHwgZGljdCgpKTtcbiAgfVxuXG4gIHJvb3QoKTogSVJvb3RSZWZlcmVuY2U8YW55PiB7XG4gICAgcmV0dXJuICh0aGlzLnJvb3RDYWNoZSA9IHRoaXMucm9vdENhY2hlIHx8IG5ldyB0aGlzLlJvb3RSZWZlcmVuY2VGYWN0b3J5KHRoaXMub2JqZWN0KSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTWV0YTtcblxuaW50ZXJmYWNlIENsYXNzTWV0YSB7XG4gIEluc3RhbmNlTWV0YUNvbnN0cnVjdG9yOiB0eXBlb2YgTWV0YTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ldGFGb3Iob2JqOiBhbnkpOiBJTWV0YSB7XG4gIHJldHVybiBNZXRhLmZvcihvYmopO1xufVxuIl19