"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var reference_1 = require("@glimmer/reference");
var util_1 = require("@glimmer/util");
var UpdatableReference = (function () {
    function UpdatableReference(content) {
        this.content = content;
        this.tag = this._tag = new reference_1.DirtyableTag();
    }
    UpdatableReference.prototype.value = function () {
        return this.content;
    };
    UpdatableReference.prototype.update = function (content) {
        this._tag.dirty();
        return this.content = content;
    };
    return UpdatableReference;
}());
var TaggedDict = (function () {
    function TaggedDict() {
        this.data = util_1.dict();
        this.tag = this._tag = new reference_1.DirtyableTag();
    }
    TaggedDict.prototype.get = function (key) {
        return this.data[key];
    };
    TaggedDict.prototype.set = function (key, value) {
        this._tag.dirty();
        return this.data[key] = value;
    };
    return TaggedDict;
}());
QUnit.module("References");
QUnit.test("CachedReference caches computation correctly", function (assert) {
    var computed = 0;
    var DictValueReference = (function (_super) {
        __extends(DictValueReference, _super);
        function DictValueReference(dict, key) {
            var _this = _super.call(this) || this;
            _this.dict = dict;
            _this.key = key;
            _this.tag = dict.tag;
            return _this;
        }
        DictValueReference.prototype.compute = function () {
            computed++;
            return this.dict.get(this.key);
        };
        return DictValueReference;
    }(reference_1.CachedReference));
    var dict = new TaggedDict();
    var reference = new DictValueReference(dict, 'foo');
    dict.set('foo', 'bar');
    assert.strictEqual(computed, 0, 'precond');
    assert.equal(reference.value(), 'bar');
    assert.equal(reference.value(), 'bar');
    assert.equal(reference.value(), 'bar');
    assert.strictEqual(computed, 1, 'computed');
    dict.set('foo', 'BAR');
    assert.equal(reference.value(), 'BAR');
    assert.equal(reference.value(), 'BAR');
    assert.equal(reference.value(), 'BAR');
    assert.strictEqual(computed, 2, 'computed');
    dict.set('baz', 'bat');
    assert.equal(reference.value(), 'BAR');
    assert.equal(reference.value(), 'BAR');
    assert.equal(reference.value(), 'BAR');
    assert.strictEqual(computed, 3, 'computed');
    dict.set('foo', 'bar');
    assert.equal(reference.value(), 'bar');
    assert.equal(reference.value(), 'bar');
    assert.equal(reference.value(), 'bar');
    assert.strictEqual(computed, 4, 'computed');
});
QUnit.test("CachedReference caches nested computation correctly", function (assert) {
    var computed = 0;
    var DictValueReference = (function (_super) {
        __extends(DictValueReference, _super);
        function DictValueReference(parent, key) {
            var _this = _super.call(this) || this;
            _this.parent = parent;
            _this.key = key;
            var _tag = _this._tag = new reference_1.UpdatableTag(reference_1.CONSTANT_TAG);
            _this.tag = reference_1.combine([parent.tag, _tag]);
            return _this;
        }
        DictValueReference.prototype.compute = function () {
            computed++;
            var _a = this, parent = _a.parent, _tag = _a._tag, key = _a.key;
            var dict = parent.value();
            _tag.update(dict.tag);
            return dict.get(key);
        };
        return DictValueReference;
    }(reference_1.CachedReference));
    var first = new TaggedDict();
    var second = new TaggedDict();
    var dictReference = new UpdatableReference(first);
    var valueReference = new DictValueReference(dictReference, 'foo');
    first.set('foo', 'bar');
    assert.strictEqual(computed, 0, 'precond');
    assert.equal(valueReference.value(), 'bar');
    assert.equal(valueReference.value(), 'bar');
    assert.equal(valueReference.value(), 'bar');
    assert.strictEqual(computed, 1, 'computed');
    second.set('foo', 'BAR');
    assert.equal(valueReference.value(), 'bar');
    assert.equal(valueReference.value(), 'bar');
    assert.equal(valueReference.value(), 'bar');
    assert.strictEqual(computed, 1, 'computed');
    dictReference.update(second);
    assert.equal(valueReference.value(), 'BAR');
    assert.equal(valueReference.value(), 'BAR');
    assert.equal(valueReference.value(), 'BAR');
    assert.strictEqual(computed, 2, 'computed');
    second.set('foo', 'foo-bar');
    assert.equal(valueReference.value(), 'foo-bar');
    assert.equal(valueReference.value(), 'foo-bar');
    assert.equal(valueReference.value(), 'foo-bar');
    assert.strictEqual(computed, 3, 'computed');
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlcy10ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQGdsaW1tZXIvcmVmZXJlbmNlL3Rlc3RzL3JlZmVyZW5jZXMtdGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnREFXNEI7QUFFNUIsc0NBRXVCO0FBRXZCO0lBSUUsNEJBQW9CLE9BQVU7UUFBVixZQUFPLEdBQVAsT0FBTyxDQUFHO1FBQzVCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLHdCQUFZLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBRUQsa0NBQUssR0FBTDtRQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxtQ0FBTSxHQUFOLFVBQU8sT0FBVTtRQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ2hDLENBQUM7SUFDSCx5QkFBQztBQUFELENBQUMsQUFoQkQsSUFnQkM7QUFFRDtJQUtFO1FBRlEsU0FBSSxHQUFHLFdBQUksRUFBSyxDQUFDO1FBR3ZCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLHdCQUFZLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBRUQsd0JBQUcsR0FBSCxVQUFJLEdBQVc7UUFDYixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBRUQsd0JBQUcsR0FBSCxVQUFJLEdBQVcsRUFBRSxLQUFRO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ2hDLENBQUM7SUFDSCxpQkFBQztBQUFELENBQUMsQUFqQkQsSUFpQkM7QUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBRTNCLEtBQUssQ0FBQyxJQUFJLENBQUMsOENBQThDLEVBQUUsVUFBQSxNQUFNO0lBQy9ELElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQztJQUVqQjtRQUFpQyxzQ0FBdUI7UUFHdEQsNEJBQW9CLElBQXdCLEVBQVUsR0FBVztZQUFqRSxZQUNFLGlCQUFPLFNBRVI7WUFIbUIsVUFBSSxHQUFKLElBQUksQ0FBb0I7WUFBVSxTQUFHLEdBQUgsR0FBRyxDQUFRO1lBRS9ELEtBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQzs7UUFDdEIsQ0FBQztRQUVELG9DQUFPLEdBQVA7WUFDRSxRQUFRLEVBQUUsQ0FBQztZQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsQ0FBQztRQUNILHlCQUFDO0lBQUQsQ0FBQyxBQVpELENBQWlDLDJCQUFlLEdBWS9DO0lBRUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxVQUFVLEVBQVUsQ0FBQztJQUNwQyxJQUFJLFNBQVMsR0FBRyxJQUFJLGtCQUFrQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUVwRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUV2QixNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFFM0MsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDdkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDdkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFdkMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBRTVDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXZCLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3ZDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3ZDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXZDLE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUU1QyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUV2QixNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN2QyxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN2QyxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUV2QyxNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFFNUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFdkIsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDdkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDdkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFdkMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQzlDLENBQUMsQ0FBQyxDQUFDO0FBRUgsS0FBSyxDQUFDLElBQUksQ0FBQyxxREFBcUQsRUFBRSxVQUFBLE1BQU07SUFDdEUsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO0lBRWpCO1FBQWlDLHNDQUF1QjtRQUl0RCw0QkFBb0IsTUFBcUMsRUFBVSxHQUFXO1lBQTlFLFlBQ0UsaUJBQU8sU0FHUjtZQUptQixZQUFNLEdBQU4sTUFBTSxDQUErQjtZQUFVLFNBQUcsR0FBSCxHQUFHLENBQVE7WUFFNUUsSUFBSSxJQUFJLEdBQUcsS0FBSSxDQUFDLElBQUksR0FBRyxJQUFJLHdCQUFZLENBQUMsd0JBQVksQ0FBQyxDQUFDO1lBQ3RELEtBQUksQ0FBQyxHQUFHLEdBQUcsbUJBQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQzs7UUFDekMsQ0FBQztRQUVELG9DQUFPLEdBQVA7WUFDRSxRQUFRLEVBQUUsQ0FBQztZQUVQLElBQUEsU0FBNEIsRUFBMUIsa0JBQU0sRUFBRSxjQUFJLEVBQUUsWUFBRyxDQUFVO1lBRWpDLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUUxQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUV0QixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QixDQUFDO1FBQ0gseUJBQUM7SUFBRCxDQUFDLEFBckJELENBQWlDLDJCQUFlLEdBcUIvQztJQUVELElBQUksS0FBSyxHQUFHLElBQUksVUFBVSxFQUFVLENBQUM7SUFDckMsSUFBSSxNQUFNLEdBQUcsSUFBSSxVQUFVLEVBQVUsQ0FBQztJQUV0QyxJQUFJLGFBQWEsR0FBRyxJQUFJLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2xELElBQUksY0FBYyxHQUFHLElBQUksa0JBQWtCLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRWxFLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXhCLE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUUzQyxNQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM1QyxNQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM1QyxNQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUU1QyxNQUFNLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFFNUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFekIsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDNUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDNUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFNUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBRTVDLGFBQWEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFN0IsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDNUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDNUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFNUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBRTVDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRTdCLE1BQU0sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2hELE1BQU0sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2hELE1BQU0sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRWhELE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM5QyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENPTlNUQU5UX1RBRyxcblxuICBEaXJ0eWFibGVUYWcsXG4gIFVwZGF0YWJsZVRhZyxcbiAgUmV2aXNpb25UYWcsXG5cbiAgUmVmZXJlbmNlLFxuICBDYWNoZWRSZWZlcmVuY2UsXG5cbiAgY29tYmluZVxufSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuXG5pbXBvcnQge1xuICBkaWN0XG59IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5jbGFzcyBVcGRhdGFibGVSZWZlcmVuY2U8VD4gaW1wbGVtZW50cyBSZWZlcmVuY2U8VD4ge1xuICBwdWJsaWMgdGFnOiBSZXZpc2lvblRhZztcbiAgcHJpdmF0ZSBfdGFnOiBEaXJ0eWFibGVUYWc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb250ZW50OiBUKSB7XG4gICAgdGhpcy50YWcgPSB0aGlzLl90YWcgPSBuZXcgRGlydHlhYmxlVGFnKCk7XG4gIH1cblxuICB2YWx1ZSgpOiBUIHtcbiAgICByZXR1cm4gdGhpcy5jb250ZW50O1xuICB9XG5cbiAgdXBkYXRlKGNvbnRlbnQ6IFQpIHtcbiAgICB0aGlzLl90YWcuZGlydHkoKTtcbiAgICByZXR1cm4gdGhpcy5jb250ZW50ID0gY29udGVudDtcbiAgfVxufVxuXG5jbGFzcyBUYWdnZWREaWN0PFQ+IHtcbiAgcHVibGljIHRhZzogUmV2aXNpb25UYWc7XG4gIHByaXZhdGUgX3RhZzogRGlydHlhYmxlVGFnO1xuICBwcml2YXRlIGRhdGEgPSBkaWN0PFQ+KCk7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy50YWcgPSB0aGlzLl90YWcgPSBuZXcgRGlydHlhYmxlVGFnKCk7XG4gIH1cblxuICBnZXQoa2V5OiBzdHJpbmcpOiBUIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhW2tleV07XG4gIH1cblxuICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBUKSB7XG4gICAgdGhpcy5fdGFnLmRpcnR5KCk7XG4gICAgcmV0dXJuIHRoaXMuZGF0YVtrZXldID0gdmFsdWU7XG4gIH1cbn1cblxuUVVuaXQubW9kdWxlKFwiUmVmZXJlbmNlc1wiKTtcblxuUVVuaXQudGVzdChcIkNhY2hlZFJlZmVyZW5jZSBjYWNoZXMgY29tcHV0YXRpb24gY29ycmVjdGx5XCIsIGFzc2VydCA9PiB7XG4gIGxldCBjb21wdXRlZCA9IDA7XG5cbiAgY2xhc3MgRGljdFZhbHVlUmVmZXJlbmNlIGV4dGVuZHMgQ2FjaGVkUmVmZXJlbmNlPHN0cmluZz4ge1xuICAgIHB1YmxpYyB0YWc6IFJldmlzaW9uVGFnO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBkaWN0OiBUYWdnZWREaWN0PHN0cmluZz4sIHByaXZhdGUga2V5OiBzdHJpbmcpIHtcbiAgICAgIHN1cGVyKCk7XG4gICAgICB0aGlzLnRhZyA9IGRpY3QudGFnO1xuICAgIH1cblxuICAgIGNvbXB1dGUoKTogc3RyaW5nIHtcbiAgICAgIGNvbXB1dGVkKys7XG4gICAgICByZXR1cm4gdGhpcy5kaWN0LmdldCh0aGlzLmtleSk7XG4gICAgfVxuICB9XG5cbiAgbGV0IGRpY3QgPSBuZXcgVGFnZ2VkRGljdDxzdHJpbmc+KCk7XG4gIGxldCByZWZlcmVuY2UgPSBuZXcgRGljdFZhbHVlUmVmZXJlbmNlKGRpY3QsICdmb28nKTtcblxuICBkaWN0LnNldCgnZm9vJywgJ2JhcicpO1xuXG4gIGFzc2VydC5zdHJpY3RFcXVhbChjb21wdXRlZCwgMCwgJ3ByZWNvbmQnKTtcblxuICBhc3NlcnQuZXF1YWwocmVmZXJlbmNlLnZhbHVlKCksICdiYXInKTtcbiAgYXNzZXJ0LmVxdWFsKHJlZmVyZW5jZS52YWx1ZSgpLCAnYmFyJyk7XG4gIGFzc2VydC5lcXVhbChyZWZlcmVuY2UudmFsdWUoKSwgJ2JhcicpO1xuXG4gIGFzc2VydC5zdHJpY3RFcXVhbChjb21wdXRlZCwgMSwgJ2NvbXB1dGVkJyk7XG5cbiAgZGljdC5zZXQoJ2ZvbycsICdCQVInKTtcblxuICBhc3NlcnQuZXF1YWwocmVmZXJlbmNlLnZhbHVlKCksICdCQVInKTtcbiAgYXNzZXJ0LmVxdWFsKHJlZmVyZW5jZS52YWx1ZSgpLCAnQkFSJyk7XG4gIGFzc2VydC5lcXVhbChyZWZlcmVuY2UudmFsdWUoKSwgJ0JBUicpO1xuXG4gIGFzc2VydC5zdHJpY3RFcXVhbChjb21wdXRlZCwgMiwgJ2NvbXB1dGVkJyk7XG5cbiAgZGljdC5zZXQoJ2JheicsICdiYXQnKTtcblxuICBhc3NlcnQuZXF1YWwocmVmZXJlbmNlLnZhbHVlKCksICdCQVInKTtcbiAgYXNzZXJ0LmVxdWFsKHJlZmVyZW5jZS52YWx1ZSgpLCAnQkFSJyk7XG4gIGFzc2VydC5lcXVhbChyZWZlcmVuY2UudmFsdWUoKSwgJ0JBUicpO1xuXG4gIGFzc2VydC5zdHJpY3RFcXVhbChjb21wdXRlZCwgMywgJ2NvbXB1dGVkJyk7XG5cbiAgZGljdC5zZXQoJ2ZvbycsICdiYXInKTtcblxuICBhc3NlcnQuZXF1YWwocmVmZXJlbmNlLnZhbHVlKCksICdiYXInKTtcbiAgYXNzZXJ0LmVxdWFsKHJlZmVyZW5jZS52YWx1ZSgpLCAnYmFyJyk7XG4gIGFzc2VydC5lcXVhbChyZWZlcmVuY2UudmFsdWUoKSwgJ2JhcicpO1xuXG4gIGFzc2VydC5zdHJpY3RFcXVhbChjb21wdXRlZCwgNCwgJ2NvbXB1dGVkJyk7XG59KTtcblxuUVVuaXQudGVzdChcIkNhY2hlZFJlZmVyZW5jZSBjYWNoZXMgbmVzdGVkIGNvbXB1dGF0aW9uIGNvcnJlY3RseVwiLCBhc3NlcnQgPT4ge1xuICBsZXQgY29tcHV0ZWQgPSAwO1xuXG4gIGNsYXNzIERpY3RWYWx1ZVJlZmVyZW5jZSBleHRlbmRzIENhY2hlZFJlZmVyZW5jZTxzdHJpbmc+IHtcbiAgICBwdWJsaWMgdGFnOiBSZXZpc2lvblRhZztcbiAgICBwcml2YXRlIF90YWc6IFVwZGF0YWJsZVRhZztcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFyZW50OiBSZWZlcmVuY2U8VGFnZ2VkRGljdDxzdHJpbmc+PiwgcHJpdmF0ZSBrZXk6IHN0cmluZykge1xuICAgICAgc3VwZXIoKTtcbiAgICAgIGxldCBfdGFnID0gdGhpcy5fdGFnID0gbmV3IFVwZGF0YWJsZVRhZyhDT05TVEFOVF9UQUcpO1xuICAgICAgdGhpcy50YWcgPSBjb21iaW5lKFtwYXJlbnQudGFnLCBfdGFnXSk7XG4gICAgfVxuXG4gICAgY29tcHV0ZSgpOiBzdHJpbmcge1xuICAgICAgY29tcHV0ZWQrKztcblxuICAgICAgbGV0IHsgcGFyZW50LCBfdGFnLCBrZXkgfSA9IHRoaXM7XG5cbiAgICAgIGxldCBkaWN0ID0gcGFyZW50LnZhbHVlKCk7XG5cbiAgICAgIF90YWcudXBkYXRlKGRpY3QudGFnKTtcblxuICAgICAgcmV0dXJuIGRpY3QuZ2V0KGtleSk7XG4gICAgfVxuICB9XG5cbiAgbGV0IGZpcnN0ID0gbmV3IFRhZ2dlZERpY3Q8c3RyaW5nPigpO1xuICBsZXQgc2Vjb25kID0gbmV3IFRhZ2dlZERpY3Q8c3RyaW5nPigpO1xuXG4gIGxldCBkaWN0UmVmZXJlbmNlID0gbmV3IFVwZGF0YWJsZVJlZmVyZW5jZShmaXJzdCk7XG4gIGxldCB2YWx1ZVJlZmVyZW5jZSA9IG5ldyBEaWN0VmFsdWVSZWZlcmVuY2UoZGljdFJlZmVyZW5jZSwgJ2ZvbycpO1xuXG4gIGZpcnN0LnNldCgnZm9vJywgJ2JhcicpO1xuXG4gIGFzc2VydC5zdHJpY3RFcXVhbChjb21wdXRlZCwgMCwgJ3ByZWNvbmQnKTtcblxuICBhc3NlcnQuZXF1YWwodmFsdWVSZWZlcmVuY2UudmFsdWUoKSwgJ2JhcicpO1xuICBhc3NlcnQuZXF1YWwodmFsdWVSZWZlcmVuY2UudmFsdWUoKSwgJ2JhcicpO1xuICBhc3NlcnQuZXF1YWwodmFsdWVSZWZlcmVuY2UudmFsdWUoKSwgJ2JhcicpO1xuXG4gIGFzc2VydC5zdHJpY3RFcXVhbChjb21wdXRlZCwgMSwgJ2NvbXB1dGVkJyk7XG5cbiAgc2Vjb25kLnNldCgnZm9vJywgJ0JBUicpO1xuXG4gIGFzc2VydC5lcXVhbCh2YWx1ZVJlZmVyZW5jZS52YWx1ZSgpLCAnYmFyJyk7XG4gIGFzc2VydC5lcXVhbCh2YWx1ZVJlZmVyZW5jZS52YWx1ZSgpLCAnYmFyJyk7XG4gIGFzc2VydC5lcXVhbCh2YWx1ZVJlZmVyZW5jZS52YWx1ZSgpLCAnYmFyJyk7XG5cbiAgYXNzZXJ0LnN0cmljdEVxdWFsKGNvbXB1dGVkLCAxLCAnY29tcHV0ZWQnKTtcblxuICBkaWN0UmVmZXJlbmNlLnVwZGF0ZShzZWNvbmQpO1xuXG4gIGFzc2VydC5lcXVhbCh2YWx1ZVJlZmVyZW5jZS52YWx1ZSgpLCAnQkFSJyk7XG4gIGFzc2VydC5lcXVhbCh2YWx1ZVJlZmVyZW5jZS52YWx1ZSgpLCAnQkFSJyk7XG4gIGFzc2VydC5lcXVhbCh2YWx1ZVJlZmVyZW5jZS52YWx1ZSgpLCAnQkFSJyk7XG5cbiAgYXNzZXJ0LnN0cmljdEVxdWFsKGNvbXB1dGVkLCAyLCAnY29tcHV0ZWQnKTtcblxuICBzZWNvbmQuc2V0KCdmb28nLCAnZm9vLWJhcicpO1xuXG4gIGFzc2VydC5lcXVhbCh2YWx1ZVJlZmVyZW5jZS52YWx1ZSgpLCAnZm9vLWJhcicpO1xuICBhc3NlcnQuZXF1YWwodmFsdWVSZWZlcmVuY2UudmFsdWUoKSwgJ2Zvby1iYXInKTtcbiAgYXNzZXJ0LmVxdWFsKHZhbHVlUmVmZXJlbmNlLnZhbHVlKCksICdmb28tYmFyJyk7XG5cbiAgYXNzZXJ0LnN0cmljdEVxdWFsKGNvbXB1dGVkLCAzLCAnY29tcHV0ZWQnKTtcbn0pO1xuIl19