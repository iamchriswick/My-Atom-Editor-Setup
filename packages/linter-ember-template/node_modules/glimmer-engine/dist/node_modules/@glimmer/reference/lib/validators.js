"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
exports.CONSTANT = 0;
exports.INITIAL = 1;
exports.VOLATILE = NaN;
var RevisionTag = (function () {
    function RevisionTag() {
    }
    RevisionTag.prototype.validate = function (snapshot) {
        return this.value() === snapshot;
    };
    return RevisionTag;
}());
exports.RevisionTag = RevisionTag;
var $REVISION = exports.INITIAL;
var DirtyableTag = (function (_super) {
    __extends(DirtyableTag, _super);
    function DirtyableTag(revision) {
        if (revision === void 0) { revision = $REVISION; }
        var _this = _super.call(this) || this;
        _this.revision = revision;
        return _this;
    }
    DirtyableTag.prototype.value = function () {
        return this.revision;
    };
    DirtyableTag.prototype.dirty = function () {
        this.revision = ++$REVISION;
    };
    return DirtyableTag;
}(RevisionTag));
exports.DirtyableTag = DirtyableTag;
function combineTagged(tagged) {
    var optimized = [];
    for (var i = 0, l = tagged.length; i < l; i++) {
        var tag = tagged[i].tag;
        if (tag === exports.VOLATILE_TAG)
            return exports.VOLATILE_TAG;
        if (tag === exports.CONSTANT_TAG)
            continue;
        optimized.push(tag);
    }
    return _combine(optimized);
}
exports.combineTagged = combineTagged;
function combineSlice(slice) {
    var optimized = [];
    var node = slice.head();
    while (node !== null) {
        var tag = node.tag;
        if (tag === exports.VOLATILE_TAG)
            return exports.VOLATILE_TAG;
        if (tag !== exports.CONSTANT_TAG)
            optimized.push(tag);
        node = slice.nextNode(node);
    }
    return _combine(optimized);
}
exports.combineSlice = combineSlice;
function combine(tags) {
    var optimized = [];
    for (var i = 0, l = tags.length; i < l; i++) {
        var tag = tags[i];
        if (tag === exports.VOLATILE_TAG)
            return exports.VOLATILE_TAG;
        if (tag === exports.CONSTANT_TAG)
            continue;
        optimized.push(tag);
    }
    return _combine(optimized);
}
exports.combine = combine;
function _combine(tags) {
    switch (tags.length) {
        case 0:
            return exports.CONSTANT_TAG;
        case 1:
            return tags[0];
        case 2:
            return new TagsPair(tags[0], tags[1]);
        default:
            return new TagsCombinator(tags);
    }
    ;
}
var CachedTag = (function (_super) {
    __extends(CachedTag, _super);
    function CachedTag() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.lastChecked = null;
        _this.lastValue = null;
        return _this;
    }
    CachedTag.prototype.value = function () {
        var _a = this, lastChecked = _a.lastChecked, lastValue = _a.lastValue;
        if (lastChecked !== $REVISION) {
            this.lastChecked = $REVISION;
            this.lastValue = lastValue = this.compute();
        }
        return this.lastValue;
    };
    CachedTag.prototype.invalidate = function () {
        this.lastChecked = null;
    };
    return CachedTag;
}(RevisionTag));
exports.CachedTag = CachedTag;
var TagsPair = (function (_super) {
    __extends(TagsPair, _super);
    function TagsPair(first, second) {
        var _this = _super.call(this) || this;
        _this.first = first;
        _this.second = second;
        return _this;
    }
    TagsPair.prototype.compute = function () {
        return Math.max(this.first.value(), this.second.value());
    };
    return TagsPair;
}(CachedTag));
var TagsCombinator = (function (_super) {
    __extends(TagsCombinator, _super);
    function TagsCombinator(tags) {
        var _this = _super.call(this) || this;
        _this.tags = tags;
        return _this;
    }
    TagsCombinator.prototype.compute = function () {
        var tags = this.tags;
        var max = -1;
        for (var i = 0; i < tags.length; i++) {
            var value = tags[i].value();
            max = Math.max(value, max);
        }
        return max;
    };
    return TagsCombinator;
}(CachedTag));
var UpdatableTag = (function (_super) {
    __extends(UpdatableTag, _super);
    function UpdatableTag(tag) {
        var _this = _super.call(this) || this;
        _this.tag = tag;
        _this.lastUpdated = exports.INITIAL;
        return _this;
    }
    UpdatableTag.prototype.compute = function () {
        return Math.max(this.lastUpdated, this.tag.value());
    };
    UpdatableTag.prototype.update = function (tag) {
        if (tag !== this.tag) {
            this.tag = tag;
            this.lastUpdated = $REVISION;
            this.invalidate();
        }
    };
    return UpdatableTag;
}(CachedTag));
exports.UpdatableTag = UpdatableTag;
//////////
exports.CONSTANT_TAG = new ((function (_super) {
    __extends(ConstantTag, _super);
    function ConstantTag() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    ConstantTag.prototype.value = function () {
        return exports.CONSTANT;
    };
    return ConstantTag;
}(RevisionTag)));
exports.VOLATILE_TAG = new ((function (_super) {
    __extends(VolatileTag, _super);
    function VolatileTag() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    VolatileTag.prototype.value = function () {
        return exports.VOLATILE;
    };
    return VolatileTag;
}(RevisionTag)));
exports.CURRENT_TAG = new ((function (_super) {
    __extends(CurrentTag, _super);
    function CurrentTag() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    CurrentTag.prototype.value = function () {
        return $REVISION;
    };
    return CurrentTag;
}(DirtyableTag)));
var CachedReference = (function () {
    function CachedReference() {
        this.lastRevision = null;
        this.lastValue = null;
    }
    CachedReference.prototype.value = function () {
        var _a = this, tag = _a.tag, lastRevision = _a.lastRevision, lastValue = _a.lastValue;
        if (!lastRevision || !tag.validate(lastRevision)) {
            lastValue = this.lastValue = this.compute();
            this.lastRevision = tag.value();
        }
        return lastValue;
    };
    CachedReference.prototype.invalidate = function () {
        this.lastRevision = null;
    };
    return CachedReference;
}());
exports.CachedReference = CachedReference;
var MapperReference = (function (_super) {
    __extends(MapperReference, _super);
    function MapperReference(reference, mapper) {
        var _this = _super.call(this) || this;
        _this.tag = reference.tag;
        _this.reference = reference;
        _this.mapper = mapper;
        return _this;
    }
    MapperReference.prototype.compute = function () {
        var _a = this, reference = _a.reference, mapper = _a.mapper;
        return mapper(reference.value());
    };
    return MapperReference;
}(CachedReference));
function map(reference, mapper) {
    return new MapperReference(reference, mapper);
}
exports.map = map;
//////////
var ReferenceCache = (function () {
    function ReferenceCache(reference) {
        this.lastValue = null;
        this.lastRevision = null;
        this.initialized = false;
        this.tag = reference.tag;
        this.reference = reference;
    }
    ReferenceCache.prototype.peek = function () {
        if (!this.initialized) {
            return this.initialize();
        }
        return this.lastValue;
    };
    ReferenceCache.prototype.revalidate = function () {
        if (!this.initialized) {
            return this.initialize();
        }
        var _a = this, reference = _a.reference, lastRevision = _a.lastRevision;
        var tag = reference.tag;
        if (tag.validate(lastRevision))
            return NOT_MODIFIED;
        this.lastRevision = tag.value();
        var lastValue = this.lastValue;
        var value = reference.value();
        if (value === lastValue)
            return NOT_MODIFIED;
        this.lastValue = value;
        return value;
    };
    ReferenceCache.prototype.initialize = function () {
        var reference = this.reference;
        var value = this.lastValue = reference.value();
        this.lastRevision = reference.tag.value();
        this.initialized = true;
        return value;
    };
    return ReferenceCache;
}());
exports.ReferenceCache = ReferenceCache;
var NOT_MODIFIED = "adb3b78e-3d22-4e4b-877a-6317c2c5c145";
function isModified(value) {
    return value !== NOT_MODIFIED;
}
exports.isModified = isModified;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdG9ycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkBnbGltbWVyL3JlZmVyZW5jZS9saWIvdmFsaWRhdG9ycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFrQmEsUUFBQSxRQUFRLEdBQWEsQ0FBQyxDQUFDO0FBQ3ZCLFFBQUEsT0FBTyxHQUFjLENBQUMsQ0FBQztBQUN2QixRQUFBLFFBQVEsR0FBYSxHQUFHLENBQUM7QUFFdEM7SUFBQTtJQU1BLENBQUM7SUFIQyw4QkFBUSxHQUFSLFVBQVMsUUFBa0I7UUFDekIsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxRQUFRLENBQUM7SUFDbkMsQ0FBQztJQUNILGtCQUFDO0FBQUQsQ0FBQyxBQU5ELElBTUM7QUFOcUIsa0NBQVc7QUFRakMsSUFBSSxTQUFTLEdBQUcsZUFBTyxDQUFDO0FBRXhCO0lBQWtDLGdDQUFXO0lBRzNDLHNCQUFZLFFBQW9CO1FBQXBCLHlCQUFBLEVBQUEsb0JBQW9CO1FBQWhDLFlBQ0UsaUJBQU8sU0FFUjtRQURDLEtBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDOztJQUMzQixDQUFDO0lBRUQsNEJBQUssR0FBTDtRQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCw0QkFBSyxHQUFMO1FBQ0UsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLFNBQVMsQ0FBQztJQUM5QixDQUFDO0lBQ0gsbUJBQUM7QUFBRCxDQUFDLEFBZkQsQ0FBa0MsV0FBVyxHQWU1QztBQWZZLG9DQUFZO0FBaUJ6Qix1QkFBOEIsTUFBdUM7SUFDbkUsSUFBSSxTQUFTLEdBQTBCLEVBQUUsQ0FBQztJQUUxQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3hDLElBQUksR0FBRyxHQUF3QixNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1FBQzdDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxvQkFBWSxDQUFDO1lBQUMsTUFBTSxDQUFDLG9CQUFZLENBQUM7UUFDOUMsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLG9CQUFZLENBQUM7WUFBQyxRQUFRLENBQUM7UUFDbkMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBWEQsc0NBV0M7QUFFRCxzQkFBNkIsS0FBK0M7SUFDMUUsSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBRW5CLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUV4QixPQUFNLElBQUksS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNwQixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBRW5CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxvQkFBWSxDQUFDO1lBQUMsTUFBTSxDQUFDLG9CQUFZLENBQUM7UUFDOUMsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLG9CQUFZLENBQUM7WUFBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTlDLElBQUksR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUFmRCxvQ0FlQztBQUVELGlCQUF3QixJQUFtQjtJQUN6QyxJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7SUFFbkIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUN0QyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEIsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLG9CQUFZLENBQUM7WUFBQyxNQUFNLENBQUMsb0JBQVksQ0FBQztRQUM5QyxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssb0JBQVksQ0FBQztZQUFDLFFBQVEsQ0FBQztRQUNuQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUFYRCwwQkFXQztBQUVELGtCQUFrQixJQUEyQjtJQUMzQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNwQixLQUFLLENBQUM7WUFDSixNQUFNLENBQUMsb0JBQVksQ0FBQztRQUN0QixLQUFLLENBQUM7WUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBd0IsQ0FBQztRQUN4QyxLQUFLLENBQUM7WUFDSixNQUFNLENBQUMsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hDO1lBQ0UsTUFBTSxDQUFDLElBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFBQSxDQUFDO0FBQ0osQ0FBQztBQUVEO0lBQXdDLDZCQUFXO0lBQW5EO1FBQUEscUVBb0JDO1FBbkJTLGlCQUFXLEdBQXFCLElBQUksQ0FBQztRQUNyQyxlQUFTLEdBQXFCLElBQUksQ0FBQzs7SUFrQjdDLENBQUM7SUFoQkMseUJBQUssR0FBTDtRQUNNLElBQUEsU0FBaUMsRUFBL0IsNEJBQVcsRUFBRSx3QkFBUyxDQUFVO1FBRXRDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQzlCLElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDO1lBQzdCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QyxDQUFDO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFxQixDQUFDO0lBQ3BDLENBQUM7SUFFUyw4QkFBVSxHQUFwQjtRQUNFLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQzFCLENBQUM7SUFHSCxnQkFBQztBQUFELENBQUMsQUFwQkQsQ0FBd0MsV0FBVyxHQW9CbEQ7QUFwQnFCLDhCQUFTO0FBc0IvQjtJQUF1Qiw0QkFBUztJQUk5QixrQkFBWSxLQUFrQixFQUFFLE1BQW1CO1FBQW5ELFlBQ0UsaUJBQU8sU0FHUjtRQUZDLEtBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLEtBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDOztJQUN2QixDQUFDO0lBRVMsMEJBQU8sR0FBakI7UUFDRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBQ0gsZUFBQztBQUFELENBQUMsQUFiRCxDQUF1QixTQUFTLEdBYS9CO0FBRUQ7SUFBNkIsa0NBQVM7SUFHcEMsd0JBQVksSUFBbUI7UUFBL0IsWUFDRSxpQkFBTyxTQUVSO1FBREMsS0FBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7O0lBQ25CLENBQUM7SUFFUyxnQ0FBTyxHQUFqQjtRQUNRLElBQUEsZ0JBQUksQ0FBVTtRQUVwQixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUViLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEdBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2pDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUM1QixHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDN0IsQ0FBQztRQUVELE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDO0lBQ0gscUJBQUM7QUFBRCxDQUFDLEFBcEJELENBQTZCLFNBQVMsR0FvQnJDO0FBRUQ7SUFBa0MsZ0NBQVM7SUFJekMsc0JBQVksR0FBZ0I7UUFBNUIsWUFDRSxpQkFBTyxTQUdSO1FBRkMsS0FBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixLQUFJLENBQUMsV0FBVyxHQUFHLGVBQU8sQ0FBQzs7SUFDN0IsQ0FBQztJQUVTLDhCQUFPLEdBQWpCO1FBQ0UsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELDZCQUFNLEdBQU4sVUFBTyxHQUFnQjtRQUNyQixFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDckIsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7WUFDZixJQUFJLENBQUMsV0FBVyxHQUFHLFNBQVMsQ0FBQztZQUM3QixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDcEIsQ0FBQztJQUNILENBQUM7SUFDSCxtQkFBQztBQUFELENBQUMsQUFyQkQsQ0FBa0MsU0FBUyxHQXFCMUM7QUFyQlksb0NBQVk7QUF1QnpCLFVBQVU7QUFFRyxRQUFBLFlBQVksR0FBZ0IsSUFBSTtJQUNqQiwrQkFBVztJQUFyQzs7SUFJQSxDQUFDO0lBSEMsMkJBQUssR0FBTDtRQUNFLE1BQU0sQ0FBQyxnQkFBUSxDQUFDO0lBQ2xCLENBQUM7SUFDSCxrQkFBQztBQUFELENBQUMsQUFKRCxDQUEwQixXQUFXLEdBS3RDLENBQUM7QUFFVyxRQUFBLFlBQVksR0FBZ0IsSUFBSTtJQUNqQiwrQkFBVztJQUFyQzs7SUFJQSxDQUFDO0lBSEMsMkJBQUssR0FBTDtRQUNFLE1BQU0sQ0FBQyxnQkFBUSxDQUFDO0lBQ2xCLENBQUM7SUFDSCxrQkFBQztBQUFELENBQUMsQUFKRCxDQUEwQixXQUFXLEdBS3RDLENBQUM7QUFFVyxRQUFBLFdBQVcsR0FBaUIsSUFBSTtJQUNsQiw4QkFBWTtJQUFyQzs7SUFJQSxDQUFDO0lBSEMsMEJBQUssR0FBTDtRQUNFLE1BQU0sQ0FBQyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUNILGlCQUFDO0FBQUQsQ0FBQyxBQUpELENBQXlCLFlBQVksR0FLdEMsQ0FBQztBQVVGO0lBQUE7UUFHVSxpQkFBWSxHQUFxQixJQUFJLENBQUM7UUFDdEMsY0FBUyxHQUFjLElBQUksQ0FBQztJQWtCdEMsQ0FBQztJQWhCQywrQkFBSyxHQUFMO1FBQ00sSUFBQSxTQUF1QyxFQUFyQyxZQUFHLEVBQUUsOEJBQVksRUFBRSx3QkFBUyxDQUFVO1FBRTVDLEVBQUUsQ0FBQyxDQUFDLENBQUMsWUFBWSxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakQsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzVDLElBQUksQ0FBQyxZQUFZLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2xDLENBQUM7UUFFRCxNQUFNLENBQUMsU0FBYyxDQUFDO0lBQ3hCLENBQUM7SUFJUyxvQ0FBVSxHQUFwQjtRQUNFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0lBQzNCLENBQUM7SUFDSCxzQkFBQztBQUFELENBQUMsQUF0QkQsSUFzQkM7QUF0QnFCLDBDQUFlO0FBNEJyQztJQUFvQyxtQ0FBa0I7SUFNcEQseUJBQVksU0FBZ0MsRUFBRSxNQUFvQjtRQUFsRSxZQUNFLGlCQUFPLFNBSVI7UUFIQyxLQUFJLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUM7UUFDekIsS0FBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsS0FBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7O0lBQ3ZCLENBQUM7SUFFUyxpQ0FBTyxHQUFqQjtRQUNNLElBQUEsU0FBNEIsRUFBMUIsd0JBQVMsRUFBRSxrQkFBTSxDQUFVO1FBQ2pDLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUNILHNCQUFDO0FBQUQsQ0FBQyxBQWpCRCxDQUFvQyxlQUFlLEdBaUJsRDtBQUVELGFBQTBCLFNBQWdDLEVBQUUsTUFBb0I7SUFDOUUsTUFBTSxDQUFDLElBQUksZUFBZSxDQUFPLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN0RCxDQUFDO0FBRkQsa0JBRUM7QUFFRCxVQUFVO0FBRVY7SUFRRSx3QkFBWSxTQUFnQztRQUpwQyxjQUFTLEdBQWMsSUFBSSxDQUFDO1FBQzVCLGlCQUFZLEdBQXFCLElBQUksQ0FBQztRQUN0QyxnQkFBVyxHQUFZLEtBQUssQ0FBQztRQUduQyxJQUFJLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUM7UUFDekIsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFDN0IsQ0FBQztJQUVELDZCQUFJLEdBQUo7UUFDRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDM0IsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBYyxDQUFDO0lBQzdCLENBQUM7SUFFRCxtQ0FBVSxHQUFWO1FBQ0UsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztZQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQzNCLENBQUM7UUFFRyxJQUFBLFNBQWtDLEVBQWhDLHdCQUFTLEVBQUUsOEJBQVksQ0FBVTtRQUN2QyxJQUFJLEdBQUcsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDO1FBRXhCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsWUFBc0IsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztRQUM5RCxJQUFJLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUUxQixJQUFBLDBCQUFTLENBQVU7UUFDekIsSUFBSSxLQUFLLEdBQUcsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzlCLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7WUFBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1FBQzdDLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBRXZCLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU8sbUNBQVUsR0FBbEI7UUFDUSxJQUFBLDBCQUFTLENBQVU7UUFFekIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDL0MsSUFBSSxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzFDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBRXhCLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQ0gscUJBQUM7QUFBRCxDQUFDLEFBakRELElBaURDO0FBakRZLHdDQUFjO0FBdUQzQixJQUFNLFlBQVksR0FBZ0Isc0NBQXNDLENBQUM7QUFFekUsb0JBQThCLEtBQW9CO0lBQ2hELE1BQU0sQ0FBQyxLQUFLLEtBQUssWUFBWSxDQUFDO0FBQ2hDLENBQUM7QUFGRCxnQ0FFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWZlcmVuY2UsIHsgUGF0aFJlZmVyZW5jZSB9IGZyb20gJy4vcmVmZXJlbmNlJztcbmltcG9ydCB7IE9wYXF1ZSwgT3B0aW9uLCBTbGljZSwgTGlua2VkTGlzdE5vZGUgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcblxuLy8vLy8vLy8vL1xuXG5leHBvcnQgaW50ZXJmYWNlIEVudGl0eVRhZzxUPiBleHRlbmRzIFJlZmVyZW5jZTxUPiB7XG4gIHZhbHVlKCk6IFQ7XG4gIHZhbGlkYXRlKHNuYXBzaG90OiBUKTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUYWdnZWQ8VD4ge1xuICB0YWc6IEVudGl0eVRhZzxUPjtcbn1cblxuLy8vLy8vLy8vL1xuXG5leHBvcnQgdHlwZSBSZXZpc2lvbiA9IG51bWJlcjtcblxuZXhwb3J0IGNvbnN0IENPTlNUQU5UOiBSZXZpc2lvbiA9IDA7XG5leHBvcnQgY29uc3QgSU5JVElBTDogIFJldmlzaW9uID0gMTtcbmV4cG9ydCBjb25zdCBWT0xBVElMRTogUmV2aXNpb24gPSBOYU47XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZXZpc2lvblRhZyBpbXBsZW1lbnRzIEVudGl0eVRhZzxSZXZpc2lvbj4ge1xuICBhYnN0cmFjdCB2YWx1ZSgpOiBSZXZpc2lvbjtcblxuICB2YWxpZGF0ZShzbmFwc2hvdDogUmV2aXNpb24pOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy52YWx1ZSgpID09PSBzbmFwc2hvdDtcbiAgfVxufVxuXG5sZXQgJFJFVklTSU9OID0gSU5JVElBTDtcblxuZXhwb3J0IGNsYXNzIERpcnR5YWJsZVRhZyBleHRlbmRzIFJldmlzaW9uVGFnIHtcbiAgcHJpdmF0ZSByZXZpc2lvbjogUmV2aXNpb247XG5cbiAgY29uc3RydWN0b3IocmV2aXNpb24gPSAkUkVWSVNJT04pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMucmV2aXNpb24gPSByZXZpc2lvbjtcbiAgfVxuXG4gIHZhbHVlKCk6IFJldmlzaW9uIHtcbiAgICByZXR1cm4gdGhpcy5yZXZpc2lvbjtcbiAgfVxuXG4gIGRpcnR5KCkge1xuICAgIHRoaXMucmV2aXNpb24gPSArKyRSRVZJU0lPTjtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29tYmluZVRhZ2dlZCh0YWdnZWQ6IFJlYWRvbmx5QXJyYXk8VGFnZ2VkPFJldmlzaW9uPj4pOiBSZXZpc2lvblRhZyB7XG4gIGxldCBvcHRpbWl6ZWQ6IEVudGl0eVRhZzxSZXZpc2lvbj5bXSA9IFtdO1xuXG4gIGZvciAobGV0IGk9MCwgbD10YWdnZWQubGVuZ3RoOyBpPGw7IGkrKykge1xuICAgIGxldCB0YWc6IEVudGl0eVRhZzxSZXZpc2lvbj4gPSB0YWdnZWRbaV0udGFnO1xuICAgIGlmICh0YWcgPT09IFZPTEFUSUxFX1RBRykgcmV0dXJuIFZPTEFUSUxFX1RBRztcbiAgICBpZiAodGFnID09PSBDT05TVEFOVF9UQUcpIGNvbnRpbnVlO1xuICAgIG9wdGltaXplZC5wdXNoKHRhZyk7XG4gIH1cblxuICByZXR1cm4gX2NvbWJpbmUob3B0aW1pemVkKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbWJpbmVTbGljZShzbGljZTogU2xpY2U8VGFnZ2VkPFJldmlzaW9uPiAmIExpbmtlZExpc3ROb2RlPik6IFJldmlzaW9uVGFnIHtcbiAgbGV0IG9wdGltaXplZCA9IFtdO1xuXG4gIGxldCBub2RlID0gc2xpY2UuaGVhZCgpO1xuXG4gIHdoaWxlKG5vZGUgIT09IG51bGwpIHtcbiAgICBsZXQgdGFnID0gbm9kZS50YWc7XG5cbiAgICBpZiAodGFnID09PSBWT0xBVElMRV9UQUcpIHJldHVybiBWT0xBVElMRV9UQUc7XG4gICAgaWYgKHRhZyAhPT0gQ09OU1RBTlRfVEFHKSBvcHRpbWl6ZWQucHVzaCh0YWcpO1xuXG4gICAgbm9kZSA9IHNsaWNlLm5leHROb2RlKG5vZGUpO1xuICB9XG5cbiAgcmV0dXJuIF9jb21iaW5lKG9wdGltaXplZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21iaW5lKHRhZ3M6IFJldmlzaW9uVGFnW10pOiBSZXZpc2lvblRhZyB7XG4gIGxldCBvcHRpbWl6ZWQgPSBbXTtcblxuICBmb3IgKGxldCBpPTAsIGw9dGFncy5sZW5ndGg7IGk8bDsgaSsrKSB7XG4gICAgbGV0IHRhZyA9IHRhZ3NbaV07XG4gICAgaWYgKHRhZyA9PT0gVk9MQVRJTEVfVEFHKSByZXR1cm4gVk9MQVRJTEVfVEFHO1xuICAgIGlmICh0YWcgPT09IENPTlNUQU5UX1RBRykgY29udGludWU7XG4gICAgb3B0aW1pemVkLnB1c2godGFnKTtcbiAgfVxuXG4gIHJldHVybiBfY29tYmluZShvcHRpbWl6ZWQpO1xufVxuXG5mdW5jdGlvbiBfY29tYmluZSh0YWdzOiBFbnRpdHlUYWc8UmV2aXNpb24+W10pOiBSZXZpc2lvblRhZyB7XG4gIHN3aXRjaCAodGFncy5sZW5ndGgpIHtcbiAgICBjYXNlIDA6XG4gICAgICByZXR1cm4gQ09OU1RBTlRfVEFHO1xuICAgIGNhc2UgMTpcbiAgICAgIHJldHVybiB0YWdzWzBdIGFzIEVudGl0eVRhZzxSZXZpc2lvbj47XG4gICAgY2FzZSAyOlxuICAgICAgcmV0dXJuIG5ldyBUYWdzUGFpcih0YWdzWzBdLCB0YWdzWzFdKTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIG5ldyBUYWdzQ29tYmluYXRvcih0YWdzKTtcbiAgfTtcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIENhY2hlZFRhZyBleHRlbmRzIFJldmlzaW9uVGFnIHtcbiAgcHJpdmF0ZSBsYXN0Q2hlY2tlZDogT3B0aW9uPFJldmlzaW9uPiA9IG51bGw7XG4gIHByaXZhdGUgbGFzdFZhbHVlOiBPcHRpb248UmV2aXNpb24+ID0gbnVsbDtcblxuICB2YWx1ZSgpOiBSZXZpc2lvbiB7XG4gICAgbGV0IHsgbGFzdENoZWNrZWQsIGxhc3RWYWx1ZSB9ID0gdGhpcztcblxuICAgIGlmIChsYXN0Q2hlY2tlZCAhPT0gJFJFVklTSU9OKSB7XG4gICAgICB0aGlzLmxhc3RDaGVja2VkID0gJFJFVklTSU9OO1xuICAgICAgdGhpcy5sYXN0VmFsdWUgPSBsYXN0VmFsdWUgPSB0aGlzLmNvbXB1dGUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5sYXN0VmFsdWUgYXMgUmV2aXNpb247XG4gIH1cblxuICBwcm90ZWN0ZWQgaW52YWxpZGF0ZSgpIHtcbiAgICB0aGlzLmxhc3RDaGVja2VkID0gbnVsbDtcbiAgfVxuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBjb21wdXRlKCk6IFJldmlzaW9uO1xufVxuXG5jbGFzcyBUYWdzUGFpciBleHRlbmRzIENhY2hlZFRhZyB7XG4gIHByaXZhdGUgZmlyc3Q6IFJldmlzaW9uVGFnO1xuICBwcml2YXRlIHNlY29uZDogUmV2aXNpb25UYWc7XG5cbiAgY29uc3RydWN0b3IoZmlyc3Q6IFJldmlzaW9uVGFnLCBzZWNvbmQ6IFJldmlzaW9uVGFnKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmZpcnN0ID0gZmlyc3Q7XG4gICAgdGhpcy5zZWNvbmQgPSBzZWNvbmQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgY29tcHV0ZSgpOiBSZXZpc2lvbiB7XG4gICAgcmV0dXJuIE1hdGgubWF4KHRoaXMuZmlyc3QudmFsdWUoKSwgdGhpcy5zZWNvbmQudmFsdWUoKSk7XG4gIH1cbn1cblxuY2xhc3MgVGFnc0NvbWJpbmF0b3IgZXh0ZW5kcyBDYWNoZWRUYWcge1xuICBwcml2YXRlIHRhZ3M6IFJldmlzaW9uVGFnW107XG5cbiAgY29uc3RydWN0b3IodGFnczogUmV2aXNpb25UYWdbXSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy50YWdzID0gdGFncztcbiAgfVxuXG4gIHByb3RlY3RlZCBjb21wdXRlKCk6IFJldmlzaW9uIHtcbiAgICBsZXQgeyB0YWdzIH0gPSB0aGlzO1xuXG4gICAgbGV0IG1heCA9IC0xO1xuXG4gICAgZm9yIChsZXQgaT0wOyBpPHRhZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCB2YWx1ZSA9IHRhZ3NbaV0udmFsdWUoKTtcbiAgICAgIG1heCA9IE1hdGgubWF4KHZhbHVlLCBtYXgpO1xuICAgIH1cblxuICAgIHJldHVybiBtYXg7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFVwZGF0YWJsZVRhZyBleHRlbmRzIENhY2hlZFRhZyB7XG4gIHByaXZhdGUgdGFnOiBSZXZpc2lvblRhZztcbiAgcHJpdmF0ZSBsYXN0VXBkYXRlZDogUmV2aXNpb247XG5cbiAgY29uc3RydWN0b3IodGFnOiBSZXZpc2lvblRhZykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy50YWcgPSB0YWc7XG4gICAgdGhpcy5sYXN0VXBkYXRlZCA9IElOSVRJQUw7XG4gIH1cblxuICBwcm90ZWN0ZWQgY29tcHV0ZSgpOiBSZXZpc2lvbiB7XG4gICAgcmV0dXJuIE1hdGgubWF4KHRoaXMubGFzdFVwZGF0ZWQsIHRoaXMudGFnLnZhbHVlKCkpO1xuICB9XG5cbiAgdXBkYXRlKHRhZzogUmV2aXNpb25UYWcpIHtcbiAgICBpZiAodGFnICE9PSB0aGlzLnRhZykge1xuICAgICAgdGhpcy50YWcgPSB0YWc7XG4gICAgICB0aGlzLmxhc3RVcGRhdGVkID0gJFJFVklTSU9OO1xuICAgICAgdGhpcy5pbnZhbGlkYXRlKCk7XG4gICAgfVxuICB9XG59XG5cbi8vLy8vLy8vLy9cblxuZXhwb3J0IGNvbnN0IENPTlNUQU5UX1RBRzogUmV2aXNpb25UYWcgPSBuZXcgKFxuICBjbGFzcyBDb25zdGFudFRhZyBleHRlbmRzIFJldmlzaW9uVGFnIHtcbiAgICB2YWx1ZSgpOiBSZXZpc2lvbiB7XG4gICAgICByZXR1cm4gQ09OU1RBTlQ7XG4gICAgfVxuICB9XG4pO1xuXG5leHBvcnQgY29uc3QgVk9MQVRJTEVfVEFHOiBSZXZpc2lvblRhZyA9IG5ldyAoXG4gIGNsYXNzIFZvbGF0aWxlVGFnIGV4dGVuZHMgUmV2aXNpb25UYWcge1xuICAgIHZhbHVlKCk6IFJldmlzaW9uIHtcbiAgICAgIHJldHVybiBWT0xBVElMRTtcbiAgICB9XG4gIH1cbik7XG5cbmV4cG9ydCBjb25zdCBDVVJSRU5UX1RBRzogRGlydHlhYmxlVGFnID0gbmV3IChcbiAgY2xhc3MgQ3VycmVudFRhZyBleHRlbmRzIERpcnR5YWJsZVRhZyB7XG4gICAgdmFsdWUoKTogUmV2aXNpb24ge1xuICAgICAgcmV0dXJuICRSRVZJU0lPTjtcbiAgICB9XG4gIH1cbik7XG5cbi8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBWZXJzaW9uZWRSZWZlcmVuY2U8VD4gZXh0ZW5kcyBSZWZlcmVuY2U8VD4sIFRhZ2dlZDxSZXZpc2lvbj4ge31cblxuZXhwb3J0IGludGVyZmFjZSBWZXJzaW9uZWRQYXRoUmVmZXJlbmNlPFQ+IGV4dGVuZHMgUGF0aFJlZmVyZW5jZTxUPiwgVGFnZ2VkPFJldmlzaW9uPiB7XG4gIGdldChwcm9wZXJ0eTogc3RyaW5nKTogVmVyc2lvbmVkUGF0aFJlZmVyZW5jZTxPcGFxdWU+O1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQ2FjaGVkUmVmZXJlbmNlPFQ+IGltcGxlbWVudHMgVmVyc2lvbmVkUmVmZXJlbmNlPFQ+IHtcbiAgcHVibGljIGFic3RyYWN0IHRhZzogUmV2aXNpb25UYWc7XG5cbiAgcHJpdmF0ZSBsYXN0UmV2aXNpb246IE9wdGlvbjxSZXZpc2lvbj4gPSBudWxsO1xuICBwcml2YXRlIGxhc3RWYWx1ZTogT3B0aW9uPFQ+ID0gbnVsbDtcblxuICB2YWx1ZSgpOiBUIHtcbiAgICBsZXQgeyB0YWcsIGxhc3RSZXZpc2lvbiwgbGFzdFZhbHVlIH0gPSB0aGlzO1xuXG4gICAgaWYgKCFsYXN0UmV2aXNpb24gfHwgIXRhZy52YWxpZGF0ZShsYXN0UmV2aXNpb24pKSB7XG4gICAgICBsYXN0VmFsdWUgPSB0aGlzLmxhc3RWYWx1ZSA9IHRoaXMuY29tcHV0ZSgpO1xuICAgICAgdGhpcy5sYXN0UmV2aXNpb24gPSB0YWcudmFsdWUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbGFzdFZhbHVlIGFzIFQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgY29tcHV0ZSgpOiBUO1xuXG4gIHByb3RlY3RlZCBpbnZhbGlkYXRlKCkge1xuICAgIHRoaXMubGFzdFJldmlzaW9uID0gbnVsbDtcbiAgfVxufVxuXG4vLy8vLy8vLy8vXG5cbmV4cG9ydCB0eXBlIE1hcHBlcjxULCBVPiA9ICh2YWx1ZTogVCkgPT4gVTtcblxuY2xhc3MgTWFwcGVyUmVmZXJlbmNlPFQsIFU+IGV4dGVuZHMgQ2FjaGVkUmVmZXJlbmNlPFU+IHtcbiAgcHVibGljIHRhZzogUmV2aXNpb25UYWc7XG5cbiAgcHJpdmF0ZSByZWZlcmVuY2U6IFZlcnNpb25lZFJlZmVyZW5jZTxUPjtcbiAgcHJpdmF0ZSBtYXBwZXI6IE1hcHBlcjxULCBVPjtcblxuICBjb25zdHJ1Y3RvcihyZWZlcmVuY2U6IFZlcnNpb25lZFJlZmVyZW5jZTxUPiwgbWFwcGVyOiBNYXBwZXI8VCwgVT4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudGFnID0gcmVmZXJlbmNlLnRhZztcbiAgICB0aGlzLnJlZmVyZW5jZSA9IHJlZmVyZW5jZTtcbiAgICB0aGlzLm1hcHBlciA9IG1hcHBlcjtcbiAgfVxuXG4gIHByb3RlY3RlZCBjb21wdXRlKCk6IFUge1xuICAgIGxldCB7IHJlZmVyZW5jZSwgbWFwcGVyIH0gPSB0aGlzO1xuICAgIHJldHVybiBtYXBwZXIocmVmZXJlbmNlLnZhbHVlKCkpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXA8VCwgVT4ocmVmZXJlbmNlOiBWZXJzaW9uZWRSZWZlcmVuY2U8VD4sIG1hcHBlcjogTWFwcGVyPFQsIFU+KTogVmVyc2lvbmVkUmVmZXJlbmNlPFU+IHtcbiAgcmV0dXJuIG5ldyBNYXBwZXJSZWZlcmVuY2U8VCwgVT4ocmVmZXJlbmNlLCBtYXBwZXIpO1xufVxuXG4vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBSZWZlcmVuY2VDYWNoZTxUPiBpbXBsZW1lbnRzIFRhZ2dlZDxSZXZpc2lvbj4ge1xuICBwdWJsaWMgdGFnOiBSZXZpc2lvblRhZztcblxuICBwcml2YXRlIHJlZmVyZW5jZTogVmVyc2lvbmVkUmVmZXJlbmNlPFQ+O1xuICBwcml2YXRlIGxhc3RWYWx1ZTogT3B0aW9uPFQ+ID0gbnVsbDtcbiAgcHJpdmF0ZSBsYXN0UmV2aXNpb246IE9wdGlvbjxSZXZpc2lvbj4gPSBudWxsO1xuICBwcml2YXRlIGluaXRpYWxpemVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocmVmZXJlbmNlOiBWZXJzaW9uZWRSZWZlcmVuY2U8VD4pIHtcbiAgICB0aGlzLnRhZyA9IHJlZmVyZW5jZS50YWc7XG4gICAgdGhpcy5yZWZlcmVuY2UgPSByZWZlcmVuY2U7XG4gIH1cblxuICBwZWVrKCk6IFQge1xuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZSgpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmxhc3RWYWx1ZSBhcyBUO1xuICB9XG5cbiAgcmV2YWxpZGF0ZSgpOiBWYWxpZGF0aW9uPFQ+IHtcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmluaXRpYWxpemUoKTtcbiAgICB9XG5cbiAgICBsZXQgeyByZWZlcmVuY2UsIGxhc3RSZXZpc2lvbiB9ID0gdGhpcztcbiAgICBsZXQgdGFnID0gcmVmZXJlbmNlLnRhZztcblxuICAgIGlmICh0YWcudmFsaWRhdGUobGFzdFJldmlzaW9uIGFzIG51bWJlcikpIHJldHVybiBOT1RfTU9ESUZJRUQ7XG4gICAgdGhpcy5sYXN0UmV2aXNpb24gPSB0YWcudmFsdWUoKTtcblxuICAgIGxldCB7IGxhc3RWYWx1ZSB9ID0gdGhpcztcbiAgICBsZXQgdmFsdWUgPSByZWZlcmVuY2UudmFsdWUoKTtcbiAgICBpZiAodmFsdWUgPT09IGxhc3RWYWx1ZSkgcmV0dXJuIE5PVF9NT0RJRklFRDtcbiAgICB0aGlzLmxhc3RWYWx1ZSA9IHZhbHVlO1xuXG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplKCk6IFQge1xuICAgIGxldCB7IHJlZmVyZW5jZSB9ID0gdGhpcztcblxuICAgIGxldCB2YWx1ZSA9IHRoaXMubGFzdFZhbHVlID0gcmVmZXJlbmNlLnZhbHVlKCk7XG4gICAgdGhpcy5sYXN0UmV2aXNpb24gPSByZWZlcmVuY2UudGFnLnZhbHVlKCk7XG4gICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7XG5cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgVmFsaWRhdGlvbjxUPiA9IFQgfCBOb3RNb2RpZmllZDtcblxuZXhwb3J0IHR5cGUgTm90TW9kaWZpZWQgPSBcImFkYjNiNzhlLTNkMjItNGU0Yi04NzdhLTYzMTdjMmM1YzE0NVwiO1xuXG5jb25zdCBOT1RfTU9ESUZJRUQ6IE5vdE1vZGlmaWVkID0gXCJhZGIzYjc4ZS0zZDIyLTRlNGItODc3YS02MzE3YzJjNWMxNDVcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzTW9kaWZpZWQ8VD4odmFsdWU6IFZhbGlkYXRpb248VD4pOiB2YWx1ZSBpcyBUIHtcbiAgcmV0dXJuIHZhbHVlICE9PSBOT1RfTU9ESUZJRUQ7XG59XG4iXX0=