"use strict";
var reference_1 = require("@glimmer/reference");
var object_reference_1 = require("@glimmer/object-reference");
var util_1 = require("@glimmer/util");
QUnit.module("Reference iterables");
var Target = (function () {
    function Target() {
        this.map = util_1.dict();
        this.list = new util_1.LinkedList();
        this.tag = reference_1.VOLATILE_TAG;
    }
    Target.prototype.retain = function (key, item, memo) {
        if (item !== this.map[key].value) {
            throw new Error("unstable reference");
        }
    };
    Target.prototype.done = function () { };
    Target.prototype.append = function (key, item, memo) {
        var node = this.map[key] = new util_1.ListNode(item);
        this.list.append(node);
    };
    Target.prototype.insert = function (key, item, memo, before) {
        var referenceNode = before ? this.map[before] : null;
        var node = this.map[key] = new util_1.ListNode(item);
        this.list.insertBefore(node, referenceNode);
    };
    Target.prototype.move = function (key, item, memo, before) {
        var referenceNode = before ? this.map[before] : null;
        var node = this.map[key];
        if (item !== node.value) {
            throw new Error("unstable reference");
        }
        this.list.remove(node);
        this.list.insertBefore(node, referenceNode);
    };
    Target.prototype.delete = function (key) {
        var node = this.map[key];
        delete this.map[key];
        this.list.remove(node);
    };
    Target.prototype.toArray = function () {
        return this.list.toArray().map(function (node) { return node.value; });
    };
    Target.prototype.toValues = function () {
        return this.toArray().map(function (ref) { return ref.value(); });
    };
    return Target;
}());
var TestIterationItem = (function () {
    function TestIterationItem(key, value, memo) {
        this.key = key;
        this.value = value;
        this.memo = memo;
    }
    return TestIterationItem;
}());
var TestIterator = (function () {
    function TestIterator(array) {
        this.position = 0;
        this.array = array;
    }
    TestIterator.prototype.isEmpty = function () {
        return this.array.length === 0;
    };
    TestIterator.prototype.next = function () {
        var _a = this, position = _a.position, array = _a.array;
        if (position >= array.length)
            return null;
        var value = array[position];
        this.position++;
        return new TestIterationItem(value.key, value, position);
    };
    return TestIterator;
}());
var TestIterable = (function () {
    function TestIterable(arrayRef) {
        this.tag = arrayRef.tag;
        this.arrayRef = arrayRef;
    }
    TestIterable.prototype.iterate = function () {
        return new TestIterator(this.arrayRef.value());
    };
    TestIterable.prototype.valueReferenceFor = function (item) {
        return new object_reference_1.UpdatableReference(item.value);
    };
    TestIterable.prototype.updateValueReference = function (reference, item) {
        reference.update(item.value);
    };
    TestIterable.prototype.memoReferenceFor = function (item) {
        return new object_reference_1.UpdatableReference(item.memo);
    };
    TestIterable.prototype.updateMemoReference = function (reference, item) {
        reference.update(item.memo);
    };
    return TestIterable;
}());
function initialize(arr) {
    var target = new Target();
    var reference = new object_reference_1.UpdatableReference(arr);
    var iterator = new reference_1.ReferenceIterator(new TestIterable(reference));
    var item;
    while (item = iterator.next()) {
        target.append(item.key, item.value, item.memo);
    }
    return { reference: reference, target: target, artifacts: iterator.artifacts };
}
function sync(target, artifacts) {
    var synchronizer = new reference_1.IteratorSynchronizer({ target: target, artifacts: artifacts });
    synchronizer.sync();
}
QUnit.test("They provide a sequence of references with keys", function (assert) {
    var arr = [{ key: "a", name: "Yehuda" }, { key: "b", name: "Godfrey" }];
    var target = initialize(arr).target;
    assert.deepEqual(target.toValues(), arr);
});
QUnit.test("When re-iterated via mutation, the original references are updated", function (assert) {
    var arr = [{ key: "a", name: "Yehuda" }, { key: "b", name: "Godfrey" }];
    var _a = initialize(arr), target = _a.target, artifacts = _a.artifacts;
    assert.deepEqual(target.toValues(), arr);
    arr.reverse();
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
    arr.push({ key: "c", name: "Godhuda" });
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
    arr.shift();
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
});
QUnit.test("When re-iterated via deep mutation, the original references are updated", function (assert) {
    var arr = [{ key: "a", name: "Yehuda" }, { key: "b", name: "Godfrey" }];
    var _a = initialize(arr), target = _a.target, artifacts = _a.artifacts;
    assert.deepEqual(target.toValues(), arr);
    arr[0].key = "b";
    arr[0].name = "Godfrey";
    arr[1].key = "a";
    arr[1].name = "Yehuda";
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
    arr[0].name = "Yehuda";
    arr[1].name = "Godfrey";
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
    arr.push({ key: "c", name: "Godhuda" });
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
    arr.shift();
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
});
QUnit.test("When re-iterated via replacement, the original references are updated", function (assert) {
    var arr = [{ key: "a", name: "Yehuda" }, { key: "b", name: "Godfrey" }];
    var _a = initialize(arr), target = _a.target, reference = _a.reference, artifacts = _a.artifacts;
    assert.deepEqual(target.toValues(), arr);
    arr = arr.slice();
    arr.reverse();
    reference.update(arr);
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
    reference.update([{ key: 'a', name: "Tom" }, { key: "b", name: "Stef " }]);
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), [{ key: 'a', name: "Tom" }, { key: "b", name: "Stef " }]);
    arr = arr.slice();
    arr.push({ key: "c", name: "Godhuda" });
    reference.update(arr);
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
    arr = arr.slice();
    arr.shift();
    reference.update(arr);
    sync(target, artifacts);
    assert.deepEqual(target.toValues(), arr);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlcmFibGUtdGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkBnbGltbWVyL3JlZmVyZW5jZS90ZXN0cy9pdGVyYWJsZS10ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxnREFZNEI7QUFFNUIsOERBQStEO0FBRS9ELHNDQUFtRTtBQUVuRSxLQUFLLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFFcEM7SUFBQTtRQUNVLFFBQUcsR0FBRyxXQUFJLEVBQW9DLENBQUM7UUFDL0MsU0FBSSxHQUFHLElBQUksaUJBQVUsRUFBb0MsQ0FBQztRQUMzRCxRQUFHLEdBQUcsd0JBQVksQ0FBQztJQThDNUIsQ0FBQztJQTVDQyx1QkFBTSxHQUFOLFVBQU8sR0FBVyxFQUFFLElBQTRCLEVBQUUsSUFBNEI7UUFDNUUsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNqQyxNQUFNLElBQUksS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDeEMsQ0FBQztJQUNILENBQUM7SUFFRCxxQkFBSSxHQUFKLGNBQVEsQ0FBQztJQUVULHVCQUFNLEdBQU4sVUFBTyxHQUFXLEVBQUUsSUFBNEIsRUFBRSxJQUE0QjtRQUM1RSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksZUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRCx1QkFBTSxHQUFOLFVBQU8sR0FBVyxFQUFFLElBQTRCLEVBQUUsSUFBNEIsRUFBRSxNQUFjO1FBQzVGLElBQUksYUFBYSxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNyRCxJQUFJ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TUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRXhCLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBRXpDLEdBQUcsR0FBRyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDbEIsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ1osU0FBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUV0QixJQUFJLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRXhCLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzNDLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgVk9MQVRJTEVfVEFHLFxuICBCYXNpY1JlZmVyZW5jZSxcbiAgUmVmZXJlbmNlLFxuICBSZXZpc2lvblRhZyxcbiAgQWJzdHJhY3RJdGVyYWJsZSxcbiAgSXRlcmF0b3IsXG4gIEl0ZXJhdGlvbkl0ZW0sXG4gIEl0ZXJhdGlvbkFydGlmYWN0cyxcbiAgUmVmZXJlbmNlSXRlcmF0b3IsXG4gIEl0ZXJhdG9yU3luY2hyb25pemVyLFxuICBJdGVyYXRvclN5bmNocm9uaXplckRlbGVnYXRlXG59IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5cbmltcG9ydCB7IFVwZGF0YWJsZVJlZmVyZW5jZSB9IGZyb20gJ0BnbGltbWVyL29iamVjdC1yZWZlcmVuY2UnO1xuXG5pbXBvcnQgeyBPcGFxdWUsIExpbmtlZExpc3QsIExpc3ROb2RlLCBkaWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5cblFVbml0Lm1vZHVsZShcIlJlZmVyZW5jZSBpdGVyYWJsZXNcIik7XG5cbmNsYXNzIFRhcmdldCBpbXBsZW1lbnRzIEl0ZXJhdG9yU3luY2hyb25pemVyRGVsZWdhdGUge1xuICBwcml2YXRlIG1hcCA9IGRpY3Q8TGlzdE5vZGU8QmFzaWNSZWZlcmVuY2U8T3BhcXVlPj4+KCk7XG4gIHByaXZhdGUgbGlzdCA9IG5ldyBMaW5rZWRMaXN0PExpc3ROb2RlPEJhc2ljUmVmZXJlbmNlPE9wYXF1ZT4+PigpO1xuICBwdWJsaWMgdGFnID0gVk9MQVRJTEVfVEFHO1xuXG4gIHJldGFpbihrZXk6IHN0cmluZywgaXRlbTogQmFzaWNSZWZlcmVuY2U8T3BhcXVlPiwgbWVtbzogQmFzaWNSZWZlcmVuY2U8T3BhcXVlPikge1xuICAgIGlmIChpdGVtICE9PSB0aGlzLm1hcFtrZXldLnZhbHVlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJ1bnN0YWJsZSByZWZlcmVuY2VcIik7XG4gICAgfVxuICB9XG5cbiAgZG9uZSgpIHt9XG5cbiAgYXBwZW5kKGtleTogc3RyaW5nLCBpdGVtOiBCYXNpY1JlZmVyZW5jZTxPcGFxdWU+LCBtZW1vOiBCYXNpY1JlZmVyZW5jZTxPcGFxdWU+KSB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLm1hcFtrZXldID0gbmV3IExpc3ROb2RlKGl0ZW0pO1xuICAgIHRoaXMubGlzdC5hcHBlbmQobm9kZSk7XG4gIH1cblxuICBpbnNlcnQoa2V5OiBzdHJpbmcsIGl0ZW06IEJhc2ljUmVmZXJlbmNlPE9wYXF1ZT4sIG1lbW86IEJhc2ljUmVmZXJlbmNlPE9wYXF1ZT4sIGJlZm9yZTogc3RyaW5nKSB7XG4gICAgbGV0IHJlZmVyZW5jZU5vZGUgPSBiZWZvcmUgPyB0aGlzLm1hcFtiZWZvcmVdIDogbnVsbDtcbiAgICBsZXQgbm9kZSA9IHRoaXMubWFwW2tleV0gPSBuZXcgTGlzdE5vZGUoaXRlbSk7XG4gICAgdGhpcy5saXN0Lmluc2VydEJlZm9yZShub2RlLCByZWZlcmVuY2VOb2RlKTtcbiAgfVxuXG4gIG1vdmUoa2V5OiBzdHJpbmcsIGl0ZW06IEJhc2ljUmVmZXJlbmNlPE9wYXF1ZT4sIG1lbW86IEJhc2ljUmVmZXJlbmNlPE9wYXF1ZT4sIGJlZm9yZTogc3RyaW5nKSB7XG4gICAgbGV0IHJlZmVyZW5jZU5vZGUgPSBiZWZvcmUgPyB0aGlzLm1hcFtiZWZvcmVdIDogbnVsbDtcbiAgICBsZXQgbm9kZSA9IHRoaXMubWFwW2tleV07XG5cbiAgICBpZiAoaXRlbSAhPT0gbm9kZS52YWx1ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwidW5zdGFibGUgcmVmZXJlbmNlXCIpO1xuICAgIH1cblxuICAgIHRoaXMubGlzdC5yZW1vdmUobm9kZSk7XG4gICAgdGhpcy5saXN0Lmluc2VydEJlZm9yZShub2RlLCByZWZlcmVuY2VOb2RlKTtcbiAgfVxuXG4gIGRlbGV0ZShrZXk6IHN0cmluZykge1xuICAgIGxldCBub2RlID0gdGhpcy5tYXBba2V5XTtcbiAgICBkZWxldGUgdGhpcy5tYXBba2V5XTtcbiAgICB0aGlzLmxpc3QucmVtb3ZlKG5vZGUpO1xuICB9XG5cbiAgdG9BcnJheSgpOiBCYXNpY1JlZmVyZW5jZTxPcGFxdWU+W10ge1xuICAgIHJldHVybiB0aGlzLmxpc3QudG9BcnJheSgpLm1hcChub2RlID0+IG5vZGUudmFsdWUpO1xuICB9XG5cbiAgdG9WYWx1ZXMoKTogT3BhcXVlW10ge1xuICAgIHJldHVybiB0aGlzLnRvQXJyYXkoKS5tYXAocmVmID0+IHJlZi52YWx1ZSgpKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgVGVzdEl0ZW0ge1xuICBrZXk6IHN0cmluZztcbiAgbmFtZTogc3RyaW5nO1xufVxuXG5jbGFzcyBUZXN0SXRlcmF0aW9uSXRlbSBpbXBsZW1lbnRzIEl0ZXJhdGlvbkl0ZW08T3BhcXVlLCBPcGFxdWU+IHtcbiAgcHVibGljIGtleTogc3RyaW5nO1xuICBwdWJsaWMgdmFsdWU6IE9wYXF1ZTtcbiAgcHVibGljIG1lbW86IE9wYXF1ZTtcblxuICBjb25zdHJ1Y3RvcihrZXk6IHN0cmluZywgdmFsdWU6IE9wYXF1ZSwgbWVtbzogT3BhcXVlKSB7XG4gICAgdGhpcy5rZXkgPSBrZXk7XG4gICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xuICAgIHRoaXMubWVtbyA9IG1lbW87XG4gIH1cbn1cblxuY2xhc3MgVGVzdEl0ZXJhdG9yIGltcGxlbWVudHMgSXRlcmF0b3I8T3BhcXVlLCBPcGFxdWU+IHtcbiAgcHJpdmF0ZSBhcnJheTogVGVzdEl0ZW1bXTtcbiAgcHJpdmF0ZSBwb3NpdGlvbiA9IDA7XG5cbiAgY29uc3RydWN0b3IoYXJyYXk6IFRlc3RJdGVtW10pIHtcbiAgICB0aGlzLmFycmF5ID0gYXJyYXk7XG4gIH1cblxuICBpc0VtcHR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmFycmF5Lmxlbmd0aCA9PT0gMDtcbiAgfVxuXG4gIG5leHQoKTogSXRlcmF0aW9uSXRlbTxPcGFxdWUsIE9wYXF1ZT4ge1xuICAgIGxldCB7IHBvc2l0aW9uLCBhcnJheSB9ID0gdGhpcztcblxuICAgIGlmIChwb3NpdGlvbiA+PSBhcnJheS5sZW5ndGgpIHJldHVybiBudWxsO1xuXG4gICAgbGV0IHZhbHVlID0gYXJyYXlbcG9zaXRpb25dO1xuXG4gICAgdGhpcy5wb3NpdGlvbisrO1xuXG4gICAgcmV0dXJuIG5ldyBUZXN0SXRlcmF0aW9uSXRlbSh2YWx1ZS5rZXksIHZhbHVlLCBwb3NpdGlvbik7XG4gIH1cbn1cblxuY2xhc3MgVGVzdEl0ZXJhYmxlIGltcGxlbWVudHMgQWJzdHJhY3RJdGVyYWJsZTxPcGFxdWUsIE9wYXF1ZSwgSXRlcmF0aW9uSXRlbTxPcGFxdWUsIE9wYXF1ZT4sIFVwZGF0YWJsZVJlZmVyZW5jZTxPcGFxdWU+LCBVcGRhdGFibGVSZWZlcmVuY2U8T3BhcXVlPj4ge1xuICBwdWJsaWMgdGFnOiBSZXZpc2lvblRhZztcbiAgcHJpdmF0ZSBhcnJheVJlZjogVXBkYXRhYmxlUmVmZXJlbmNlPFRlc3RJdGVtW10+O1xuXG4gIGNvbnN0cnVjdG9yKGFycmF5UmVmOiBVcGRhdGFibGVSZWZlcmVuY2U8VGVzdEl0ZW1bXT4pIHtcbiAgICB0aGlzLnRhZyA9IGFycmF5UmVmLnRhZztcbiAgICB0aGlzLmFycmF5UmVmID0gYXJyYXlSZWY7XG4gIH1cblxuICBpdGVyYXRlKCk6IFRlc3RJdGVyYXRvciB7XG4gICAgcmV0dXJuIG5ldyBUZXN0SXRlcmF0b3IodGhpcy5hcnJheVJlZi52YWx1ZSgpKTtcbiAgfVxuXG4gIHZhbHVlUmVmZXJlbmNlRm9yKGl0ZW06IFRlc3RJdGVyYXRpb25JdGVtKTogVXBkYXRhYmxlUmVmZXJlbmNlPE9wYXF1ZT4ge1xuICAgIHJldHVybiBuZXcgVXBkYXRhYmxlUmVmZXJlbmNlKGl0ZW0udmFsdWUpO1xuICB9XG5cbiAgdXBkYXRlVmFsdWVSZWZlcmVuY2UocmVmZXJlbmNlOiBVcGRhdGFibGVSZWZlcmVuY2U8T3BhcXVlPiwgaXRlbTogVGVzdEl0ZXJhdGlvbkl0ZW0pIHtcbiAgICByZWZlcmVuY2UudXBkYXRlKGl0ZW0udmFsdWUpO1xuICB9XG5cbiAgbWVtb1JlZmVyZW5jZUZvcihpdGVtOiBUZXN0SXRlcmF0aW9uSXRlbSk6IFVwZGF0YWJsZVJlZmVyZW5jZTxPcGFxdWU+IHtcbiAgICByZXR1cm4gbmV3IFVwZGF0YWJsZVJlZmVyZW5jZShpdGVtLm1lbW8pO1xuICB9XG5cbiAgdXBkYXRlTWVtb1JlZmVyZW5jZShyZWZlcmVuY2U6IFVwZGF0YWJsZVJlZmVyZW5jZTxPcGFxdWU+LCBpdGVtOiBUZXN0SXRlcmF0aW9uSXRlbSkge1xuICAgIHJlZmVyZW5jZS51cGRhdGUoaXRlbS5tZW1vKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpbml0aWFsaXplKGFycjogVGVzdEl0ZW1bXSk6IHsgYXJ0aWZhY3RzOiBJdGVyYXRpb25BcnRpZmFjdHMsIHRhcmdldDogVGFyZ2V0LCByZWZlcmVuY2U6IFVwZGF0YWJsZVJlZmVyZW5jZTxUZXN0SXRlbVtdPiB9IHtcbiAgbGV0IHRhcmdldCA9IG5ldyBUYXJnZXQoKTtcbiAgbGV0IHJlZmVyZW5jZSA9IG5ldyBVcGRhdGFibGVSZWZlcmVuY2UoYXJyKTtcbiAgbGV0IGl0ZXJhdG9yID0gbmV3IFJlZmVyZW5jZUl0ZXJhdG9yKG5ldyBUZXN0SXRlcmFibGUocmVmZXJlbmNlKSk7XG4gIGxldCBpdGVtOiBJdGVyYXRpb25JdGVtPFJlZmVyZW5jZTxPcGFxdWU+LCBSZWZlcmVuY2U8T3BhcXVlPj47XG5cbiAgd2hpbGUgKGl0ZW0gPSBpdGVyYXRvci5uZXh0KCkpIHtcbiAgICB0YXJnZXQuYXBwZW5kKGl0ZW0ua2V5LCBpdGVtLnZhbHVlLCBpdGVtLm1lbW8pO1xuICB9XG5cbiAgcmV0dXJuIHsgcmVmZXJlbmNlLCB0YXJnZXQsIGFydGlmYWN0czogaXRlcmF0b3IuYXJ0aWZhY3RzIH07XG59XG5cbmZ1bmN0aW9uIHN5bmModGFyZ2V0OiBUYXJnZXQsIGFydGlmYWN0czogSXRlcmF0aW9uQXJ0aWZhY3RzKSB7XG4gIGxldCBzeW5jaHJvbml6ZXIgPSBuZXcgSXRlcmF0b3JTeW5jaHJvbml6ZXIoeyB0YXJnZXQsIGFydGlmYWN0cyB9KTtcbiAgc3luY2hyb25pemVyLnN5bmMoKTtcbn1cblxuUVVuaXQudGVzdChcIlRoZXkgcHJvdmlkZSBhIHNlcXVlbmNlIG9mIHJlZmVyZW5jZXMgd2l0aCBrZXlzXCIsIGFzc2VydCA9PiB7XG4gIGxldCBhcnIgPSBbeyBrZXk6IFwiYVwiLCBuYW1lOiBcIlllaHVkYVwiIH0sIHsga2V5OiBcImJcIiwgbmFtZTogXCJHb2RmcmV5XCIgfV07XG4gIGxldCB7IHRhcmdldCB9ID0gaW5pdGlhbGl6ZShhcnIpO1xuXG4gIGFzc2VydC5kZWVwRXF1YWwodGFyZ2V0LnRvVmFsdWVzKCksIGFycik7XG59KTtcblxuUVVuaXQudGVzdChcIldoZW4gcmUtaXRlcmF0ZWQgdmlhIG11dGF0aW9uLCB0aGUgb3JpZ2luYWwgcmVmZXJlbmNlcyBhcmUgdXBkYXRlZFwiLCBhc3NlcnQgPT4ge1xuICBsZXQgYXJyID0gW3sga2V5OiBcImFcIiwgbmFtZTogXCJZZWh1ZGFcIiB9LCB7IGtleTogXCJiXCIsIG5hbWU6IFwiR29kZnJleVwiIH1dO1xuICBsZXQgeyB0YXJnZXQsIGFydGlmYWN0cyB9ID0gaW5pdGlhbGl6ZShhcnIpO1xuXG4gIGFzc2VydC5kZWVwRXF1YWwodGFyZ2V0LnRvVmFsdWVzKCksIGFycik7XG5cbiAgYXJyLnJldmVyc2UoKTtcblxuICBzeW5jKHRhcmdldCwgYXJ0aWZhY3RzKTtcblxuICBhc3NlcnQuZGVlcEVxdWFsKHRhcmdldC50b1ZhbHVlcygpLCBhcnIpO1xuXG4gIGFyci5wdXNoKHsga2V5OiBcImNcIiwgbmFtZTogXCJHb2RodWRhXCIgfSk7XG5cbiAgc3luYyh0YXJnZXQsIGFydGlmYWN0cyk7XG5cbiAgYXNzZXJ0LmRlZXBFcXVhbCh0YXJnZXQudG9WYWx1ZXMoKSwgYXJyKTtcblxuICBhcnIuc2hpZnQoKTtcblxuICBzeW5jKHRhcmdldCwgYXJ0aWZhY3RzKTtcblxuICBhc3NlcnQuZGVlcEVxdWFsKHRhcmdldC50b1ZhbHVlcygpLCBhcnIpO1xufSk7XG5cblFVbml0LnRlc3QoXCJXaGVuIHJlLWl0ZXJhdGVkIHZpYSBkZWVwIG11dGF0aW9uLCB0aGUgb3JpZ2luYWwgcmVmZXJlbmNlcyBhcmUgdXBkYXRlZFwiLCBhc3NlcnQgPT4ge1xuICBsZXQgYXJyID0gW3sga2V5OiBcImFcIiwgbmFtZTogXCJZZWh1ZGFcIiB9LCB7IGtleTogXCJiXCIsIG5hbWU6IFwiR29kZnJleVwiIH1dO1xuICBsZXQgeyB0YXJnZXQsIGFydGlmYWN0cyB9ID0gaW5pdGlhbGl6ZShhcnIpO1xuXG4gIGFzc2VydC5kZWVwRXF1YWwodGFyZ2V0LnRvVmFsdWVzKCksIGFycik7XG5cbiAgYXJyWzBdLmtleSA9IFwiYlwiO1xuICBhcnJbMF0ubmFtZSA9IFwiR29kZnJleVwiO1xuICBhcnJbMV0ua2V5ID0gXCJhXCI7XG4gIGFyclsxXS5uYW1lID0gXCJZZWh1ZGFcIjtcblxuICBzeW5jKHRhcmdldCwgYXJ0aWZhY3RzKTtcblxuICBhc3NlcnQuZGVlcEVxdWFsKHRhcmdldC50b1ZhbHVlcygpLCBhcnIpO1xuXG4gIGFyclswXS5uYW1lID0gXCJZZWh1ZGFcIjtcbiAgYXJyWzFdLm5hbWUgPSBcIkdvZGZyZXlcIjtcblxuICBzeW5jKHRhcmdldCwgYXJ0aWZhY3RzKTtcblxuICBhc3NlcnQuZGVlcEVxdWFsKHRhcmdldC50b1ZhbHVlcygpLCBhcnIpO1xuXG4gIGFyci5wdXNoKHsga2V5OiBcImNcIiwgbmFtZTogXCJHb2RodWRhXCIgfSk7XG5cbiAgc3luYyh0YXJnZXQsIGFydGlmYWN0cyk7XG5cbiAgYXNzZXJ0LmRlZXBFcXVhbCh0YXJnZXQudG9WYWx1ZXMoKSwgYXJyKTtcblxuICBhcnIuc2hpZnQoKTtcblxuICBzeW5jKHRhcmdldCwgYXJ0aWZhY3RzKTtcblxuICBhc3NlcnQuZGVlcEVxdWFsKHRhcmdldC50b1ZhbHVlcygpLCBhcnIpO1xufSk7XG5cblFVbml0LnRlc3QoXCJXaGVuIHJlLWl0ZXJhdGVkIHZpYSByZXBsYWNlbWVudCwgdGhlIG9yaWdpbmFsIHJlZmVyZW5jZXMgYXJlIHVwZGF0ZWRcIiwgYXNzZXJ0ID0+IHtcbiAgbGV0IGFyciA9IFt7IGtleTogXCJhXCIsIG5hbWU6IFwiWWVodWRhXCIgfSwgeyBrZXk6IFwiYlwiLCBuYW1lOiBcIkdvZGZyZXlcIiB9XTtcbiAgbGV0IHsgdGFyZ2V0LCByZWZlcmVuY2UsIGFydGlmYWN0cyB9ID0gaW5pdGlhbGl6ZShhcnIpO1xuXG4gIGFzc2VydC5kZWVwRXF1YWwodGFyZ2V0LnRvVmFsdWVzKCksIGFycik7XG5cbiAgYXJyID0gYXJyLnNsaWNlKCk7XG4gIGFyci5yZXZlcnNlKCk7XG4gIHJlZmVyZW5jZS51cGRhdGUoYXJyKTtcblxuICBzeW5jKHRhcmdldCwgYXJ0aWZhY3RzKTtcblxuICBhc3NlcnQuZGVlcEVxdWFsKHRhcmdldC50b1ZhbHVlcygpLCBhcnIpO1xuXG4gIHJlZmVyZW5jZS51cGRhdGUoW3sga2V5OiAnYScsIG5hbWU6IFwiVG9tXCIgfSwgeyBrZXk6IFwiYlwiLCBuYW1lOiBcIlN0ZWYgXCJ9XSk7XG5cbiAgc3luYyh0YXJnZXQsIGFydGlmYWN0cyk7XG5cbiAgYXNzZXJ0LmRlZXBFcXVhbCh0YXJnZXQudG9WYWx1ZXMoKSwgW3sga2V5OiAnYScsIG5hbWU6IFwiVG9tXCIgfSwgeyBrZXk6IFwiYlwiLCBuYW1lOiBcIlN0ZWYgXCJ9XSk7XG5cbiAgYXJyID0gYXJyLnNsaWNlKCk7XG4gIGFyci5wdXNoKHsga2V5OiBcImNcIiwgbmFtZTogXCJHb2RodWRhXCIgfSk7XG4gIHJlZmVyZW5jZS51cGRhdGUoYXJyKTtcblxuICBzeW5jKHRhcmdldCwgYXJ0aWZhY3RzKTtcblxuICBhc3NlcnQuZGVlcEVxdWFsKHRhcmdldC50b1ZhbHVlcygpLCBhcnIpO1xuXG4gIGFyciA9IGFyci5zbGljZSgpO1xuICBhcnIuc2hpZnQoKTtcbiAgcmVmZXJlbmNlLnVwZGF0ZShhcnIpO1xuXG4gIHN5bmModGFyZ2V0LCBhcnRpZmFjdHMpO1xuXG4gIGFzc2VydC5kZWVwRXF1YWwodGFyZ2V0LnRvVmFsdWVzKCksIGFycik7XG59KTtcbiJdfQ==