"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var index_1 = require("../index");
QUnit.module('[glimmer-object-model] reference');
function MakeSub() {
    var Sub = index_1.classof(index_1.default.extend({
        name: 'Dan'
    }));
    var SubSub = index_1.classof(Sub.extend({
        sal: 'Mr.'
    }));
    var obj = Sub.create();
    var root = index_1.root(obj);
    var name = root.get('name');
    return { Sub: Sub, SubSub: SubSub, root: root, obj: obj, name: name };
}
QUnit.test('getting a reference', function (assert) {
    var _a = MakeSub(), root = _a.root, obj = _a.obj, name = _a.name;
    assert.strictEqual(root.value(), obj);
    assert.strictEqual(name.value(), 'Dan');
});
QUnit.test('unchanged references are valid', function (assert) {
    var _a = MakeSub(), root = _a.root, obj = _a.obj, name = _a.name;
    var dan = name.value();
    var nameTag = name.tag;
    var initialSnapshot = nameTag.value();
    assert.strictEqual(name.value(), dan);
    assert.strictEqual(nameTag.validate(initialSnapshot), true);
});
QUnit.test('changed references are invalid', function (assert) {
    var _a = MakeSub(), root = _a.root, obj = _a.obj, name = _a.name;
    var nameTag = name.tag;
    var initialSnapshot = nameTag.value();
    index_1.set(obj, 'name', 'Daniel');
    assert.strictEqual(nameTag.validate(initialSnapshot), false);
    assert.strictEqual(name.value(), 'Daniel');
});
var Bucket = (function () {
    function Bucket(name, sal, loud) {
        this.name = name;
        this.sal = sal;
        this.loud = loud;
    }
    return Bucket;
}());
var State = (function () {
    function State(root) {
        this.references = {
            name: root.get('name'),
            sal: root.get('sal'),
            loud: root.get('loud')
        };
        this.update();
    }
    State.prototype.updateValues = function () {
        this.values = {
            name: this.references.name.value(),
            sal: this.references.sal.value(),
            loud: this.references.loud.value()
        };
    };
    State.prototype.updateTags = function () {
        this.tags = {
            name: this.references.name.tag,
            sal: this.references.sal.tag,
            loud: this.references.loud.tag
        };
    };
    State.prototype.updateSnapshot = function () {
        this.snapshot = {
            name: this.tags.name.value(),
            sal: this.tags.sal.value(),
            loud: this.tags.loud.value()
        };
    };
    State.prototype.update = function () {
        this.updateValues();
        this.updateTags();
        this.updateSnapshot();
    };
    State.prototype.validateTags = function (_a) {
        var _b = _a.name, name = _b === void 0 ? true : _b, _c = _a.sal, sal = _c === void 0 ? true : _c, _d = _a.loud, loud = _d === void 0 ? true : _d;
        QUnit.assert.strictEqual(this.tags.name.validate(this.snapshot.name), name, "valid(name) != " + name);
        QUnit.assert.strictEqual(this.tags.sal.validate(this.snapshot.sal), sal, "valid(sal) != " + sal);
        QUnit.assert.strictEqual(this.tags.loud.validate(this.snapshot.loud), loud, "valid(loud) != " + loud);
        this.updateTags();
    };
    State.prototype.validateValues = function (_a) {
        var _b = _a.name, name = _b === void 0 ? this.values.name : _b, _c = _a.sal, sal = _c === void 0 ? this.values.sal : _c, _d = _a.loud, loud = _d === void 0 ? this.values.loud : _d;
        QUnit.assert.strictEqual(this.references.name.value(), name, "name != " + name);
        QUnit.assert.strictEqual(this.references.sal.value(), sal, "sal != " + sal);
        QUnit.assert.strictEqual(this.references.loud.value(), loud, "loud != " + loud);
        this.updateValues();
    };
    return State;
}());
QUnit.test('references are granular', function (assert) {
    var SubSub = MakeSub().SubSub;
    var obj = SubSub.create({ loud: true });
    var root = index_1.root(obj);
    var state = new State(root);
    index_1.set(obj, 'name', 'Daniel');
    step('Update name');
    state.validateTags({ name: false });
    state.validateValues({ name: 'Daniel' });
    state.update();
    index_1.set(obj, 'loud', false);
    step('Update loud');
    state.validateTags({ loud: false });
    state.validateValues({ loud: false });
    state.update();
});
QUnit.test('works with ES6 subclassing', function (assert) {
    var Sub = MakeSub().Sub;
    var SubSub = (function (_super) {
        __extends(SubSub, _super);
        function SubSub() {
            return _super !== null && _super.apply(this, arguments) || this;
        }
        return SubSub;
    }(Sub));
    var obj = SubSub.create({ loud: true, sal: 'Mr.' });
    var root = index_1.root(obj);
    var state = new State(root);
    index_1.set(obj, 'name', 'Daniel');
    step('Update name');
    state.validateTags({ name: false });
    state.validateValues({ name: 'Daniel' });
    state.update();
    index_1.set(obj, 'loud', false);
    step('Update loud');
    state.validateTags({ loud: false });
    state.validateValues({ loud: false });
    state.update();
});
function step(desc) {
    QUnit.assert.ok(true, desc);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlLXRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJAZ2xpbW1lci9vYmplY3QtbW9kZWwvdGVzdHMvcmVmZXJlbmNlLXRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0NBQWdHO0FBR2hHLEtBQUssQ0FBQyxNQUFNLENBQUMsa0NBQWtDLENBQUMsQ0FBQztBQUVqRDtJQUNFLElBQUksR0FBRyxHQUFHLGVBQU8sQ0FBTSxlQUFhLENBQUMsTUFBTSxDQUFDO1FBQzFDLElBQUksRUFBRSxLQUFLO0tBQ1osQ0FBQyxDQUFDLENBQUM7SUFNSixJQUFJLE1BQU0sR0FBRyxlQUFPLENBQVMsR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUN0QyxHQUFHLEVBQUUsS0FBSztLQUNYLENBQUMsQ0FBQyxDQUFDO0lBTUosSUFBSSxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBRXZCLElBQUksSUFBSSxHQUFHLFlBQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRTVCLE1BQU0sQ0FBQyxFQUFFLEdBQUcsS0FBQSxFQUFFLE1BQU0sUUFBQSxFQUFFLElBQUksTUFBQSxFQUFFLEdBQUcsS0FBQSxFQUFFLElBQUksTUFBQSxFQUFFLENBQUM7QUFDMUMsQ0FBQztBQUVELEtBQUssQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsVUFBQSxNQUFNO0lBQ2xDLElBQUEsY0FBK0IsRUFBN0IsY0FBSSxFQUFFLFlBQUcsRUFBRSxjQUFJLENBQWU7SUFFcEMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDdEMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDMUMsQ0FBQyxDQUFDLENBQUM7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O0lBQ3BDLEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN0QyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDakIsQ0FBQyxDQUFDLENBQUM7QUFFSCxjQUFjLElBQVk7SUFDeEIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQzlCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgR2xpbW1lck9iamVjdCwgeyBWZXJzaW9uZWRSb290UmVmZXJlbmNlLCBjbGFzc29mLCByb290IGFzIHJvb3RGb3IsIHNldCB9IGZyb20gJy4uL2luZGV4JztcclxuaW1wb3J0IHsgVmVyc2lvbmVkUGF0aFJlZmVyZW5jZSwgUmV2aXNpb25UYWcgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xyXG5cclxuUVVuaXQubW9kdWxlKCdbZ2xpbW1lci1vYmplY3QtbW9kZWxdIHJlZmVyZW5jZScpO1xyXG5cclxuZnVuY3Rpb24gTWFrZVN1YigpIHtcclxuICBsZXQgU3ViID0gY2xhc3NvZjxTdWI+KEdsaW1tZXJPYmplY3QuZXh0ZW5kKHtcclxuICAgIG5hbWU6ICdEYW4nXHJcbiAgfSkpO1xyXG5cclxuICBpbnRlcmZhY2UgU3ViIHtcclxuICAgIG5hbWU6IHN0cmluZztcclxuICB9XHJcblxyXG4gIGxldCBTdWJTdWIgPSBjbGFzc29mPFN1YlN1Yj4oU3ViLmV4dGVuZCh7XHJcbiAgICBzYWw6ICdNci4nXHJcbiAgfSkpO1xyXG5cclxuICBpbnRlcmZhY2UgU3ViU3ViIGV4dGVuZHMgU3ViIHtcclxuICAgIHNhbDogc3RyaW5nO1xyXG4gIH1cclxuXHJcbiAgbGV0IG9iaiA9IFN1Yi5jcmVhdGUoKTtcclxuXHJcbiAgbGV0IHJvb3QgPSByb290Rm9yKG9iaik7XHJcbiAgbGV0IG5hbWUgPSByb290LmdldCgnbmFtZScpO1xyXG5cclxuICByZXR1cm4geyBTdWIsIFN1YlN1Yiwgcm9vdCwgb2JqLCBuYW1lIH07XHJcbn1cclxuXHJcblFVbml0LnRlc3QoJ2dldHRpbmcgYSByZWZlcmVuY2UnLCBhc3NlcnQgPT4ge1xyXG4gIGxldCB7IHJvb3QsIG9iaiwgbmFtZSB9ID0gTWFrZVN1YigpO1xyXG5cclxuICBhc3NlcnQuc3RyaWN0RXF1YWwocm9vdC52YWx1ZSgpLCBvYmopO1xyXG4gIGFzc2VydC5zdHJpY3RFcXVhbChuYW1lLnZhbHVlKCksICdEYW4nKTtcclxufSk7XHJcblxyXG5RVW5pdC50ZXN0KCd1bmNoYW5nZWQgcmVmZXJlbmNlcyBhcmUgdmFsaWQnLCBhc3NlcnQgPT4ge1xyXG4gIGxldCB7IHJvb3QsIG9iaiwgbmFtZSB9ID0gTWFrZVN1YigpO1xyXG5cclxuICBsZXQgZGFuID0gbmFtZS52YWx1ZSgpO1xyXG4gIGxldCBuYW1lVGFnID0gbmFtZS50YWc7XHJcbiAgbGV0IGluaXRpYWxTbmFwc2hvdCA9IG5hbWVUYWcudmFsdWUoKTtcclxuXHJcbiAgYXNzZXJ0LnN0cmljdEVxdWFsKG5hbWUudmFsdWUoKSwgZGFuKTtcclxuICBhc3NlcnQuc3RyaWN0RXF1YWwobmFtZVRhZy52YWxpZGF0ZShpbml0aWFsU25hcHNob3QpLCB0cnVlKTtcclxufSk7XHJcblxyXG5RVW5pdC50ZXN0KCdjaGFuZ2VkIHJlZmVyZW5jZXMgYXJlIGludmFsaWQnLCBhc3NlcnQgPT4ge1xyXG4gIGxldCB7IHJvb3QsIG9iaiwgbmFtZSB9ID0gTWFrZVN1YigpO1xyXG5cclxuICBsZXQgbmFtZVRhZyA9IG5hbWUudGFnO1xyXG4gIGxldCBpbml0aWFsU25hcHNob3QgPSBuYW1lVGFnLnZhbHVlKCk7XHJcblxyXG4gIHNldChvYmosICduYW1lJywgJ0RhbmllbCcpO1xyXG5cclxuICBhc3NlcnQuc3RyaWN0RXF1YWwobmFtZVRhZy52YWxpZGF0ZShpbml0aWFsU25hcHNob3QpLCBmYWxzZSk7XHJcbiAgYXNzZXJ0LnN0cmljdEVxdWFsKG5hbWUudmFsdWUoKSwgJ0RhbmllbCcpO1xyXG59KTtcclxuXHJcbmNsYXNzIEJ1Y2tldDxOYW1lLCBTYWwsIExvdWQ+IHtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHB1YmxpYyBuYW1lOiBOYW1lLFxyXG4gICAgcHVibGljIHNhbDogU2FsLFxyXG4gICAgcHVibGljIGxvdWQ6IExvdWRcclxuICApIHt9XHJcbn1cclxuXHJcbnR5cGUgUmVmZXJlbmNlcyA9IEJ1Y2tldDxWZXJzaW9uZWRQYXRoUmVmZXJlbmNlPHN0cmluZz4sIFZlcnNpb25lZFBhdGhSZWZlcmVuY2U8c3RyaW5nPiwgVmVyc2lvbmVkUGF0aFJlZmVyZW5jZTxib29sZWFuPj47XHJcbnR5cGUgVmFsdWVzID0gQnVja2V0PHN0cmluZywgc3RyaW5nLCBib29sZWFuPjtcclxudHlwZSBUYWdzID0gQnVja2V0PFJldmlzaW9uVGFnLCBSZXZpc2lvblRhZywgUmV2aXNpb25UYWc+O1xyXG50eXBlIFNuYXBzaG90cyA9IEJ1Y2tldDxudW1iZXIsIG51bWJlciwgbnVtYmVyPjtcclxuXHJcbmludGVyZmFjZSBUZXN0T2JqZWN0IHtcclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgc2FsOiBzdHJpbmc7XHJcbiAgbG91ZDogYm9vbGVhbjtcclxufVxyXG5cclxuY2xhc3MgU3RhdGUge1xyXG4gIHByaXZhdGUgcmVmZXJlbmNlczogUmVmZXJlbmNlcztcclxuICBwcml2YXRlIHZhbHVlczogVmFsdWVzO1xyXG4gIHByaXZhdGUgdGFnczogVGFncztcclxuICBwcml2YXRlIHNuYXBzaG90OiBTbmFwc2hvdHM7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHJvb3Q6IFZlcnNpb25lZFJvb3RSZWZlcmVuY2U8VGVzdE9iamVjdD4pIHtcclxuICAgIHRoaXMucmVmZXJlbmNlcyA9IHtcclxuICAgICAgbmFtZTogcm9vdC5nZXQ8c3RyaW5nPignbmFtZScpLFxyXG4gICAgICBzYWw6IHJvb3QuZ2V0PHN0cmluZz4oJ3NhbCcpLFxyXG4gICAgICBsb3VkOiByb290LmdldDxib29sZWFuPignbG91ZCcpXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMudXBkYXRlKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZVZhbHVlcygpIHtcclxuICAgIHRoaXMudmFsdWVzID0ge1xyXG4gICAgICBuYW1lOiB0aGlzLnJlZmVyZW5jZXMubmFtZS52YWx1ZSgpLFxyXG4gICAgICBzYWw6IHRoaXMucmVmZXJlbmNlcy5zYWwudmFsdWUoKSxcclxuICAgICAgbG91ZDogdGhpcy5yZWZlcmVuY2VzLmxvdWQudmFsdWUoKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlVGFncygpIHtcclxuICAgIHRoaXMudGFncyA9IHtcclxuICAgICAgbmFtZTogdGhpcy5yZWZlcmVuY2VzLm5hbWUudGFnLFxyXG4gICAgICBzYWw6IHRoaXMucmVmZXJlbmNlcy5zYWwudGFnLFxyXG4gICAgICBsb3VkOiB0aGlzLnJlZmVyZW5jZXMubG91ZC50YWdcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZVNuYXBzaG90KCkge1xyXG4gICAgdGhpcy5zbmFwc2hvdCA9IHtcclxuICAgICAgbmFtZTogdGhpcy50YWdzLm5hbWUudmFsdWUoKSxcclxuICAgICAgc2FsOiB0aGlzLnRhZ3Muc2FsLnZhbHVlKCksXHJcbiAgICAgIGxvdWQ6IHRoaXMudGFncy5sb3VkLnZhbHVlKClcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICB1cGRhdGUoKSB7XHJcbiAgICB0aGlzLnVwZGF0ZVZhbHVlcygpO1xyXG4gICAgdGhpcy51cGRhdGVUYWdzKCk7XHJcbiAgICB0aGlzLnVwZGF0ZVNuYXBzaG90KCk7XHJcbiAgfVxyXG5cclxuICB2YWxpZGF0ZVRhZ3MoeyBuYW1lID0gdHJ1ZSwgc2FsID0gdHJ1ZSwgbG91ZCA9IHRydWUgfSkge1xyXG4gICAgUVVuaXQuYXNzZXJ0LnN0cmljdEVxdWFsKHRoaXMudGFncy5uYW1lLnZhbGlkYXRlKHRoaXMuc25hcHNob3QubmFtZSksIG5hbWUsIGB2YWxpZChuYW1lKSAhPSAke25hbWV9YCk7XHJcbiAgICBRVW5pdC5hc3NlcnQuc3RyaWN0RXF1YWwodGhpcy50YWdzLnNhbC52YWxpZGF0ZSh0aGlzLnNuYXBzaG90LnNhbCksIHNhbCwgYHZhbGlkKHNhbCkgIT0gJHtzYWx9YCk7XHJcbiAgICBRVW5pdC5hc3NlcnQuc3RyaWN0RXF1YWwodGhpcy50YWdzLmxvdWQudmFsaWRhdGUodGhpcy5zbmFwc2hvdC5sb3VkKSwgbG91ZCwgYHZhbGlkKGxvdWQpICE9ICR7bG91ZH1gKTtcclxuICAgIHRoaXMudXBkYXRlVGFncygpO1xyXG4gIH1cclxuXHJcbiAgdmFsaWRhdGVWYWx1ZXMoeyBuYW1lID0gdGhpcy52YWx1ZXMubmFtZSwgc2FsID0gdGhpcy52YWx1ZXMuc2FsLCBsb3VkID0gdGhpcy52YWx1ZXMubG91ZCB9KSB7XHJcbiAgICBRVW5pdC5hc3NlcnQuc3RyaWN0RXF1YWwodGhpcy5yZWZlcmVuY2VzLm5hbWUudmFsdWUoKSwgbmFtZSwgYG5hbWUgIT0gJHtuYW1lfWApO1xyXG4gICAgUVVuaXQuYXNzZXJ0LnN0cmljdEVxdWFsKHRoaXMucmVmZXJlbmNlcy5zYWwudmFsdWUoKSwgc2FsLCBgc2FsICE9ICR7c2FsfWApO1xyXG4gICAgUVVuaXQuYXNzZXJ0LnN0cmljdEVxdWFsKHRoaXMucmVmZXJlbmNlcy5sb3VkLnZhbHVlKCksIGxvdWQsIGBsb3VkICE9ICR7bG91ZH1gKTtcclxuICAgIHRoaXMudXBkYXRlVmFsdWVzKCk7XHJcbiAgfVxyXG59XHJcblxyXG5RVW5pdC50ZXN0KCdyZWZlcmVuY2VzIGFyZSBncmFudWxhcicsIGFzc2VydCA9PiB7XHJcbiAgbGV0IHsgU3ViU3ViIH0gPSBNYWtlU3ViKCk7XHJcblxyXG4gIGxldCBvYmogPSBTdWJTdWIuY3JlYXRlKHsgbG91ZDogdHJ1ZSB9KTtcclxuICBsZXQgcm9vdCA9IHJvb3RGb3Iob2JqKTtcclxuXHJcbiAgbGV0IHN0YXRlID0gbmV3IFN0YXRlKHJvb3QpO1xyXG5cclxuICBzZXQob2JqLCAnbmFtZScsICdEYW5pZWwnKTtcclxuXHJcbiAgc3RlcCgnVXBkYXRlIG5hbWUnKTtcclxuXHJcbiAgc3RhdGUudmFsaWRhdGVUYWdzKHsgbmFtZTogZmFsc2UgfSk7XHJcbiAgc3RhdGUudmFsaWRhdGVWYWx1ZXMoeyBuYW1lOiAnRGFuaWVsJyB9KTtcclxuICBzdGF0ZS51cGRhdGUoKTtcclxuXHJcbiAgc2V0KG9iaiwgJ2xvdWQnLCBmYWxzZSk7XHJcblxyXG4gIHN0ZXAoJ1VwZGF0ZSBsb3VkJyk7XHJcblxyXG4gIHN0YXRlLnZhbGlkYXRlVGFncyh7IGxvdWQ6IGZhbHNlIH0pO1xyXG4gIHN0YXRlLnZhbGlkYXRlVmFsdWVzKHsgbG91ZDogZmFsc2UgfSk7XHJcbiAgc3RhdGUudXBkYXRlKCk7XHJcbn0pO1xyXG5cclxuUVVuaXQudGVzdCgnd29ya3Mgd2l0aCBFUzYgc3ViY2xhc3NpbmcnLCBhc3NlcnQgPT4ge1xyXG4gIGxldCB7IFN1YiB9ID0gTWFrZVN1YigpO1xyXG5cclxuICBjbGFzcyBTdWJTdWIgZXh0ZW5kcyBTdWIge1xyXG4gICAgc2FsOiBzdHJpbmc7XHJcbiAgICBsb3VkOiBib29sZWFuO1xyXG4gIH1cclxuXHJcbiAgbGV0IG9iaiA9IFN1YlN1Yi5jcmVhdGUoeyBsb3VkOiB0cnVlLCBzYWw6ICdNci4nIH0pO1xyXG4gIGxldCByb290ID0gcm9vdEZvcihvYmopO1xyXG5cclxuICBsZXQgc3RhdGUgPSBuZXcgU3RhdGUocm9vdCk7XHJcblxyXG4gIHNldChvYmosICduYW1lJywgJ0RhbmllbCcpO1xyXG5cclxuICBzdGVwKCdVcGRhdGUgbmFtZScpO1xyXG5cclxuICBzdGF0ZS52YWxpZGF0ZVRhZ3MoeyBuYW1lOiBmYWxzZSB9KTtcclxuICBzdGF0ZS52YWxpZGF0ZVZhbHVlcyh7IG5hbWU6ICdEYW5pZWwnIH0pO1xyXG4gIHN0YXRlLnVwZGF0ZSgpO1xyXG5cclxuICBzZXQob2JqLCAnbG91ZCcsIGZhbHNlKTtcclxuXHJcbiAgc3RlcCgnVXBkYXRlIGxvdWQnKTtcclxuXHJcbiAgc3RhdGUudmFsaWRhdGVUYWdzKHsgbG91ZDogZmFsc2UgfSk7XHJcbiAgc3RhdGUudmFsaWRhdGVWYWx1ZXMoeyBsb3VkOiBmYWxzZSB9KTtcclxuICBzdGF0ZS51cGRhdGUoKTtcclxufSk7XHJcblxyXG5mdW5jdGlvbiBzdGVwKGRlc2M6IHN0cmluZykge1xyXG4gIFFVbml0LmFzc2VydC5vayh0cnVlLCBkZXNjKTtcclxufVxyXG4iXX0=