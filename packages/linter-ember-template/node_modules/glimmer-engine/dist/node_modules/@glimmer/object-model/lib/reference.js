"use strict";
var meta_1 = require("./meta");
var reference_1 = require("@glimmer/reference");
var util_1 = require("@glimmer/util");
if (util_1.HAS_NATIVE_WEAKMAP) {
    var META_1 = new WeakMap();
    var CLASS_META_1 = new WeakMap();
    exports.classMeta = function _classMetaNative(object) {
        var m = CLASS_META_1.get(object);
        if (m === undefined) {
            m = new meta_1.ClassMeta();
            CLASS_META_1.set(object, m);
        }
        return m;
    };
    exports.meta = function _metaNative(object) {
        var m = META_1.get(object);
        if (m === undefined) {
            m = new meta_1.default();
            META_1.set(object, m);
        }
        return m;
    };
}
else {
    var GLIMMER_META_1 = 'META__glimmer__1484170086860394543206811';
    var GLIMMER_CLASS_META_1 = 'CLASS_META__glimmer__14841708559821468834708062';
    exports.classMeta = function _classMetaFaux(object) {
        var m = object[GLIMMER_CLASS_META_1];
        if (m === undefined) {
            m = new meta_1.ClassMeta();
            object[GLIMMER_CLASS_META_1] = m;
        }
        return m;
    };
    exports.meta = function _metaFaux(object) {
        var m = object[GLIMMER_META_1];
        if (m === undefined) {
            m = new meta_1.default();
            object[GLIMMER_META_1] = m;
        }
        return m;
    };
}
function set(object, key, value) {
    object[key] = value;
    exports.meta(object).dirty(key);
}
exports.set = set;
function root(object) {
    return new VersionedRootReference(object);
}
exports.root = root;
var VersionedRootReference = (function () {
    function VersionedRootReference(inner) {
        this.inner = inner;
        this.tag = reference_1.CONSTANT_TAG;
    }
    VersionedRootReference.prototype.value = function () {
        return this.inner;
    };
    VersionedRootReference.prototype.get = function (key) {
        return new VersionedObjectReference(this, key);
    };
    return VersionedRootReference;
}());
exports.VersionedRootReference = VersionedRootReference;
var VersionedObjectReference = (function () {
    function VersionedObjectReference(parent, key) {
        this.parent = parent;
        this.key = key;
        this.tag = reference_1.CURRENT_TAG;
    }
    VersionedObjectReference.prototype.value = function () {
        var _this = this;
        var _a = this, parent = _a.parent, key = _a.key;
        var parentObject = this.parent.value();
        var computed = exports.classMeta(Object.getPrototypeOf(parentObject)).getComputed(key);
        var tags = [exports.meta(parentObject).tag(key)];
        if (computed) {
            tags.push.apply(tags, computed.dependentKeys.map(function (key) { return path(_this, key).tag; }));
        }
        this.tag = reference_1.combine(tags);
        return parentObject[key];
    };
    VersionedObjectReference.prototype.get = function (key) {
        return new VersionedObjectReference(this, key);
    };
    return VersionedObjectReference;
}());
exports.VersionedObjectReference = VersionedObjectReference;
function path(parent, key) {
    return key.split('.').reduce(function (ref, part) { return ref.get(part); }, parent);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQGdsaW1tZXIvb2JqZWN0LW1vZGVsL2xpYi9yZWZlcmVuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLCtCQUF5QztBQUd6QyxnREFNNEI7QUFFNUIsc0NBQW1FO0FBS25FLEVBQUUsQ0FBQyxDQUFDLHlCQUFrQixDQUFDLENBQUMsQ0FBQztJQUN2QixJQUFNLE1BQUksR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBQzNCLElBQU0sWUFBVSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFDakMsaUJBQVMsR0FBRywwQkFBMEIsTUFBdUI7UUFDM0QsSUFBSSxDQUFDLEdBQUcsWUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUvQixFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNwQixDQUFDLEdBQUcsSUFBSSxnQkFBUyxFQUFFLENBQUM7WUFDcEIsWUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDNUIsQ0FBQztRQUVELE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDLENBQUM7SUFFRixZQUFJLEdBQUcscUJBQXFCLE1BQXVCO1FBQ2pELElBQUksQ0FBQyxHQUFHLE1BQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFekIsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsQ0FBQyxHQUFHLElBQUksY0FBSSxFQUFFLENBQUM7WUFDZixNQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN0QixDQUFDO1FBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNYLENBQUMsQ0FBQztBQUVKLENBQUM7QUFBQyxJQUFJLENBQUMsQ0FBQztJQUNOLElBQU0sY0FBWSxHQUFHLDBDQUEwQyxDQUFDO0lBQ2hFLElBQU0sb0JBQWtCLEdBQUcsaURBQWlELENBQUM7SUFDN0UsaUJBQVMsR0FBRyx3QkFBd0IsTUFBdUI7UUFDekQsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLG9CQUFrQixDQUFDLENBQUM7UUFFbkMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsQ0FBQyxHQUFHLElBQUksZ0JBQVMsRUFBRSxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxvQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQyxDQUFDO1FBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNYLENBQUMsQ0FBQztJQUVGLFlBQUksR0FBRyxtQkFBbUIsTUFBdUI7UUFDL0MsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLGNBQVksQ0FBQyxDQUFDO1FBRTdCLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsR0FBRyxJQUFJLGNBQUksRUFBRSxDQUFDO1lBQ2YsTUFBTSxDQUFDLGNBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzQixDQUFDO1FBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNYLENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxhQUF1QixNQUF1QixFQUFFLEdBQWdCLEVBQUUsS0FBUTtJQUN4RSxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ3BCLFlBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDMUIsQ0FBQztBQUhELGtCQUdDO0FBRUQsY0FBZ0QsTUFBUztJQUN2RCxNQUFNLENBQUMsSUFBSSxzQkFBc0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM1QyxDQUFDO0FBRkQsb0JBRUM7QUFFRDtJQUdFLGdDQUFvQixLQUFRO1FBQVIsVUFBSyxHQUFMLEtBQUssQ0FBRztRQUMxQixJQUFJLENBQUMsR0FBRyxHQUFHLHdCQUFZLENBQUM7SUFDMUIsQ0FBQztJQUVELHNDQUFLLEdBQUw7UUFDRSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsb0NBQUcsR0FBSCxVQUFzQixHQUFnQjtRQUNwQyxNQUFNLENBQUMsSUFBSSx3QkFBd0IsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUNILDZCQUFDO0FBQUQsQ0FBQyxBQWRELElBY0M7QUFkWSx3REFBc0I7QUFnQm5DO0lBR0Usa0NBQW9CLE1BQXNDLEVBQVUsR0FBZ0I7UUFBaEUsV0FBTSxHQUFOLE1BQU0sQ0FBZ0M7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFhO1FBRjdFLFFBQUcsR0FBZ0IsdUJBQVcsQ0FBQztJQUVpRCxDQUFDO0lBRXhGLHdDQUFLLEdBQUw7UUFBQSxpQkFhQztRQVpLLElBQUEsU0FBc0IsRUFBcEIsa0JBQU0sRUFBRSxZQUFHLENBQVU7UUFDM0IsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQXFCLENBQUM7UUFFMUQsSUFBSSxRQUFRLEdBQUcsaUJBQVMsQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9FLElBQUksSUFBSSxHQUFrQixDQUFDLFlBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUV4RCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2IsSUFBSSxDQUFDLElBQUksT0FBVCxJQUFJLEVBQVMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxJQUFJLENBQUMsS0FBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBbkIsQ0FBbUIsQ0FBQyxFQUFFO1FBQ3ZFLENBQUM7UUFFRCxJQUFJLENBQUMsR0FBRyxHQUFHLG1CQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekIsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRUQsc0NBQUcsR0FBSCxVQUFJLEdBQWdCO1FBQ2xCLE1BQU0sQ0FBQyxJQUFJLHdCQUF3QixDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBQ0gsK0JBQUM7QUFBRCxDQUFDLEFBdkJELElBdUJDO0FBdkJZLDREQUF3QjtBQXlCckMsY0FBYyxNQUFzQyxFQUFFLEdBQVc7SUFDL0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUMsR0FBRyxFQUFFLElBQUksSUFBSyxPQUFBLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQWIsQ0FBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ3JFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgR2xpbW1lckluc3RhbmNlIGZyb20gJy4vb2JqZWN0JztcbmltcG9ydCBNZXRhLCB7IENsYXNzTWV0YSB9IGZyb20gJy4vbWV0YSc7XG5pbXBvcnQgeyBDb21wdXRlZCB9IGZyb20gJy4vYmx1ZXByaW50JztcblxuaW1wb3J0IHtcbiAgQ1VSUkVOVF9UQUcsXG4gIENPTlNUQU5UX1RBRyxcbiAgVmVyc2lvbmVkUGF0aFJlZmVyZW5jZSxcbiAgUmV2aXNpb25UYWcsXG4gIGNvbWJpbmVcbn0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcblxuaW1wb3J0IHsgT3BhcXVlLCBPcHRpb24sIEhBU19OQVRJVkVfV0VBS01BUCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5leHBvcnQgbGV0IGNsYXNzTWV0YTtcbmV4cG9ydCBsZXQgbWV0YTtcblxuaWYgKEhBU19OQVRJVkVfV0VBS01BUCkge1xuICBjb25zdCBNRVRBID0gbmV3IFdlYWtNYXAoKTtcbiAgY29uc3QgQ0xBU1NfTUVUQSA9IG5ldyBXZWFrTWFwKCk7XG4gIGNsYXNzTWV0YSA9IGZ1bmN0aW9uIF9jbGFzc01ldGFOYXRpdmUob2JqZWN0OiBHbGltbWVySW5zdGFuY2UpOiBDbGFzc01ldGEge1xuICAgIGxldCBtID0gQ0xBU1NfTUVUQS5nZXQob2JqZWN0KTtcblxuICAgIGlmIChtID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG0gPSBuZXcgQ2xhc3NNZXRhKCk7XG4gICAgICBDTEFTU19NRVRBLnNldChvYmplY3QsIG0pO1xuICAgIH1cblxuICAgIHJldHVybiBtO1xuICB9O1xuXG4gIG1ldGEgPSBmdW5jdGlvbiBfbWV0YU5hdGl2ZShvYmplY3Q6IEdsaW1tZXJJbnN0YW5jZSk6IE1ldGEge1xuICAgIGxldCBtID0gTUVUQS5nZXQob2JqZWN0KTtcblxuICAgIGlmIChtID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG0gPSBuZXcgTWV0YSgpO1xuICAgICAgTUVUQS5zZXQob2JqZWN0LCBtKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbTtcbiAgfTtcblxufSBlbHNlIHtcbiAgY29uc3QgR0xJTU1FUl9NRVRBID0gJ01FVEFfX2dsaW1tZXJfXzE0ODQxNzAwODY4NjAzOTQ1NDMyMDY4MTEnO1xuICBjb25zdCBHTElNTUVSX0NMQVNTX01FVEEgPSAnQ0xBU1NfTUVUQV9fZ2xpbW1lcl9fMTQ4NDE3MDg1NTk4MjE0Njg4MzQ3MDgwNjInO1xuICBjbGFzc01ldGEgPSBmdW5jdGlvbiBfY2xhc3NNZXRhRmF1eChvYmplY3Q6IEdsaW1tZXJJbnN0YW5jZSk6IENsYXNzTWV0YSB7XG4gICAgbGV0IG0gPSBvYmplY3RbR0xJTU1FUl9DTEFTU19NRVRBXTtcblxuICAgIGlmIChtID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG0gPSBuZXcgQ2xhc3NNZXRhKCk7XG4gICAgICBvYmplY3RbR0xJTU1FUl9DTEFTU19NRVRBXSA9IG07XG4gICAgfVxuXG4gICAgcmV0dXJuIG07XG4gIH07XG5cbiAgbWV0YSA9IGZ1bmN0aW9uIF9tZXRhRmF1eChvYmplY3Q6IEdsaW1tZXJJbnN0YW5jZSk6IE1ldGEge1xuICAgIGxldCBtID0gb2JqZWN0W0dMSU1NRVJfTUVUQV07XG5cbiAgICBpZiAobSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBtID0gbmV3IE1ldGEoKTtcbiAgICAgIG9iamVjdFtHTElNTUVSX01FVEFdID0gbTtcbiAgICB9XG5cbiAgICByZXR1cm4gbTtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldDxUPihvYmplY3Q6IEdsaW1tZXJJbnN0YW5jZSwga2V5OiBQcm9wZXJ0eUtleSwgdmFsdWU6IFQpIHtcbiAgb2JqZWN0W2tleV0gPSB2YWx1ZTtcbiAgbWV0YShvYmplY3QpLmRpcnR5KGtleSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByb290PFQgZXh0ZW5kcyBHbGltbWVySW5zdGFuY2U+KG9iamVjdDogVCk6IFZlcnNpb25lZFJvb3RSZWZlcmVuY2U8VD4ge1xuICByZXR1cm4gbmV3IFZlcnNpb25lZFJvb3RSZWZlcmVuY2Uob2JqZWN0KTtcbn1cblxuZXhwb3J0IGNsYXNzIFZlcnNpb25lZFJvb3RSZWZlcmVuY2U8VD4gaW1wbGVtZW50cyBWZXJzaW9uZWRQYXRoUmVmZXJlbmNlPE9wYXF1ZT4ge1xuICBwdWJsaWMgdGFnOiBSZXZpc2lvblRhZztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBUKSB7XG4gICAgdGhpcy50YWcgPSBDT05TVEFOVF9UQUc7XG4gIH1cblxuICB2YWx1ZSgpOiBUIHtcbiAgICByZXR1cm4gdGhpcy5pbm5lcjtcbiAgfVxuXG4gIGdldDxUIGV4dGVuZHMgT3BhcXVlPihrZXk6IFByb3BlcnR5S2V5KTogVmVyc2lvbmVkUGF0aFJlZmVyZW5jZTxUPiB7XG4gICAgcmV0dXJuIG5ldyBWZXJzaW9uZWRPYmplY3RSZWZlcmVuY2UodGhpcywga2V5KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVmVyc2lvbmVkT2JqZWN0UmVmZXJlbmNlIGltcGxlbWVudHMgVmVyc2lvbmVkUGF0aFJlZmVyZW5jZTxPcGFxdWU+IHtcbiAgcHVibGljIHRhZzogUmV2aXNpb25UYWcgPSBDVVJSRU5UX1RBRztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBhcmVudDogVmVyc2lvbmVkUGF0aFJlZmVyZW5jZTxPcGFxdWU+LCBwcml2YXRlIGtleTogUHJvcGVydHlLZXkpIHt9XG5cbiAgdmFsdWUoKSB7XG4gICAgbGV0IHsgcGFyZW50LCBrZXkgfSA9IHRoaXM7XG4gICAgbGV0IHBhcmVudE9iamVjdCA9IHRoaXMucGFyZW50LnZhbHVlKCkgYXMgR2xpbW1lckluc3RhbmNlO1xuXG4gICAgbGV0IGNvbXB1dGVkID0gY2xhc3NNZXRhKE9iamVjdC5nZXRQcm90b3R5cGVPZihwYXJlbnRPYmplY3QpKS5nZXRDb21wdXRlZChrZXkpO1xuICAgIGxldCB0YWdzOiBSZXZpc2lvblRhZ1tdID0gW21ldGEocGFyZW50T2JqZWN0KS50YWcoa2V5KV07XG5cbiAgICBpZiAoY29tcHV0ZWQpIHtcbiAgICAgIHRhZ3MucHVzaCguLi5jb21wdXRlZC5kZXBlbmRlbnRLZXlzLm1hcChrZXkgPT4gcGF0aCh0aGlzLCBrZXkpLnRhZykpO1xuICAgIH1cblxuICAgIHRoaXMudGFnID0gY29tYmluZSh0YWdzKTtcbiAgICByZXR1cm4gcGFyZW50T2JqZWN0W2tleV07XG4gIH1cblxuICBnZXQoa2V5OiBQcm9wZXJ0eUtleSk6IFZlcnNpb25lZFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gICAgcmV0dXJuIG5ldyBWZXJzaW9uZWRPYmplY3RSZWZlcmVuY2UodGhpcywga2V5KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXRoKHBhcmVudDogVmVyc2lvbmVkUGF0aFJlZmVyZW5jZTxPcGFxdWU+LCBrZXk6IHN0cmluZyk6IFZlcnNpb25lZFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gIHJldHVybiBrZXkuc3BsaXQoJy4nKS5yZWR1Y2UoKHJlZiwgcGFydCkgPT4gcmVmLmdldChwYXJ0KSwgcGFyZW50KTtcbn1cbiJdfQ==