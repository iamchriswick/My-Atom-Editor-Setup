"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var bench_1 = require("./bench");
var stats_1 = require("./stats");
var TestReporter = (function (_super) {
    __extends(TestReporter, _super);
    function TestReporter() {
        var _this = _super.call(this) || this;
        _this.pre = document.createElement('pre');
        _this.cycle = document.createElement('pre');
        _this.cycle.id = "cycle";
        _this.pre.id = "benchmark-log";
        document.body.appendChild(_this.cycle);
        document.body.appendChild(_this.pre);
        return _this;
    }
    TestReporter.prototype.progress = function (count, elapsed, stats) {
        var error = stats.rme.toFixed(2);
        this.cycle.innerHTML = count + " samples in " + toHumanTime(elapsed) + " (" + toHumanTime(stats.mean) + " \u00B1 " + error + "%)";
    };
    TestReporter.prototype.error = function (error) {
        this.logln(error['stack']);
        this.cycle.innerHTML = "Errored";
    };
    TestReporter.prototype.complete = function (benchmark, event) {
        var rawStats = benchmark.stats;
        if (rawStats.sample.length === 0)
            return;
        var stats = new stats_1.default({ bucket_precision: rawStats.moe });
        stats.push(rawStats.sample);
        this.cycle.innerHTML = "Idle";
        var unit = humanUnitFor(stats.median(), stats.percentile(95), stats.percentile(99), stats.moe());
        this.logln('Samples:    ' + rawStats.sample.length);
        this.logln('Median:     ' + toHumanTime(stats.median(), unit, 4));
        this.logln('95%:        ' + toHumanTime(stats.percentile(95), unit, 4));
        this.logln('99%:        ' + toHumanTime(stats.percentile(99), unit, 4));
        this.logln('Confidence: ±' + toHumanTime(stats.moe(), unit, 4));
        this.logln('\n');
        this.logln('Distribution:');
        var div = document.createElement('div');
        div.className = 'histogram';
        var distribution = stats.iqr().distribution();
        var maxHeight = Math.max.apply(Math, distribution.filter(function (d) { return d; }).map(function (d) { return d.count; }));
        var widthPercentage = 100 / distribution.length;
        distribution.forEach(function (d, i) {
            var bar = document.createElement('div');
            bar.style.width = widthPercentage + "%";
            bar.style.height = 95 * d.count / maxHeight + "%";
            bar.style.bottom = '0px';
            bar.style.left = i * widthPercentage + "%";
            bar.className = 'bar';
            bar.title = d.count;
            div.appendChild(bar);
            var label = document.createElement('span');
            label.style.width = '100px';
            label.style.height = '20px';
            label.style.bottom = '-20px';
            label.style.left = i * widthPercentage + "%";
            label.style.transform = 'translateX(-50px)';
            label.style.textAlign = 'center';
            label.style.lineHeight = '20px';
            label.style.fontSize = '10px';
            label.className = 'label';
            label.innerText = toHumanTime(d.range[0], unit, 2, false);
            div.appendChild(label);
            var label2 = label.cloneNode(false);
            label2.style.left = (i + 1) * widthPercentage + "%";
            label2.innerText = toHumanTime(d.range[1], unit, 2, false);
            div.appendChild(label2);
        });
        document.body.appendChild(div);
        this.logln('\n');
    };
    TestReporter.prototype.logln = function (message) {
        var child = document.createElement('pre');
        child.innerText = message;
        this.pre.appendChild(child);
    };
    return TestReporter;
}(bench_1.BenchmarkReporter));
exports.TestReporter = TestReporter;
var TimeUnit;
(function (TimeUnit) {
    TimeUnit[TimeUnit["ns"] = 1000000000] = "ns";
    TimeUnit[TimeUnit["\u00B5s"] = 1000000] = "\u00B5s";
    TimeUnit[TimeUnit["ms"] = 1000] = "ms";
    TimeUnit[TimeUnit["s"] = 1] = "s";
})(TimeUnit || (TimeUnit = {}));
;
function humanUnitFor() {
    var seconds = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        seconds[_i] = arguments[_i];
    }
    var units = seconds.map(function (time) {
        if (time < (1 / 10000000)) {
            return TimeUnit.ns;
        }
        else if (time < (1 / 10000)) {
            return TimeUnit.µs;
        }
        else if (time < 1 / 10) {
            return TimeUnit.ms;
        }
        else {
            return TimeUnit.s;
        }
    });
    return Math.min.apply(Math, units);
}
function toHumanTime(seconds, base, precision, displayUnit) {
    if (base === void 0) { base = humanUnitFor(seconds); }
    if (precision === void 0) { precision = 2; }
    if (displayUnit === void 0) { displayUnit = true; }
    var number = (seconds * base).toFixed(precision);
    var unit = displayUnit ? TimeUnit[base] : '';
    return "" + number + unit;
}
var TestBenchmarkEnvironment = (function (_super) {
    __extends(TestBenchmarkEnvironment, _super);
    function TestBenchmarkEnvironment() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    TestBenchmarkEnvironment.prototype.elapsed = function (timestamp) {
        return Date.now() - timestamp;
    };
    return TestBenchmarkEnvironment;
}(bench_1.BenchmarkEnvironment));
exports.TestBenchmarkEnvironment = TestBenchmarkEnvironment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVuY2gtaW5mcmEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnbGltbWVyLWJlbmNobWFya3MvbGliL2JlbmNoLWluZnJhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGlDQUFrRTtBQUNsRSxpQ0FBNEI7QUFFNUI7SUFBa0MsZ0NBQWlCO0lBSWpEO1FBQUEsWUFDRSxpQkFBTyxTQUtSO1FBVE8sU0FBRyxHQUFtQixRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BELFdBQUssR0FBbUIsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUk1RCxLQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFDeEIsS0FBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsZUFBZSxDQUFDO1FBQzlCLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0QyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7O0lBQ3RDLENBQUM7SUFFRCwrQkFBUSxHQUFSLFVBQVMsS0FBYSxFQUFFLE9BQWUsRUFBRSxLQUFzQjtRQUM3RCxJQUFJLEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBTSxLQUFLLG9CQUFlLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBSyxXQUFXLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBTSxLQUFLLE9BQUksQ0FBQztJQUNoSCxDQUFDO0lBRUQsNEJBQUssR0FBTCxVQUFNLEtBQVk7UUFDaEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxT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InNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlbmNobWFya1JlcG9ydGVyLCBCZW5jaG1hcmtFbnZpcm9ubWVudCB9IGZyb20gJy4vYmVuY2gnO1xuaW1wb3J0IFN0YXRzIGZyb20gJy4vc3RhdHMnO1xuXG5leHBvcnQgY2xhc3MgVGVzdFJlcG9ydGVyIGV4dGVuZHMgQmVuY2htYXJrUmVwb3J0ZXIge1xuICBwcml2YXRlIHByZTogSFRNTFByZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwcmUnKTtcbiAgcHJpdmF0ZSBjeWNsZTogSFRNTFByZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwcmUnKTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuY3ljbGUuaWQgPSBcImN5Y2xlXCI7XG4gICAgdGhpcy5wcmUuaWQgPSBcImJlbmNobWFyay1sb2dcIjtcbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuY3ljbGUpO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wcmUpO1xuICB9XG5cbiAgcHJvZ3Jlc3MoY291bnQ6IG51bWJlciwgZWxhcHNlZDogbnVtYmVyLCBzdGF0czogQmVuY2htYXJrLlN0YXRzKSB7XG4gICAgbGV0IGVycm9yID0gc3RhdHMucm1lLnRvRml4ZWQoMik7XG4gICAgdGhpcy5jeWNsZS5pbm5lckhUTUwgPSBgJHtjb3VudH0gc2FtcGxlcyBpbiAke3RvSHVtYW5UaW1lKGVsYXBzZWQpfSAoJHt0b0h1bWFuVGltZShzdGF0cy5tZWFuKX0gwrEgJHtlcnJvcn0lKWA7XG4gIH1cblxuICBlcnJvcihlcnJvcjogRXJyb3IpIHtcbiAgICB0aGlzLmxvZ2xuKGVycm9yWydzdGFjayddKTtcbiAgICB0aGlzLmN5Y2xlLmlubmVySFRNTCA9IFwiRXJyb3JlZFwiO1xuICB9XG5cbiAgY29tcGxldGUoYmVuY2htYXJrOiBCZW5jaG1hcmssIGV2ZW50OiBCZW5jaG1hcmsuRXZlbnQpIHtcbiAgICBsZXQgcmF3U3RhdHMgPSBiZW5jaG1hcmsuc3RhdHM7XG4gICAgaWYgKHJhd1N0YXRzLnNhbXBsZS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICBsZXQgc3RhdHMgPSBuZXcgU3RhdHMoeyBidWNrZXRfcHJlY2lzaW9uOiByYXdTdGF0cy5tb2UgfSk7XG4gICAgc3RhdHMucHVzaChyYXdTdGF0cy5zYW1wbGUpO1xuXG4gICAgdGhpcy5jeWNsZS5pbm5lckhUTUwgPSBcIklkbGVcIjtcblxuICAgIGxldCB1bml0ID0gaHVtYW5Vbml0Rm9yKHN0YXRzLm1lZGlhbigpLCBzdGF0cy5wZXJjZW50aWxlKDk1KSwgc3RhdHMucGVyY2VudGlsZSg5OSksIHN0YXRzLm1vZSgpKTtcblxuICAgIHRoaXMubG9nbG4oJ1NhbXBsZXM6ICAgICcgICsgcmF3U3RhdHMuc2FtcGxlLmxlbmd0aCk7XG4gICAgdGhpcy5sb2dsbignTWVkaWFuOiAgICAgJyAgKyB0b0h1bWFuVGltZShzdGF0cy5tZWRpYW4oKSwgdW5pdCwgNCkpO1xuICAgIHRoaXMubG9nbG4oJzk1JTogICAgICAgICcgICsgdG9IdW1hblRpbWUoc3RhdHMucGVyY2VudGlsZSg5NSksIHVuaXQsIDQpKTtcbiAgICB0aGlzLmxvZ2xuKCc5OSU6ICAgICAgICAnICArIHRvSHVtYW5UaW1lKHN0YXRzLnBlcmNlbnRpbGUoOTkpLCB1bml0LCA0KSk7XG4gICAgdGhpcy5sb2dsbignQ29uZmlkZW5jZTogwrEnICsgdG9IdW1hblRpbWUoc3RhdHMubW9lKCksIHVuaXQsIDQpKTtcbiAgICB0aGlzLmxvZ2xuKCdcXG4nKTtcbiAgICB0aGlzLmxvZ2xuKCdEaXN0cmlidXRpb246Jyk7XG5cbiAgICBsZXQgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgZGl2LmNsYXNzTmFtZSA9ICdoaXN0b2dyYW0nO1xuXG4gICAgbGV0IGRpc3RyaWJ1dGlvbiA9IHN0YXRzLmlxcigpLmRpc3RyaWJ1dGlvbigpO1xuXG4gICAgbGV0IG1heEhlaWdodCA9IE1hdGgubWF4KC4uLmRpc3RyaWJ1dGlvbi5maWx0ZXIoZCA9PiBkKS5tYXAoZCA9PiBkLmNvdW50KSk7XG4gICAgbGV0IHdpZHRoUGVyY2VudGFnZSA9IDEwMCAvIGRpc3RyaWJ1dGlvbi5sZW5ndGg7XG5cbiAgICBkaXN0cmlidXRpb24uZm9yRWFjaCgoZCwgaSkgPT4ge1xuICAgICAgbGV0IGJhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgYmFyLnN0eWxlLndpZHRoID0gYCR7d2lkdGhQZXJjZW50YWdlfSVgO1xuICAgICAgYmFyLnN0eWxlLmhlaWdodCA9IGAkezk1ICogZC5jb3VudCAvIG1heEhlaWdodH0lYDtcbiAgICAgIGJhci5zdHlsZS5ib3R0b20gPSAnMHB4JztcbiAgICAgIGJhci5zdHlsZS5sZWZ0ID0gYCR7aSAqIHdpZHRoUGVyY2VudGFnZX0lYDtcbiAgICAgIGJhci5jbGFzc05hbWUgPSAnYmFyJztcbiAgICAgIGJhci50aXRsZSA9IGQuY291bnQ7XG4gICAgICBkaXYuYXBwZW5kQ2hpbGQoYmFyKTtcblxuICAgICAgbGV0IGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgICAgbGFiZWwuc3R5bGUud2lkdGggPSAnMTAwcHgnO1xuICAgICAgbGFiZWwuc3R5bGUuaGVpZ2h0ID0gJzIwcHgnO1xuICAgICAgbGFiZWwuc3R5bGUuYm90dG9tID0gJy0yMHB4JztcbiAgICAgIGxhYmVsLnN0eWxlLmxlZnQgPSBgJHtpICogd2lkdGhQZXJjZW50YWdlfSVgO1xuICAgICAgbGFiZWwuc3R5bGUudHJhbnNmb3JtID0gJ3RyYW5zbGF0ZVgoLTUwcHgpJztcbiAgICAgIGxhYmVsLnN0eWxlLnRleHRBbGlnbiA9ICdjZW50ZXInO1xuICAgICAgbGFiZWwuc3R5bGUubGluZUhlaWdodCA9ICcyMHB4JztcbiAgICAgIGxhYmVsLnN0eWxlLmZvbnRTaXplID0gJzEwcHgnO1xuICAgICAgbGFiZWwuY2xhc3NOYW1lID0gJ2xhYmVsJztcbiAgICAgIGxhYmVsLmlubmVyVGV4dCA9IHRvSHVtYW5UaW1lKGQucmFuZ2VbMF0sIHVuaXQsIDIsIGZhbHNlKTtcbiAgICAgIGRpdi5hcHBlbmRDaGlsZChsYWJlbCk7XG5cbiAgICAgIGxldCBsYWJlbDIgPSBsYWJlbC5jbG9uZU5vZGUoZmFsc2UpIGFzIEhUTUxTcGFuRWxlbWVudDtcbiAgICAgIGxhYmVsMi5zdHlsZS5sZWZ0ID0gYCR7KGkrMSkgKiB3aWR0aFBlcmNlbnRhZ2V9JWA7XG4gICAgICBsYWJlbDIuaW5uZXJUZXh0ID0gdG9IdW1hblRpbWUoZC5yYW5nZVsxXSwgdW5pdCwgMiwgZmFsc2UpO1xuICAgICAgZGl2LmFwcGVuZENoaWxkKGxhYmVsMik7XG4gICAgfSk7XG5cbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRpdik7XG5cbiAgICB0aGlzLmxvZ2xuKCdcXG4nKTtcbiAgfVxuXG4gIHByaXZhdGUgbG9nbG4obWVzc2FnZSkge1xuICAgIGxldCBjaGlsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3ByZScpO1xuICAgIGNoaWxkLmlubmVyVGV4dCA9IG1lc3NhZ2U7XG4gICAgdGhpcy5wcmUuYXBwZW5kQ2hpbGQoY2hpbGQpO1xuICB9XG59XG5cbmVudW0gVGltZVVuaXQge1xuICBucyA9IDEwMDAwMDAwMDAsXG4gIMK1cyA9IDEwMDAwMDAsXG4gIG1zID0gMTAwMCxcbiAgcyAgPSAxXG59O1xuXG5mdW5jdGlvbiBodW1hblVuaXRGb3IoLi4uc2Vjb25kczogbnVtYmVyW10pOiBUaW1lVW5pdCB7XG4gIGxldCB1bml0cyA9IHNlY29uZHMubWFwKHRpbWUgPT4ge1xuICAgIGlmICh0aW1lIDwgKDEgLyAxMDAwMDAwMCkpIHtcbiAgICAgIHJldHVybiBUaW1lVW5pdC5ucztcbiAgICB9IGVsc2UgaWYgKHRpbWUgPCAoMSAvIDEwMDAwKSkge1xuICAgICAgcmV0dXJuIFRpbWVVbml0LsK1cztcbiAgICB9IGVsc2UgaWYgKHRpbWUgPCAxIC8gMTApIHtcbiAgICAgIHJldHVybiBUaW1lVW5pdC5tcztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFRpbWVVbml0LnM7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gTWF0aC5taW4oLi4udW5pdHMpO1xufVxuXG5mdW5jdGlvbiB0b0h1bWFuVGltZShzZWNvbmRzOiBudW1iZXIsIGJhc2U6IFRpbWVVbml0ID0gaHVtYW5Vbml0Rm9yKHNlY29uZHMpLCBwcmVjaXNpb24gPSAyLCBkaXNwbGF5VW5pdCA9IHRydWUpIHtcbiAgbGV0IG51bWJlciA9IChzZWNvbmRzICogYmFzZSkudG9GaXhlZChwcmVjaXNpb24pO1xuICBsZXQgdW5pdCA9IGRpc3BsYXlVbml0ID8gVGltZVVuaXRbYmFzZV0gOiAnJztcbiAgcmV0dXJuIGAke251bWJlcn0ke3VuaXR9YDtcbn1cblxuZXhwb3J0IGNsYXNzIFRlc3RCZW5jaG1hcmtFbnZpcm9ubWVudCBleHRlbmRzIEJlbmNobWFya0Vudmlyb25tZW50IHtcbiAgZWxhcHNlZCh0aW1lc3RhbXA6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIERhdGUubm93KCkgLSB0aW1lc3RhbXA7XG4gIH1cbn1cbiJdfQ==