import { DirtyableTag } from '@glimmer/reference';
import { TestEnvironment, TestDynamicScope } from './environment';
import { assign } from './helpers';
export function skip(target, name, descriptor) {
    descriptor.value['skip'] = true;
}
export class VersionedObject {
    constructor(value) {
        this.tag = new DirtyableTag();
        assign(this, value);
    }
    update(value) {
        assign(this, value);
        this.dirty();
    }
    set(key, value) {
        this[key] = value;
        this.dirty();
    }
    dirty() {
        this.tag.dirty();
    }
}
export class SimpleRootReference {
    constructor(object) {
        this.object = object;
        this.tag = object.tag;
    }
    get(key) {
        return new SimplePathReference(this, key);
    }
    value() {
        return this.object;
    }
}
class SimplePathReference {
    constructor(parent, key) {
        this.parent = parent;
        this.key = key;
        this.tag = parent.tag;
    }
    get(key) {
        return new SimplePathReference(this, key);
    }
    value() {
        return this.parent.value()[this.key];
    }
}
function isMarker(node) {
    if (node instanceof Comment && node.textContent === '') {
        return true;
    }
    if (node instanceof Text && node.textContent === '') {
        return true;
    }
    return false;
}
export class RenderingTest {
    constructor(env = new TestEnvironment(), template, appendTo) {
        this.env = env;
        this.appendTo = appendTo;
        this.context = null;
        this.result = null;
        this.template = this.env.compile(template);
        this.assert = QUnit.config.current.assert;
    }
    teardown() { }
    render(context) {
        this.env.begin();
        let dynamicScope = new TestDynamicScope();
        let appendTo = this.appendTo;
        let rootObject = new VersionedObject(context);
        let root = new SimpleRootReference(rootObject);
        this.context = rootObject;
        this.result = this.template.render(root, appendTo, dynamicScope);
        this.env.commit();
        this.element = document.getElementById('qunit-fixture').firstChild;
    }
    assertContent(expected, message) {
        let actual = document.getElementById('qunit-fixture').innerHTML;
        QUnit.equal(actual, expected);
    }
    takeSnapshot() {
        let snapshot = this.snapshot = [];
        let node = this.element.firstChild;
        while (node) {
            if (!isMarker(node)) {
                snapshot.push(node);
            }
            node = node.nextSibling;
        }
        return snapshot;
    }
    assertStableRerender() {
        this.takeSnapshot();
        this.rerender();
        this.assertInvariants();
    }
    rerender() {
        this.result.rerender();
    }
    assertInvariants(oldSnapshot, newSnapshot) {
        oldSnapshot = oldSnapshot || this.snapshot;
        newSnapshot = newSnapshot || this.takeSnapshot();
        this.assert.strictEqual(newSnapshot.length, oldSnapshot.length, 'Same number of nodes');
        for (let i = 0; i < oldSnapshot.length; i++) {
            this.assertSameNode(newSnapshot[i], oldSnapshot[i]);
        }
    }
    assertSameNode(actual, expected) {
        this.assert.strictEqual(actual, expected, 'DOM node stability');
    }
    runTask(callback) {
        callback();
        this.env.begin();
        this.result.rerender();
        this.env.commit();
    }
}
export function testModule(description) {
    return function (TestClass) {
        let context;
        QUnit.module(`[Browser] ${description || TestClass.name}`, {
            afterEach() {
                context.teardown();
            }
        });
        let keys = Object.getOwnPropertyNames(TestClass.prototype);
        keys.forEach(key => {
            if (key === 'constructor')
                return;
            let value = Object.getOwnPropertyDescriptor(TestClass.prototype, key).value;
            let isSkipped = value.skip;
            if (typeof value === 'function' && !isSkipped) {
                QUnit.test(key, (assert) => {
                    let env = new TestEnvironment();
                    context = new TestClass(env, value['template'], document.getElementById('qunit-fixture'));
                    value.call(context, assert);
                });
            }
            else if (isSkipped) {
                QUnit.skip(key, () => { });
            }
        });
    };
}
export function template(t) {
    return function template(target, name, descriptor) {
        if (typeof descriptor.value !== 'function') {
            throw new Error("Can't decorator a non-function with the @template decorator");
        }
        descriptor.value['template'] = t;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWJzdHJhY3QtdGVzdC1jYXNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQGdsaW1tZXIvdGVzdC1oZWxwZXJzL2xpYi9hYnN0cmFjdC10ZXN0LWNhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFnRCxZQUFZLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVoRyxPQUFPLEVBQ0wsZUFBZSxFQUNmLGdCQUFnQixFQUNqQixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRW5DLE1BQU0sZUFBZSxNQUFjLEVBQUUsSUFBWSxFQUFFLFVBQThCO0lBQy9FLFVBQVUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO0FBQ2xDLENBQUM7QUFFRCxNQUFNO0lBSUosWUFBWSxLQUFhO1FBQ3ZCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUM5QixNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxNQUFNLENBQUMsS0FBYTtRQUNsQixNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNmLENBQUM7SUFFRCxHQUFHLENBQUMsR0FBVyxFQUFFLEtBQWE7UUFDNUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUNsQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQsS0FBSztRQUNILElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBRUQsTUFBTTtJQUdKLFlBQW9CLE1BQXVCO1FBQXZCLFdBQU0sR0FBTixNQUFNLENBQWlCO1FBQ3pDLElBQUksQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztJQUN4QixDQUFD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QUNyQixJQUFJLEdBQUcsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO29CQUNoQyxPQUFPLEdBQUcsSUFBSSxTQUFTLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxRQUFRLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7b0JBQzFGLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUM5QixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDckIsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsUUFBTyxDQUFDLENBQUMsQ0FBQztZQUM1QixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsTUFBTSxtQkFBbUIsQ0FBUztJQUNoQyxNQUFNLENBQUMsa0JBQWtCLE1BQWMsRUFBRSxJQUFZLEVBQUUsVUFBOEI7UUFDbkYsRUFBRSxDQUFDLENBQUMsT0FBTyxVQUFVLENBQUMsS0FBSyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDM0MsTUFBTSxJQUFJLEtBQUssQ0FBQyw2REFBNkQsQ0FBQyxDQUFDO1FBQ2pGLENBQUM7UUFFRCxVQUFVLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuQyxDQUFDLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGF0aFJlZmVyZW5jZSwgVGFnZ2VkLCBSZXZpc2lvbiwgUmV2aXNpb25UYWcsIERpcnR5YWJsZVRhZyB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQgeyBUZW1wbGF0ZSwgUmVuZGVyUmVzdWx0LCBTaW1wbGUgfSBmcm9tICdAZ2xpbW1lci9ydW50aW1lJztcbmltcG9ydCB7XG4gIFRlc3RFbnZpcm9ubWVudCxcbiAgVGVzdER5bmFtaWNTY29wZVxufSBmcm9tICcuL2Vudmlyb25tZW50JztcbmltcG9ydCB7IE9wYXF1ZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgYXNzaWduIH0gZnJvbSAnLi9oZWxwZXJzJztcblxuZXhwb3J0IGZ1bmN0aW9uIHNraXAodGFyZ2V0OiBPYmplY3QsIG5hbWU6IHN0cmluZywgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yKSB7XG4gIGRlc2NyaXB0b3IudmFsdWVbJ3NraXAnXSA9IHRydWU7XG59XG5cbmV4cG9ydCBjbGFzcyBWZXJzaW9uZWRPYmplY3QgaW1wbGVtZW50cyBUYWdnZWQ8UmV2aXNpb24+IHtcbiAgcHVibGljIHRhZzogRGlydHlhYmxlVGFnO1xuICBwdWJsaWMgdmFsdWU6IE9iamVjdDtcblxuICBjb25zdHJ1Y3Rvcih2YWx1ZTogT2JqZWN0KSB7XG4gICAgdGhpcy50YWcgPSBuZXcgRGlydHlhYmxlVGFnKCk7XG4gICAgYXNzaWduKHRoaXMsIHZhbHVlKTtcbiAgfVxuXG4gIHVwZGF0ZSh2YWx1ZTogT2JqZWN0KSB7XG4gICAgYXNzaWduKHRoaXMsIHZhbHVlKTtcbiAgICB0aGlzLmRpcnR5KCk7XG4gIH1cblxuICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBPcGFxdWUpIHtcbiAgICB0aGlzW2tleV0gPSB2YWx1ZTtcbiAgICB0aGlzLmRpcnR5KCk7XG4gIH1cblxuICBkaXJ0eSgpIHtcbiAgICB0aGlzLnRhZy5kaXJ0eSgpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTaW1wbGVSb290UmVmZXJlbmNlIGltcGxlbWVudHMgUGF0aFJlZmVyZW5jZTxPcGFxdWU+IHtcbiAgcHVibGljIHRhZzogUmV2aXNpb25UYWc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvYmplY3Q6IFZlcnNpb25lZE9iamVjdCkge1xuICAgIHRoaXMudGFnID0gb2JqZWN0LnRhZztcbiAgfVxuXG4gIGdldChrZXk6IHN0cmluZyk6IFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gICAgcmV0dXJuIG5ldyBTaW1wbGVQYXRoUmVmZXJlbmNlKHRoaXMsIGtleSk7XG4gIH1cblxuICB2YWx1ZSgpOiBPYmplY3Qge1xuICAgIHJldHVybiB0aGlzLm9iamVjdDtcbiAgfVxufVxuXG5jbGFzcyBTaW1wbGVQYXRoUmVmZXJlbmNlIGltcGxlbWVudHMgUGF0aFJlZmVyZW5jZTxPcGFxdWU+IHtcbiAgcHVibGljIHRhZzogUmV2aXNpb25UYWc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwYXJlbnQ6IFBhdGhSZWZlcmVuY2U8T3BhcXVlPiwgcHJpdmF0ZSBrZXk6IHN0cmluZykge1xuICAgIHRoaXMudGFnID0gcGFyZW50LnRhZztcbiAgfVxuXG4gIGdldChrZXk6IHN0cmluZyk6IFNpbXBsZVBhdGhSZWZlcmVuY2Uge1xuICAgIHJldHVybiBuZXcgU2ltcGxlUGF0aFJlZmVyZW5jZSh0aGlzLCBrZXkpO1xuICB9XG5cbiAgdmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50LnZhbHVlKClbdGhpcy5rZXldO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzTWFya2VyKG5vZGUpIHtcbiAgaWYgKG5vZGUgaW5zdGFuY2VvZiBDb21tZW50ICYmIG5vZGUudGV4dENvbnRlbnQgPT09ICcnKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpZiAobm9kZSBpbnN0YW5jZW9mIFRleHQgJiYgbm9kZS50ZXh0Q29udGVudCA9PT0gJycpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGNsYXNzIFJlbmRlcmluZ1Rlc3Qge1xuICBwdWJsaWMgdGVtcGxhdGU6IFRlbXBsYXRlPHt9PjtcbiAgcHJvdGVjdGVkIGNvbnRleHQ6IFZlcnNpb25lZE9iamVjdCA9IG51bGw7XG4gIHByaXZhdGUgcmVzdWx0OiBSZW5kZXJSZXN1bHQgPSBudWxsO1xuICBwdWJsaWMgc25hcHNob3Q6IEVsZW1lbnRbXTtcbiAgcHVibGljIGVsZW1lbnQ6IE5vZGU7XG4gIHB1YmxpYyBhc3NlcnQ6IFFVbml0Wydhc3NlcnQnXTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgZW52OiBUZXN0RW52aXJvbm1lbnQgPSBuZXcgVGVzdEVudmlyb25tZW50KCksIHRlbXBsYXRlOiBzdHJpbmcsIHByaXZhdGUgYXBwZW5kVG86IFNpbXBsZS5FbGVtZW50KSB7XG4gICAgdGhpcy50ZW1wbGF0ZSA9IHRoaXMuZW52LmNvbXBpbGUodGVtcGxhdGUpO1xuICAgIHRoaXMuYXNzZXJ0ID0gUVVuaXQuY29uZmlnLmN1cnJlbnQuYXNzZXJ0O1xuICB9XG5cbiAgdGVhcmRvd24oKSB7fVxuXG4gIHJlbmRlcihjb250ZXh0OiBPYmplY3QpIHtcbiAgICB0aGlzLmVudi5iZWdpbigpO1xuICAgIGxldCBkeW5hbWljU2NvcGUgPSBuZXcgVGVzdER5bmFtaWNTY29wZSgpO1xuICAgIGxldCBhcHBlbmRUbyA9IHRoaXMuYXBwZW5kVG87XG4gICAgbGV0IHJvb3RPYmplY3QgPSBuZXcgVmVyc2lvbmVkT2JqZWN0KGNvbnRleHQpO1xuICAgIGxldCByb290ID0gbmV3IFNpbXBsZVJvb3RSZWZlcmVuY2Uocm9vdE9iamVjdCk7XG5cbiAgICB0aGlzLmNvbnRleHQgPSByb290T2JqZWN0O1xuICAgIHRoaXMucmVzdWx0ID0gdGhpcy50ZW1wbGF0ZS5yZW5kZXIocm9vdCwgYXBwZW5kVG8sIGR5bmFtaWNTY29wZSk7XG4gICAgdGhpcy5lbnYuY29tbWl0KCk7XG4gICAgdGhpcy5lbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1bml0LWZpeHR1cmUnKS5maXJzdENoaWxkO1xuICB9XG4gIGFzc2VydENvbnRlbnQoZXhwZWN0ZWQ6IHN0cmluZywgbWVzc2FnZT86IHN0cmluZykge1xuICAgIGxldCBhY3R1YWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVuaXQtZml4dHVyZScpLmlubmVySFRNTDtcbiAgICBRVW5pdC5lcXVhbChhY3R1YWwsIGV4cGVjdGVkKTtcbiAgfVxuXG4gIHRha2VTbmFwc2hvdCgpIHtcbiAgICBsZXQgc25hcHNob3QgPSB0aGlzLnNuYXBzaG90ID0gW107XG4gICAgbGV0IG5vZGUgPSB0aGlzLmVsZW1lbnQuZmlyc3RDaGlsZDtcblxuICAgIHdoaWxlIChub2RlKSB7XG4gICAgICBpZiAoIWlzTWFya2VyKG5vZGUpKSB7XG4gICAgICAgIHNuYXBzaG90LnB1c2gobm9kZSk7XG4gICAgICB9XG5cbiAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nO1xuICAgIH1cblxuICAgIHJldHVybiBzbmFwc2hvdDtcbiAgfVxuXG4gIGFzc2VydFN0YWJsZVJlcmVuZGVyKCkge1xuICAgIHRoaXMudGFrZVNuYXBzaG90KCk7XG4gICAgdGhpcy5yZXJlbmRlcigpO1xuICAgIHRoaXMuYXNzZXJ0SW52YXJpYW50cygpO1xuICB9XG5cbiAgcmVyZW5kZXIoKSB7XG4gICAgdGhpcy5yZXN1bHQucmVyZW5kZXIoKTtcbiAgfVxuXG4gIGFzc2VydEludmFyaWFudHMob2xkU25hcHNob3Q/OiBBcnJheTxOb2RlPiwgbmV3U25hcHNob3Q/OiBBcnJheTxOb2RlPikge1xuICAgIG9sZFNuYXBzaG90ID0gb2xkU25hcHNob3QgfHwgdGhpcy5zbmFwc2hvdDtcbiAgICBuZXdTbmFwc2hvdCA9IG5ld1NuYXBzaG90IHx8IHRoaXMudGFrZVNuYXBzaG90KCk7XG5cbiAgICB0aGlzLmFzc2VydC5zdHJpY3RFcXVhbChuZXdTbmFwc2hvdC5sZW5ndGgsIG9sZFNuYXBzaG90Lmxlbmd0aCwgJ1NhbWUgbnVtYmVyIG9mIG5vZGVzJyk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9sZFNuYXBzaG90Lmxlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLmFzc2VydFNhbWVOb2RlKG5ld1NuYXBzaG90W2ldLCBvbGRTbmFwc2hvdFtpXSk7XG4gICAgfVxuICB9XG5cbiAgYXNzZXJ0U2FtZU5vZGUoYWN0dWFsOiBOb2RlLCBleHBlY3RlZDogTm9kZSkge1xuICAgIHRoaXMuYXNzZXJ0LnN0cmljdEVxdWFsKGFjdHVhbCwgZXhwZWN0ZWQsICdET00gbm9kZSBzdGFiaWxpdHknKTtcbiAgfVxuXG4gIHJ1blRhc2soY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICBjYWxsYmFjaygpO1xuICAgIHRoaXMuZW52LmJlZ2luKCk7XG4gICAgdGhpcy5yZXN1bHQucmVyZW5kZXIoKTtcbiAgICB0aGlzLmVudi5jb21taXQoKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgQ29uc3RydWN0b3I8VD4ge1xuICBuZXcoLi4uYXJncyk6IFQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0ZXN0TW9kdWxlKGRlc2NyaXB0aW9uPzogc3RyaW5nKSB7XG4gIHJldHVybiBmdW5jdGlvbihUZXN0Q2xhc3M6IHR5cGVvZiBSZW5kZXJpbmdUZXN0KSB7XG4gICAgbGV0IGNvbnRleHQ6IFJlbmRlcmluZ1Rlc3Q7XG5cbiAgICBRVW5pdC5tb2R1bGUoYFtCcm93c2VyXSAke2Rlc2NyaXB0aW9uIHx8IFRlc3RDbGFzcy5uYW1lfWAsIHtcbiAgICAgIGFmdGVyRWFjaCgpIHtcbiAgICAgICAgY29udGV4dC50ZWFyZG93bigpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbGV0IGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhUZXN0Q2xhc3MucHJvdG90eXBlKTtcbiAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGlmIChrZXkgPT09ICdjb25zdHJ1Y3RvcicpIHJldHVybjtcbiAgICAgIGxldCB2YWx1ZSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoVGVzdENsYXNzLnByb3RvdHlwZSwga2V5KS52YWx1ZTtcbiAgICAgIGxldCBpc1NraXBwZWQgPSB2YWx1ZS5za2lwO1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNTa2lwcGVkKSB7XG4gICAgICAgIFFVbml0LnRlc3Qoa2V5LCAoYXNzZXJ0KSA9PiB7XG4gICAgICAgICAgbGV0IGVudiA9IG5ldyBUZXN0RW52aXJvbm1lbnQoKTtcbiAgICAgICAgICBjb250ZXh0ID0gbmV3IFRlc3RDbGFzcyhlbnYsIHZhbHVlWyd0ZW1wbGF0ZSddLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVuaXQtZml4dHVyZScpKTtcbiAgICAgICAgICB2YWx1ZS5jYWxsKGNvbnRleHQsIGFzc2VydCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChpc1NraXBwZWQpIHtcbiAgICAgICAgUVVuaXQuc2tpcChrZXksICgpID0+IHt9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRlbXBsYXRlKHQ6IHN0cmluZykge1xuICByZXR1cm4gZnVuY3Rpb24gdGVtcGxhdGUodGFyZ2V0OiBPYmplY3QsIG5hbWU6IHN0cmluZywgZGVzY3JpcHRvcjogUHJvcGVydHlEZXNjcmlwdG9yKSB7XG4gICAgaWYgKHR5cGVvZiBkZXNjcmlwdG9yLnZhbHVlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW4ndCBkZWNvcmF0b3IgYSBub24tZnVuY3Rpb24gd2l0aCB0aGUgQHRlbXBsYXRlIGRlY29yYXRvclwiKTtcbiAgICB9XG5cbiAgICBkZXNjcmlwdG9yLnZhbHVlWyd0ZW1wbGF0ZSddID0gdDtcbiAgfTtcbn1cbiJdfQ==