import { PropertyReference } from './references/descriptors';
import RootReference from './references/root';
import { DictSet, dict } from '@glimmer/util';
import { VOLATILE_TAG } from '@glimmer/reference';
const NOOP_DESTROY = { destroy() { } };
class ConstPath {
    constructor(parent, property) {
        this.tag = VOLATILE_TAG;
        this.parent = parent;
    }
    chain() { return NOOP_DESTROY; }
    notify() { }
    value() {
        return this.parent[this.property];
    }
    get(prop) {
        return new ConstPath(this.parent[this.property], prop);
    }
}
class ConstRoot {
    constructor(value) {
        this.tag = VOLATILE_TAG;
        this.inner = value;
    }
    update(inner) {
        this.inner = inner;
    }
    chain() { return NOOP_DESTROY; }
    notify() { }
    value() {
        return this.inner;
    }
    referenceFromParts(parts) {
        throw new Error("Not implemented");
    }
    chainFor(prop) {
        throw new Error("Not implemented");
    }
    get(prop) {
        return new ConstPath(this.inner, prop);
    }
}
class ConstMeta /*implements IMeta*/ {
    constructor(object) {
        this.object = object;
    }
    root() {
        return new ConstRoot(this.object);
    }
}
export const CLASS_META = "df8be4c8-4e89-44e2-a8f9-550c8dacdca7";
const hasOwnProperty = Object.hasOwnProperty;
class Meta {
    constructor(object, { RootReferenceFactory, DefaultPathReferenceFactory }) {
        this.references = null;
        this.slots = null;
        this.referenceTypes = null;
        this.propertyMetadata = null;
        this.object = object;
        this.RootReferenceFactory = RootReferenceFactory || RootReference;
        this.DefaultPathReferenceFactory = DefaultPathReferenceFactory || PropertyReference;
    }
    static for(obj) {
        if (obj === null || obj === undefined)
            return new Meta(obj, {});
        if (hasOwnProperty.call(obj, '_meta') && obj._meta)
            return obj._meta;
        if (!Object.isExtensible(obj))
            return new ConstMeta(obj);
        let MetaToUse = Meta;
        if (obj.constructor && obj.constructor[CLASS_META]) {
            let classMeta = obj.constructor[CLASS_META];
            MetaToUse = classMeta.InstanceMetaConstructor;
        }
        else if (obj[CLASS_META]) {
            MetaToUse = obj[CLASS_META].InstanceMetaConstructor;
        }
        return (obj._meta = new MetaToUse(obj, {}));
    }
    static exists(obj) {
        return typeof obj === 'object' && obj._meta;
    }
    static metadataForProperty(key) {
        return null;
    }
    addReference(property, reference) {
        let refs = this.references = this.references || dict();
        let set = refs[property] = refs[property] || new DictSet();
        set.add(reference);
    }
    addReferenceTypeFor(property, type) {
        this.referenceTypes = this.referenceTypes || dict();
        this.referenceTypes[property] = type;
    }
    referenceTypeFor(property) {
        if (!this.referenceTypes)
            return PropertyReference;
        return this.referenceTypes[property] || PropertyReference;
    }
    removeReference(property, reference) {
        if (!this.references)
            return;
        let set = this.references[property];
        set.delete(reference);
    }
    getReferenceTypes() {
        this.referenceTypes = this.referenceTypes || dict();
        return this.referenceTypes;
    }
    referencesFor(property) {
        if (!this.references)
            return;
        return this.references[property];
    }
    getSlots() {
        return (this.slots = this.slots || dict());
    }
    root() {
        return (this.rootCache = this.rootCache || new this.RootReferenceFactory(this.object));
    }
}
export default Meta;
export function metaFor(obj) {
    return Meta.for(obj);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkBnbGltbWVyL29iamVjdC1yZWZlcmVuY2UvbGliL21ldGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDN0QsT0FBTyxhQUFhLE1BQU0sbUJBQW1CLENBQUM7QUFHOUMsT0FBTyxFQUFRLE9BQU8sRUFBZ0IsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBU2xFLE9BQU8sRUFBbUMsWUFBWSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFJbkYsTUFBTSxZQUFZLEdBQUcsRUFBRSxPQUFPLEtBQUksQ0FBQyxFQUFFLENBQUM7QUFFdEM7SUFLRSxZQUFZLE1BQVcsRUFBRSxRQUFnQjtRQUZsQyxRQUFHLEdBQUcsWUFBWSxDQUFDO1FBR3hCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxLQUFLLEtBQUssTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7SUFDaEMsTUFBTSxLQUFJLENBQUM7SUFFWCxLQUFLO1FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxHQUFHLENBQUMsSUFBWTtRQUNkLE1BQU0sQ0FBQyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN6RCxDQUFDO0NBQ0Y7QUFFRDtJQUlFLFlBQVksS0FBSztRQUZWLFFBQUcsR0FBRyxZQUFZLENBQUM7UUFHeEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDckIsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFVO1FBQ2YsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDckIsQ0FBQztJQUVELEtBQUssS0FBSyxNQUFN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O1FBQ2YsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsY0FBYyxJQUFJLElBQUksRUFBNkIsQ0FBQztRQUMvRSxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRUQsYUFBYSxDQUFDLFFBQWdCO1FBQzVCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUFDLE1BQU0sQ0FBQztRQUM3QixNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsUUFBUTtRQUNOLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxJQUFJO1FBQ0YsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3pGLENBQUM7Q0FDRjtBQUVELGVBQWUsSUFBSSxDQUFDO0FBTXBCLE1BQU0sa0JBQWtCLEdBQVE7SUFDOUIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3BlcnR5UmVmZXJlbmNlIH0gZnJvbSAnLi9yZWZlcmVuY2VzL2Rlc2NyaXB0b3JzJztcbmltcG9ydCBSb290UmVmZXJlbmNlIGZyb20gJy4vcmVmZXJlbmNlcy9yb290JztcbmltcG9ydCB7IE1ldGFPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XG5cbmltcG9ydCB7IERpY3QsIERpY3RTZXQsIEhhc0d1aWQsIFNldCwgZGljdCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5pbXBvcnQge1xuICBSb290UmVmZXJlbmNlRmFjdG9yeSxcbiAgUGF0aFJlZmVyZW5jZUZhY3RvcnksXG4gIE1ldGEgYXMgSU1ldGEsXG4gIFJvb3RSZWZlcmVuY2UgYXMgSVJvb3RSZWZlcmVuY2Vcbn0gZnJvbSAnLi90eXBlcyc7XG5cbmltcG9ydCB7IFBhdGhSZWZlcmVuY2UgYXMgSVBhdGhSZWZlcmVuY2UsIFZPTEFUSUxFX1RBRyB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5cbmltcG9ydCB7IElubmVyUmVmZXJlbmNlRmFjdG9yeSB9IGZyb20gJy4vcmVmZXJlbmNlcy9kZXNjcmlwdG9ycyc7XG5cbmNvbnN0IE5PT1BfREVTVFJPWSA9IHsgZGVzdHJveSgpIHt9IH07XG5cbmNsYXNzIENvbnN0UGF0aCBpbXBsZW1lbnRzIElQYXRoUmVmZXJlbmNlPGFueT4ge1xuICBwcml2YXRlIHBhcmVudDogYW55O1xuICBwcml2YXRlIHByb3BlcnR5OiBzdHJpbmc7XG4gIHB1YmxpYyB0YWcgPSBWT0xBVElMRV9UQUc7XG5cbiAgY29uc3RydWN0b3IocGFyZW50OiBhbnksIHByb3BlcnR5OiBzdHJpbmcpIHtcbiAgICB0aGlzLnBhcmVudCA9IHBhcmVudDtcbiAgfVxuXG4gIGNoYWluKCkgeyByZXR1cm4gTk9PUF9ERVNUUk9ZOyB9XG4gIG5vdGlmeSgpIHt9XG5cbiAgdmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50W3RoaXMucHJvcGVydHldO1xuICB9XG5cbiAgZ2V0KHByb3A6IHN0cmluZyk6IElQYXRoUmVmZXJlbmNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgQ29uc3RQYXRoKHRoaXMucGFyZW50W3RoaXMucHJvcGVydHldLCBwcm9wKTtcbiAgfVxufVxuXG5jbGFzcyBDb25zdFJvb3QgaW1wbGVtZW50cyBJUm9vdFJlZmVyZW5jZTxhbnk+IHtcbiAgcHJpdmF0ZSBpbm5lcjogYW55O1xuICBwdWJsaWMgdGFnID0gVk9MQVRJTEVfVEFHO1xuXG4gIGNvbnN0cnVjdG9yKHZhbHVlKSB7XG4gICAgdGhpcy5pbm5lciA9IHZhbHVlO1xuICB9XG5cbiAgdXBkYXRlKGlubmVyOiBhbnkpIHtcbiAgICB0aGlzLmlubmVyID0gaW5uZXI7XG4gIH1cblxuICBjaGFpbigpIHsgcmV0dXJuIE5PT1BfREVTVFJPWTsgfVxuICBub3RpZnkoKSB7fVxuXG4gIHZhbHVlKCk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuaW5uZXI7XG4gIH1cblxuICByZWZlcmVuY2VGcm9tUGFydHMocGFydHM6IHN0cmluZ1tdKTogSVBhdGhSZWZlcmVuY2U8YW55PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IGltcGxlbWVudGVkXCIpO1xuICB9XG5cbiAgY2hhaW5Gb3IocHJvcDogc3RyaW5nKTogSVBhdGhSZWZlcmVuY2U8YW55PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IGltcGxlbWVudGVkXCIpO1xuICB9XG5cbiAgZ2V0KHByb3A6IHN0cmluZyk6IElQYXRoUmVmZXJlbmNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgQ29uc3RQYXRoKHRoaXMuaW5uZXIsIHByb3ApO1xuICB9XG59XG5cbmNsYXNzIENvbnN0TWV0YSAvKmltcGxlbWVudHMgSU1ldGEqLyB7XG4gIHByaXZhdGUgb2JqZWN0OiBhbnk7XG5cbiAgY29uc3RydWN0b3Iob2JqZWN0OiBhbnkpIHtcbiAgICB0aGlzLm9iamVjdCA9IG9iamVjdDtcbiAgfVxuXG4gIHJvb3QoKTogQ29uc3RSb290IHtcbiAgICByZXR1cm4gbmV3IENvbnN0Um9vdCh0aGlzLm9iamVjdCk7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IENMQVNTX01FVEEgPSBcImRmOGJlNGM4LTRlODktNDRlMi1hOGY5LTU1MGM4ZGFjZGNhN1wiO1xuXG5jb25zdCBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eTtcblxuY2xhc3MgTWV0YSBpbXBsZW1lbnRzIElNZXRhLCBIYXNHdWlkIHtcbiAgc3RhdGljIGZvcihvYmo6IGFueSk6IElNZXRhIHtcbiAgICBpZiAob2JqID09PSBudWxsIHx8IG9iaiA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbmV3IE1ldGEob2JqLCB7fSk7XG4gICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqLCAnX21ldGEnKSAmJiBvYmouX21ldGEpIHJldHVybiBvYmouX21ldGE7XG4gICAgaWYgKCFPYmplY3QuaXNFeHRlbnNpYmxlKG9iaikpIHJldHVybiA8YW55Pm5ldyBDb25zdE1ldGEob2JqKTtcblxuICAgIGxldCBNZXRhVG9Vc2U6IHR5cGVvZiBNZXRhID0gTWV0YTtcblxuICAgIGlmIChvYmouY29uc3RydWN0b3IgJiYgb2JqLmNvbnN0cnVjdG9yW0NMQVNTX01FVEFdKSB7XG4gICAgICBsZXQgY2xhc3NNZXRhOiBDbGFzc01ldGEgPSBvYmouY29uc3RydWN0b3JbQ0xBU1NfTUVUQV07XG4gICAgICBNZXRhVG9Vc2UgPSBjbGFzc01ldGEuSW5zdGFuY2VNZXRhQ29uc3RydWN0b3I7XG4gICAgfSBlbHNlIGlmIChvYmpbQ0xBU1NfTUVUQV0pIHtcbiAgICAgIE1ldGFUb1VzZSA9IG9ialtDTEFTU19NRVRBXS5JbnN0YW5jZU1ldGFDb25zdHJ1Y3RvcjtcbiAgICB9XG5cbiAgICByZXR1cm4gKG9iai5fbWV0YSA9IG5ldyBNZXRhVG9Vc2Uob2JqLCB7fSkpO1xuICB9XG5cbiAgc3RhdGljIGV4aXN0cyhvYmo6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmouX21ldGE7XG4gIH1cblxuICBzdGF0aWMgbWV0YWRhdGFGb3JQcm9wZXJ0eShrZXk6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcml2YXRlIG9iamVjdDogYW55O1xuICBwcml2YXRlIFJvb3RSZWZlcmVuY2VGYWN0b3J5OiBSb290UmVmZXJlbmNlRmFjdG9yeTxhbnk+O1xuICBwcml2YXRlIERlZmF1bHRQYXRoUmVmZXJlbmNlRmFjdG9yeTogSW5uZXJSZWZlcmVuY2VGYWN0b3J5PGFueT47XG4gIHByaXZhdGUgcm9vdENhY2hlOiBJUm9vdFJlZmVyZW5jZTxhbnk+O1xuICBwcml2YXRlIHJlZmVyZW5jZXM6IERpY3Q8RGljdFNldDxJUGF0aFJlZmVyZW5jZTxhbnk+ICYgSGFzR3VpZD4+ID0gbnVsbDtcbiAgcHVibGljIF9ndWlkO1xuICBwcm90ZWN0ZWQgc2xvdHM6IERpY3Q8YW55PiA9IG51bGw7XG4gIHByb3RlY3RlZCByZWZlcmVuY2VUeXBlczogRGljdDxJbm5lclJlZmVyZW5jZUZhY3Rvcnk8YW55Pj4gPSBudWxsO1xuICBwcm90ZWN0ZWQgcHJvcGVydHlNZXRhZGF0YTogRGljdDxhbnk+ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihvYmplY3Q6IGFueSwgeyBSb290UmVmZXJlbmNlRmFjdG9yeSwgRGVmYXVsdFBhdGhSZWZlcmVuY2VGYWN0b3J5IH06IE1ldGFPcHRpb25zKSB7XG4gICAgdGhpcy5vYmplY3QgPSBvYmplY3Q7XG4gICAgdGhpcy5Sb290UmVmZXJlbmNlRmFjdG9yeSA9IFJvb3RSZWZlcmVuY2VGYWN0b3J5IHx8IFJvb3RSZWZlcmVuY2U7XG4gICAgdGhpcy5EZWZhdWx0UGF0aFJlZmVyZW5jZUZhY3RvcnkgPSBEZWZhdWx0UGF0aFJlZmVyZW5jZUZhY3RvcnkgfHwgUHJvcGVydHlSZWZlcmVuY2U7XG4gIH1cblxuICBhZGRSZWZlcmVuY2UocHJvcGVydHk6IHN0cmluZywgcmVmZXJlbmNlOiBJUGF0aFJlZmVyZW5jZTxhbnk+ICYgSGFzR3VpZCkge1xuICAgIGxldCByZWZzID0gdGhpcy5yZWZlcmVuY2VzID0gdGhpcy5yZWZlcmVuY2VzIHx8IGRpY3Q8RGljdFNldDxJUGF0aFJlZmVyZW5jZTxhbnk+ICYgSGFzR3VpZD4+KCk7XG4gICAgbGV0IHNldCA9IHJlZnNbcHJvcGVydHldID0gcmVmc1twcm9wZXJ0eV0gfHwgbmV3IERpY3RTZXQ8SVBhdGhSZWZlcmVuY2U8YW55PiAmIEhhc0d1aWQ+KCk7XG4gICAgc2V0LmFkZChyZWZlcmVuY2UpO1xuICB9XG5cbiAgYWRkUmVmZXJlbmNlVHlwZUZvcihwcm9wZXJ0eTogc3RyaW5nLCB0eXBlOiBQYXRoUmVmZXJlbmNlRmFjdG9yeTxhbnk+KSB7XG4gICAgdGhpcy5yZWZlcmVuY2VUeXBlcyA9IHRoaXMucmVmZXJlbmNlVHlwZXMgfHwgZGljdDxQYXRoUmVmZXJlbmNlRmFjdG9yeTxhbnk+PigpO1xuICAgIHRoaXMucmVmZXJlbmNlVHlwZXNbcHJvcGVydHldID0gdHlwZTtcbiAgfVxuXG4gIHJlZmVyZW5jZVR5cGVGb3IocHJvcGVydHk6IHN0cmluZyk6IElubmVyUmVmZXJlbmNlRmFjdG9yeTxhbnk+IHtcbiAgICBpZiAoIXRoaXMucmVmZXJlbmNlVHlwZXMpIHJldHVybiBQcm9wZXJ0eVJlZmVyZW5jZTtcbiAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VUeXBlc1twcm9wZXJ0eV0gfHwgUHJvcGVydHlSZWZlcmVuY2U7XG4gIH1cblxuICByZW1vdmVSZWZlcmVuY2UocHJvcGVydHk6IHN0cmluZywgcmVmZXJlbmNlOiBJUGF0aFJlZmVyZW5jZTxhbnk+ICYgSGFzR3VpZCkge1xuICAgIGlmICghdGhpcy5yZWZlcmVuY2VzKSByZXR1cm47XG4gICAgbGV0IHNldCA9IHRoaXMucmVmZXJlbmNlc1twcm9wZXJ0eV07XG4gICAgc2V0LmRlbGV0ZShyZWZlcmVuY2UpO1xuICB9XG5cbiAgZ2V0UmVmZXJlbmNlVHlwZXMoKTogRGljdDxJbm5lclJlZmVyZW5jZUZhY3Rvcnk8YW55Pj4ge1xuICAgIHRoaXMucmVmZXJlbmNlVHlwZXMgPSB0aGlzLnJlZmVyZW5jZVR5cGVzIHx8IGRpY3Q8UGF0aFJlZmVyZW5jZUZhY3Rvcnk8YW55Pj4oKTtcbiAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VUeXBlcztcbiAgfVxuXG4gIHJlZmVyZW5jZXNGb3IocHJvcGVydHk6IHN0cmluZyk6IFNldDxJUGF0aFJlZmVyZW5jZTxhbnk+PiB7XG4gICAgaWYgKCF0aGlzLnJlZmVyZW5jZXMpIHJldHVybjtcbiAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VzW3Byb3BlcnR5XTtcbiAgfVxuXG4gIGdldFNsb3RzKCkge1xuICAgIHJldHVybiAodGhpcy5zbG90cyA9IHRoaXMuc2xvdHMgfHwgZGljdCgpKTtcbiAgfVxuXG4gIHJvb3QoKTogSVJvb3RSZWZlcmVuY2U8YW55PiB7XG4gICAgcmV0dXJuICh0aGlzLnJvb3RDYWNoZSA9IHRoaXMucm9vdENhY2hlIHx8IG5ldyB0aGlzLlJvb3RSZWZlcmVuY2VGYWN0b3J5KHRoaXMub2JqZWN0KSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTWV0YTtcblxuaW50ZXJmYWNlIENsYXNzTWV0YSB7XG4gIEluc3RhbmNlTWV0YUNvbnN0cnVjdG9yOiB0eXBlb2YgTWV0YTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ldGFGb3Iob2JqOiBhbnkpOiBJTWV0YSB7XG4gIHJldHVybiBNZXRhLmZvcihvYmopO1xufVxuIl19