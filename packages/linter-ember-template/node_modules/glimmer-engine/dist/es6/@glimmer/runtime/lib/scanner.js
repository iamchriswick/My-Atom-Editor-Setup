import { CompiledProgram, CompiledBlock } from './compiled/blocks';
import { builder } from './compiler';
import * as WireFormat from '@glimmer/wire-format';
import { entryPoint as entryPointTable, layout as layoutTable, block as blockTable } from './symbol-table';
import { STATEMENTS } from './syntax/functions';
import { SPECIALIZE } from './syntax/specialize';
export function compileStatement(statement, builder) {
    let refined = SPECIALIZE.specialize(statement, builder.symbolTable);
    STATEMENTS.compile(refined, builder);
}
export class Template {
    constructor(statements, symbolTable) {
        this.statements = statements;
        this.symbolTable = symbolTable;
    }
}
export class Layout extends Template {
}
export class EntryPoint extends Template {
    compile(env) {
        let table = this.symbolTable;
        let b = builder(env, table);
        for (let i = 0; i < this.statements.length; i++) {
            let statement = this.statements[i];
            let refined = SPECIALIZE.specialize(statement, table);
            STATEMENTS.compile(refined, b);
        }
        return new CompiledProgram(b.toSlice(), this.symbolTable.size);
    }
}
export class InlineBlock extends Template {
    splat(builder) {
        let table = builder.symbolTable;
        let locals = table.getSymbols().locals;
        if (locals) {
            builder.pushChildScope();
            builder.bindPositionalArgsForLocals(locals);
        }
        for (let i = 0; i < this.statements.length; i++) {
            let statement = this.statements[i];
            let refined = SPECIALIZE.specialize(statement, table);
            STATEMENTS.compile(refined, builder);
        }
        if (locals) {
            builder.popScope();
        }
    }
    compile(env) {
        let table = this.symbolTable;
        let b = builder(env, table);
        this.splat(b);
        return new CompiledBlock(b.toSlice());
    }
}
export class PartialBlock extends Template {
    compile(env) {
        let table = this.symbolTable;
        let b = builder(env, table);
        for (let i = 0; i < this.statements.length; i++) {
            let statement = this.statements[i];
            let refined = SPECIALIZE.specialize(statement, table);
            STATEMENTS.compile(refined, b);
        }
        return new CompiledProgram(b.toSlice(), table.size);
    }
}
export default class Scanner {
    constructor(block, meta, env) {
        this.block = block;
        this.meta = meta;
        this.env = env;
    }
    scanEntryPoint() {
        let { block, meta } = this;
        let symbolTable = entryPointTable(meta);
        let child = scanBlock(block, symbolTable, this.env);
        return new EntryPoint(child.statements, symbolTable);
    }
    scanLayout() {
        let { block, meta } = this;
        let { named, yields, hasPartials } = block;
        let symbolTable = layoutTable(meta, named, yields, hasPartials);
        let child = scanBlock(block, symbolTable, this.env);
        return new Layout(child.statements, symbolTable);
    }
    scanPartial(symbolTable) {
        let { block } = this;
        let child = scanBlock(block, symbolTable, this.env);
        return new PartialBlock(child.statements, symbolTable);
    }
}
export function scanBlock({ statements }, symbolTable, env) {
    return new RawInlineBlock(env, symbolTable, statements).scan();
}
export var BaselineSyntax;
(function (BaselineSyntax) {
    BaselineSyntax.isScannedComponent = WireFormat.is('scanned-component');
    BaselineSyntax.isPrimitiveElement = WireFormat.is('open-primitive-element');
    BaselineSyntax.isOptimizedAppend = WireFormat.is('optimized-append');
    BaselineSyntax.isUnoptimizedAppend = WireFormat.is('unoptimized-append');
    BaselineSyntax.isAnyAttr = WireFormat.is('any-dynamic-attr');
    BaselineSyntax.isStaticPartial = WireFormat.is('static-partial');
    BaselineSyntax.isDynamicPartial = WireFormat.is('dynamic-partial');
    BaselineSyntax.isFunctionExpression = WireFormat.is('function');
    BaselineSyntax.isNestedBlock = WireFormat.is('nested-block');
    BaselineSyntax.isScannedBlock = WireFormat.is('scanned-block');
    BaselineSyntax.isDebugger = WireFormat.is('debugger');
    var NestedBlock;
    (function (NestedBlock) {
        function defaultBlock(sexp) {
            return sexp[4];
        }
        NestedBlock.defaultBlock = defaultBlock;
        function inverseBlock(sexp) {
            return sexp[5];
        }
        NestedBlock.inverseBlock = inverseBlock;
        function params(sexp) {
            return sexp[2];
        }
        NestedBlock.params = params;
        function hash(sexp) {
            return sexp[3];
        }
        NestedBlock.hash = hash;
    })(NestedBlock = BaselineSyntax.NestedBlock || (BaselineSyntax.NestedBlock = {}));
})(BaselineSyntax || (BaselineSyntax = {}));
export class RawInlineBlock {
    constructor(env, table, statements) {
        this.env = env;
        this.table = table;
        this.statements = statements;
    }
    scan() {
        let buffer = [];
        for (let i = 0; i < this.statements.length; i++) {
            let statement = this.statements[i];
            if (WireFormat.Statements.isBlock(statement)) {
                buffer.push(this.specializeBlock(statement));
            }
            else if (WireFormat.Statements.isComponent(statement)) {
                buffer.push(...this.specializeComponent(statement));
            }
            else {
                buffer.push(statement);
            }
        }
        return new InlineBlock(buffer, this.table);
    }
    specializeBlock(block) {
        let [, path, params, hash, template, inverse] = block;
        return ['scanned-block', path, params, hash, this.child(template), this.child(inverse)];
    }
    specializeComponent(sexp) {
        let [, tag, component] = sexp;
        if (this.env.hasComponentDefinition([tag], this.table)) {
            let child = this.child(component);
            let attrs = new RawInlineBlock(this.env, this.table, component.attrs);
            return [['scanned-component', tag, attrs, component.args, child]];
        }
        else {
            let buf = [];
            buf.push(['open-element', tag, []]);
            buf.push(...component.attrs);
            buf.push(['flush-element']);
            buf.push(...component.statements);
            buf.push(['close-element']);
            return buf;
        }
    }
    child(block) {
        if (!block)
            return null;
        let table = blockTable(this.table, block.locals);
        return new RawInlineBlock(this.env, table, block.statements);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nhbm5lci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkBnbGltbWVyL3J1bnRpbWUvbGliL3NjYW5uZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBS3JDLE9BQU8sS0FBSyxVQUFVLE1BQU0sc0JBQXNCLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsSUFBSSxlQUFlLEVBQUUsTUFBTSxJQUFJLFdBQVcsRUFBRSxLQUFLLElBQUksVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHM0csT0FBTyxFQUNMLFVBQVUsRUFDWCxNQUFNLG9CQUFvQixDQUFDO0FBRTVCLE9BQU8sRUFDTCxVQUFVLEVBQ1gsTUFBTSxxQkFBcUIsQ0FBQztBQUk3QixNQUFNLDJCQUEyQixTQUFzQyxFQUFFLE9BQXNCO0lBQzdGLElBQUksT0FBTyxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRSxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBRUQsTUFBTTtJQUNKLFlBQW1CLFVBQXlDLEVBQVMsV0FBd0I7UUFBMUUsZUFBVSxHQUFWLFVBQVUsQ0FBK0I7UUFBUyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtJQUFHLENBQUM7Q0FDbEc7QUFFRCxNQUFNLGFBQWMsU0FBUSxRQUFRO0NBRW5DO0FBRUQsTUFBTSxpQkFBa0IsU0FBUSxRQUFRO0lBR3RDLE9BQU8sQ0FBQyxHQUFnQjtRQUN0QixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBRTdCLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFNUIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2hELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakMsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLGVBQWUsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqRSxDQUFDO0NBQ0Y7QUFFRCxNQUFNLGtCQUFtQixTQUFRLFFBQVE7SUFDdkMsS0FBSyxDQUFDLE9BQXNCO1FBQzFCLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFFaEMsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDLE1BQU0sQ0FBQztRQUV2QyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1gsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3pCLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QyxDQUFDO1FBRUQsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2hELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDdkMsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWCxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDckIsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLENBQUMsR0FBZ0I7UUFDdEIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUM3QixJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRTVCLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFZCxNQUFNLENBQUMsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDeEMsQ0FBQztDQUNGO0FBRUQsTUFBTSxtQkFBb0IsU0FBUSxRQUFRO0lBR3hDLE9BQU8sQ0FBQyxHQUFnQjtRQUN0QixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQzdCLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFNUIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2hELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakMsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLGVBQWUsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RELENBQUM7Q0FDRjtBQUVELE1BQU0sQ0FBQyxPQUFPO0lBQ1osWUFBb0IsS0FBOEIsRUFBVSxJQUFrQixFQUFVLEdBQWdCO1FBQXBGLFVBQUssR0FBTCxLQUFLLENBQXlCO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBYztRQUFVLFFBQUcsR0FBSCxHQUFHLENBQWE7SUFDeEcsQ0FBQztJQUVELGNBQWM7UUFDWixJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQztRQUUzQixJQUFJLFdBQVcsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEMsSUFBSSxLQUFLLEdBQUcsU0FBUyxDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sQ0FBQyxJQUFJLFVBQVUsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxVQUFVO1FBQ1IsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBRTNDLElBQUksV0FBVyxHQUFHLFdBQVcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNoRSxJQUFJLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFcEQsTUFBTSxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELFdBQVcsQ0FBQyxXQUF3QjtRQUNsQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBRXJCLElBQUksS0FBSyxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVwRCxNQUFNLENBQUMsSUFBSSxZQUFZLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN6RCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLG9CQUFvQixFQUFFLFVBQVUsRUFBbUIsRUFBRSxXQUF3QixFQUFFLEdBQWdCO0lBQ25HLE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxHQUFHLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2pFLENBQUM7QUFLRCxNQUFNLEtBQVcsY0FBYyxDQThFOUI7QUE5RUQsV0FBaUIsY0FBYztJQUtoQixpQ0FBa0IsR0FBRyxVQUFVLENBQUMsRUFBRSxDQUFtQixtQkFBbUIsQ0FBQyxDQUFDO0lBTzFFLGlDQUFrQixHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQXVCLHdCQUF3QixDQUFDLENBQUM7SUFHbkYsZ0NBQWlCLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBa0Isa0JBQWtCLENBQUMsQ0FBQztJQUd2RSxrQ0FBbUIsR0FBRyxVQUFVLENBQUMsRUFBRSxDQUFvQixvQkFBb0IsQ0FBQyxDQUFDO0lBRzdFLHdCQUFTLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBaUIsa0JBQWtCLENBQUMsQ0FBQztJQUc5RCw4QkFBZSxHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQWdCLGdCQUFnQixDQUFDLENBQUM7SUFFakUsK0JBQWdCLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBaUIsaUJBQWlCLENBQUMsQ0FBQztJQUlwRSxtQ0FBb0IsR0FBRyxVQUFVLENBQUMsRUFBRSxDQUFxQixVQUFVLENBQUMsQ0FBQztJQUdyRSw0QkFBYSxHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQWMsY0FBYyxDQUFDLENBQUM7SUFHM0QsNkJBQWMsR0FBRyxVQUFVLENBQUMsRUFBRSxDQUFlLGVBQWUsQ0FBQyxDQUFDO0lBRzlELHlCQUFVLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBVyxVQUFVLENBQUMsQ0FBQztJQUk5RCxJQUFpQixXQUFXLENBZ0IzQjtJQWhCRCxXQUFpQixXQUFXO1FBQzFCLHNCQUE2QixJQUFpQjtZQUM1QyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLENBQUM7UUFGZSx3QkFBWSxlQUUzQixDQUFBO1FBRUQsc0JBQTZCLElBQWlCO1lBQzVDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakIsQ0FBQztRQUZlLHdCQUFZLGVBRTNCLENBQUE7UUFFRCxnQkFBdUIsSUFBaUI7WUFDdEMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQixDQUFDO1FBRmUsa0JBQU0sU0FFckIsQ0FBQTtRQUVELGNBQXFCLElBQWlCO1lBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakIsQ0FBQztRQUZlLGdCQUFJLE9BRW5CLENBQUE7SUFDSCxDQUFDLEVBaEJnQixXQUFXLEdBQVgsMEJBQVcsS0FBWCwwQkFBVyxRQWdCM0I7QUFtQkgsQ0FBQyxFQTlFZ0IsY0FBYyxLQUFkLGNBQWMsUUE4RTlCO0FBRUQsTUFBTTtJQUNKLFlBQW9CLEdBQWdCLEVBQVUsS0FBa0IsRUFBVSxVQUFpQztRQUF2RixRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBYTtRQUFVLGVBQVUsR0FBVixVQUFVLENBQXVCO0lBQUcsQ0FBQztJQUUvRyxJQUFJO1FBQ0YsSUFBSSxNQUFNLEdBQWtDLEVBQUUsQ0FBQztRQUUvQyxHQUFHLENBQUEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDL0MsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQy9DLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4RCxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDdEQsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDekIsQ0FBQztRQUNILENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRU8sZUFBZSxDQUFDLEtBQWtDO1FBQ3hELElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDdEQsTUFBTSxDQUFDLENBQUMsZUFBZSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQzFGLENBQUM7SUFFTyxtQkFBbUIsQ0FBQyxJQUFxQztRQUMvRCxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBRTlCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZELElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDbEMsSUFBSSxLQUFLLEdBQUcsSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0RSxNQUFNLENBQUMsQ0FBQyxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksR0FBRyxHQUFrQyxFQUFFLENBQUM7WUFDNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNwQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1lBQzVCLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbEMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFDNUIsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUNiLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQThCO1FBQ2xDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFJLEtBQUssR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakQsTUFBTSxDQUFDLElBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUMvRCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21waWxlZFByb2dyYW0sIENvbXBpbGVkQmxvY2sgfSBmcm9tICcuL2NvbXBpbGVkL2Jsb2Nrcyc7XG5pbXBvcnQgeyBidWlsZGVyIH0gZnJvbSAnLi9jb21waWxlcic7XG5pbXBvcnQgT3Bjb2RlQnVpbGRlciBmcm9tICcuL2NvbXBpbGVkL29wY29kZXMvYnVpbGRlcic7XG5pbXBvcnQgRW52aXJvbm1lbnQgZnJvbSAnLi9lbnZpcm9ubWVudCc7XG5pbXBvcnQgeyBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IFNlcmlhbGl6ZWRUZW1wbGF0ZUJsb2NrLCBUZW1wbGF0ZU1ldGEsIFNlcmlhbGl6ZWRCbG9jaywgU3RhdGVtZW50IGFzIFNlcmlhbGl6ZWRTdGF0ZW1lbnQgfSBmcm9tICdAZ2xpbW1lci93aXJlLWZvcm1hdCc7XG5pbXBvcnQgKiBhcyBXaXJlRm9ybWF0IGZyb20gJ0BnbGltbWVyL3dpcmUtZm9ybWF0JztcbmltcG9ydCB7IGVudHJ5UG9pbnQgYXMgZW50cnlQb2ludFRhYmxlLCBsYXlvdXQgYXMgbGF5b3V0VGFibGUsIGJsb2NrIGFzIGJsb2NrVGFibGUgfSBmcm9tICcuL3N5bWJvbC10YWJsZSc7XG5pbXBvcnQgeyBPcGFxdWUsIFN5bWJvbFRhYmxlLCBQcm9ncmFtU3ltYm9sVGFibGUgfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcblxuaW1wb3J0IHtcbiAgU1RBVEVNRU5UU1xufSBmcm9tICcuL3N5bnRheC9mdW5jdGlvbnMnO1xuXG5pbXBvcnQge1xuICBTUEVDSUFMSVpFXG59IGZyb20gJy4vc3ludGF4L3NwZWNpYWxpemUnO1xuXG5leHBvcnQgdHlwZSBEZXNlcmlhbGl6ZWRTdGF0ZW1lbnQgPSBXaXJlRm9ybWF0LlN0YXRlbWVudCB8IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5BdHRyaWJ1dGUgfCBXaXJlRm9ybWF0LlN0YXRlbWVudHMuQXJndW1lbnQ7XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21waWxlU3RhdGVtZW50KHN0YXRlbWVudDogQmFzZWxpbmVTeW50YXguQW55U3RhdGVtZW50LCBidWlsZGVyOiBPcGNvZGVCdWlsZGVyKSB7XG4gIGxldCByZWZpbmVkID0gU1BFQ0lBTElaRS5zcGVjaWFsaXplKHN0YXRlbWVudCwgYnVpbGRlci5zeW1ib2xUYWJsZSk7XG4gIFNUQVRFTUVOVFMuY29tcGlsZShyZWZpbmVkLCBidWlsZGVyKTtcbn1cblxuZXhwb3J0IGNsYXNzIFRlbXBsYXRlIHtcbiAgY29uc3RydWN0b3IocHVibGljIHN0YXRlbWVudHM6IEJhc2VsaW5lU3ludGF4LkFueVN0YXRlbWVudFtdLCBwdWJsaWMgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlKSB7fVxufVxuXG5leHBvcnQgY2xhc3MgTGF5b3V0IGV4dGVuZHMgVGVtcGxhdGUge1xuICBwdWJsaWMgc3ltYm9sVGFibGU6IFByb2dyYW1TeW1ib2xUYWJsZTtcbn1cblxuZXhwb3J0IGNsYXNzIEVudHJ5UG9pbnQgZXh0ZW5kcyBUZW1wbGF0ZSB7XG4gIHB1YmxpYyBzeW1ib2xUYWJsZTogUHJvZ3JhbVN5bWJvbFRhYmxlO1xuXG4gIGNvbXBpbGUoZW52OiBFbnZpcm9ubWVudCk6IENvbXBpbGVkUHJvZ3JhbSB7XG4gICAgbGV0IHRhYmxlID0gdGhpcy5zeW1ib2xUYWJsZTtcblxuICAgIGxldCBiID0gYnVpbGRlcihlbnYsIHRhYmxlKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdGF0ZW1lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgc3RhdGVtZW50ID0gdGhpcy5zdGF0ZW1lbnRzW2ldO1xuICAgICAgbGV0IHJlZmluZWQgPSBTUEVDSUFMSVpFLnNwZWNpYWxpemUoc3RhdGVtZW50LCB0YWJsZSk7XG4gICAgICBTVEFURU1FTlRTLmNvbXBpbGUocmVmaW5lZCwgYik7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBDb21waWxlZFByb2dyYW0oYi50b1NsaWNlKCksIHRoaXMuc3ltYm9sVGFibGUuc2l6ZSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIElubGluZUJsb2NrIGV4dGVuZHMgVGVtcGxhdGUge1xuICBzcGxhdChidWlsZGVyOiBPcGNvZGVCdWlsZGVyKSB7XG4gICAgbGV0IHRhYmxlID0gYnVpbGRlci5zeW1ib2xUYWJsZTtcblxuICAgIGxldCBsb2NhbHMgPSB0YWJsZS5nZXRTeW1ib2xzKCkubG9jYWxzO1xuXG4gICAgaWYgKGxvY2Fscykge1xuICAgICAgYnVpbGRlci5wdXNoQ2hpbGRTY29wZSgpO1xuICAgICAgYnVpbGRlci5iaW5kUG9zaXRpb25hbEFyZ3NGb3JMb2NhbHMobG9jYWxzKTtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3RhdGVtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHN0YXRlbWVudCA9IHRoaXMuc3RhdGVtZW50c1tpXTtcbiAgICAgIGxldCByZWZpbmVkID0gU1BFQ0lBTElaRS5zcGVjaWFsaXplKHN0YXRlbWVudCwgdGFibGUpO1xuICAgICAgU1RBVEVNRU5UUy5jb21waWxlKHJlZmluZWQsIGJ1aWxkZXIpO1xuICAgIH1cblxuICAgIGlmIChsb2NhbHMpIHtcbiAgICAgIGJ1aWxkZXIucG9wU2NvcGUoKTtcbiAgICB9XG4gIH1cblxuICBjb21waWxlKGVudjogRW52aXJvbm1lbnQpOiBDb21waWxlZEJsb2NrIHtcbiAgICBsZXQgdGFibGUgPSB0aGlzLnN5bWJvbFRhYmxlO1xuICAgIGxldCBiID0gYnVpbGRlcihlbnYsIHRhYmxlKTtcblxuICAgIHRoaXMuc3BsYXQoYik7XG5cbiAgICByZXR1cm4gbmV3IENvbXBpbGVkQmxvY2soYi50b1NsaWNlKCkpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYXJ0aWFsQmxvY2sgZXh0ZW5kcyBUZW1wbGF0ZSB7XG4gIHB1YmxpYyBzeW1ib2xUYWJsZTogUHJvZ3JhbVN5bWJvbFRhYmxlO1xuXG4gIGNvbXBpbGUoZW52OiBFbnZpcm9ubWVudCk6IENvbXBpbGVkUHJvZ3JhbSB7XG4gICAgbGV0IHRhYmxlID0gdGhpcy5zeW1ib2xUYWJsZTtcbiAgICBsZXQgYiA9IGJ1aWxkZXIoZW52LCB0YWJsZSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3RhdGVtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHN0YXRlbWVudCA9IHRoaXMuc3RhdGVtZW50c1tpXTtcbiAgICAgIGxldCByZWZpbmVkID0gU1BFQ0lBTElaRS5zcGVjaWFsaXplKHN0YXRlbWVudCwgdGFibGUpO1xuICAgICAgU1RBVEVNRU5UUy5jb21waWxlKHJlZmluZWQsIGIpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgQ29tcGlsZWRQcm9ncmFtKGIudG9TbGljZSgpLCB0YWJsZS5zaXplKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTY2FubmVyIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBibG9jazogU2VyaWFsaXplZFRlbXBsYXRlQmxvY2ssIHByaXZhdGUgbWV0YTogVGVtcGxhdGVNZXRhLCBwcml2YXRlIGVudjogRW52aXJvbm1lbnQpIHtcbiAgfVxuXG4gIHNjYW5FbnRyeVBvaW50KCk6IEVudHJ5UG9pbnQge1xuICAgIGxldCB7IGJsb2NrLCBtZXRhIH0gPSB0aGlzO1xuXG4gICAgbGV0IHN5bWJvbFRhYmxlID0gZW50cnlQb2ludFRhYmxlKG1ldGEpO1xuICAgIGxldCBjaGlsZCA9IHNjYW5CbG9jayhibG9jaywgc3ltYm9sVGFibGUsIHRoaXMuZW52KTtcbiAgICByZXR1cm4gbmV3IEVudHJ5UG9pbnQoY2hpbGQuc3RhdGVtZW50cywgc3ltYm9sVGFibGUpO1xuICB9XG5cbiAgc2NhbkxheW91dCgpOiBMYXlvdXQge1xuICAgIGxldCB7IGJsb2NrLCBtZXRhIH0gPSB0aGlzO1xuICAgIGxldCB7IG5hbWVkLCB5aWVsZHMsIGhhc1BhcnRpYWxzIH0gPSBibG9jaztcblxuICAgIGxldCBzeW1ib2xUYWJsZSA9IGxheW91dFRhYmxlKG1ldGEsIG5hbWVkLCB5aWVsZHMsIGhhc1BhcnRpYWxzKTtcbiAgICBsZXQgY2hpbGQgPSBzY2FuQmxvY2soYmxvY2ssIHN5bWJvbFRhYmxlLCB0aGlzLmVudik7XG5cbiAgICByZXR1cm4gbmV3IExheW91dChjaGlsZC5zdGF0ZW1lbnRzLCBzeW1ib2xUYWJsZSk7XG4gIH1cblxuICBzY2FuUGFydGlhbChzeW1ib2xUYWJsZTogU3ltYm9sVGFibGUpOiBQYXJ0aWFsQmxvY2sge1xuICAgIGxldCB7IGJsb2NrIH0gPSB0aGlzO1xuXG4gICAgbGV0IGNoaWxkID0gc2NhbkJsb2NrKGJsb2NrLCBzeW1ib2xUYWJsZSwgdGhpcy5lbnYpO1xuXG4gICAgcmV0dXJuIG5ldyBQYXJ0aWFsQmxvY2soY2hpbGQuc3RhdGVtZW50cywgc3ltYm9sVGFibGUpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzY2FuQmxvY2soeyBzdGF0ZW1lbnRzIH06IFNlcmlhbGl6ZWRCbG9jaywgc3ltYm9sVGFibGU6IFN5bWJvbFRhYmxlLCBlbnY6IEVudmlyb25tZW50KTogSW5saW5lQmxvY2sge1xuICByZXR1cm4gbmV3IFJhd0lubGluZUJsb2NrKGVudiwgc3ltYm9sVGFibGUsIHN0YXRlbWVudHMpLnNjYW4oKTtcbn1cblxuaW1wb3J0IHsgUHVibGljVk0gfSBmcm9tICcuL3ZtJztcbmltcG9ydCB7IFBhdGhSZWZlcmVuY2UgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuXG5leHBvcnQgbmFtZXNwYWNlIEJhc2VsaW5lU3ludGF4IHtcbiAgaW1wb3J0IENvcmUgPSBXaXJlRm9ybWF0LkNvcmU7XG5cbiAgLy8gVE9ETzogdXNlIHN5bWJvbHMgZm9yIHNleHBbMF0/XG4gIGV4cG9ydCB0eXBlIFNjYW5uZWRDb21wb25lbnQgPSBbJ3NjYW5uZWQtY29tcG9uZW50Jywgc3RyaW5nLCBSYXdJbmxpbmVCbG9jaywgV2lyZUZvcm1hdC5Db3JlLkhhc2gsIE9wdGlvbjxSYXdJbmxpbmVCbG9jaz5dO1xuICBleHBvcnQgY29uc3QgaXNTY2FubmVkQ29tcG9uZW50ID0gV2lyZUZvcm1hdC5pczxTY2FubmVkQ29tcG9uZW50Pignc2Nhbm5lZC1jb21wb25lbnQnKTtcblxuICBpbXBvcnQgUGFyYW1zID0gV2lyZUZvcm1hdC5Db3JlLlBhcmFtcztcbiAgaW1wb3J0IEhhc2ggPSBXaXJlRm9ybWF0LkNvcmUuSGFzaDtcbiAgZXhwb3J0IHR5cGUgQmxvY2sgPSBJbmxpbmVCbG9jaztcblxuICBleHBvcnQgdHlwZSBPcGVuUHJpbWl0aXZlRWxlbWVudCA9IFsnb3Blbi1wcmltaXRpdmUtZWxlbWVudCcsIHN0cmluZywgc3RyaW5nW11dO1xuICBleHBvcnQgY29uc3QgaXNQcmltaXRpdmVFbGVtZW50ID0gV2lyZUZvcm1hdC5pczxPcGVuUHJpbWl0aXZlRWxlbWVudD4oJ29wZW4tcHJpbWl0aXZlLWVsZW1lbnQnKTtcblxuICBleHBvcnQgdHlwZSBPcHRpbWl6ZWRBcHBlbmQgPSBbJ29wdGltaXplZC1hcHBlbmQnLCBXaXJlRm9ybWF0LkV4cHJlc3Npb24sIGJvb2xlYW5dO1xuICBleHBvcnQgY29uc3QgaXNPcHRpbWl6ZWRBcHBlbmQgPSBXaXJlRm9ybWF0LmlzPE9wdGltaXplZEFwcGVuZD4oJ29wdGltaXplZC1hcHBlbmQnKTtcblxuICBleHBvcnQgdHlwZSBVbm9wdGltaXplZEFwcGVuZCA9IFsndW5vcHRpbWl6ZWQtYXBwZW5kJywgV2lyZUZvcm1hdC5FeHByZXNzaW9uLCBib29sZWFuXTtcbiAgZXhwb3J0IGNvbnN0IGlzVW5vcHRpbWl6ZWRBcHBlbmQgPSBXaXJlRm9ybWF0LmlzPFVub3B0aW1pemVkQXBwZW5kPigndW5vcHRpbWl6ZWQtYXBwZW5kJyk7XG5cbiAgZXhwb3J0IHR5cGUgQW55RHluYW1pY0F0dHIgPSBbJ2FueS1keW5hbWljLWF0dHInLCBzdHJpbmcsIFdpcmVGb3JtYXQuRXhwcmVzc2lvbiwgT3B0aW9uPHN0cmluZz4sIGJvb2xlYW5dO1xuICBleHBvcnQgY29uc3QgaXNBbnlBdHRyID0gV2lyZUZvcm1hdC5pczxBbnlEeW5hbWljQXR0cj4oJ2FueS1keW5hbWljLWF0dHInKTtcblxuICBleHBvcnQgdHlwZSBTdGF0aWNQYXJ0aWFsID0gWydzdGF0aWMtcGFydGlhbCcsIHN0cmluZ107XG4gIGV4cG9ydCBjb25zdCBpc1N0YXRpY1BhcnRpYWwgPSBXaXJlRm9ybWF0LmlzPFN0YXRpY1BhcnRpYWw+KCdzdGF0aWMtcGFydGlhbCcpO1xuICBleHBvcnQgdHlwZSBEeW5hbWljUGFydGlhbCA9IFsnZHluYW1pYy1wYXJ0aWFsJywgV2lyZUZvcm1hdC5FeHByZXNzaW9uXTtcbiAgZXhwb3J0IGNvbnN0IGlzRHluYW1pY1BhcnRpYWwgPSBXaXJlRm9ybWF0LmlzPER5bmFtaWNQYXJ0aWFsPignZHluYW1pYy1wYXJ0aWFsJyk7XG5cbiAgZXhwb3J0IHR5cGUgRnVuY3Rpb25FeHByZXNzaW9uQ2FsbGJhY2s8VD4gPSAoVk06IFB1YmxpY1ZNLCBzeW1ib2xUYWJsZTogU3ltYm9sVGFibGUpID0+IFBhdGhSZWZlcmVuY2U8VD47XG4gIGV4cG9ydCB0eXBlIEZ1bmN0aW9uRXhwcmVzc2lvbiA9IFsnZnVuY3Rpb24nLCBGdW5jdGlvbkV4cHJlc3Npb25DYWxsYmFjazxPcGFxdWU+XTtcbiAgZXhwb3J0IGNvbnN0IGlzRnVuY3Rpb25FeHByZXNzaW9uID0gV2lyZUZvcm1hdC5pczxGdW5jdGlvbkV4cHJlc3Npb24+KCdmdW5jdGlvbicpO1xuXG4gIGV4cG9ydCB0eXBlIE5lc3RlZEJsb2NrID0gWyduZXN0ZWQtYmxvY2snLCBXaXJlRm9ybWF0LkNvcmUuUGF0aCwgV2lyZUZvcm1hdC5Db3JlLlBhcmFtcywgV2lyZUZvcm1hdC5Db3JlLkhhc2gsIE9wdGlvbjxCbG9jaz4sIE9wdGlvbjxCbG9jaz5dO1xuICBleHBvcnQgY29uc3QgaXNOZXN0ZWRCbG9jayA9IFdpcmVGb3JtYXQuaXM8TmVzdGVkQmxvY2s+KCduZXN0ZWQtYmxvY2snKTtcblxuICBleHBvcnQgdHlwZSBTY2FubmVkQmxvY2sgPSBbJ3NjYW5uZWQtYmxvY2snLCBDb3JlLlBhdGgsIENvcmUuUGFyYW1zLCBDb3JlLkhhc2gsIE9wdGlvbjxSYXdJbmxpbmVCbG9jaz4sIE9wdGlvbjxSYXdJbmxpbmVCbG9jaz5dO1xuICBleHBvcnQgY29uc3QgaXNTY2FubmVkQmxvY2sgPSBXaXJlRm9ybWF0LmlzPFNjYW5uZWRCbG9jaz4oJ3NjYW5uZWQtYmxvY2snKTtcblxuICBleHBvcnQgdHlwZSBEZWJ1Z2dlciA9IFsnZGVidWdnZXInXTtcbiAgZXhwb3J0IGNvbnN0IGlzRGVidWdnZXIgPSBXaXJlRm9ybWF0LmlzPERlYnVnZ2VyPignZGVidWdnZXInKTtcblxuICBleHBvcnQgdHlwZSBBcmdzID0gW1BhcmFtcywgSGFzaCwgT3B0aW9uPEJsb2NrPiwgT3B0aW9uPEJsb2NrPl07XG5cbiAgZXhwb3J0IG5hbWVzcGFjZSBOZXN0ZWRCbG9jayB7XG4gICAgZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRCbG9jayhzZXhwOiBOZXN0ZWRCbG9jayk6IE9wdGlvbjxJbmxpbmVCbG9jaz4ge1xuICAgICAgcmV0dXJuIHNleHBbNF07XG4gICAgfVxuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIGludmVyc2VCbG9jayhzZXhwOiBOZXN0ZWRCbG9jayk6IE9wdGlvbjxJbmxpbmVCbG9jaz4ge1xuICAgICAgcmV0dXJuIHNleHBbNV07XG4gICAgfVxuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIHBhcmFtcyhzZXhwOiBOZXN0ZWRCbG9jayk6IFdpcmVGb3JtYXQuQ29yZS5QYXJhbXMge1xuICAgICAgcmV0dXJuIHNleHBbMl07XG4gICAgfVxuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIGhhc2goc2V4cDogTmVzdGVkQmxvY2spOiBXaXJlRm9ybWF0LkNvcmUuSGFzaCB7XG4gICAgICByZXR1cm4gc2V4cFszXTtcbiAgICB9XG4gIH1cblxuICBleHBvcnQgdHlwZSBTdGF0ZW1lbnQgPVxuICAgICAgU2Nhbm5lZENvbXBvbmVudFxuICAgIHwgT3BlblByaW1pdGl2ZUVsZW1lbnRcbiAgICB8IE9wdGltaXplZEFwcGVuZFxuICAgIHwgVW5vcHRpbWl6ZWRBcHBlbmRcbiAgICB8IFN0YXRpY1BhcnRpYWxcbiAgICB8IER5bmFtaWNQYXJ0aWFsXG4gICAgfCBBbnlEeW5hbWljQXR0clxuICAgIHwgTmVzdGVkQmxvY2tcbiAgICB8IFNjYW5uZWRCbG9ja1xuICAgIHwgRGVidWdnZXJcbiAgICA7XG5cbiAgZXhwb3J0IHR5cGUgQW55U3RhdGVtZW50ID0gU3RhdGVtZW50IHwgV2lyZUZvcm1hdC5TdGF0ZW1lbnQ7XG4gIGV4cG9ydCB0eXBlIEFueUV4cHJlc3Npb24gPSBGdW5jdGlvbkV4cHJlc3Npb24gfCBXaXJlRm9ybWF0LkV4cHJlc3Npb247XG5cbiAgZXhwb3J0IHR5cGUgUHJvZ3JhbSA9IEFueVN0YXRlbWVudFtdO1xufVxuXG5leHBvcnQgY2xhc3MgUmF3SW5saW5lQmxvY2sge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVudjogRW52aXJvbm1lbnQsIHByaXZhdGUgdGFibGU6IFN5bWJvbFRhYmxlLCBwcml2YXRlIHN0YXRlbWVudHM6IFNlcmlhbGl6ZWRTdGF0ZW1lbnRbXSkge31cblxuICBzY2FuKCk6IElubGluZUJsb2NrIHtcbiAgICBsZXQgYnVmZmVyOiBCYXNlbGluZVN5bnRheC5BbnlTdGF0ZW1lbnRbXSA9IFtdO1xuXG4gICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuc3RhdGVtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHN0YXRlbWVudCA9IHRoaXMuc3RhdGVtZW50c1tpXTtcbiAgICAgIGlmIChXaXJlRm9ybWF0LlN0YXRlbWVudHMuaXNCbG9jayhzdGF0ZW1lbnQpKSB7XG4gICAgICAgIGJ1ZmZlci5wdXNoKHRoaXMuc3BlY2lhbGl6ZUJsb2NrKHN0YXRlbWVudCkpO1xuICAgICAgfSBlbHNlIGlmIChXaXJlRm9ybWF0LlN0YXRlbWVudHMuaXNDb21wb25lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICBidWZmZXIucHVzaCguLi50aGlzLnNwZWNpYWxpemVDb21wb25lbnQoc3RhdGVtZW50KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBidWZmZXIucHVzaChzdGF0ZW1lbnQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXcgSW5saW5lQmxvY2soYnVmZmVyLCB0aGlzLnRhYmxlKTtcbiAgfVxuXG4gIHByaXZhdGUgc3BlY2lhbGl6ZUJsb2NrKGJsb2NrOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuQmxvY2spOiBCYXNlbGluZVN5bnRheC5TY2FubmVkQmxvY2sge1xuICAgIGxldCBbLCBwYXRoLCBwYXJhbXMsIGhhc2gsIHRlbXBsYXRlLCBpbnZlcnNlXSA9IGJsb2NrO1xuICAgIHJldHVybiBbJ3NjYW5uZWQtYmxvY2snLCBwYXRoLCBwYXJhbXMsIGhhc2gsIHRoaXMuY2hpbGQodGVtcGxhdGUpLCB0aGlzLmNoaWxkKGludmVyc2UpXTtcbiAgfVxuXG4gIHByaXZhdGUgc3BlY2lhbGl6ZUNvbXBvbmVudChzZXhwOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuQ29tcG9uZW50KTogQmFzZWxpbmVTeW50YXguQW55U3RhdGVtZW50W10ge1xuICAgIGxldCBbLCB0YWcsIGNvbXBvbmVudF0gPSBzZXhwO1xuXG4gICAgaWYgKHRoaXMuZW52Lmhhc0NvbXBvbmVudERlZmluaXRpb24oW3RhZ10sIHRoaXMudGFibGUpKSB7XG4gICAgICBsZXQgY2hpbGQgPSB0aGlzLmNoaWxkKGNvbXBvbmVudCk7XG4gICAgICBsZXQgYXR0cnMgPSBuZXcgUmF3SW5saW5lQmxvY2sodGhpcy5lbnYsIHRoaXMudGFibGUsIGNvbXBvbmVudC5hdHRycyk7XG4gICAgICByZXR1cm4gW1snc2Nhbm5lZC1jb21wb25lbnQnLCB0YWcsIGF0dHJzLCBjb21wb25lbnQuYXJncywgY2hpbGRdXTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGJ1ZjogQmFzZWxpbmVTeW50YXguQW55U3RhdGVtZW50W10gPSBbXTtcbiAgICAgIGJ1Zi5wdXNoKFsnb3Blbi1lbGVtZW50JywgdGFnLCBbXV0pO1xuICAgICAgYnVmLnB1c2goLi4uY29tcG9uZW50LmF0dHJzKTtcbiAgICAgIGJ1Zi5wdXNoKFsnZmx1c2gtZWxlbWVudCddKTtcbiAgICAgIGJ1Zi5wdXNoKC4uLmNvbXBvbmVudC5zdGF0ZW1lbnRzKTtcbiAgICAgIGJ1Zi5wdXNoKFsnY2xvc2UtZWxlbWVudCddKTtcbiAgICAgIHJldHVybiBidWY7XG4gICAgfVxuICB9XG5cbiAgY2hpbGQoYmxvY2s6IE9wdGlvbjxTZXJpYWxpemVkQmxvY2s+KTogT3B0aW9uPFJhd0lubGluZUJsb2NrPiB7XG4gICAgaWYgKCFibG9jaykgcmV0dXJuIG51bGw7XG4gICAgbGV0IHRhYmxlID0gYmxvY2tUYWJsZSh0aGlzLnRhYmxlLCBibG9jay5sb2NhbHMpO1xuICAgIHJldHVybiBuZXcgUmF3SW5saW5lQmxvY2sodGhpcy5lbnYsIHRhYmxlLCBibG9jay5zdGF0ZW1lbnRzKTtcbiAgfVxufVxuIl19