import { UpdatingOpcode } from '../../opcodes';
import { Assert } from './vm';
import { EvaluatedArgs } from '../../compiled/expressions/args';
import { CONSTANT_TAG, ReferenceCache, combine, isConst } from '@glimmer/reference';
import { APPEND_OPCODES, OpcodeName as Op } from '../../opcodes';
APPEND_OPCODES.add(Op.PutDynamicComponent, vm => {
    let reference = vm.frame.getOperand();
    let cache = isConst(reference) ? undefined : new ReferenceCache(reference);
    let definition = cache ? cache.peek() : reference.value();
    vm.frame.setImmediate(definition);
    if (cache) {
        vm.updateWith(new Assert(cache));
    }
});
APPEND_OPCODES.add(Op.PutComponent, (vm, { op1: _component }) => {
    let definition = vm.constants.getOther(_component);
    vm.frame.setImmediate(definition);
});
APPEND_OPCODES.add(Op.OpenComponent, (vm, { op1: _args, op2: _shadow }) => {
    let rawArgs = vm.constants.getExpression(_args);
    let shadow = vm.constants.getBlock(_shadow);
    let definition = vm.frame.getImmediate();
    let dynamicScope = vm.pushDynamicScope();
    let callerScope = vm.scope();
    let manager = definition.manager;
    let args = manager.prepareArgs(definition, rawArgs.evaluate(vm), dynamicScope);
    let hasDefaultBlock = !!args.blocks.default; // TODO Cleanup?
    let component = manager.create(vm.env, definition, args, dynamicScope, vm.getSelf(), hasDefaultBlock);
    let destructor = manager.getDestructor(component);
    if (destructor)
        vm.newDestroyable(destructor);
    let layout = manager.layoutFor(definition, component, vm.env);
    let selfRef = manager.getSelf(component);
    vm.beginCacheGroup();
    vm.stack().pushSimpleBlock();
    vm.pushRootScope(selfRef, layout.symbols);
    vm.invokeLayout(args, layout, callerScope, component, manager, shadow);
    vm.updateWith(new UpdateComponentOpcode(definition.name, component, manager, args, dynamicScope));
});
// export class DidCreateElementOpcode extends Opcode {
//   public type = "did-create-element";
//   evaluate(vm: VM) {
//     let manager = vm.frame.getManager();
//     let component = vm.frame.getComponent();
//     let action = 'DidCreateElementOpcode#evaluate';
//     manager.didCreateElement(component, vm.stack().expectConstructing(action), vm.stack().expectOperations(action));
//   }
//   toJSON(): OpcodeJSON {
//     return {
//       guid: this._guid,
//       type: this.type,
//       args: ["$ARGS"]
//     };
//   }
// }
APPEND_OPCODES.add(Op.DidCreateElement, vm => {
    let manager = vm.frame.getManager();
    let component = vm.frame.getComponent();
    let action = 'DidCreateElementOpcode#evaluate';
    manager.didCreateElement(component, vm.stack().expectConstructing(action), vm.stack().expectOperations(action));
});
// export class ShadowAttributesOpcode extends Opcode {
//   public type = "shadow-attributes";
//   evaluate(vm: VM) {
//     let shadow = vm.frame.getShadow();
//     vm.pushCallerScope();
//     if (!shadow) return;
//     vm.invokeBlock(shadow, EvaluatedArgs.empty());
//   }
//   toJSON(): OpcodeJSON {
//     return {
//       guid: this._guid,
//       type: this.type,
//       args: ["$ARGS"]
//     };
//   }
// }
// Slow path for non-specialized component invocations. Uses an internal
// named lookup on the args.
APPEND_OPCODES.add(Op.ShadowAttributes, vm => {
    let shadow = vm.frame.getShadow();
    vm.pushCallerScope();
    if (!shadow)
        return;
    vm.invokeBlock(shadow, EvaluatedArgs.empty());
});
// export class DidRenderLayoutOpcode extends Opcode {
//   public type = "did-render-layout";
//   evaluate(vm: VM) {
//     let manager = vm.frame.getManager();
//     let component = vm.frame.getComponent();
//     let bounds = vm.stack().popBlock();
//     manager.didRenderLayout(component, bounds);
//     vm.env.didCreate(component, manager);
//     vm.updateWith(new DidUpdateLayoutOpcode(manager, component, bounds));
//   }
// }
APPEND_OPCODES.add(Op.DidRenderLayout, vm => {
    let manager = vm.frame.getManager();
    let component = vm.frame.getComponent();
    let bounds = vm.stack().popBlock();
    manager.didRenderLayout(component, bounds);
    vm.env.didCreate(component, manager);
    vm.updateWith(new DidUpdateLayoutOpcode(manager, component, bounds));
});
// export class CloseComponentOpcode extends Opcode {
//   public type = "close-component";
//   evaluate(vm: VM) {
//     vm.popScope();
//     vm.popDynamicScope();
//     vm.commitCacheGroup();
//   }
// }
APPEND_OPCODES.add(Op.CloseComponent, vm => {
    vm.popScope();
    vm.popDynamicScope();
    vm.commitCacheGroup();
});
export class UpdateComponentOpcode extends UpdatingOpcode {
    constructor(name, component, manager, args, dynamicScope) {
        super();
        this.name = name;
        this.component = component;
        this.manager = manager;
        this.args = args;
        this.dynamicScope = dynamicScope;
        this.type = "update-component";
        let componentTag = manager.getTag(component);
        if (componentTag) {
            this.tag = combine([args.tag, componentTag]);
        }
        else {
            this.tag = args.tag;
        }
    }
    evaluate(_vm) {
        let { component, manager, args, dynamicScope } = this;
        manager.update(component, args, dynamicScope);
    }
    toJSON() {
        return {
            guid: this._guid,
            type: this.type,
            args: [JSON.stringify(this.name)]
        };
    }
}
export class DidUpdateLayoutOpcode extends UpdatingOpcode {
    constructor(manager, component, bounds) {
        super();
        this.manager = manager;
        this.component = component;
        this.bounds = bounds;
        this.type = "did-update-layout";
        this.tag = CONSTANT_TAG;
    }
    evaluate(vm) {
        let { manager, component, bounds } = this;
        manager.didUpdateLayout(component, bounds);
        vm.env.didUpdate(component, manager);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQGdsaW1tZXIvcnVudGltZS9saWIvY29tcGlsZWQvb3Bjb2Rlcy9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRzlCLE9BQU8sRUFBZ0IsYUFBYSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFHOUUsT0FBTyxFQUFFLFlBQVksRUFBRSxjQUFjLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBZSxNQUFNLG9CQUFvQixDQUFDO0FBQ2pHLE9BQU8sRUFBRSxjQUFjLEVBQUUsVUFBVSxJQUFJLEVBQUUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVqRSxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFO0lBQzNDLElBQUksU0FBUyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFrQyxDQUFDO0lBQ3RFLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxTQUFTLEdBQUcsSUFBSSxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDM0UsSUFBSSxVQUFVLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7SUFFMUQsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7SUFFbEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNWLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNuQyxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVB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SSxHQUFHLG1CQUFtQixDQUFDO1FBQzNCLFFBQUcsR0FBZ0IsWUFBWSxDQUFDO0lBUXZDLENBQUM7SUFFRCxRQUFRLENBQUMsRUFBYztRQUNyQixJQUFJLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFFMUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFM0MsRUFBRSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9wY29kZUpTT04sIFVwZGF0aW5nT3Bjb2RlIH0gZnJvbSAnLi4vLi4vb3Bjb2Rlcyc7XG5pbXBvcnQgeyBBc3NlcnQgfSBmcm9tICcuL3ZtJztcbmltcG9ydCB7IENvbXBvbmVudCwgQ29tcG9uZW50TWFuYWdlciwgQ29tcG9uZW50RGVmaW5pdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvbmVudC9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFVwZGF0aW5nVk0gfSBmcm9tICcuLi8uLi92bSc7XG5pbXBvcnQgeyBDb21waWxlZEFyZ3MsIEV2YWx1YXRlZEFyZ3MgfSBmcm9tICcuLi8uLi9jb21waWxlZC9leHByZXNzaW9ucy9hcmdzJztcbmltcG9ydCB7IER5bmFtaWNTY29wZSB9IGZyb20gJy4uLy4uL2Vudmlyb25tZW50JztcbmltcG9ydCBCb3VuZHMgZnJvbSAnLi4vLi4vYm91bmRzJztcbmltcG9ydCB7IENPTlNUQU5UX1RBRywgUmVmZXJlbmNlQ2FjaGUsIGNvbWJpbmUsIGlzQ29uc3QsIFJldmlzaW9uVGFnIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCB7IEFQUEVORF9PUENPREVTLCBPcGNvZGVOYW1lIGFzIE9wIH0gZnJvbSAnLi4vLi4vb3Bjb2Rlcyc7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5QdXREeW5hbWljQ29tcG9uZW50LCB2bSA9PiB7XG4gIGxldCByZWZlcmVuY2UgPSB2bS5mcmFtZS5nZXRPcGVyYW5kPENvbXBvbmVudERlZmluaXRpb248Q29tcG9uZW50Pj4oKTtcbiAgbGV0IGNhY2hlID0gaXNDb25zdChyZWZlcmVuY2UpID8gdW5kZWZpbmVkIDogbmV3IFJlZmVyZW5jZUNhY2hlKHJlZmVyZW5jZSk7XG4gIGxldCBkZWZpbml0aW9uID0gY2FjaGUgPyBjYWNoZS5wZWVrKCkgOiByZWZlcmVuY2UudmFsdWUoKTtcblxuICB2bS5mcmFtZS5zZXRJbW1lZGlhdGUoZGVmaW5pdGlvbik7XG5cbiAgaWYgKGNhY2hlKSB7XG4gICAgdm0udXBkYXRlV2l0aChuZXcgQXNzZXJ0KGNhY2hlKSk7XG4gIH1cbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUHV0Q29tcG9uZW50LCAodm0sIHsgb3AxOiBfY29tcG9uZW50IH0pID0+IHtcbiAgbGV0IGRlZmluaXRpb24gPSB2bS5jb25zdGFudHMuZ2V0T3RoZXI8Q29tcG9uZW50RGVmaW5pdGlvbjxDb21wb25lbnQ+PihfY29tcG9uZW50KTtcbiAgdm0uZnJhbWUuc2V0SW1tZWRpYXRlKGRlZmluaXRpb24pO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5PcGVuQ29tcG9uZW50LCAodm0sIHsgb3AxOiBfYXJncywgb3AyOiBfc2hhZG93IH0pID0+IHtcbiAgbGV0IHJhd0FyZ3MgPSB2bS5jb25zdGFudHMuZ2V0RXhwcmVzc2lvbjxDb21waWxlZEFyZ3M+KF9hcmdzKTtcbiAgbGV0IHNoYWRvdyA9IHZtLmNvbnN0YW50cy5nZXRCbG9jayhfc2hhZG93KTtcblxuICBsZXQgZGVmaW5pdGlvbiA9IHZtLmZyYW1lLmdldEltbWVkaWF0ZTxDb21wb25lbnREZWZpbml0aW9uPENvbXBvbmVudD4+KCk7XG4gIGxldCBkeW5hbWljU2NvcGUgPSB2bS5wdXNoRHluYW1pY1Njb3BlKCk7XG4gIGxldCBjYWxsZXJTY29wZSA9IHZtLnNjb3BlKCk7XG5cbiAgbGV0IG1hbmFnZXIgPSBkZWZpbml0aW9uLm1hbmFnZXI7XG4gIGxldCBhcmdzID0gbWFuYWdlci5wcmVwYXJlQXJncyhkZWZpbml0aW9uLCByYXdBcmdzLmV2YWx1YXRlKHZtKSwgZHluYW1pY1Njb3BlKTtcbiAgbGV0IGhhc0RlZmF1bHRCbG9jayA9ICEhYXJncy5ibG9ja3MuZGVmYXVsdDsgLy8gVE9ETyBDbGVhbnVwP1xuICBsZXQgY29tcG9uZW50ID0gbWFuYWdlci5jcmVhdGUodm0uZW52LCBkZWZpbml0aW9uLCBhcmdzLCBkeW5hbWljU2NvcGUsIHZtLmdldFNlbGYoKSwgaGFzRGVmYXVsdEJsb2NrKTtcbiAgbGV0IGRlc3RydWN0b3IgPSBtYW5hZ2VyLmdldERlc3RydWN0b3IoY29tcG9uZW50KTtcbiAgaWYgKGRlc3RydWN0b3IpIHZtLm5ld0Rlc3Ryb3lhYmxlKGRlc3RydWN0b3IpO1xuXG4gIGxldCBsYXlvdXQgPSBtYW5hZ2VyLmxheW91dEZvcihkZWZpbml0aW9uLCBjb21wb25lbnQsIHZtLmVudik7XG4gIGxldCBzZWxmUmVmID0gbWFuYWdlci5nZXRTZWxmKGNvbXBvbmVudCk7XG5cbiAgdm0uYmVnaW5DYWNoZUdyb3VwKCk7XG4gIHZtLnN0YWNrKCkucHVzaFNpbXBsZUJsb2NrKCk7XG4gIHZtLnB1c2hSb290U2NvcGUoc2VsZlJlZiwgbGF5b3V0LnN5bWJvbHMpO1xuICB2bS5pbnZva2VMYXlvdXQoYXJncywgbGF5b3V0LCBjYWxsZXJTY29wZSwgY29tcG9uZW50LCBtYW5hZ2VyLCBzaGFkb3cpO1xuXG4gIHZtLnVwZGF0ZVdpdGgobmV3IFVwZGF0ZUNvbXBvbmVudE9wY29kZShkZWZpbml0aW9uLm5hbWUsIGNvbXBvbmVudCwgbWFuYWdlciwgYXJncywgZHluYW1pY1Njb3BlKSk7XG59KTtcblxuLy8gZXhwb3J0IGNsYXNzIERpZENyZWF0ZUVsZW1lbnRPcGNvZGUgZXh0ZW5kcyBPcGNvZGUge1xuLy8gICBwdWJsaWMgdHlwZSA9IFwiZGlkLWNyZWF0ZS1lbGVtZW50XCI7XG5cbi8vICAgZXZhbHVhdGUodm06IFZNKSB7XG4vLyAgICAgbGV0IG1hbmFnZXIgPSB2bS5mcmFtZS5nZXRNYW5hZ2VyKCk7XG4vLyAgICAgbGV0IGNvbXBvbmVudCA9IHZtLmZyYW1lLmdldENvbXBvbmVudCgpO1xuXG4vLyAgICAgbGV0IGFjdGlvbiA9ICdEaWRDcmVhdGVFbGVtZW50T3Bjb2RlI2V2YWx1YXRlJztcbi8vICAgICBtYW5hZ2VyLmRpZENyZWF0ZUVsZW1lbnQoY29tcG9uZW50LCB2bS5zdGFjaygpLmV4cGVjdENvbnN0cnVjdGluZyhhY3Rpb24pLCB2bS5zdGFjaygpLmV4cGVjdE9wZXJhdGlvbnMoYWN0aW9uKSk7XG4vLyAgIH1cblxuLy8gICB0b0pTT04oKTogT3Bjb2RlSlNPTiB7XG4vLyAgICAgcmV0dXJuIHtcbi8vICAgICAgIGd1aWQ6IHRoaXMuX2d1aWQsXG4vLyAgICAgICB0eXBlOiB0aGlzLnR5cGUsXG4vLyAgICAgICBhcmdzOiBbXCIkQVJHU1wiXVxuLy8gICAgIH07XG4vLyAgIH1cbi8vIH1cblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkRpZENyZWF0ZUVsZW1lbnQsIHZtID0+IHtcbiAgbGV0IG1hbmFnZXIgPSB2bS5mcmFtZS5nZXRNYW5hZ2VyKCk7XG4gIGxldCBjb21wb25lbnQgPSB2bS5mcmFtZS5nZXRDb21wb25lbnQoKTtcblxuICBsZXQgYWN0aW9uID0gJ0RpZENyZWF0ZUVsZW1lbnRPcGNvZGUjZXZhbHVhdGUnO1xuICBtYW5hZ2VyLmRpZENyZWF0ZUVsZW1lbnQoY29tcG9uZW50LCB2bS5zdGFjaygpLmV4cGVjdENvbnN0cnVjdGluZyhhY3Rpb24pLCB2bS5zdGFjaygpLmV4cGVjdE9wZXJhdGlvbnMoYWN0aW9uKSk7XG59KTtcblxuLy8gZXhwb3J0IGNsYXNzIFNoYWRvd0F0dHJpYnV0ZXNPcGNvZGUgZXh0ZW5kcyBPcGNvZGUge1xuLy8gICBwdWJsaWMgdHlwZSA9IFwic2hhZG93LWF0dHJpYnV0ZXNcIjtcblxuLy8gICBldmFsdWF0ZSh2bTogVk0pIHtcbi8vICAgICBsZXQgc2hhZG93ID0gdm0uZnJhbWUuZ2V0U2hhZG93KCk7XG5cbi8vICAgICB2bS5wdXNoQ2FsbGVyU2NvcGUoKTtcbi8vICAgICBpZiAoIXNoYWRvdykgcmV0dXJuO1xuXG4vLyAgICAgdm0uaW52b2tlQmxvY2soc2hhZG93LCBFdmFsdWF0ZWRBcmdzLmVtcHR5KCkpO1xuLy8gICB9XG5cbi8vICAgdG9KU09OKCk6IE9wY29kZUpTT04ge1xuLy8gICAgIHJldHVybiB7XG4vLyAgICAgICBndWlkOiB0aGlzLl9ndWlkLFxuLy8gICAgICAgdHlwZTogdGhpcy50eXBlLFxuLy8gICAgICAgYXJnczogW1wiJEFSR1NcIl1cbi8vICAgICB9O1xuLy8gICB9XG4vLyB9XG5cbi8vIFNsb3cgcGF0aCBmb3Igbm9uLXNwZWNpYWxpemVkIGNvbXBvbmVudCBpbnZvY2F0aW9ucy4gVXNlcyBhbiBpbnRlcm5hbFxuLy8gbmFtZWQgbG9va3VwIG9uIHRoZSBhcmdzLlxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlNoYWRvd0F0dHJpYnV0ZXMsIHZtID0+IHtcbiAgbGV0IHNoYWRvdyA9IHZtLmZyYW1lLmdldFNoYWRvdygpO1xuXG4gIHZtLnB1c2hDYWxsZXJTY29wZSgpO1xuICBpZiAoIXNoYWRvdykgcmV0dXJuO1xuXG4gIHZtLmludm9rZUJsb2NrKHNoYWRvdywgRXZhbHVhdGVkQXJncy5lbXB0eSgpKTtcbn0pO1xuXG4vLyBleHBvcnQgY2xhc3MgRGlkUmVuZGVyTGF5b3V0T3Bjb2RlIGV4dGVuZHMgT3Bjb2RlIHtcbi8vICAgcHVibGljIHR5cGUgPSBcImRpZC1yZW5kZXItbGF5b3V0XCI7XG5cbi8vICAgZXZhbHVhdGUodm06IFZNKSB7XG4vLyAgICAgbGV0IG1hbmFnZXIgPSB2bS5mcmFtZS5nZXRNYW5hZ2VyKCk7XG4vLyAgICAgbGV0IGNvbXBvbmVudCA9IHZtLmZyYW1lLmdldENvbXBvbmVudCgpO1xuLy8gICAgIGxldCBib3VuZHMgPSB2bS5zdGFjaygpLnBvcEJsb2NrKCk7XG5cbi8vICAgICBtYW5hZ2VyLmRpZFJlbmRlckxheW91dChjb21wb25lbnQsIGJvdW5kcyk7XG5cbi8vICAgICB2bS5lbnYuZGlkQ3JlYXRlKGNvbXBvbmVudCwgbWFuYWdlcik7XG5cbi8vICAgICB2bS51cGRhdGVXaXRoKG5ldyBEaWRVcGRhdGVMYXlvdXRPcGNvZGUobWFuYWdlciwgY29tcG9uZW50LCBib3VuZHMpKTtcbi8vICAgfVxuLy8gfVxuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuRGlkUmVuZGVyTGF5b3V0LCB2bSA9PiB7XG4gIGxldCBtYW5hZ2VyID0gdm0uZnJhbWUuZ2V0TWFuYWdlcigpO1xuICBsZXQgY29tcG9uZW50ID0gdm0uZnJhbWUuZ2V0Q29tcG9uZW50KCk7XG4gIGxldCBib3VuZHMgPSB2bS5zdGFjaygpLnBvcEJsb2NrKCk7XG5cbiAgbWFuYWdlci5kaWRSZW5kZXJMYXlvdXQoY29tcG9uZW50LCBib3VuZHMpO1xuXG4gIHZtLmVudi5kaWRDcmVhdGUoY29tcG9uZW50LCBtYW5hZ2VyKTtcblxuICB2bS51cGRhdGVXaXRoKG5ldyBEaWRVcGRhdGVMYXlvdXRPcGNvZGUobWFuYWdlciwgY29tcG9uZW50LCBib3VuZHMpKTtcbn0pO1xuXG4vLyBleHBvcnQgY2xhc3MgQ2xvc2VDb21wb25lbnRPcGNvZGUgZXh0ZW5kcyBPcGNvZGUge1xuLy8gICBwdWJsaWMgdHlwZSA9IFwiY2xvc2UtY29tcG9uZW50XCI7XG5cbi8vICAgZXZhbHVhdGUodm06IFZNKSB7XG4vLyAgICAgdm0ucG9wU2NvcGUoKTtcbi8vICAgICB2bS5wb3BEeW5hbWljU2NvcGUoKTtcbi8vICAgICB2bS5jb21taXRDYWNoZUdyb3VwKCk7XG4vLyAgIH1cbi8vIH1cblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkNsb3NlQ29tcG9uZW50LCB2bSA9PiB7XG4gIHZtLnBvcFNjb3BlKCk7XG4gIHZtLnBvcER5bmFtaWNTY29wZSgpO1xuICB2bS5jb21taXRDYWNoZUdyb3VwKCk7XG59KTtcblxuZXhwb3J0IGNsYXNzIFVwZGF0ZUNvbXBvbmVudE9wY29kZSBleHRlbmRzIFVwZGF0aW5nT3Bjb2RlIHtcbiAgcHVibGljIHR5cGUgPSBcInVwZGF0ZS1jb21wb25lbnRcIjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG5hbWU6IHN0cmluZyxcbiAgICBwcml2YXRlIGNvbXBvbmVudDogQ29tcG9uZW50LFxuICAgIHByaXZhdGUgbWFuYWdlcjogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnQ+LFxuICAgIHByaXZhdGUgYXJnczogRXZhbHVhdGVkQXJncyxcbiAgICBwcml2YXRlIGR5bmFtaWNTY29wZTogRHluYW1pY1Njb3BlLFxuICApIHtcbiAgICBzdXBlcigpO1xuXG4gICAgbGV0IGNvbXBvbmVudFRhZyA9IG1hbmFnZXIuZ2V0VGFnKGNvbXBvbmVudCk7XG5cbiAgICBpZiAoY29tcG9uZW50VGFnKSB7XG4gICAgICB0aGlzLnRhZyA9IGNvbWJpbmUoW2FyZ3MudGFnLCBjb21wb25lbnRUYWddKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50YWcgPSBhcmdzLnRhZztcbiAgICB9XG4gIH1cblxuICBldmFsdWF0ZShfdm06IFVwZGF0aW5nVk0pIHtcbiAgICBsZXQgeyBjb21wb25lbnQsIG1hbmFnZXIsIGFyZ3MsIGR5bmFtaWNTY29wZSB9ID0gdGhpcztcblxuICAgIG1hbmFnZXIudXBkYXRlKGNvbXBvbmVudCwgYXJncywgZHluYW1pY1Njb3BlKTtcbiAgfVxuXG4gIHRvSlNPTigpOiBPcGNvZGVKU09OIHtcbiAgICByZXR1cm4ge1xuICAgICAgZ3VpZDogdGhpcy5fZ3VpZCxcbiAgICAgIHR5cGU6IHRoaXMudHlwZSxcbiAgICAgIGFyZ3M6IFtKU09OLnN0cmluZ2lmeSh0aGlzLm5hbWUpXVxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIERpZFVwZGF0ZUxheW91dE9wY29kZSBleHRlbmRzIFVwZGF0aW5nT3Bjb2RlIHtcbiAgcHVibGljIHR5cGUgPSBcImRpZC11cGRhdGUtbGF5b3V0XCI7XG4gIHB1YmxpYyB0YWc6IFJldmlzaW9uVGFnID0gQ09OU1RBTlRfVEFHO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbWFuYWdlcjogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnQ+LFxuICAgIHByaXZhdGUgY29tcG9uZW50OiBDb21wb25lbnQsXG4gICAgcHJpdmF0ZSBib3VuZHM6IEJvdW5kc1xuICApIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgZXZhbHVhdGUodm06IFVwZGF0aW5nVk0pIHtcbiAgICBsZXQgeyBtYW5hZ2VyLCBjb21wb25lbnQsIGJvdW5kcyB9ID0gdGhpcztcblxuICAgIG1hbmFnZXIuZGlkVXBkYXRlTGF5b3V0KGNvbXBvbmVudCwgYm91bmRzKTtcblxuICAgIHZtLmVudi5kaWRVcGRhdGUoY29tcG9uZW50LCBtYW5hZ2VyKTtcbiAgfVxufVxuIl19