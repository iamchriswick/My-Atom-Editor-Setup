import Meta, { ClassMeta } from './meta';
import { CURRENT_TAG, CONSTANT_TAG, combine } from '@glimmer/reference';
import { HAS_NATIVE_WEAKMAP } from '@glimmer/util';
export let classMeta;
export let meta;
if (HAS_NATIVE_WEAKMAP) {
    const META = new WeakMap();
    const CLASS_META = new WeakMap();
    classMeta = function _classMetaNative(object) {
        let m = CLASS_META.get(object);
        if (m === undefined) {
            m = new ClassMeta();
            CLASS_META.set(object, m);
        }
        return m;
    };
    meta = function _metaNative(object) {
        let m = META.get(object);
        if (m === undefined) {
            m = new Meta();
            META.set(object, m);
        }
        return m;
    };
}
else {
    const GLIMMER_META = 'META__glimmer__1484170086860394543206811';
    const GLIMMER_CLASS_META = 'CLASS_META__glimmer__14841708559821468834708062';
    classMeta = function _classMetaFaux(object) {
        let m = object[GLIMMER_CLASS_META];
        if (m === undefined) {
            m = new ClassMeta();
            object[GLIMMER_CLASS_META] = m;
        }
        return m;
    };
    meta = function _metaFaux(object) {
        let m = object[GLIMMER_META];
        if (m === undefined) {
            m = new Meta();
            object[GLIMMER_META] = m;
        }
        return m;
    };
}
export function set(object, key, value) {
    object[key] = value;
    meta(object).dirty(key);
}
export function root(object) {
    return new VersionedRootReference(object);
}
export class VersionedRootReference {
    constructor(inner) {
        this.inner = inner;
        this.tag = CONSTANT_TAG;
    }
    value() {
        return this.inner;
    }
    get(key) {
        return new VersionedObjectReference(this, key);
    }
}
export class VersionedObjectReference {
    constructor(parent, key) {
        this.parent = parent;
        this.key = key;
        this.tag = CURRENT_TAG;
    }
    value() {
        let { parent, key } = this;
        let parentObject = this.parent.value();
        let computed = classMeta(Object.getPrototypeOf(parentObject)).getComputed(key);
        let tags = [meta(parentObject).tag(key)];
        if (computed) {
            tags.push(...computed.dependentKeys.map(key => path(this, key).tag));
        }
        this.tag = combine(tags);
        return parentObject[key];
    }
    get(key) {
        return new VersionedObjectReference(this, key);
    }
}
function path(parent, key) {
    return key.split('.').reduce((ref, part) => ref.get(part), parent);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQGdsaW1tZXIvb2JqZWN0LW1vZGVsL2xpYi9yZWZlcmVuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxJQUFJLEVBQUUsRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFHekMsT0FBTyxFQUNMLFdBQVcsRUFDWCxZQUFZLEVBR1osT0FBTyxFQUNSLE1BQU0sb0JBQW9CLENBQUM7QUFFNUIsT0FBTyxFQUFrQixrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuRSxNQUFNLENBQUMsSUFBSSxTQUFTLENBQUM7QUFDckIsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDO0FBRWhCLEVBQUUsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztJQUN2QixNQUFNLElBQUksR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBQzNCLE1BQU0sVUFBVSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFDakMsU0FBUyxHQUFHLDBCQUEwQixNQUF1QjtRQUMzRCxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRS9CLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ3BCLFVBQVUsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzVCLENBQUM7UUFFRCxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQyxDQUFDO0lBRUYsSUFBSSxHQUFHLHFCQUFxQixNQUF1QjtRQUNqRCxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXpCLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsR0FBRyxJQUFJ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Q0FBQztRQUN2RSxDQUFDO1FBRUQsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekIsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRUQsR0FBRyxDQUFDLEdBQWdCO1FBQ2xCLE1BQU0sQ0FBQyxJQUFJLHdCQUF3QixDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNqRCxDQUFDO0NBQ0Y7QUFFRCxjQUFjLE1BQXNDLEVBQUUsR0FBVztJQUMvRCxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxLQUFLLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDckUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBHbGltbWVySW5zdGFuY2UgZnJvbSAnLi9vYmplY3QnO1xuaW1wb3J0IE1ldGEsIHsgQ2xhc3NNZXRhIH0gZnJvbSAnLi9tZXRhJztcbmltcG9ydCB7IENvbXB1dGVkIH0gZnJvbSAnLi9ibHVlcHJpbnQnO1xuXG5pbXBvcnQge1xuICBDVVJSRU5UX1RBRyxcbiAgQ09OU1RBTlRfVEFHLFxuICBWZXJzaW9uZWRQYXRoUmVmZXJlbmNlLFxuICBSZXZpc2lvblRhZyxcbiAgY29tYmluZVxufSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuXG5pbXBvcnQgeyBPcGFxdWUsIE9wdGlvbiwgSEFTX05BVElWRV9XRUFLTUFQIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5cbmV4cG9ydCBsZXQgY2xhc3NNZXRhO1xuZXhwb3J0IGxldCBtZXRhO1xuXG5pZiAoSEFTX05BVElWRV9XRUFLTUFQKSB7XG4gIGNvbnN0IE1FVEEgPSBuZXcgV2Vha01hcCgpO1xuICBjb25zdCBDTEFTU19NRVRBID0gbmV3IFdlYWtNYXAoKTtcbiAgY2xhc3NNZXRhID0gZnVuY3Rpb24gX2NsYXNzTWV0YU5hdGl2ZShvYmplY3Q6IEdsaW1tZXJJbnN0YW5jZSk6IENsYXNzTWV0YSB7XG4gICAgbGV0IG0gPSBDTEFTU19NRVRBLmdldChvYmplY3QpO1xuXG4gICAgaWYgKG0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgbSA9IG5ldyBDbGFzc01ldGEoKTtcbiAgICAgIENMQVNTX01FVEEuc2V0KG9iamVjdCwgbSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG07XG4gIH07XG5cbiAgbWV0YSA9IGZ1bmN0aW9uIF9tZXRhTmF0aXZlKG9iamVjdDogR2xpbW1lckluc3RhbmNlKTogTWV0YSB7XG4gICAgbGV0IG0gPSBNRVRBLmdldChvYmplY3QpO1xuXG4gICAgaWYgKG0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgbSA9IG5ldyBNZXRhKCk7XG4gICAgICBNRVRBLnNldChvYmplY3QsIG0pO1xuICAgIH1cblxuICAgIHJldHVybiBtO1xuICB9O1xuXG59IGVsc2Uge1xuICBjb25zdCBHTElNTUVSX01FVEEgPSAnTUVUQV9fZ2xpbW1lcl9fMTQ4NDE3MDA4Njg2MDM5NDU0MzIwNjgxMSc7XG4gIGNvbnN0IEdMSU1NRVJfQ0xBU1NfTUVUQSA9ICdDTEFTU19NRVRBX19nbGltbWVyX18xNDg0MTcwODU1OTgyMTQ2ODgzNDcwODA2Mic7XG4gIGNsYXNzTWV0YSA9IGZ1bmN0aW9uIF9jbGFzc01ldGFGYXV4KG9iamVjdDogR2xpbW1lckluc3RhbmNlKTogQ2xhc3NNZXRhIHtcbiAgICBsZXQgbSA9IG9iamVjdFtHTElNTUVSX0NMQVNTX01FVEFdO1xuXG4gICAgaWYgKG0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgbSA9IG5ldyBDbGFzc01ldGEoKTtcbiAgICAgIG9iamVjdFtHTElNTUVSX0NMQVNTX01FVEFdID0gbTtcbiAgICB9XG5cbiAgICByZXR1cm4gbTtcbiAgfTtcblxuICBtZXRhID0gZnVuY3Rpb24gX21ldGFGYXV4KG9iamVjdDogR2xpbW1lckluc3RhbmNlKTogTWV0YSB7XG4gICAgbGV0IG0gPSBvYmplY3RbR0xJTU1FUl9NRVRBXTtcblxuICAgIGlmIChtID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG0gPSBuZXcgTWV0YSgpO1xuICAgICAgb2JqZWN0W0dMSU1NRVJfTUVUQV0gPSBtO1xuICAgIH1cblxuICAgIHJldHVybiBtO1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0PFQ+KG9iamVjdDogR2xpbW1lckluc3RhbmNlLCBrZXk6IFByb3BlcnR5S2V5LCB2YWx1ZTogVCkge1xuICBvYmplY3Rba2V5XSA9IHZhbHVlO1xuICBtZXRhKG9iamVjdCkuZGlydHkoa2V5KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJvb3Q8VCBleHRlbmRzIEdsaW1tZXJJbnN0YW5jZT4ob2JqZWN0OiBUKTogVmVyc2lvbmVkUm9vdFJlZmVyZW5jZTxUPiB7XG4gIHJldHVybiBuZXcgVmVyc2lvbmVkUm9vdFJlZmVyZW5jZShvYmplY3QpO1xufVxuXG5leHBvcnQgY2xhc3MgVmVyc2lvbmVkUm9vdFJlZmVyZW5jZTxUPiBpbXBsZW1lbnRzIFZlcnNpb25lZFBhdGhSZWZlcmVuY2U8T3BhcXVlPiB7XG4gIHB1YmxpYyB0YWc6IFJldmlzaW9uVGFnO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IFQpIHtcbiAgICB0aGlzLnRhZyA9IENPTlNUQU5UX1RBRztcbiAgfVxuXG4gIHZhbHVlKCk6IFQge1xuICAgIHJldHVybiB0aGlzLmlubmVyO1xuICB9XG5cbiAgZ2V0PFQgZXh0ZW5kcyBPcGFxdWU+KGtleTogUHJvcGVydHlLZXkpOiBWZXJzaW9uZWRQYXRoUmVmZXJlbmNlPFQ+IHtcbiAgICByZXR1cm4gbmV3IFZlcnNpb25lZE9iamVjdFJlZmVyZW5jZSh0aGlzLCBrZXkpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBWZXJzaW9uZWRPYmplY3RSZWZlcmVuY2UgaW1wbGVtZW50cyBWZXJzaW9uZWRQYXRoUmVmZXJlbmNlPE9wYXF1ZT4ge1xuICBwdWJsaWMgdGFnOiBSZXZpc2lvblRhZyA9IENVUlJFTlRfVEFHO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFyZW50OiBWZXJzaW9uZWRQYXRoUmVmZXJlbmNlPE9wYXF1ZT4sIHByaXZhdGUga2V5OiBQcm9wZXJ0eUtleSkge31cblxuICB2YWx1ZSgpIHtcbiAgICBsZXQgeyBwYXJlbnQsIGtleSB9ID0gdGhpcztcbiAgICBsZXQgcGFyZW50T2JqZWN0ID0gdGhpcy5wYXJlbnQudmFsdWUoKSBhcyBHbGltbWVySW5zdGFuY2U7XG5cbiAgICBsZXQgY29tcHV0ZWQgPSBjbGFzc01ldGEoT2JqZWN0LmdldFByb3RvdHlwZU9mKHBhcmVudE9iamVjdCkpLmdldENvbXB1dGVkKGtleSk7XG4gICAgbGV0IHRhZ3M6IFJldmlzaW9uVGFnW10gPSBbbWV0YShwYXJlbnRPYmplY3QpLnRhZyhrZXkpXTtcblxuICAgIGlmIChjb21wdXRlZCkge1xuICAgICAgdGFncy5wdXNoKC4uLmNvbXB1dGVkLmRlcGVuZGVudEtleXMubWFwKGtleSA9PiBwYXRoKHRoaXMsIGtleSkudGFnKSk7XG4gICAgfVxuXG4gICAgdGhpcy50YWcgPSBjb21iaW5lKHRhZ3MpO1xuICAgIHJldHVybiBwYXJlbnRPYmplY3Rba2V5XTtcbiAgfVxuXG4gIGdldChrZXk6IFByb3BlcnR5S2V5KTogVmVyc2lvbmVkUGF0aFJlZmVyZW5jZTxPcGFxdWU+IHtcbiAgICByZXR1cm4gbmV3IFZlcnNpb25lZE9iamVjdFJlZmVyZW5jZSh0aGlzLCBrZXkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHBhdGgocGFyZW50OiBWZXJzaW9uZWRQYXRoUmVmZXJlbmNlPE9wYXF1ZT4sIGtleTogc3RyaW5nKTogVmVyc2lvbmVkUGF0aFJlZmVyZW5jZTxPcGFxdWU+IHtcbiAgcmV0dXJuIGtleS5zcGxpdCgnLicpLnJlZHVjZSgocmVmLCBwYXJ0KSA9PiByZWYuZ2V0KHBhcnQpLCBwYXJlbnQpO1xufVxuIl19