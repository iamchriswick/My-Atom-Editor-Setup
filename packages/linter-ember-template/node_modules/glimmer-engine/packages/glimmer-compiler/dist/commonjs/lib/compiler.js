"use strict";
const glimmer_syntax_1 = require("glimmer-syntax");
const template_compiler_1 = require("./template-compiler");
const defaultId = (() => {
    let idFn;
    return () => {
        if (!idFn) {
            if (typeof require === 'function') {
                try {
                    /* tslint:disable:no-require-imports */
                    const crypto = require('crypto');
                    /* tslint:enable:no-require-imports */
                    idFn = src => {
                        let hash = crypto.createHash('sha1');
                        hash.update(src, 'utf8');
                        // trim to 6 bytes of data (2^48 - 1)
                        return hash.digest('base64').substring(0, 8);
                    };
                    idFn("test");
                }
                catch (e) {
                    idFn = null;
                }
            }
            if (!idFn) {
                idFn = () => null;
            }
        }
        return idFn;
    };
})();
function precompile(string, options) {
    let opts = options || {
        id: defaultId(),
        meta: {}
    };
    let ast = glimmer_syntax_1.preprocess(string, opts);
    let { block, meta } = template_compiler_1.default.compile(opts, ast);
    let idFn = opts.id || defaultId();
    let blockJSON = JSON.stringify(block.toJSON());
    let templateJSONObject = {
        id: idFn(JSON.stringify(meta) + blockJSON),
        block: blockJSON,
        meta
    };
    // JSON is javascript
    return JSON.stringify(templateJSONObject);
}
exports.precompile = precompile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvY29tcGlsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLG1EQUE0QztBQUM1QywyREFBdUU7QUFhdkUsTUFBTSxTQUFTLEdBQXVCLENBQUM7SUFDckMsSUFBSSxJQUFrQixDQUFDO0lBQ3ZCLE1BQU0sQ0FBQztRQUNMLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNWLEVBQUUsQ0FBQyxDQUFDLE9BQU8sT0FBTyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLElBQUksQ0FBQztvQkFDSCx1Q0FBdUM7b0JBQ3ZDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDakMsc0NBQXNDO29CQUN0QyxJQUFJLEdBQUcsR0FBRzt3QkFDUixJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO3dCQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQzt3QkFDekIscUNBQXFDO3dCQUNyQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDO29CQUM5QyxDQUFDLENBQUM7b0JBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNmLENBQUU7Z0JBQUEsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDWCxJQUFJLEdBQUcsSUFBSSxDQUFDO2dCQUNkLENBQUM7WUFDSCxDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNWLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQztZQUNwQixDQUFDO1FBQ0gsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDLENBQUM7QUFDSixDQUFDLENBQUMsRUFBRSxDQUFDO0FBaUJMLG9CQUEyQixNQUFjLEVBQUUsT0FBK0I7SUFDeEUsSUFBSSxJQUFJLEdBQUcsT0FBTyxJQUFJO1FBQ3BCLEVBQUUsRUFBRSxTQUFTLEVBQUU7UUFDZixJQUFJLEVBQUUsRUFBRTtLQUNULENBQUM7SUFDRixJQUFJLEdBQUcsR0FBRywyQkFBVSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNuQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLDJCQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDMUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUNsQyxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQy9DLElBQUksa0JBQWtCLEdBQXdDO1FBQzVELEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUM7UUFDMUMsS0FBSyxFQUFFLFNBQVM7UUFDaEIsSUFBSTtLQUNMLENBQUM7SUFFRixxQkFBcUI7SUFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUM1QyxDQUFDO0FBakJELGdDQWlCQyJ9