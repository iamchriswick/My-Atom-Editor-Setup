"use strict";
const glimmer_util_1 = require("glimmer-util");
const builder_1 = require("./builder");
const vm_1 = require("./vm");
const scanner_1 = require("./scanner");
let clientId = 0;
function templateFactory({ id: templateId, meta, block }) {
    let parsedBlock;
    let id = templateId || `client-${clientId++}`;
    let create = (env, envMeta) => {
        let newMeta = envMeta ? glimmer_util_1.assign({}, envMeta, meta) : meta;
        if (!parsedBlock) {
            parsedBlock = JSON.parse(block);
        }
        return template(parsedBlock, id, newMeta, env);
    };
    return { id, meta, create };
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = templateFactory;
function template(block, id, meta, env) {
    let scanner = new scanner_1.default(block, meta, env);
    let entryPoint;
    let asEntryPoint = () => {
        if (!entryPoint)
            entryPoint = scanner.scanEntryPoint();
        return entryPoint;
    };
    let layout;
    let asLayout = () => {
        if (!layout)
            layout = scanner.scanLayout();
        return layout;
    };
    let asPartial = (symbols) => scanner.scanPartial(symbols);
    let render = (self, appendTo, dynamicScope) => {
        let elementStack = builder_1.ElementStack.forInitialRender(env, appendTo, null);
        let compiled = asEntryPoint().compile(env);
        let vm = vm_1.VM.initial(env, self, dynamicScope, elementStack, compiled.symbols);
        return vm.execute({ ops: compiled.ops, start: 0, end: compiled.ops.length - 1 });
    };
    return { id, meta, _block: block, asEntryPoint, asLayout, asPartial, render };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvdGVtcGxhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUtBLCtDQUFzQztBQUd0Qyx1Q0FBeUM7QUFDekMsNkJBQTBCO0FBRTFCLHVDQUltQjtBQTZEbkIsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO0FBU2pCLHlCQUF3QyxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBd0M7SUFDM0csSUFBSSxXQUFvQyxDQUFDO0lBQ3pDLElBQUksRUFBRSxHQUFHLFVBQVUsSUFBSSxVQUFVLFFBQVEsRUFBRSxFQUFFLENBQUM7SUFDOUMsSUFBSSxNQUFNLEdBQUcsQ0FBQyxHQUFnQixFQUFFLE9BQVk7UUFDMUMsSUFBSSxPQUFPLEdBQUcsT0FBTyxHQUFHLHFCQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDekQsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xDLENBQUM7UUFDRCxNQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2pELENBQUMsQ0FBQztJQUNGLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFDOUIsQ0FBQzs7QUFYRCxrQ0FXQztBQUVELGtCQUFxQixLQUE4QixFQUFFLEVBQVUsRUFBRSxJQUFPLEVBQUUsR0FBZ0I7SUFDeEYsSUFBSSxPQUFPLEdBQUcsSUFBSSxpQkFBTyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDNUMsSUFBSSxVQUFzQixDQUFDO0lBQzNCLElBQUksWUFBWSxHQUFHO1FBQ2pCLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO1lBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2RCxNQUFNLENBQUMsVUFBVSxDQUFDO0lBQ3BCLENBQUMsQ0FBQztJQUNGLElBQUksTUFBYyxDQUFDO0lBQ25CLElBQUksUUFBUSxHQUFHO1FBQ2IsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQzNDLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEIsQ0FBQyxDQUFDO0lBQ0YsSUFBSSxTQUFTLEdBQUcsQ0FBQyxPQUFvQixLQUFLLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkUsSUFBSSxNQUFNLEdBQUcsQ0FBQyxJQUF3QixFQUFFLFFBQXdCLEVBQUUsWUFBMEI7UUFDMUYsSUFBSSxZQUFZLEdBQUcsc0JBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3RFLElBQUksUUFBUSxHQUFHLFlBQVksRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzQyxJQUFJLEVBQUUsR0FBRyxPQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0UsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxHQUFHLEVBQUUsUUFBUSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ25GLENBQUMsQ0FBQztJQUNGLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsQ0FBQztBQUNoRixDQUFDIn0=